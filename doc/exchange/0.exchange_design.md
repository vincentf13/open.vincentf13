# ğŸ¥ æ¼”ç¤ºå½±ç‰‡

- [Web äº¤æ˜“çµ‚ç«¯æ¼”ç¤º (React / Ant Design)](https://www.youtube.com/watch?v=MYQobecR8DA&t=67s)

# ç³»çµ±åŠŸèƒ½

å–®å‘æŒå€‰
é€å€‰ä¿è­‰é‡‘æ¨¡å¼

- order
    - é™åƒ¹å–®ã€å¸‚åƒ¹å–®
    - é–‹å€‰ (å¤š/ç©º)ã€å¹³å€‰ã€æ’¤éŠ·å§”è¨—
- å¸³å‹™
    - ä¸‹å–®é æ‰£
    - æ ¹æ“šæˆäº¤ã€å¼·å¹³äº‹ä»¶èª¿æ•´å¸³å‹™ã€‚
    - å…¬å¸å¸³ç›®å°æ˜ æœƒè¨ˆç§‘ç›®ï¼Œé›™åˆ†éŒ„è¨˜å¸³æ³•
- æ’®åˆ
    - æ¯å€‹äº¤æ˜“å°ç¶­è­·ç¨ç«‹çš„ Order Bookï¼Œå–®ç·šç¨‹å…§å­˜æ’®åˆ
    - WAL
    - åƒ¹æ ¼å„ªå…ˆã€æ™‚é–“å„ªå…ˆ (Price-Time Priority) çš„æ’®åˆç®—æ³•

- è¡Œæƒ…
    - æ ¹æ“šæˆäº¤èˆ‡æ›æ’¤å–®äº‹ä»¶ï¼Œæ›´æ–° Tickerã€æ·±åº¦ã€K ç·š
    - K ç·šåœ–æŸ¥è©¢:
        - æä¾›å¤šç¨®æ™‚é–“é€±æœŸ (1m, 5m, 1h, 1d ç­‰) çš„ K ç·šæ•¸æ“šã€‚
        - æ”¯æ´ REST API
- å€‰ä½
    - å–®å‘æŒå€‰ï¼Œç”¨æˆ¶å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æŒå€‰çš„è©³ç´°è³‡è¨Šï¼ŒåŒ…æ‹¬å€‰ä½æ•¸é‡ã€é–‹å€‰å‡åƒ¹ã€æœªå¯¦ç¾/å·²å¯¦ç¾ç›ˆè™§ã€ä¿è­‰é‡‘ã€å¼·å¹³åƒ¹æ ¼ç­‰ã€‚
    - å¹³å€‰é æ‰£ã€æ§“æ¡¿å€æ•¸èª¿æ•´æ¥å£
    - æ¶ˆè²»æˆäº¤ã€å¸³å‹™ã€è¡Œæƒ…äº‹ä»¶ï¼Œå³æ™‚æ›´æ–°å€‰ä½ä¿¡æ¯
    - event sourcing
- é¢¨æ§
    - ä¸‹å–®é æª¢ï¼Œæ ¹æ“šå€‰ä½å¤§å°å’Œæ§“æ¡¿ï¼Œè¨ˆç®—åˆå§‹ä¿è­‰é‡‘èˆ‡ç¶­æŒä¿è­‰é‡‘ã€‚
    - ç•¶ç”¨æˆ¶çš„ä¿è­‰é‡‘ç‡ä½æ–¼ç¶­æŒä¿è­‰é‡‘ç‡æ™‚ï¼Œç³»çµ±è‡ªå‹•åŸ·è¡Œå¼·åˆ¶å¹³å€‰æµç¨‹ã€‚

æš«ä¸å¯¦ä½œ

- ~~flip åæ‰‹é–‹å¹³å€‰èˆ‡çµç®—~~
- ~~è³‡é‡‘è²»ç‡~~
- ~~é¢¨éšªæº–å‚™é‡‘ï¼ˆInsurance Fundï¼‰~~
- ~~ADL è‡ªå‹•æ¸›å€‰~~
- ~~æ ¹æ“šå¤šå®¶å¤–éƒ¨äº¤æ˜“æ‰€çš„ç¾è²¨åƒ¹æ ¼ï¼Œè¨ˆç®—å‡ºå…¬å…çš„æŒ‡æ•¸åƒ¹æ ¼èˆ‡æ¨™è¨˜åƒ¹æ ¼ï¼Œä¸¦æ¨é€è¡Œæƒ…äº‹ä»¶~~
- ~~æ¡ç”¨æ¨™è¨˜åƒ¹æ ¼è§¸ç™¼å¼·å¹³ï¼Œä»¥é¿å…å¸‚å ´æ’é‡é€ æˆçš„ç•°å¸¸æ³¢å‹•ã€‚~~

# å…¨åŸŸæ¶æ§‹èˆ‡æ¦‚å¿µ (Architecture Overview)

## ç›®éŒ„çµæ§‹

## æœå‹™ä¾è³´é—œä¿‚åœ–

```mermaid
flowchart LR
    Client[å‰ç«¯/äº¤æ˜“å®¢æˆ¶ç«¯]

    subgraph Services[æœå‹™ç¾¤]
        Gateway[Gateway]
        Auth[Auth]
        User[User]
        OrderSvc[Order]
        RiskSvc[Risk]
        LedgerSvc[Ledger]
        PositionsSvc[Positions]
        MarketSvc[Market]
        MatchingSvc[Matching]
    end

    Client -->|HTTP| Gateway
    Gateway -->|REST| Auth
    Gateway -->|REST| User
    Gateway -->|REST| OrderSvc
    Gateway -->|REST| LedgerSvc
    Gateway -->|REST| PositionsSvc
    Gateway -->|REST| MarketSvc

    %% æ ¸å¿ƒä¸‹å–®éˆè·¯
    OrderSvc -- 1.é æª¢ --> RiskSvc
    OrderSvc -- 2.é–å€‰ --> PositionsSvc
    OrderSvc -- 3.å‡çµ --> LedgerSvc
    OrderSvc -- 4.æ’®åˆ --> MatchingSvc

    %% æ’®åˆå¾Œç•°æ­¥äº‹ä»¶æµ
    MatchingSvc -- TradeExecuted --> LedgerSvc
    MatchingSvc -- TradeExecuted --> PositionsSvc
    MatchingSvc -- TradeExecuted --> MarketSvc
    MatchingSvc -- OrderBookUpdated --> MarketSvc

    %% é¢¨æ§å›é¥‹è¿´åœˆ
    PositionsSvc -- PositionUpdated --> RiskSvc
    MarketSvc -- MarkPriceUpdated --> RiskSvc
    RiskSvc -- LiquidationTriggered --> OrderSvc
```

#    

# æ ¸å¿ƒæ¥­å‹™æµç¨‹ (Core Business Flows)

# å¸³è™Ÿ

## `POST /api/users`ï¼šè¨»å†Š

- å‰ç«¯å‘¼å« `POST /api/users`ï¼ˆç”± Gateway è½‰ç™¼ï¼‰ã€‚
- `user-service` é©—è­‰ä¿¡ç®±æ˜¯å¦å·²å­˜åœ¨ï¼Œå»ºç«‹ `User` ä¸»æª”ï¼Œèˆ‡åœ¨ `user_registration_prepare` è¡¨å¯«å…¥ä¸€ç­† `PREPARE` ç‹€æ…‹çš„è¨»å†Šå·¥ä½œï¼ˆåŒ…å«
  userIdã€emailã€é‡è©¦æ¬¡æ•¸ç­‰æ¬„ä½ï¼‰ã€‚
- å»ºç«‹æˆåŠŸå¾Œå‘¼å« `auth` æœå‹™ï¼Œå‚³å…¥ `AuthCredentialCreateRequest`ï¼ˆå¸¶å…¥ userIdã€å‹åˆ¥ã€å¯†ç¢¼é›œæ¹Šèˆ‡é¹½å€¼ï¼‰ï¼›`auth` å¯«å…¥
  `auth_credentials`ï¼Œä¸¦å›å ±æˆåŠŸä»¥æ›´æ–°è¨»å†Šå·¥ä½œç‹€æ…‹ç‚º `COMPLETED`ã€‚
- è‹¥æ†‘è­‰å»ºç«‹å¤±æ•—æˆ– `auth` æš«æ™‚ä¸å¯ç”¨ï¼Œ`user-service` æœƒä¿ç•™ `PREPARE` ç‹€æ…‹ä¸¦å›å‚³ `RemoteServiceError`ï¼Œä»¥ä¾¿ç¨å¾Œé‡è©¦ã€‚
- **æ’ç¨‹è£œå„Ÿ**ï¼š`UserRegistrationResumer`ï¼ˆSpring Scheduling/Quartz Jobï¼‰æ¯åˆ†é˜æƒæ `user_registration_prepare`ï¼Œå°åœç•™åœ¨
  `PREPARE` çš„è¨˜éŒ„é‡æ–°å‘¼å« `auth` å»ºæ†‘è­‰ï¼›æˆåŠŸå¾Œæ¨™è¨˜ `COMPLETED`ï¼Œé€£çºŒ N æ¬¡å¤±æ•—å‰‡æ¨™è¨˜ `FAILED` ä¸¦ç™¼é€å‘Šè­¦é€šçŸ¥ç‡Ÿé‹è™•ç†ã€‚

## `POST /api/auth/credentials`ï¼šå»ºç«‹æ†‘è­‰

## POST `/api/auth/login`ï¼šç™»å…¥

- ç”± `sdk-auth-server` æä¾›é è¨­å¯¦ä½œï¼›æœå‹™å¼•å…¥è©²æ¨¡çµ„å¾Œå³å¯ç›´æ¥å•Ÿç”¨ã€‚

ç™»å…¥æµç¨‹

- `POST /api/auth/login`ï¼š
    - Gateway å°‡è«‹æ±‚è½‰çµ¦ `auth`ã€‚
    - `auth` ä¾ credential type è®€å– `auth_credentials`ï¼Œä»¥ `BCrypt`/`Argon2` é©—è­‰å¯†ç¢¼ä¸¦æª¢æŸ¥ç‹€æ…‹ï¼ˆLOCKEDã€EXPIRED ç­‰ï¼‰ï¼Œå¿…è¦æ™‚è¿½åŠ 
      OTP/FIDO äºŒæ¬¡é©—è­‰ã€‚
    - é©—è­‰æˆåŠŸå¾Œå¯«å…¥ `login_audits`ã€`auth_sessions`ï¼Œä¸¦åœ¨ Redis å»ºç«‹ `auth:session:{sessionId}`ï¼ˆå«
      userIdã€rolesã€IPã€è£ç½®æŒ‡ç´‹ã€TTLï¼‰ã€‚
    - å›å‚³ Access/Refresh Tokenï¼ŒJWT å…§å« `sessionId`ã€`authContext`ï¼Œä¾›ä¸‹æ¸¸æœå‹™è§£æã€‚
- è«‹æ±‚æˆæ¬Šï¼šå¾ŒçºŒæ‰€æœ‰ API ç”± Gateway çš„ JWT Filter é©—è­‰ Access Tokenï¼Œä¸¦ä»¥ `sessionId` æŸ¥è©¢ Redisï¼ˆæˆ–æœ¬åœ°å¿«å–ï¼‰ç¢ºèªæœƒè©±ä»æœ‰æ•ˆï¼›è‹¥ä¸å­˜åœ¨æˆ–æ¨™è¨˜
  `revoked` å³æ‹’çµ•ã€‚
- Token çºŒæœŸï¼šAccess Token éæœŸæ™‚ï¼Œå‰ç«¯å‘¼å« `POST /api/auth/token/refresh`ï¼Œ`auth` é©—è­‰ Refresh Token æ˜¯å¦ä» activeï¼Œä½¿ç”¨æ¨‚è§€é–ï¼ˆ
  `refresh_tokens.version`ï¼‰é¿å…é‡æ”¾ï¼ŒæˆåŠŸå‰‡ç°½ç™¼æ–° Access/Refresh ä¸¦å»¶é•· Redis session TTLã€‚
- ç™»å‡º/å¤±æ•ˆï¼š`POST /api/auth/logout` æˆ–é¢¨æ§äº‹ä»¶æœƒæ¨™è¨˜ Refresh Token ç‚º `revoked`ã€åˆªé™¤ Redis sessionï¼Œä¸¦ç™¼å¸ƒ
  `AuthSessionRevoked` äº‹ä»¶ï¼›Gateway æˆ–æœå‹™å´å¯ç«‹å³çµ‚æ­¢è©²æœƒè©±ã€‚
- ä¸‹æ¸¸ä½¿ç”¨ï¼šå„æœå‹™çš„å®‰å…¨ Filter è§£æ JWTï¼Œå°‡ `OpenJwtUser`ï¼ˆuserIdã€rolesã€scopesã€sessionIdï¼‰æ”¾å…¥ ThreadLocal æˆ– Reactor
  Contextï¼Œæ”¯æ´å¯©è¨ˆèˆ‡æˆæ¬Šåˆ¤å®šã€‚

## POST `/api/auth/token/refresh`ï¼šrefresh token

- ä½¿ç”¨ Refresh Token å–å¾—æ–°çš„ Access Tokenï¼Œä¸¦å»¶é•· Redis session åˆ°æœŸæ™‚é–“ã€‚
- ç”± `sdk-auth-server` æä¾›é è¨­å¯¦ä½œï¼›æœå‹™å¼•å…¥è©²æ¨¡çµ„å¾Œå³å¯ç›´æ¥å•Ÿç”¨ã€‚

## POST `/api/auth/logout`ï¼šç™»å‡º

- ä½œå»¢ Refresh Token/Sessionï¼ˆåˆªé™¤ Redis sessionï¼‰ã€‚
-
    - ç”± `sdk-auth-server` æä¾›é è¨­å¯¦ä½œï¼›æœå‹™å¼•å…¥è©²æ¨¡çµ„å¾Œå³å¯ç›´æ¥å•Ÿç”¨ã€‚

# æ§“æ¡¿é…ç½®

#### POST `/api/risk/precheck/leverage` (é¢¨æ§è©¦ç®—èˆ‡é©—è­‰)

- **Request (`LeveragePrecheckRequest`)**:
    - `userId`, `instrumentId`
    - `targetLeverage` (ç›®æ¨™æ§“æ¡¿)
    - `currentPosition` (ç•¶å‰å€‰ä½æ•¸é‡ã€ç•¶å‰ Marginã€æŒå€‰æ–¹å‘)
    - `markPrice` (æœ€æ–°æ¨™è¨˜åƒ¹æ ¼)

- **Processing**:

    1. **åç¾©åƒ¹å€¼æª¢æŸ¥**ï¼šè¨ˆç®— `notional = size * markPrice`ï¼Œæª¢æŸ¥æ˜¯å¦è¶…é `targetLeverage` å°æ‡‰çš„ Tier ä¸Šé™ï¼ˆä¾‹å¦‚ 100x
       ä¸èƒ½é–‹è¶…é 50k USDTï¼‰ã€‚
    2. æª¢æŸ¥æ§“æ¡¿å€æ˜¯å¦ç¬¦åˆ risk_limit é…ç½®
    3. **ä¿è­‰é‡‘è¨ˆç®—**ï¼š
        - `newMinMargin = notional / targetLeverage` (æ–°èµ·å§‹ä¿è­‰é‡‘)
        - `marginDelta = newMinMargin - currentMargin`
        - _æ³¨æ„ï¼šå¦‚æœ `marginDelta > 0` ä»£è¡¨éœ€è£œéŒ¢ï¼›`< 0` ä»£è¡¨é€€éŒ¢ã€‚_
    4. **å¼·å¹³åƒ¹é æ¼” (Critical)**ï¼š
        - è©¦ç®—èª¿æ•´å¾Œçš„å¼·å¹³åƒ¹ `newLiqPrice`ã€‚
        - **æª¢æŸ¥**ï¼šè‹¥åšå¤šï¼Œ`newLiqPrice >= markPrice` å‰‡**æ‹’çµ•**ï¼ˆä¸€æ”¹å°±çˆ†å€‰ï¼‰ï¼›è‹¥åšç©ºï¼Œ`newLiqPrice <= markPrice` å‰‡**æ‹’çµ•
          **ã€‚

    5. **é¤˜é¡é æª¢æŸ¥ (Optional)**ï¼šè‹¥æ˜¯è£œéŒ¢ï¼Œå¯å…ˆè®€å–ç”¨æˆ¶é¤˜é¡çœ‹å¤ ä¸å¤ ï¼ˆéå¼·é–å®šï¼Œåƒ…ä½œ UX æç¤ºï¼‰ã€‚
- **Response**:
    - `allow`: boolean
    - `marginDelta`: decimal (æ­£æ•¸=è£œä¿è­‰é‡‘, è² æ•¸=é‡‹æ”¾ä¿è­‰é‡‘)
    - `newLiqPrice`: decimal (é ä¼°æ–°å¼·å¹³åƒ¹ï¼Œä¾›å‰ç«¯å±•ç¤º)
    - `reason`: string (è‹¥å¤±æ•—ï¼Œè¿”å›åŸå› ï¼Œå¦‚ "Instant Liquidation Risk")

---

#### POST `/api/positions/{instrumentId}/leverage` (æ ¸å¿ƒæ¥­å‹™)

é€™æ˜¯äº‹å‹™çš„å”èª¿å…¥å£ã€‚

- **æµç¨‹é‚è¼¯**:
    1. **Call Precheck**: å‘¼å«ä¸Šè¿° `/api/risk/precheck/leverage`ï¼Œç²å– `allow` å’Œ `marginDelta`ã€‚
       è‹¥ `allow=false` ç›´æ¥å ±éŒ¯ã€‚
    2. **æ±ºç­–åˆ†æ”¯**:

    - **åˆ†æ”¯ Aï¼šèª¿ä½æ§“æ¡¿ (Need to Add Margin, `marginDelta > 0`)**
        - Step 1
            - Position Service åœ¨è‡ªå·±çš„è³‡æ–™åº« `retry_task`  è¡¨å¯«å…¥ä¸€ç­† `PENDING` ç‹€æ…‹çš„ä»»å‹™å–®
              biz_type = å€‰ä½èª¿ä½æ§“æ¡¿
              biz_key = é›ªèŠ±ID
              payload = step 2 çš„è«‹æ±‚åƒæ•¸
            - (Error Handling):  å®šæœŸæƒæ `retry_task`  è¡¨ ä¸­ï¼Œ biz_type = å€‰ä½èª¿ä½æ§“æ¡¿ï¼Œè¶…éä¸€å®šæ™‚é–“ï¼ˆå¦‚ 10 ç§’ï¼‰ä»è™•æ–¼
              `PENDING` çš„ä»»å‹™ã€‚
              é‡å°é€™äº›å¡ä½çš„ä»»å‹™ï¼Œç”¨biz_key = é›ªèŠ±IDï¼Œå» Wallet Service åæŸ¥äº¤æ˜“ç‹€æ…‹ï¼š
                - **è‹¥éŒ¢åŒ…å·²æ‰£æ¬¾**ï¼šPosition Service ç¹¼çºŒå®Œæˆå€‰ä½æ›´æ–°ï¼Œå°‡ä»»å‹™æ”¹ç‚º `SUCCESS`ã€‚
                - **è‹¥éŒ¢åŒ…æœªæ‰£æ¬¾**ï¼šè¦–æƒ…æ³é‡è©¦æ‰£æ¬¾æˆ–æ¨™è¨˜å¤±æ•—ã€‚
        - **Step 2 (RPC):** åŒæ­¥å‘¼å« Wallet Service `POST /api/account/balance/transfer`ã€‚
            - Action: `DEDUCT` (æ‰£é™¤å¯ç”¨é¤˜é¡)
            - Amount: `marginDelta`
        - **Step 3 (DB):** è‹¥ Step 1 æˆåŠŸï¼Œé–‹å•Ÿ DB Transactionï¼š
            - æ›´æ–° `positions.leverage = targetLeverage`
            - æ›´æ–° `positions.margin = positions.margin + marginDelta`
            - å¯«å…¥ `position_events` ä¸€ç­†æ§“æ¡¿èª¿æ•´ç´€éŒ„ï¼ˆäº‹ä»¶é¡å‹æ²¿ç”¨ `PositionUpdated`/`MARGIN_ADJUSTED`ï¼‰
            - (Error Handling):** è‹¥ Step 3 DB å¯«å…¥å¤±æ•—ï¼Œç™¼èµ· **è£œå„Ÿè«‹æ±‚** å‘¼å« Wallet Service æŠŠéŒ¢é€€å›ï¼ˆRefundï¼‰ã€‚
    - **åˆ†æ”¯ Bï¼šèª¿é«˜æ§“æ¡¿ (Release Margin, `marginDelta < 0`)**
        - **Step 1 (DB):** é–‹å•Ÿ DB Transactionï¼š
            - æ›´æ–° `positions.leverage = targetLeverage`
            - æ›´æ–° `positions.margin = positions.margin - abs(marginDelta)`
            - **æª¢æŸ¥**ï¼šå†æ¬¡ç¢ºèªæ‰£æ¸›å¾Œçš„ margin ä¸æœƒå°è‡´ç«‹å³çˆ†å€‰ (Double check)ã€‚
            - Position Service åœ¨è‡ªå·±çš„è³‡æ–™åº« `retry_task`  è¡¨å¯«å…¥ä¸€ç­† `PENDING` ç‹€æ…‹çš„ä»»å‹™å–®
              biz_type = å€‰ä½èª¿é«˜æ§“æ¡¿
              biz_key = é›ªèŠ±ID
              payload = step 2 çš„è«‹æ±‚åƒæ•¸
        - **Step 2 (RPC):** è‹¥ Step 1 æˆåŠŸï¼ŒåŒæ­¥å‘¼å« Wallet Serviceã€‚
            - Action: `ADD` (å¢åŠ å¯ç”¨é¤˜é¡)
            - Amount: `abs(marginDelta)`
            - (Error Handling): è‹¥step 2 å¤±æ•—
              å®šæœŸæƒæ `retry_task`  è¡¨ ä¸­ï¼Œ biz_type = å€‰ä½èª¿é«˜æ§“æ¡¿ï¼Œè¶…éä¸€å®šæ™‚é–“ï¼ˆå¦‚ 10 ç§’ï¼‰ä»è™•æ–¼ `PENDING` çš„ä»»å‹™ã€‚ç”±å¾Œå°
              Job ç„¡é™é‡è©¦ç›´åˆ°éŒ¢åŠ çµ¦ç”¨æˆ¶ã€‚**ï¼ˆçµ•å°ä¸èƒ½å›æ»¾ Step 1ï¼Œå¦å‰‡ç”¨æˆ¶å€‰ä½è®Šå±éšªäº†éŒ¢é‚„æ²’é€€å‡ºä¾†ï¼Œæˆ–è€…é€ æˆç³»çµ±å°‘éŒ¢ï¼‰**ã€‚

### `POST /api/account/balance/transfer`

- **Request**:
    - `userId`: string
    - `asset`: enum (`AssetSymbol`ï¼Œèˆ‡å¸³æœ¬/æ’®åˆå…±ç”¨çš„è³‡ç”¢æšèˆ‰)
    - `amount`: decimal (çµ•å°å€¼)
    - `type`: enum (`DEDUCT_TO_POSITION`, `RELEASE_FROM_POSITION`)
    - `refId`: string (å†ªç­‰æ€§ ID)
    - `instrumentId`: string (ç”¨æ–¼å¸³å–®ç´€éŒ„)
- Wallet Service çš„æ‰£æ¬¾æ¥å£å¿…é ˆæ”¯æ´å†ªç­‰æ€§ã€‚å³ä½¿ Position Service é‡å•Ÿå¾Œé‡è¤‡ç™¼é€ç›¸åŒçš„ `request_id` è«‹æ±‚æ‰£æ¬¾ï¼ŒWallet
  Service ä¹Ÿä¸èƒ½é‡è¤‡æ‰£éŒ¢ï¼Œè€Œæ˜¯ç›´æ¥å›å‚³ç•¶å‰çš„æˆåŠŸç‹€æ…‹ã€‚
- **Response**:
    - `success`: boolean
    - `code`: string (e.g., `INSUFFICIENT_BALANCE`)

### `GET` `/api/account/transaction/{refId}`

- ä¾› Position Service çš„ Recovery Job åæŸ¥ä½¿ç”¨ã€‚
- å›å‚³è©²ç­†äº¤æ˜“çš„æœ€çµ‚ç‹€æ…‹ï¼ˆå·²åŸ·è¡Œ / ä¸å­˜åœ¨ï¼‰ã€‚

## äº‹ä»¶: PositionUpdatedï¼ˆæ²¿ç”¨æ—¢æœ‰æ ¼å¼ï¼‰

æ§“æ¡¿/ä¿è­‰é‡‘èª¿æ•´å®Œæˆå¾Œï¼Œæ²¿ç”¨æ¨™æº– `PositionUpdated` äº‹ä»¶ï¼ˆtopic: `positions.updated`ï¼‰
å¦‚éœ€æ¨™è¨»åŸå› ï¼Œå¯åœ¨ metadata/reference æ¬„ä½æ¨™è¨˜ï¼ˆä¾‹ï¼š`referenceType=èª¿é«˜æ§“æ¡¿ or èª¿ä½æ§“æ¡¿`ï¼‰ã€‚

## research

ä¿®æ”¹åˆç´„æ§“æ¡¿ï¼ˆLeverageï¼‰çš„æµç¨‹ï¼Œæœ¬è³ªä¸Šå°±æ˜¯ **é‡æ–°è¨ˆç®—ä¸¦èª¿æ•´ã€Œèµ·å§‹ä¿è­‰é‡‘ï¼ˆInitial Marginï¼‰** çš„éç¨‹ã€‚
å°æ–¼**é€å€‰æ¨¡å¼ï¼ˆIsolated Modeï¼‰ä¾†èªªï¼Œé€™å€‹å‹•ä½œæœƒç›´æ¥å°è‡´è³‡é‡‘åœ¨ã€Œå¯ç”¨é¤˜é¡ã€èˆ‡ã€Œå€‰ä½ä¿è­‰é‡‘ã€ä¹‹é–“æµå‹•ã€‚
ä»¥ä¸‹æˆ‘å°‡å¾**ã€Œæ¥­å‹™é‚è¼¯ï¼ˆäº¤æ˜“è€…è¦–è§’ï¼‰ã€**èˆ‡**ã€Œç³»çµ±åŸ·è¡Œé‚è¼¯ï¼ˆå¾Œç«¯è¦–è§’ï¼‰ã€å…©å€‹å±¤é¢ä¾†è©³ç´°ä»‹ç´¹ã€‚

---

### ä¸€ã€ æ¥­å‹™é‚è¼¯ï¼šèª¿é«˜ vs èª¿ä½

ä¿®æ”¹æ§“æ¡¿ä¸»è¦åˆ†ç‚ºå…©å€‹æ–¹å‘ï¼Œå®ƒå€‘å°è³‡é‡‘çš„è¦æ±‚æˆªç„¶ä¸åŒï¼š

#### 1. èª¿é«˜æ§“æ¡¿ï¼ˆä¾‹å¦‚ 10x â†’ 20xï¼‰

- **æ„ç¾©ï¼š** ä½ å¸Œæœ›ç”¨æ›´å°‘çš„æœ¬é‡‘ä¾†ç¶­æŒåŒæ¨£è¦æ¨¡çš„å€‰ä½ã€‚
- **è³‡é‡‘æµå‘ï¼š** **é‡‹æ”¾ä¿è­‰é‡‘ï¼ˆRelease Marginï¼‰**ã€‚
    - ç³»çµ±æœƒè¨ˆç®—å‡ºå¤šé¤˜çš„ä¿è­‰é‡‘ï¼Œå°‡å…¶å¾ã€Œå€‰ä½ã€é€€å›åˆ°ã€ŒéŒ¢åŒ…å¯ç”¨é¤˜é¡ã€ã€‚
- **é¢¨éšªè®ŠåŒ–ï¼š** å¼·å¹³åƒ¹æ ¼æœƒ**æ›´é è¿‘**ç•¶å‰å¸‚åƒ¹ï¼ˆæ›´å®¹æ˜“çˆ†å€‰ï¼‰ã€‚
- **é™åˆ¶ï¼š**
    - æ–°çš„æ§“æ¡¿å€æ•¸å¿…é ˆç¬¦åˆè©²å¹£ç¨®çš„ã€ŒæŒå€‰åˆ†å±¤é™åˆ¶ã€ï¼ˆPosition Tierï¼‰ã€‚é€šå¸¸æŒå€‰é‡è¶Šå¤§ï¼Œå…è¨±çš„æœ€é«˜æ§“æ¡¿è¶Šä½ã€‚
    - ä¿®æ”¹å¾Œä¸èƒ½å°è‡´ç«‹å³çˆ†å€‰ï¼ˆå³ä¿®æ”¹å¾Œçš„å¼·å¹³åƒ¹ä¸èƒ½ç©¿éç•¶å‰å¸‚åƒ¹ï¼‰ã€‚

#### 2. èª¿ä½æ§“æ¡¿ï¼ˆä¾‹å¦‚ 20x â†’ 10xï¼‰

- **æ„ç¾©ï¼š** ä½ å¸Œæœ›å¢åŠ æŠ•å…¥çš„æœ¬é‡‘ï¼Œè®“å€‰ä½æ›´å®‰å…¨ã€‚
- **è³‡é‡‘æµå‘ï¼š** **è¿½åŠ ä¿è­‰é‡‘ï¼ˆAdd Marginï¼‰**ã€‚
    - ç³»çµ±éœ€è¦å¾ä½ çš„ã€ŒéŒ¢åŒ…å¯ç”¨é¤˜é¡ã€ä¸­æ‰£é™¤è³‡é‡‘ï¼Œé–å®šåˆ°ã€Œå€‰ä½ã€ä¸­ã€‚
- **é¢¨éšªè®ŠåŒ–ï¼š** å¼·å¹³åƒ¹æ ¼æœƒ**é é›¢**ç•¶å‰å¸‚åƒ¹ï¼ˆæ›´ä¸å®¹æ˜“çˆ†å€‰ï¼‰ã€‚
- **é™åˆ¶ï¼š**
    - **éŒ¢åŒ…é¤˜é¡å¿…é ˆè¶³å¤ **æ”¯ä»˜éœ€è¦è¿½åŠ çš„ä¿è­‰é‡‘å·®é¡ã€‚å¦‚æœé¤˜é¡ä¸è¶³ï¼Œä¿®æ”¹æœƒå¤±æ•—ã€‚

---

### äºŒã€ ç³»çµ±åŸ·è¡Œæµç¨‹ï¼ˆBackend Workflowï¼‰

å¦‚æœä½ æ­£åœ¨è¨­è¨ˆäº¤æ˜“ç³»çµ±ï¼Œè™•ç† `ChangeLeverage` è«‹æ±‚çš„æ¨™æº–æµç¨‹å¦‚ä¸‹ï¼š

#### æ¥æ”¶è«‹æ±‚èˆ‡é©—è­‰

å‰ç«¯å‚³å…¥åƒæ•¸ï¼š`{ symbol, positionSide, newLeverage }`

1. **æª¢æŸ¥å€‰ä½æ˜¯å¦å­˜åœ¨ï¼š** ç¢ºèªç”¨æˆ¶ç•¶å‰æŒæœ‰è©²åˆç´„çš„å€‰ä½ã€‚
2. **æª¢æŸ¥æœ€å¤§æ§“æ¡¿é™åˆ¶ï¼š** æ ¹æ“šç•¶å‰ã€ŒæŒå€‰åç¾©åƒ¹å€¼ï¼ˆNotional Valueï¼‰ã€ï¼ŒæŸ¥è©¢é¢¨éšªé™é¡è¡¨ï¼ˆRisk Limit Tableï¼‰ï¼Œç¢ºèª `newLeverage`
   æ˜¯å¦åˆæ³•ã€‚
    - _ä¾‹å¦‚ï¼šæŒå€‰ 100 è¬ USDT çš„ BTCï¼Œå¯èƒ½äº¤æ˜“æ‰€è¦å®šæœ€é«˜åªèƒ½é–‹ 50xï¼Œç”¨æˆ¶è‹¥è«‹æ±‚ 100x å‰‡æ‹’çµ•ã€‚

#### è©¦ç®—ä¿è­‰é‡‘è®ŠåŒ– (Pre-calculation)

ç³»çµ±éœ€è¨ˆç®—åˆ‡æ›æ§“æ¡¿å¾Œçš„**æ–°ä¿è­‰é‡‘éœ€æ±‚**ï¼š

- **èˆŠä¿è­‰é‡‘** = æŒå€‰æ•¸é‡ Ã— èˆŠå–®ä½ä¿è­‰é‡‘
- **æ–°ä¿è­‰é‡‘** = æŒå€‰æ•¸é‡ Ã— (é–‹å€‰å‡åƒ¹ / newLeverage)
- **å·®é¡ (Delta)** = æ–°ä¿è­‰é‡‘ - èˆŠä¿è­‰é‡‘

#### **é‡æ–°è¨ˆç®—å¼·å¹³åƒ¹**

- ä½¿ç”¨ä½ å‰›æ‰æä¾›çš„å…¬å¼ï¼Œå¸¶å…¥æ–°çš„ `marginPerUnit` é‡æ–°è¨ˆç®— `Liquidation Price` ä¸¦å¯«å…¥è³‡æ–™åº«ã€‚

#### è³‡é‡‘æª¢æŸ¥ (Check Balance)

- **å¦‚æœ Delta > 0ï¼ˆèª¿ä½æ§“æ¡¿ï¼Œéœ€è£œéŒ¢ï¼‰ï¼š**
    - æª¢æŸ¥ `User_Available_Balance >= Delta`ï¼Ÿ
    - è‹¥ä¸è¶³ï¼Œæ‹‹å‡ºéŒ¯èª¤ `Insufficient Balance`ã€‚
- **å¦‚æœ Delta < 0ï¼ˆèª¿é«˜æ§“æ¡¿ï¼Œé€€éŒ¢ï¼‰ï¼š**
    - é€šå¸¸ç„¡è³‡é‡‘æª¢æŸ¥é™åˆ¶ï¼Œç›´æ¥é€šéã€‚

#### åŸ·è¡ŒåŸå­æ“ä½œ (Atomic Execution)

é€™ä¸€æ­¥å¿…é ˆåœ¨è³‡æ–™åº«äº¤æ˜“ï¼ˆTransactionï¼‰æˆ–å…§å­˜æ’®åˆå¼•æ“ä¸­åŸå­æ€§åœ°åŸ·è¡Œï¼š

1. **æ›´æ–°å€‰ä½ä¿¡æ¯ï¼š** å°‡å€‰ä½çš„ `leverage` æ¬„ä½æ›´æ–°ç‚º `newLeverage`ã€‚
2. **æ›´æ–°å€‰ä½ä¿è­‰é‡‘ï¼š** å°‡å€‰ä½çš„ `margin` æ›´æ–°ç‚º `æ–°ä¿è­‰é‡‘`ã€‚
3. **æ›´æ–°éŒ¢åŒ…é¤˜é¡ï¼š**
    - è‹¥éœ€è£œéŒ¢ï¼š`Wallet_Balance` æ‰£é™¤ `Delta`ã€‚
    - è‹¥é€€éŒ¢ï¼š`Wallet_Balance` å¢åŠ  `abs(Delta)`ã€‚

#### é¢¨éšªæª¢æŸ¥ (Post-Check, Optional but Recommended)

- åœ¨æäº¤ä¿®æ”¹å‰ï¼Œç³»çµ±é€šå¸¸æœƒè©¦ç®—æ–°çš„å¼·å¹³åƒ¹ã€‚
- å¦‚æœ `æ–°å¼·å¹³åƒ¹` å·²ç¶“è¢«ç•¶å‰ `Mark Price`ï¼ˆæ¨™è¨˜åƒ¹æ ¼ï¼‰è§¸ç™¼ï¼Œå‰‡**ç¦æ­¢ä¿®æ”¹**ã€‚
    - _åŸå› ï¼šä¸èƒ½è®“ç”¨æˆ¶ä¿®æ”¹æ§“æ¡¿å¾Œç¬é–“çˆ†å€‰ï¼Œé€™æœƒå°è‡´ç³»çµ±ç”¢ç”Ÿå£å¸³æˆ–ç”¨æˆ¶çˆ­è­°ã€‚_

### race condition

- æ³¨æ„ï¼šåˆ†æ•£å¼äº‹å‹™ï¼Œå¿…é ˆå…ˆæ‰£éŒ¢å†è½‰å¸³ã€‚ä»¥åŠè£œå„Ÿæ©Ÿåˆ¶ã€‚

# ä¸‹å–®åŠçµç®—

## `POST /api/orders`

- è«‹æ±‚: ç”¨æˆ¶  `POST /api/orders` (instrument_id, side, type, price, quantity)
- ä»¥ `CREATED` ç‹€æ…‹å¯«å…¥ ordersï¼Œä¸¦ç´€éŒ„ `intent`
- èª¿ç”¨  `/api/positions/intent/reserve`
    - å–å¾—:  `PositionIntentType`ï¼š`INCREASE`ï¼ˆç´”é–‹å€‰ï¼‰ã€`REDUCE`ï¼ˆéƒ¨åˆ†å¹³å€‰ï¼‰ã€`CLOSE`ï¼ˆå…¨éƒ¨å¹³å€‰ï¼‰ã€‚
    - è‹¥ç‚ºå¹³å€‰ï¼Œé–å®šå¹³å€‰æ•¸é‡ï¼ˆé å‡çµå€‰ä½ï¼‰ï¼Œè‹¥å‡çµå¤±æ•—ï¼Œç‹€æ…‹æ”¹ç‚º `rejected`ï¼Œç´€éŒ„ rejected_reasonã€‚
    - ä½µç™¼æƒ…å¢ƒ:
        - æƒ…å¢ƒ Aï¼šåˆ¤æ–·ç‚ºåŠ å€‰ (INCREASE) â†’ å¯¦éš›è®Šæˆ å¹³å€‰ (REDUCE) ã€å®‰å…¨ã€‘
            - **ç‹€æ…‹**ï¼šç”¨æˆ¶æŒæœ‰ `+10 ETH` (å¤šå–®)ã€‚
            - **å‹•ä½œ**ï¼šç”¨æˆ¶ä¸‹å–® `è²·å…¥ +5 ETH`ã€‚
            - **Intent åˆ¤æ–·**ï¼šç³»çµ±èªç‚ºé€™æ˜¯ **åŠ å€‰ (INCREASE)**ã€‚
            - **è³‡é‡‘å‡çµ**ï¼šå› ç‚ºæ˜¯åŠ å€‰ï¼ŒRisk å¼•æ“**å‡çµäº† 5 ETH çš„ä¿è­‰é‡‘**ã€‚
            - **ä¸¦ç™¼äº‹ä»¶ (The Flip)**ï¼šåœ¨è²·å–®æˆäº¤å‰ï¼Œå¦ä¸€ç­†å¸‚åƒ¹è³£å–® `è³£å‡º -20 ETH` å…ˆæˆäº¤äº†ã€‚
                - å€‰ä½è®Šç‚º `-10 ETH` (ç©ºå–®)ã€‚
            - **çµæœ**ï¼šåŸæœ¬çš„ `è²·å…¥ +5 ETH` çµ‚æ–¼æˆäº¤äº†ã€‚
                - å› ç‚ºç¾åœ¨å€‰ä½æ˜¯ç©ºå–®ï¼Œé€™ç­†è²·å–®å¯¦éš›ä¸Šè®Šæˆäº† **å¹³ç©ºå€‰ (REDUCE)**ã€‚
            - **ç³»çµ±å½±éŸ¿**ï¼š
                - **è³‡é‡‘**ï¼šä½ é å…ˆå‡çµäº†ä¿è­‰é‡‘ï¼ˆç•¶ä½œé–‹å€‰ï¼‰ï¼Œçµæœç™¼ç¾æ˜¯å¹³å€‰ï¼ˆåè€Œé‡‹æ”¾ä¿è­‰é‡‘ï¼‰ã€‚*
                  *é€™å°ç³»çµ±æ˜¯å®‰å…¨çš„ï¼ˆOver-collateralizedï¼Œè¶…é¡æŠµæŠ¼ï¼‰**ã€‚ä½ åªæ˜¯æš«æ™‚å¤šå‡çµäº†éŒ¢ï¼Œçµç®—æ™‚æŠŠéŒ¢é€€å›çµ¦
                  `Spot Available` å³å¯ã€‚
                - **é‚è¼¯**ï¼šLedger æ”¶åˆ°æˆäº¤ï¼Œé›–ç„¶ Order æ¨™è¨˜ç‚º INCREASEï¼Œä½† Position ç™¼ç¾æ˜¯å¹³å€‰ï¼Œæœƒç™¼å‡º
                  `PositionMarginReleased`ï¼ŒLedger åŸ·è¡Œé€€æ¬¾ã€‚
            - **çµè«–ï¼š
                - é€™ç¨®æƒ…æ³é›–ç„¶é‚è¼¯è®Šäº†ï¼Œä½†è³‡é‡‘æ˜¯å®‰å…¨çš„ï¼Œä¸éœ€è¦é¡å¤–å­—æ®µå»æ“‹ã€‚**
                - ä½†æ˜¯ flip éœ€è¦å°å¿ƒè™•ç†é€™å€‹å ´æ™¯å•é¡Œ -> [[#Flip å ´æ™¯]]
        - æƒ…å¢ƒ Bï¼šåˆ¤æ–·ç‚ºå¹³å€‰ (REDUCE) â†’ å¯¦éš›è®Šæˆ åŠ å€‰ (INCREASE)
            - **ç‹€æ…‹**ï¼šç”¨æˆ¶æŒæœ‰ `+10 ETH` (å¤šå–®)ã€‚
            - **å‹•ä½œ**ï¼šç”¨æˆ¶ä¸‹å–® `è³£å‡º -5 ETH`ã€‚
            - **Intent åˆ¤æ–·**ï¼šç³»çµ±èªç‚ºé€™æ˜¯ **å¹³å€‰ (REDUCE)**ã€‚
            - **è³‡é‡‘å‡çµ**ï¼šå› ç‚ºæ˜¯å¹³å€‰ï¼Œ**ä¸å‡çµä¿è­‰é‡‘**ã€‚
            - **ä¸¦ç™¼äº‹ä»¶ (The Flip)**ï¼šåœ¨è³£å–®æˆäº¤å‰ï¼Œå¦ä¸€ç­†å¸‚åƒ¹è³£å–® `è³£å‡º -10 ETH` å…ˆæˆäº¤äº†ã€‚
                - å€‰ä½è®Šç‚º `0`ã€‚
            - **çµæœ**ï¼šåŸæœ¬çš„ `è³£å‡º -5 ETH` çµ‚æ–¼æˆäº¤äº†ã€‚
                - å› ç‚ºå€‰ä½å·²æ­¸é›¶ï¼Œé€™ç­†è³£å–®è®Šæˆäº† **é–‹ç©ºå€‰ (INCREASE)**ã€‚
            - **ç³»çµ±å½±éŸ¿**ï¼š
                - **è³‡é‡‘**ï¼š**åš´é‡å•é¡Œï¼** ä½ ç•¶åˆä»¥ç‚ºæ˜¯å¹³å€‰ï¼Œæ‰€ä»¥**æ²’å‡çµä¿è­‰é‡‘**ã€‚ç¾åœ¨è®Šæˆäº†é–‹å€‰ï¼Œç”¨æˆ¶å¸³æˆ¶è£¡å¯èƒ½æ ¹æœ¬æ²’éŒ¢ï¼é€™æœƒå°è‡´
                  **ç©¿å€‰**ã€‚

> 			- **è§£æ³•: é–å®šå¹³å€‰æ•¸é‡**

- **é¢¨æ§é æª¢**: Order Svc å‘¼å«  `/api/risk/orders/precheck`ï¼Œ
    - è‹¥æ˜¯é–‹å€‰ï¼Œè¨ˆç®— requiredMargin èˆ‡ feeï¼Œfee å…ˆä»¥ Taker fee é æ”¶ã€‚æˆäº¤å¾Œå†é€€å·®åƒ¹ã€‚
    - è‹¥æ”¶åˆ° é¢¨æ§æ‹’çµ• ç‹€æ…‹æ”¹ç‚º `rejected`ï¼Œç´€éŒ„ rejected_reasonã€‚
- è‹¥ **Intent = INCREASE**
  é–‹å€‰æµç¨‹:
    - **è³‡é‡‘å‡çµ**:
        - å°‡ç‹€æ…‹æ”¹ç‚º `FREEZING_MARGIN` ä¸¦ç™¼å¸ƒ `FundsFreezeRequested`ï¼Œå…§å« requiredMargin èˆ‡ feeã€‚
        - Ledger Svc æ¶ˆè²»ä¸¦åŸ·è¡Œï¼š`DEBIT Spot Reserved` -> `CREDIT Spot Available`ã€‚
          æˆåŠŸç™¼å¸ƒ `FundsFrozen`ï¼Œå¤±æ•—ç™¼å¸ƒ `FundsFreezeFailed`ã€‚
        - Order Svc æ”¶åˆ° `FundsFrozen`ï¼Œå°‡ç‹€æ…‹æ”¹ç‚º `NEW`ï¼Œç´€éŒ„ submitted_atï¼Œç™¼å¸ƒ `OrderCreated` çµ¦ Matching Svcã€‚
          è‹¥æ”¶åˆ° `FundsFreezeFailed` ç‹€æ…‹æ”¹ç‚º `rejected`ï¼Œç´€éŒ„ rejected_reasonã€‚
    - **æ’®åˆ**:
        - Matching æ¶ˆè²» `OrderCreated` ï¼Œæ’®åˆæˆåŠŸï¼Œç™¼å¸ƒ `TradeExecuted`ã€‚
    - **çµç®— (ç•°æ­¥)**:
        - Ledger Svc æ¶ˆè²» `TradeExecuted`
        - Positions Svc æ¶ˆè²» `TradeMarginSettled` äº‹ä»¶
            - è‹¥é‡åˆ° flipï¼Œåˆ‡åˆ†ç‚ºå¹³å€‰å†åå‘é–‹å€‰ï¼Œå¹³å€‰å°‡è§¸ç™¼ Ledger é‡‹æ”¾ä¿è­‰é‡‘
        - Order Svc æ¶ˆè²» `TradeExecuted`
- è‹¥ Intent = REDUCEã€CLOSE
  å¹³å€‰æµç¨‹:
    - **å€‰ä½é–å®š**:
        - Order Svc è¨˜éŒ„ submitted_atï¼Œå°‡ç‹€æ…‹æ”¹ç‚º `NEW`ï¼Œç™¼å¸ƒ `OrderCreated` çµ¦ Matching Svcã€‚
    - **æ’®åˆ**:
        - Matching æ¶ˆè²» `OrderCreated` ï¼Œæ’®åˆæˆåŠŸï¼Œç™¼å¸ƒ `TradeExecuted`ã€‚
    - **çµç®— (ç•°æ­¥)**:
        - Positions Svc æ¶ˆè²» `TradeExecuted`
        - Ledger Svc æ¶ˆè²» `PositionMarginReleased`
        - Order Svc æ¶ˆè²» `TradeExecuted`:
- åæ‰‹æµç¨‹ (The Flip - å–®å‘æŒå€‰ç‰¹æœ‰)  [ä¸å¯¦ä½œ]
  å ´æ™¯: æŒæœ‰ 10 å¤šå–®ï¼Œè³£å‡º 15 ç©ºå–® (å¹³ 10 é–‹ 5)

## POST `/api/risk/orders/precheck`

- **Endpoint**ï¼š`POST /api/risk/orders/precheck`
- **Request**ï¼š
    - `userId`, `instrumentId`
    - `side`: BUY/SELL
    - `type`: LIMIT/MARKET
    - `price`
    - `quantity`
    - `intent`: INCREASE / REDUCE / CLOSE
    - `positionSnapshot`: leverage, margin, quantity, markPrice, unrealizedPnl
- **Response**ï¼š
    - `allow`: boolean
    - `requiredMargin`: decimalï¼ˆæœ¬æ¬¡å§”è¨—éœ€é æ‰£çš„ä¿è­‰é‡‘ï¼‰
    - `fee`: decimalï¼ˆé æ”¶æ‰‹çºŒè²»ï¼Œé è¨­ä»¥ taker è¨ˆç®—ï¼‰
    - `reason`: stringï¼ˆæ‹’çµ•æ™‚è¿”å›ï¼‰
- **è™•ç†é‚è¼¯**ï¼š
    1. **åŸºç¤é©—è­‰**ï¼šæª¢æŸ¥ Instrument ç‹€æ…‹ã€Risk Limitï¼ˆMax Leverage, Max Order Valueï¼‰ã€‚
    2. **åç¾©åƒ¹å€¼è¨ˆç®—**ï¼š`order_notional = price * quantity * contract_size`ã€‚
    3. **æ„åœ–åˆ¤æ–·**ï¼š
        - **INCREASE (åŠ å€‰/é–‹å€‰)**ï¼š
            - `requiredMargin = max(order_notional / leverage, order_notional * initial_margin_rate)`ã€‚
            - `simulated_notional = current_notional + order_notional`ã€‚
        - **REDUCE / CLOSE (æ¸›å€‰/å¹³å€‰)**ï¼š
            - `requiredMargin = 0`ã€‚
            - `simulated_notional = max(0, current_notional - order_notional)`ã€‚
    4. **è²»ç”¨è¨ˆç®—**ï¼š`fee = order_notional * taker_fee_rate`ã€‚
    5. **æ¨¡æ“¬å¼·å¹³é¢¨éšª (Pre-liquidation Check)**ï¼š
        - `current_equity = margin + unrealized_pnl`ã€‚
        - `simulated_equity = current_equity + requiredMargin - fee`ã€‚
        - `simulated_margin_ratio = simulated_equity / simulated_notional`ã€‚
        - è‹¥ `simulated_margin_ratio < maintenance_margin_rate`ï¼Œå‰‡æ‹’çµ•ï¼ˆ`allow=false`, reason="Insufficient margin..."ï¼‰ã€‚
    6. å›å‚³ `requiredMargin` èˆ‡ `fee` ä¾› Order æœå‹™å‡çµè³‡é‡‘ã€‚

## position æ¶ˆè²» `TradeMarginSettled`ã€`TradeExecuted`

- æŸ¥æ‰¾æˆ–å»ºç«‹å€‰ä½:
    * æ ¹æ“šäº‹ä»¶ä¸­çš„ `userId`, `instrument_id` (äº¤æ˜“å°) å’Œ `side` (æ–¹å‘ï¼Œå¤š/ç©º)ï¼ŒæŸ¥æ‰¾å°æ‡‰çš„ç¾æœ‰å€‰ä½ã€‚
    * å¦‚æœå€‰ä½ä¸å­˜åœ¨ (å³ç‚ºé–‹å€‰äº¤æ˜“)ï¼Œå‰‡å»ºç«‹ä¸€ç­†æ–°çš„å€‰ä½ç´€éŒ„ã€‚

* é‚è¼¯åˆ†æ”¯
    * è‹¥æ¶ˆè²» `TradeMarginSettled`
        * å†ªç­‰æ€§æ•ˆé©—
        * `quantity` `=` `èˆŠæ•¸é‡` `+` `æœ¬æ¬¡é–‹å€‰æ•¸é‡`
        * `entry_price` `=` `(èˆŠé–‹å€‰åƒ¹` `*` `èˆŠæ•¸é‡` `+` `æœ¬æ¬¡æˆäº¤åƒ¹` `*` `æœ¬æ¬¡æˆäº¤æ•¸é‡)` `/` `æ–°æ•¸é‡`
        * æ›´æ–° `margin = èˆŠ magin + æ–°å¢é€å€‰ä¿è­‰é‡‘é¡ `
        * ç´¯ç© cum_fee
        * ç´¯ç© cum_realized_pnl (æ‰£é™¤æœ¬æ¬¡é–‹å€‰æ‰‹çºŒè²»)
        * è‹¥é‡åˆ° flipï¼Œåˆ‡åˆ†ç‚ºå¹³å€‰å†åå‘é–‹å€‰ï¼Œå¹³å€‰å°‡è§¸ç™¼ Ledger é‡‹æ”¾ä¿è­‰é‡‘

    * è‹¥æ¶ˆè²» `TradeExecuted
        * å†ªç­‰æ€§æ•ˆé©—
        * `quantity` `=` `èˆŠæ•¸é‡` `-` `æœ¬æ¬¡å¹³å€‰æ•¸é‡`
        * closing_reserved_quantity çš„æ•¸é‡è‹¥è¶³å¤ ï¼Œå°±å°‡ quantity èˆ‡ closing_reserved_quantity éƒ½æ‰£é™¤å¹³å€‰æ•¸é‡
          æª¢æŸ¥è‹¥å€‰ä½æ•¸é‡ç‚º0 ï¼Œå°‡è©²å€‰ä½ç‹€æ…‹æ›´æ–°ç‚º CLOSEDã€‚
        * æ›´æ–° `margin = èˆŠ magin / èˆŠæ•¸é‡ * quantity`ï¼Œå°‡æ¸›å°‘çš„ä¿è­‰é‡‘è¨˜ä¸‹ä¾†ï¼Œç™¼å‡ºäº‹ä»¶çµ¦ Ledger è®“å…¶æ‰£é™¤å€‰ä½ä¿è­‰é‡‘
        * è¨ˆç®— `Realized PnL`
          å·²å¯¦ç¾ç›ˆè™§ = (å¹³å€‰æˆäº¤åƒ¹ - å¹³å‡é–‹å€‰åƒ¹) Ã— å¹³å€‰æ•¸é‡ Ã— åˆç´„é¢å€¼ï¼ˆä¾å¤šç©ºæ±ºå®šæ­£è² ï¼‰
        * ç´¯ç© cum_realized_pnl (æ‰£é™¤æœ¬æ¬¡å¹³å€‰æ‰‹çºŒè²»)
        * ç´¯ç© cum_fee

- è¨ˆç®—`æœªå¯¦ç¾ç›ˆè™§` `(Unrealized` `PNL)ã€margin_ratio`:
    * å¾æœ¬åœ° `MarkPriceCache` ä¸­è®€å–æœ€æ–°çš„æ¨™è¨˜åƒ¹æ ¼ (`Mark Price`) (è©²åƒ¹æ ¼ç”± `MarkPriceUpdated` äº‹ä»¶æ›´æ–°)ã€‚
    * è‹¥æš«ç„¡è³‡æ–™å‰‡ä¿ç•™ä¸Šä¸€ç­†æ¨™è¨˜åƒ¹ï¼Œå‰‡ä¸è™•ç†ï¼Œè·³éä»¥ä¸‹è¨ˆç®—ï¼Œå¾…äº‹ä»¶æŠµé”æ™‚å†åˆ·æ–°ã€‚
    * æ›´æ–°mark_price
    * `æœªå¯¦ç¾ç›ˆè™§` `=` `(æ¨™è¨˜åƒ¹æ ¼` `-` `æ–°å¹³å‡é–‹å€‰åƒ¹)` `*` `æ–°æ•¸é‡` `*` `åˆç´„é¢å€¼`
    * è¨ˆç®—`margin_ratio`ï¼š
      `margin_ratio = (equity / market_notional) = (margin + unrealized_pnl ) / (mark_price * quantity * contract_size)`
- é‡æ–°è¨ˆç®—å¼·å¹³åƒ¹ (`Liquidation` `Price`): æ ¹æ“šæ›´æ–°å¾Œçš„å€‰ä½ã€æ§“æ¡¿å’Œä¿è­‰é‡‘ç‡ï¼Œé‡æ–°è¨ˆç®—å¼·å¹³åƒ¹æ ¼ã€‚
    - æ¯å–®ä½ä¿è­‰é‡‘é‡‘é¡ï¼šmarginPerUnit = isolatedMarginAmount / (positionQuantity * contract_size)
    - å¤šå–®é€å€‰å€‰ä½çš„å¼·å¹³åƒ¹æ ¼ï¼šliquidationPrice_Long = (entryPrice - marginPerUnit) / (1 - maintenanceMarginRate)
    - ç©ºå–®å¼·å¹³åƒ¹æ ¼å…¬å¼ï¼šliquidationPrice_Short = (entryPrice + marginPerUnit) / (1 + maintenanceMarginRate)
- æŒä¹…åŒ–å„²å­˜:
    * å°‡æ›´æ–°å¾Œçš„å€‰ä½è³‡è¨Š (æ•¸é‡ã€å‡åƒ¹ã€æœªå¯¦ç¾ç›ˆè™§ç­‰) å„²å­˜åˆ° `positions` è³‡æ–™è¡¨ä¸­ã€‚
    * åœ¨ `position_events` è¡¨ä¸­æ–°å¢ä¸€ç­†äº‹ä»¶ç´€éŒ„ï¼Œç”¨æ–¼å¯©è¨ˆå’Œè¿½è¹¤ã€‚
- ç™¼å¸ƒ `PositionUpdated` äº‹ä»¶: å€‰ä½ç‹€æ…‹æ›´æ–°å¾Œï¼Œç™¼å¸ƒ PositionUpdated äº‹ä»¶ï¼Œ

## account æ¶ˆè²» `TradeExecuted`ã€`PositionMarginReleased`

## order æ¶ˆè²» `TradeExecuted`

Order æœå‹™éœ€è¦æ¶ˆè²» Matching å¼•æ“ç™¼å¸ƒçš„ `TradeExecuted` äº‹ä»¶ï¼Œä»¥æ›´æ–°è¨‚å–®çš„æˆäº¤ç‹€æ…‹ã€ç´¯è¨ˆæˆäº¤é‡ã€å¹³å‡æˆäº¤åƒ¹æ ¼å’Œæ‰‹çºŒè²»ç­‰é—œéµæ¬„ä½ã€‚

### æ›´æ–°é‚è¼¯

**1. è¨‚å–®ç‹€æ…‹è½‰æ›**

```
NEW â†’ PARTIALLY_FILLED â†’ FILLED
        â†˜                â†—
          (å¤šæ¬¡éƒ¨åˆ†æˆäº¤)
```

**2. ç´¯è¨ˆæˆäº¤é‡è¨ˆç®—**

```java
order.filled_quantity +=trade.quantity;
order.remaining_quantity =order.quantity -order.filled_quantity;
```

**3. å¹³å‡æˆäº¤åƒ¹æ ¼è¨ˆç®—ï¼ˆåŠ æ¬Šå¹³å‡ï¼‰**

```java
// ç´¯è¨ˆæˆäº¤ç¸½é‡‘é¡
total_value +=(trade.price *trade.quantity);
// è¨ˆç®—åŠ æ¬Šå¹³å‡åƒ¹æ ¼
order.avg_fill_price =total_value /order.filled_quantity;
```

**4. æ‰‹çºŒè²»ç´¯è¨ˆ**

```java
order.fee +=trade.fee;
```

### å†ªç­‰æ€§ä¿è­‰

ç‚ºé¿å…é‡è¤‡æ¶ˆè²»å°è‡´æ•¸æ“šéŒ¯èª¤ï¼ŒOrder æœå‹™æ‡‰ï¼š

1. **æª¢æŸ¥ trade_id**: åœ¨ `order_events` è¡¨ä¸­è¨˜éŒ„å·²è™•ç†çš„ `trade_id`
   ```sql
   SELECT COUNT(*) FROM order_events
   WHERE order_id = ? AND reference_id = ?  -- reference_id å­˜ trade_id
   ```

2. **ä½¿ç”¨æ¨‚è§€é–**: é€šé `version` æ¬„ä½æˆ– `updated_at` ç¢ºä¿ä¸¦ç™¼å®‰å…¨
   ```sql
   UPDATE orders
   SET filled_quantity = ?, avg_fill_price = ?, fee = ?, version = version + 1
   WHERE order_id = ? AND version = ?  -- æ¨‚è§€é–
   ```

3. **äº‹å‹™æ€§å¯«å…¥**: è¨‚å–®æ›´æ–° + äº‹ä»¶è¨˜éŒ„å¿…é ˆåœ¨åŒä¸€äº‹å‹™ä¸­å®Œæˆ
   ```java
   @Transactional
   public void handleTradeExecuted(TradeExecutedEvent event) {
       // 1. å†ªç­‰æ€§æª¢æŸ¥
       if (isTradeAlreadyProcessed(event.getTradeId())) {
           return;
       }

       // 2. æ›´æ–°è¨‚å–®ç‹€æ…‹
       Order order = orderRepository.findById(event.getOrderId());
       order.applyTrade(event);
       orderRepository.save(order);

       // 3. è¨˜éŒ„äº‹ä»¶
       orderEventRepository.save(new OrderEvent(
           event.getOrderId(),
           order.isFilled() ? "ORDER_FILLED" : "ORDER_PARTIALLY_FILLED",
           event.getTradeId(),
           event.getOccurredAt()
       ));
   }
   ```

## Flip å ´æ™¯

åˆç´„äº¤æ˜“æ‰€ï¼Œ
è¦å¦‚ä½•é¿å…äºŒå€‹é–‹å€‰å§”è¨—ï¼Œä¸€å€‹BUY 5å¼µ ä¸€å€‹SELL 10å¼µï¼ŒBUY 5å¼µæˆäº¤äº†ï¼Œé€™æ™‚ç”¨æˆ¶åˆä¸‹äº†ä¸‰å¼µå¹³å€‰å–®ï¼Œé æ‰£äº†ä¸‰å¼µçš„å€‰ä½ï¼ŒSELL 10å¼µ
æœ€å¾Œæˆäº¤ï¼Œç™¼ç”Ÿå€‰ä½åè½‰ï¼Œé€™æ™‚å€‰ä½è¦å…ˆCLOSEï¼Œå†åå‘é–‹å€‰ï¼Œä½†æ˜¯CLOSE çš„å€‰ä½æœ‰ä¸‰å¼µçš„é ç•™ï¼Œæ²’è¾¦æ³•CLOSEã€‚ é€™å€‹å ´æ™¯è©²å¦‚ä½•è™•ç†?

#### æ¡ç”¨ã€Œæ·¨å€‰ä½ã€ç®¡ç†ï¼ˆNetting Modeï¼‰âŒ

å¦‚æœæ˜¯æ¨™æº–çš„åå‘é–‹å€‰é‚è¼¯ï¼ˆå³ä¸æ”¯æ´åŒæ™‚æŒæœ‰å¤šç©ºé›™å‘ï¼‰ï¼Œ
å»ºè­°åœ¨"æ’®åˆå¼•æ“"åº•å±¤å¯¦æ–½ä»¥ä¸‹è¦å‰‡ï¼š

##### è¦å‰‡ï¼šé–‹å€‰å§”è¨—èˆ‡å¹³å€‰å§”è¨—çš„äº’æ–¥

ç•¶ SELL 10 å¼µæˆäº¤æ™‚ï¼Œç³»çµ±æ‡‰æª¢æŸ¥ç•¶å‰æ˜¯å¦æœ‰é‡å°è©²æ–¹å‘çš„åå‘æ›å–®ã€‚

- **è‡ªå‹•é‡‹æ”¾é¡åº¦ï¼š** å¦‚æœ SELL 10 çš„ç›®çš„æ˜¯ç‚ºäº†åè½‰å€‰ä½ï¼Œç³»çµ±æ‡‰å…·å‚™ã€Œè¨‚å–®è¦†è“‹ã€é‚è¼¯ã€‚
- **é‚è¼¯æµï¼š**
    - SELL 10 æˆäº¤ â†’ è§¸ç™¼å¹³å€‰ç¨‹åºã€‚
    - æª¢æŸ¥ç™¼ç¾ BUY 5 è¢«å¹³å€‰æ›å–®é–å®šäº† 3 å¼µã€‚
    - ç³»çµ±è‡ªå‹•**å¤±æ•ˆï¼ˆInvalidateï¼‰**é‚£ 3 å¼µå¹³å€‰å–®ï¼ˆå› ç‚ºåŸæœ¬è¦å¹³çš„å°è±¡å³å°‡è¢«é€™ç­† SELL å¤§å–®ã€Œåƒæ‰ã€äº†ï¼‰ã€‚
    - é‡‹æ”¾é–å®šï¼Œé †åˆ©å®Œæˆã€Œå¹³ 5 é–‹ 5ã€ã€‚
- æˆ‘ï¼š é€™ä¸€æ­¥æ²’æœ‰è¾¦æ³•åšåˆ° å› ç‚ºæ’®åˆè·Ÿ å€‰ä½äºŒå€‹æœå‹™æ˜¯åˆ†é–‹çš„ï¼Œé€éKAFKA ç™¼å¸ƒå¼äº‹å‹™ï¼Œè¦å€‰ä½æœå‹™æ¥é“æˆäº¤ä¿¡æ¯ï¼Œæ‰èƒ½çŸ¥é“ç™¼ç”ŸFLIPã€‚

---

#### å§”è¨—å±¤ç´šçš„ã€Œåªæ¸›å€‰ï¼ˆReduce-Onlyï¼‰ã€æ¨™ç±¤ âŒ

é€™æ˜¯ç›®å‰ä¸»æµäº¤æ˜“æ‰€ï¼ˆå¦‚ Binance, OKXï¼‰æœ€æ™®éçš„åšæ³•ã€‚

- **å®šç¾©ï¼š** è¦æ±‚ç”¨æˆ¶åœ¨ä¸‹å¹³å€‰å–®æ™‚ï¼Œå¿…é ˆå‹¾é¸ **Reduce-Only**ã€‚
- **è™•ç†é€»è¾‘ï¼š**
    - **Reduce-Only è¨‚å–®ä¸å…è¨±å¢åŠ å€‰ä½ã€‚**
    - ç•¶ SELL 10 å¼µï¼ˆé–‹å€‰å–®ï¼‰æˆäº¤ä¸¦å°è‡´å€‰ä½åè½‰ç‚º SELL 5 æ™‚ï¼Œç³»çµ±æœƒ**è‡ªå‹•æª¢ç´¢**è©²å¹£å°ä¸‹æ‰€æœ‰çš„ã€Œè²·å…¥å¹³å€‰ï¼ˆBUY
      Closeï¼‰ã€Reduce-Only æ›å–®ã€‚
    - **è‡ªå‹•æ’¤å–®ï¼š** ç”±æ–¼å€‰ä½å·²ç¶“è®Šæˆ SELLï¼ŒåŸæœ¬ç”¨ä¾†å¹³æ‰ BUY å€‰ä½çš„æ›å–®ï¼ˆé‚£ 3 å¼µï¼‰å·²ç¶“å¤±å»äº†ã€Œæ¸›å€‰ã€çš„æ„ç¾©ï¼ˆåè€Œæœƒè®Šæˆå¢å€‰ï¼‰ï¼Œç³»çµ±æœƒæ ¹æ“šè¦å‰‡
      **è‡ªå‹•æ’¤éŠ·**é€™äº›ä¸ç¬¦åˆ Reduce-Only æ¢ä»¶çš„å–®å­ã€‚
- æˆ‘ï¼š ä¸€æ¨£æœ‰ä½µç™¼ æˆäº¤æ™‚é–“å·®å•é¡Œ

#### æ¡ç”¨ã€Œé›™å‘ç¨ç«‹é¡åº¦ã€èˆ‡ã€Œè‡ªå‹•ç¸®é‡ã€æ©Ÿåˆ¶ âœ”ï¸

å¦‚æœæ’®åˆå¼•æ“èˆ‡å€‰ä½æœå‹™åˆ†é–‹å¤ªé ï¼Œç„¡æ³•å…±äº«å…§å­˜ï¼Œå¦ä¸€ç¨®åšæ³•æ˜¯**ã€Œæˆäº¤æ™‚ä¿®æ­£ã€**ï¼š

ç•¶ SELL 10 æˆäº¤ä¸¦ç™¼é€ Kafka è¨Šæ¯çµ¦å€‰ä½æœå‹™å¾Œï¼Œå€‰ä½æœå‹™æœƒç™¼ç¾ï¼š

- **ç‹€æ…‹ Aï¼š** SELL 10 æˆäº¤ï¼ˆæ‡‰å°è‡´å€‰ä½ç¿»è½‰ç‚º SELL 5ï¼‰ã€‚
- **ç‹€æ…‹ Bï¼š** é‚£ 3 å¼µå¹³å€‰å–®ç«Ÿç„¶ä¹Ÿæˆäº¤äº†ï¼ˆKafka ç¨å¾Œå‚³ä¾† 3 å¼µå–®æˆäº¤çš„æ¶ˆæ¯ï¼‰ã€‚

**æ­¤æ™‚ç³»çµ±çš„ã€Œå¸³å‹™è£œå„Ÿã€é‚è¼¯ï¼š** åœ¨ Netting æ¨¡å¼ä¸‹ï¼Œé€™ 3 å¼µå–®é›–ç„¶ã€Œæ’®åˆæˆäº¤ã€äº†ï¼Œä½†ç•¶è¨Šæ¯å‚³åˆ°å€‰ä½æœå‹™æ™‚ï¼Œå€‰ä½æœå‹™æ‡‰åˆ¤å®šå…¶ç‚º*
*ç„¡æ•ˆæˆäº¤ï¼ˆInvalid Fillï¼‰**ã€‚

- **åšæ³•ï¼š** ç³»çµ±å°‡é€™ 3 å¼µå–®è¦–ç‚ºã€Œé–‹æ–°å€‰ã€è€Œéã€Œå¹³å€‰ã€ã€‚
- **é¢¨éšªï¼š** é€™æœƒå°è‡´ç”¨æˆ¶æŒå€‰è®Šæˆ SELL 5 + SELL 3 = SELL 8ã€‚
- **å°ç­–ï¼š** é€™æ˜¯ç›®å‰å¤§å¤šæ•¸äº¤æ˜“æ‰€çš„é‚è¼¯â€”â€”**å¦‚æœå¹³å€‰å–®æˆäº¤æ™‚å·²ç¶“æ²’æœ‰å€‰ä½å¯å¹³ï¼Œå‰‡è©²å–®è‡ªå‹•è½‰ç‚ºé–‹å€‰å–®ï¼ˆåªè¦ä¿è­‰é‡‘è¶³å¤ ï¼‰**ã€‚
- ç™¼æ¶ˆæ¯çµ¦ Account æœå‹™ï¼Œæ‰£æ¸›è³‡é‡‘ã€‚
- **å€‰ä½èˆ‡é å‡çµè™•ç†ï¼š**
    - å€‰ä½ç¿»è½‰æ™‚ï¼Œ`closingReservedQuantity` åƒ…æ‰£æ‰è¢« flip åƒæ‰çš„æ•¸é‡ï¼ˆ`min(reserved, closedQty)`ï¼‰ã€‚
    - å¾ŒçºŒå¹³å€‰å–®è‹¥å·²ç„¡å¯å¹³å€‰ä½ï¼Œè¦–ç‚º Invalid Fill ä¸¦æ”¹ç‚ºé–‹å€‰è™•ç†ã€‚
- **å¸³å‹™è™•ç†ï¼š**
    - Account æ”¶åˆ° `positions.close-to-open-compensation` å¾Œï¼Œä¸ä¾è³´é æ‰£ï¼Œç›´æ¥çµç®—ä¿è­‰é‡‘èˆ‡æ‰‹çºŒè²»ã€‚
    - å…è¨±é¤˜é¡ç‚ºè² ä¸¦è¨˜éŒ„åŸå› ï¼Œç”¨æˆ¶éœ€è£œè³‡é‡‘æˆ–å¹³å€‰å›æ­£å¾Œæ‰å¯ç¹¼çºŒä¸‹å–®ã€‚

å¦‚æœç”¨æˆ¶ä¿è­‰é‡‘ä¸è¶³ä»¥æ”¯æ’é€™é¡å¤–çš„ 3 å¼µ SELL å–®ï¼Œå‰‡è©²æˆäº¤åœ¨çµç®—å±¤ç´šåŸ·è¡Œ**å¼·å¹³æˆ–è‡ªå‹•æ’¤å›ï¼ˆæ ¹æ“šäº¤æ˜“æ‰€é¢¨æ§è¦å‰‡ï¼‰**ã€‚

- æˆ‘ï¼šæ­£å¼ç‰ˆæœ¬æ‡‰è©²è§¸ç™¼å¼·å¹³ã€‚é€™è£¡åªç°¡å–®æŠŠç”¨æˆ¶è³‡é‡‘æ‰£æˆè² æ•¸ï¼Œä¸¦ç´€éŒ„åŸå› ã€‚ç”¨æˆ¶ä¸‹å–®æ™‚ï¼Œæç¤ºåŸå› ï¼Œä¸¦è«‹ä»–å€‘è£œå……è³‡é‡‘ï¼Œæˆ–å¹³å€‰åˆ°æ­£æ•¸å¾Œï¼Œæ‰å¯ç¹¼çºŒä¸‹å–®ã€‚

---

#### ç‰©ç†éš”çµ•ï¼šåˆ©ç”¨æ’®åˆå¼•æ“çš„ã€Œå¸³æˆ¶åºåˆ—åŒ–ã€âœ”ï¸

ç‚ºäº†å¾¹åº•è§£æ±ºæ‚¨çš„æ“”å¿ƒï¼ˆå³æ’¤å–®å¤±æ•—ï¼‰ï¼Œç›®å‰çš„é ‚å°–äº¤æ˜“æ‰€æ¶æ§‹é€šå¸¸æ¡ç”¨ä»¥ä¸‹è¨­è¨ˆï¼š

1. **å–®ä¸€è™•ç†ç·šï¼ˆSingle-threaded sequencingï¼‰ï¼š** å°æ–¼åŒä¸€å€‹ç”¨æˆ¶ã€åŒä¸€å€‹å¹£å°çš„æ‰€æœ‰å‹•ä½œï¼ˆä¸‹å–®ã€æˆäº¤ã€æ’¤å–®ï¼‰ï¼Œåœ¨æ’®åˆå¼•æ“ä¸­å¿…é ˆæ˜¯*
   *åš´æ ¼ä¸²è¡Œ**çš„ã€‚

2. **å‰ç½®æ ¡é©—ï¼ˆPre-Matching Checkï¼‰ï¼š**
    - ç•¶ SELL 10 æº–å‚™æˆäº¤æ™‚ï¼Œå¼•æ“å…ˆç®—ä¸€ä¸‹ï¼š`Current_Position(5) - Matching_Amount(10) = -5`ã€‚
    - ç™¼ç¾æ–¹å‘è®Šäº†ï¼Œå¼•æ“**åŸåœ°**åŸ·è¡Œä¸€å€‹å…§å­˜å‹•ä½œï¼š`Cancel_All_Opposite_Reduce_Only_Orders`ã€‚
    - å› ç‚ºæ˜¯åœ¨åŒä¸€å€‹ç·šç¨‹å…§è™•ç†ï¼Œæ‰€ä»¥é€™ 3 å¼µå–®ã€Œçµ•å°ä¸å¯èƒ½ã€åœ¨é€™ä¸€åˆ»è¢«åˆ¥äººåƒæ‰ï¼Œå› ç‚ºå¼•æ“æ­£åœ¨è™•ç†é€™ç­† SELL 10ï¼Œé‚„æ²’å»è™•ç†åˆ¥çš„å–®ã€‚

# æ’®åˆ

## æ¶æ§‹è¨­è¨ˆ (Architecture)

Matching Service æ¡ç”¨ **é«˜æ€§èƒ½å–®åŸ·è¡Œç·’æ’®åˆæ¨¡å‹ (LMAX Architecture Style)**ï¼Œçµåˆ **WAL (Write-Ahead Logging)** èˆ‡ *
*ç•°æ­¥è½åº« (Async Persistence)** æ©Ÿåˆ¶ï¼Œä»¥å¯¦ç¾å¾®ç§’ç´šå»¶é²èˆ‡é«˜ååé‡ã€‚

### æ ¸å¿ƒè¨­è¨ˆç†å¿µ

1. **å–®åŸ·è¡Œç·’æ¨¡å‹ (Thread-per-Instrument)**:
    * é‡å°å–®ä¸€ `instrument_id` (äº¤æ˜“å°)ï¼Œæ‰€æœ‰æ’®åˆé‚è¼¯åœ¨å°ˆå±¬çš„å–®ä¸€åŸ·è¡Œç·’ä¸­åš´æ ¼ä¸²è¡ŒåŸ·è¡Œï¼Œæ¶ˆé™¤é–ç«¶çˆ­èˆ‡ Context Switch é–‹éŠ·ã€‚
    * æ‰€æœ‰ç†±æ•¸æ“šï¼ˆOrderBookã€ç´¢å¼•ã€å»é‡é›†åˆï¼‰å¸¸é§è¨˜æ†¶é«” (In-Memory)ã€‚

2. **WAL ç‚ºæœ€é«˜çœŸç† (WAL as Truth)**:
    * æ’®åˆçµæœä¸ç›´æ¥å¯«å…¥è³‡æ–™åº«ï¼Œè€Œæ˜¯å…ˆå¾ªåºå¯«å…¥æœ¬åœ°ç£ç¢Ÿçš„ WAL æª”æ¡ˆã€‚
    * WAL è½ç›¤æˆåŠŸå³è¦–ç‚ºæ¥­å‹™æˆåŠŸ (Commit Point)ï¼Œç¢ºä¿æ¥µè‡´å¯«å…¥æ•ˆèƒ½ã€‚

3. **ç•°æ­¥åŠ è¼‰èˆ‡ç™¼é€ (Async Loader & Outbox)**:
    * èƒŒæ™¯åŸ·è¡Œç·’ (Loader) è² è²¬è®€å– WALï¼Œå°‡æˆäº¤ç´€éŒ„ (Trade) ç•°æ­¥å¯«å…¥ MySQLã€‚
    * æ¡ç”¨ **CDC Outbox Pattern**ï¼šåœ¨åŒä¸€è³‡æ–™åº«äº‹å‹™ä¸­å¯«å…¥ `mq_outbox` è¡¨ï¼Œç”± Debezium æ•æ‰ Binlog ä¸¦æ¨é€è‡³
      Kafkaï¼Œç¢ºä¿è³‡æ–™åº«èˆ‡è¨Šæ¯ä½‡åˆ—çš„ä¸€è‡´æ€§ã€‚

### æ’®åˆè™•ç†æµç¨‹

1. **è¨‚å–®æ¥æ”¶ (Ingress)**:
    * Matching Engine æ‰¹é‡æ‹‰å– Kafka `order.created` äº‹ä»¶ã€‚
    * ä¾æ“š `instrument_id` è·¯ç”±è‡³å°æ‡‰çš„ `InstrumentProcessor`ã€‚

2. **è¨˜æ†¶é«”æ’®åˆ (Matching)**:
    * åŸ·è¡Œç·’å…§åŸ·è¡Œæ’®åˆé‚è¼¯ï¼Œæ›´æ–°è¨˜æ†¶é«”ä¸­çš„ OrderBookã€‚
    * ç”Ÿæˆ `MatchResult` (åŒ…å«æˆäº¤æ˜ç´° Tradeã€è¨‚å–®ç°¿è®Šæ›´ OrderBookUpdate)ã€‚

3. **æŒä¹…åŒ– (Persistence)**:
    * å°‡ `MatchResult` åºåˆ—åŒ–ä¸¦ Append åˆ°æœ¬åœ° WAL æª”æ¡ˆ (`wal-{instrumentId}.wal`)ã€‚
    * å®šæœŸæˆ–å®šé‡åŸ·è¡Œ Snapshot (`snapshot-{instrumentId}.json`) ä»¥åŠ é€Ÿé‡å•Ÿæ¢å¾©ã€‚

4. **äº‹ä»¶ç™¼å¸ƒ (Egress)**:
    * **Loader (ç¨ç«‹åŸ·è¡Œç·’)** å°¾éš¨è®€å– WAL å…§å®¹ã€‚
    * é–‹å•Ÿ DB Transactionï¼š
        * æ‰¹é‡æ’å…¥ `trade` è¡¨ã€‚
        * å°‡äº‹ä»¶ (TradeExecuted, OrderBookUpdated) å¯«å…¥ `mq_outbox` è¡¨ (å« Global Sequence)ã€‚
    * Commit Transactionã€‚
    * Debezium æ•æ‰ `mq_outbox` è®Šæ›´ï¼Œç™¼é€è‡³ Kafka Topics (`matching.trade-executed`, `matching.orderbook-updated`)ã€‚

## match æ¶ˆè²» `OrderCreated`

- æ¶ˆè²» `OrderCreated` äº‹ä»¶ã€‚
- å¯«å…¥ WAL ç¢ºä¿æŒä¹…åŒ–ã€‚
- æ›´æ–°å…§å­˜è¨‚å–®ç°¿ã€‚
- æ’®åˆçµæœç•°æ­¥ç¶“ç”± WAL -> Loader -> DB -> CDC -> Kafka ç™¼å¸ƒ `TradeExecuted` èˆ‡ `OrderBookUpdated`ã€‚

### æ’®åˆå¾Œäº‹ä»¶æµ

`TradeExecuted` è¢«å¤šæ¨¡çµ„å¹³è¡Œæ¶ˆè²»ï¼š

| æ¨¡çµ„        | è™•ç†                                                                       |
|-----------|--------------------------------------------------------------------------|
| account   | é›™åˆ†éŒ„è¨˜å¸³ã€æ‰£é™¤å‡çµã€è¨ˆç®—æ‰‹çºŒè²»                                                         |
| positions | æ›´æ–°å€‰ä½èˆ‡å¹³å‡æˆæœ¬ã€ç›ˆè™§                                                             |
| market    | **æ ¹æ“š `TradeExecuted` æ›´æ–° Ticker/K ç·šï¼›<br>æ ¹æ“š `OrderBookUpdated` æ›´æ–°æ·±åº¦åœ–èˆ‡æœ€ä½³åƒ¹** |

### æ’®åˆå¾Œè³‡é‡‘èˆ‡ç‹€æ…‹æ¼”é€²

é–‹å€‰

| éšæ®µ    | Order ç‹€æ…‹         | Ledger å‹•ä½œ | Positions |
|-------|------------------|-----------|-----------|
| ä¸‹å–®    | CREATED          | å‡çµä¿è­‰é‡‘     | ç„¡         |
| æ’®åˆä¸­   | PARTIALLY_FILLED | éƒ¨åˆ†æ‰£æ¬¾èˆ‡è§£å‡   | å€‰ä½å¢æ¸›      |
| æ’®åˆå®Œæˆ  | FILLED           | å…¨éƒ¨çµç®—èˆ‡è§£å‡   | å€‰ä½å®Œæˆæ›´æ–°    |
| æ’¤å–®æˆ–å¤±æ•— | CANCELLED        | è§£å‡ä¿è­‰é‡‘     | ä¸è®Š        |

# æ’®åˆå¾Œè³‡æ–™æµ (Post-Match Data Flow)

ç•¶ Matching Svc ç”¢å‡º `TradeExecuted` å¾Œï¼Œç³»çµ±ä½µè¡Œè™•ç†ï¼š

- **è¡Œæƒ… (Market-Data)**:
    - æ›´æ–° Ticker (æœ€æ–°åƒ¹ã€é‡)ã€‚
    - æ›´æ–° K ç·š (OHLC)ã€‚
    - æ›´æ–° Mark Price (è‹¥æˆäº¤åƒ¹è®Šå‹•)ã€‚
- **é¢¨éšª (Risk-Margin)**:
    - æ¶ˆè²» `MarkPriceUpdated`ã€‚
    - é‡ç®—æ‰€æœ‰å€‰ä½çš„ `Margin Ratio`ã€‚
    - è‹¥ä½æ–¼ `Maintenance Margin`ï¼Œè§¸ç™¼ `LiquidationTriggered`ã€‚
- position :
    - æ¶ˆè²»`MarkPriceUpdated`

## Market æ¶ˆè²» `OrderBookUpdated`

#### æ¶ˆè²»äº‹ä»¶

- **æ¶ˆè²» `OrderBookUpdated`**:
    - é€™æ˜¯æ§‹å»º**å¯¦æ™‚å¸‚å ´æ·±åº¦ (Order Book)** çš„å”¯ä¸€æº–ç¢ºæ•¸æ“šæºã€‚
    - `Market-Data` åœ¨å…§å­˜ä¸­ç¶­è­·æ¯å€‹äº¤æ˜“å°çš„è¨‚å–®ç°¿ï¼Œæ”¶åˆ° `OrderBookUpdated` æ™‚ç›´æ¥è¦†å¯«ç›¸é—œ instrument çš„ bids/asks ä»¥åŠ
      bestBid/bestAsk/midPriceï¼Œé¿å…é å·®åˆ†æ¨å°é€ æˆæ¼‚ç§»ã€‚

--- 

#### æ·±åº¦è³‡æ–™è™•ç†ä¸»æµç¨‹

```
OrderBookUpdated
  â†“
Market-Data Consumer
  â†“
æ›´æ–°å…§å­˜ä¸­çš„è¨‚å–®ç°¿ (æ·±åº¦åœ–)
  â†“
è¦–éœ€æ±‚æ›´æ–°è¡Œæƒ…å¿«å–
```

---

#### æ›´æ–°å…§å­˜ä¸­è¨‚å–®ç°¿ ã€æœ€ä½³è²·åƒ¹/è³£åƒ¹/ä¸­é–“åƒ¹

- ä¾†æºï¼šmatching é€é `OrderBookUpdated` æ¨é€çš„è¨‚å–®ç°¿å¿«ç…§ã€‚
- è³‡æ–™çµæ§‹ï¼š

    ```
    bids: [(price, qty)...]  # é«˜â†’ä½
    asks: [(price, qty)...]  # ä½â†’é«˜
    ```
- æ¯æ¬¡æ›´æ–°
    - æœ€ä½³è²·åƒ¹ / è³£åƒ¹ (`best_bid`, `best_ask`)
    - ä¸­é–“åƒ¹ (`mid_price = (bid + ask)/2`)

## market æ¶ˆè²»ï¼š`Matching`

### æ¶ˆè²»äº‹ä»¶

- **æ¶ˆè²» `TradeExecuted`**:
    - ç”¨æ–¼æ›´æ–° Ticker è³‡è¨Šï¼šæœ€æ–°æˆäº¤åƒ¹ã€24h æˆäº¤é‡ã€æ¼²è·Œå¹…ç­‰ã€‚
    - ä½œç‚º K ç·šèšåˆçš„æ•¸æ“šæºï¼ˆä¸åŒé€±æœŸçš„ open/high/low/close è³‡æ–™çš†ç”±æˆäº¤äº‹ä»¶æ¨å°ï¼‰ã€‚

---

### æˆäº¤è³‡æ–™è™•ç†ä¸»æµç¨‹

```
TradeExecuted
  â†“
Market-Data Consumer
  â†“
æ›´æ–° Ticker èˆ‡æˆäº¤åºåˆ—ç·©å­˜
  â†“
ç”Ÿæˆè¡ç”Ÿè³‡æ–™ (K ç·šã€æŒ‡æ•¸åƒ¹ã€Funding Rateã€æ¨™è¨˜åƒ¹)
  â†“
æ›´æ–°å¿«ç…§è³‡æ–™åº«
```

---

### æ›´æ–°å…§å­˜ä¸­æœ€æ–°æˆäº¤åƒ¹ã€24H æˆäº¤é‡/æˆäº¤é¡/é«˜ä½åƒ¹

æ¥æ”¶åˆ°æˆäº¤å¾Œï¼š

```
last_price = trade.price
volume_24h += trade.quantity
turnover_24h += trade.price * trade.quantity
high_24h = max(high_24h, trade.price)
low_24h  = min(low_24h, trade.price)
price_change_24h = (last_price - open_24h) / open_24h
```

çµæœå­˜å…¥ `ticker_cache[instrument_id]`ï¼Œä¾› REST æŸ¥è©¢ä½¿ç”¨ï¼ˆä½¿ç”¨è€…æ‰‹å‹•åˆ·æ–°é é¢ï¼‰ã€‚

---

### è¡ç”Ÿè³‡æ–™ç”Ÿæˆ

| è¡ç”Ÿè³‡æ–™é¡å‹                | è§¸ç™¼ä¾†æº / æ™‚æ©Ÿ                                     | ç”¢å‡ºäº‹ä»¶èˆ‡ç›®çš„                                                                                  |
|-----------------------|-----------------------------------------------|------------------------------------------------------------------------------------------|
| **K ç·š (Candlestick)** | æ¯å€‹æ™‚é–“çª—ï¼ˆ1m/5m/1hâ€¦ï¼‰æœ‰æˆäº¤ (`TradeExecuted`) èšæ»¿æˆ–æ™‚é–“åˆ°æœŸ | `KlineClosed` â†’ å¯«å…¥ `market.kline` topicï¼Œä¾›å‰ç«¯ç¹ªåœ–ã€æ­·å²å›æ”¾ï¼Œä¸¦åŒæ­¥ flush è‡³ `kline_buckets` è³‡æ–™è¡¨       |
| **æŒ‡æ•¸åƒ¹ (Index Price)** | å¤–éƒ¨è¡Œæƒ…èšåˆå™¨è¼ªè©¢/æ¨é€æ–°å ±åƒ¹æˆ–åµæ¸¬åˆ°é¡¯è‘—åƒ¹å·®                       | `IndexPriceUpdated` â†’ å»£æ’­æ–¼ `market.index-price` topicï¼Œä½œç‚ºæ¨™è¨˜åƒ¹ã€æ¸…ç®—å¼•æ“çš„åŸºæº–ï¼›åŒæ™‚ç·©å­˜åœ¨ Redis ä¾›å³æ™‚æŸ¥è©¢     |
| **æ¨™è¨˜åƒ¹ (Mark Price)**  | æŒ‡æ•¸åƒ¹æ›´æ–°æˆ– Premium Index / Funding Basis è®Šå‹•       | `MarkPriceUpdated`ï¼ˆå·²å« index/mark/fair priceï¼‰â†’ è®“ `positions`/`risk` é‡æ–°è¨ˆç®—æœªå¯¦ç¾ç›ˆè™§èˆ‡ä¿è­‰é‡‘ç‡        |
| **Funding Rate**      | æ¯å€‹çµç®—å‘¨æœŸï¼ˆé è¨­ 8hï¼‰è¨ˆç®—æœ€æ–°è³‡é‡‘è²»ç‡                         | `FundingRateUpdated` â†’ å¯«å…¥ `market.funding-rate` topicï¼Œä¾›çµç®—æœå‹™ç™¼æ”¾è³‡é‡‘è²»ï¼›åŒæ™‚è¨˜éŒ„æ–¼ `funding_rates` è¡¨ |

--- 

#### K ç·šç”Ÿæˆï¼ˆ1m/5m/1hâ€¦ï¼‰ï¼Œç™¼å¸ƒäº‹ä»¶

1. **å®šç¾© K ç·šæ¡¶**ï¼šæ¯çµ„ `instrumentId + period` ç¶­è­·ä¸€å€‹ bucketï¼Œä»¥ `(instrumentId, period, bucket_start)` ç‚º keyï¼Œå…§å« K
   ç·šæ¬„ä½ï¼š

```
    open_price          DECIMAL(20,8)   NOT NULL COMMENT 'é–‹ç›¤åƒ¹'
    high_price          DECIMAL(20,8)   NOT NULL COMMENT 'æœ€é«˜åƒ¹'
    low_price           DECIMAL(20,8)   NOT NULL COMMENT 'æœ€ä½åƒ¹'
    close_price         DECIMAL(20,8)   NOT NULL COMMENT 'æ”¶ç›¤åƒ¹'
    volume              DECIMAL(30,12)  NOT NULL DEFAULT 0 COMMENT 'æˆäº¤é‡ (ä»¥ base asset è¨ˆ)'
    turnover            DECIMAL(30,12)  NOT NULL DEFAULT 0 COMMENT 'æˆäº¤é¡ (ä»¥ quote asset è¨ˆ)'
    trade_count         INT             NOT NULL DEFAULT 0 COMMENT 'æˆäº¤ç­†æ•¸'
    taker_buy_volume    DECIMAL(30,12)  NULL     COMMENT 'åƒå–®æ–¹æˆäº¤é‡ (å¤šé ­)'
    taker_buy_turnover  DECIMAL(30,12)  NULL     COMMENT 'åƒå–®æ–¹æˆäº¤é¡ (å¤šé ­)'
```

3. **æ”¶é›†æˆäº¤**ï¼šæ¯ç­† `TradeExecuted` ä¾ `instrumentId + period + bucket_start` æŠ•å…¥ in-memory bucketï¼ˆ
   `bucket_start = floor(tradeTime, period)`ï¼‰ï¼Œå³æ™‚æ›´æ–° OHLCV èˆ‡é‡èƒ½æ¬„ä½ï¼Œç¢ºä¿æ‰€æœ‰æˆäº¤æŒ‰æ™‚é–“çª—èšåˆã€‚

4. **æ™‚é–“çª—é–‰åˆ**ï¼šæ’ç¨‹æ–¼æ¯å€‹ period çµæŸæ™‚æª¢æŸ¥ bucketï¼›è‹¥è©²çª—ç„¡æˆäº¤ï¼Œä»è£œä¸Šä¸€æ ¹â€œç©ºç™½ K ç·šâ€ï¼ˆæ²¿ç”¨ä¸Šä¸€æ ¹ close ä½œç‚º
   open/high/low/closeï¼Œé‡èƒ½ç‚º 0ï¼‰ä»¥ç¶­æŒåœ–è¡¨é€£çºŒã€‚

5. ~~**è£œå¯«å»¶é²æˆäº¤**ï¼šbucket é—œé–‰å¾Œä»ä¿æŒ `is_closed = FALSE` ä¸€æ®µç·©è¡æ™‚é–“ï¼Œè‹¥æ”¶åˆ°è½åœ¨è©²æ™‚é–“çª—çš„å»¶é²æˆäº¤å°±é‡æ–°è¨ˆç®—
   OHLCVï¼›ç¢ºèªä¸å†æœ‰è£œä»¶å¾Œæ‰è¨­æˆ TRUEï¼Œé¿å…éºæ¼æˆäº¤åˆä¸å¿…é‡å»ºæ•´å¼µè¡¨ã€‚~~

6. **æŒä¹…åŒ–**ï¼šç•¶å‰ bucket å®Œæˆï¼ˆæˆ–è£œå¯«å®Œæˆï¼‰å³ upsert è‡³ `kline_buckets`ï¼Œæ¬„ä½åŒ…å«
   `instrument_id, period, bucket_start/end, open/high/low/close, volume, turnover, taker_buy_*`ï¼Œä¸»éµå¯ç”¨ Snowflake æˆ–
   `(instrumentId, period, bucket_start)`ã€‚

7. **äº‹ä»¶èˆ‡å¿«å–**ï¼šå¯«å…¥æˆåŠŸå¾Œç™¼å¸ƒ `KlineClosed` äº‹ä»¶ä¾›å ±è¡¨/ä¸‹æ¸¸é‡ç®—ï¼›å¸¸ç”¨é€±æœŸï¼ˆ1m/5m/1h/1dï¼‰äº¦å°‡æœ€è¿‘ N æ ¹ç·©å­˜åœ¨ Redis/LRUï¼Œä¾›
   REST æŸ¥è©¢æ™‚ç›´æ¥è®€å–ï¼ˆä½¿ç”¨è€…éœ€æ‰‹å‹•åˆ·æ–°ï¼‰ã€‚

> ä»¥ä¸Šæµç¨‹è®“æ¯å€‹é€±æœŸéƒ½æœ‰ä¸€è‡´çš„ OHLCVï¼Œæ”¯æ´å»¶é²è£œä»¶ä¸¦ä»¥äº‹ä»¶ + REST æŸ¥è©¢è¼¸å‡ºã€‚


---

#### å…§å­˜ç”Ÿæˆ  Mark Priceï¼ˆå–æœ€æ–°æˆäº¤åƒ¹ï¼‰ï¼Œç™¼å¸ƒäº‹ä»¶

- **è³‡æ–™ä¾†æº**ï¼šMarket æœå‹™æ¶ˆè²» `TradeExecuted` äº‹ä»¶å¾Œï¼ŒæŠŠè©² instrument çš„æœ€å¾Œæˆäº¤åƒ¹å¯«é€² in-memory cacheï¼ˆå¯ç‚º
  `ConcurrentHashMap` æˆ– Redisï¼‰ã€‚æœ€æ–°ä¸€ç­†æˆäº¤åƒ¹å³ç‚ºè©²æ¨™çš„çš„ Mark Priceã€‚
- **æŒä¹…åŒ–**ï¼šæ¯æ¬¡æ”¶åˆ°æˆäº¤æ™‚ï¼Œè‹¥ price è®Šå‹•æˆ–è·ä¸Šä¸€ç­†è¶…éè¨­å®šé–“éš”ï¼Œå°±æŠŠ
  `instrumentId / markPrice / tradeId / tradeExecutedAt` upsert è‡³ `mark_price_snapshots`ï¼Œä¿ç•™è¿½æº¯ç´€éŒ„ã€‚
- **äº‹ä»¶æ¨æ’­**ï¼šæ›´æ–°æˆåŠŸå¾Œç™¼å¸ƒ `MarkPriceUpdated`ï¼ˆtopic: `market.mark-price`ï¼‰ï¼Œpayload åƒ…åŒ…å«å¿…è¦æ¬„ä½ï¼š

```json
{
  "instrumentId": "BTCUSDT-PERP",
  "markPrice": 63980.45,
  "tradeId": 123456789,
  "executedAt": "2024-05-07T10:15:30.000Z"
}
```

- **ä½¿ç”¨æ–¹å¼**ï¼šPositions / Risk æœå‹™åƒ…éœ€å–é€™å€‹æœ€æ–°æˆäº¤åƒ¹ä½œç‚º Mark Priceï¼Œå³å¯é©…å‹•å¼·å¹³æˆ–ç›ˆè™§è¨ˆç®—ï¼Œçœå»å¤–éƒ¨æŒ‡æ•¸æˆ– premium
  æ¨å°æµç¨‹ã€‚

è£œå„Ÿæ©Ÿåˆ¶

- è‹¥è®€å–å…§å­˜æ™‚ï¼Œæ²’æœ‰æ•¸æ“šï¼Œå°±æŸ¥ `mark_price_snapshots` è©² instrumentId æœ€å¾Œä¸€ç­†æ•¸æ“šä½¿ç”¨ï¼Œè‹¥æ²’æœ‰æœ€å¾Œä¸€ç­†æ•¸æ“šï¼Œç”Ÿæˆä¸€ç­†é»˜èªæ•¸æ“šæ’å…¥ï¼Œä¸¦ä½¿ç”¨é»˜èªæ•¸æ“šã€‚

---

#### ~~ç”Ÿæˆ Funding Rateï¼Œç™¼å¸ƒäº‹ä»¶~~

è³‡é‡‘è²»ç‡çš„è¨ˆç®—æ˜¯ã€Œæ¯å€‹ funding intervalï¼ˆé è¨­ 8 å°æ™‚ï¼Œå¯èª¿ 1 å°æ™‚ç­‰ï¼‰ã€è·‘ä¸€æ¬¡æ‰¹æ¬¡æµç¨‹ï¼Œæœƒé‡å°è©²å€é–“å…§çš„è¡Œæƒ…è³‡æ–™åšå½™æ•´å¾Œå†è¨ˆç®—ï¼š

- premium_indexï¼šä¸æ˜¯å–å–®ä¸€æ™‚åˆ»ï¼Œè€Œæ˜¯å°æœ€è¿‘ä¸€æ®µæ™‚é–“ï¼ˆå¸¸è¦‹ç‚ºæœ€å¾Œ 1ï½5 åˆ†é˜ï¼Œæˆ–æ•´å€‹ 8 å°æ™‚çš„åŠ æ¬Šå¹³å‡ï¼‰åšå¹³å‡ï¼Œè®“è³‡æ–™ä¸æœƒè¢«ç¬æ™‚å°–å³°å½±éŸ¿ã€‚å¯¦ä½œä¸Šå¯ä»¥ç›´æ¥å¾
  `mark_price_snapshots` å–è©²å€é–“çš„ `fair_priceã€index_price` è¨ˆç®—å¾Œå¹³å‡ï¼Œæˆ–åœ¨è¡Œæƒ…è¨ˆç®—éšæ®µå°±æŒçºŒç¶­è­·ä¸€å€‹æ»‘å‹•å¹³å‡ã€‚
- interest_rateã€borrow_rateï¼šé€šå¸¸ä»¥å¤–éƒ¨æˆ–å…§éƒ¨é…ç½®çš„å¹´åŒ–åˆ©ç‡ç‚ºåŸºç¤ï¼Œå†æ›ç®—æˆæœ¬æœŸï¼ˆ8 å°æ™‚ï¼‰çš„å€¼ã€‚å¦‚æœä½ å¸Œæœ›åæ˜ éå» 8
  å°æ™‚çš„å¸‚å ´è®ŠåŒ–ï¼Œä¹Ÿå¯ä»¥å–è©²æœŸé–“çš„å¹³å‡åˆ©ç‡ï¼ˆä¾‹å¦‚å°æ¯æ¬¡æ›´æ–°çš„åˆ©ç‡å¿«ç…§åšå¹³å‡ï¼‰ï¼Œä½†å¤šæ•¸å¹³å°ç›´æ¥ä½¿ç”¨ç•¶å‰é…ç½®å€¼å³å¯ã€‚
- ä»¥ä¸Šè³‡æ–™æ•´å‚™å¥½å¾Œï¼Œå°±ç”¨ `funding_rate` `=` `clamp(premium_index` `+` `clamp(interest_rate_diff,` `â€¦))` ç­‰å…¬å¼ç®—å‡ºæœ¬æœŸè³‡é‡‘è²»ç‡ï¼Œå¯«å…¥
  funding_rates ä¸¦ç™¼å¸ƒ `FundingRateUpdated`ã€‚


1. **èª¿åº¦è¨ˆç®—**ï¼šä¾ `funding_interval`ï¼ˆé è¨­ 8hï¼Œå¯é…ç½® 1hï¼‰å•Ÿå‹•æ‰¹æ¬¡ä»»å‹™ï¼Œæ”¶é›†è¿‘æœŸ `mark_price_snapshots`ã€è¨ˆç®—`premium_index`
   å¹³å‡å€¼
2. **æ¨å°åˆ©ç‡å·®**ï¼š

    ```
    interest_rate = quote_asset_annual_rate / (365 * 24 / funding_interval_hours)
    borrow_rate   = base_asset_annual_rate / (365 * 24 / funding_interval_hours)
    interest_rate_diff = interest_rate - borrow_rate
    ```

   å…©å€‹å¹´åŒ–åˆ©ç‡ä¾†è‡ªå¤–éƒ¨å€Ÿè²¸å¸‚å ´æˆ–å…§éƒ¨è¨­å®šï¼Œå¯ per instrument è¦†å¯«ã€‚

3. **è¨ˆç®—è³‡é‡‘è²»ç‡èˆ‡è²»ç”¨**ï¼š

    ```
    funding_rate = clamp(premium_index + clamp(interest_rate_diff, -0.0005, 0.0005), -0.0075, 0.0075)
    funding_fee  = position_notional * funding_rate
    ```

   `premium_index` å–è¿‘ 1~5 åˆ†é˜å¹³å‡ï¼Œé¿å…ç¬æ™‚ç•°å¸¸ï¼›clamp æ•¸å€¼å¯ä¾ç‡Ÿé‹ç­–ç•¥èª¿æ•´ã€‚

4. **å¯«å…¥ `funding_rates` è¡¨**ï¼š
    - Upsert æ¬„ä½ï¼š
      `instrument_id, rate, premium_index, interest_rate, borrow_rate, mark_price, index_price, effective_at, calculated_at, funding_interval`ã€‚
    - é è¨­ `settled = FALSE`ï¼Œå¾… account å®Œæˆæ‰£è£œå¾Œç”±çµç®—æœå‹™è¨­ç‚º `TRUE` ä¸¦å¡« `settled_at`ã€‚
    - è‹¥è¼¸å…¥ä¸å®Œæ•´ï¼Œæ²¿ç”¨ä¸Šä¸€æœŸä¸¦åœ¨ç´€éŒ„ä¸Šæ¨™è¨˜ `source_status = 'DEGRADED'` ä»¥åˆ©ç›£æ§ã€‚
5. **ç™¼å¸ƒäº‹ä»¶**ï¼š

    ```
    FundingRateUpdated {
      instrumentId,
      rate,
      premiumIndex,
      interestRate,
      borrowRate,
      effectiveAt,
      fundingInterval
    }
    ```

   positionsã€account æ¶ˆè²»ç”¨æ–¼è¨ˆç®—ç”¨æˆ¶æ‡‰æ”¶ä»˜è³‡é‡‘è²»ï¼›å ±è¡¨/ç›£æ§å‰‡ç¹ªè£½æ­·å²æ›²ç·šä¸¦è§¸ç™¼å‘Šè­¦ã€‚
6. **å°å¸³èˆ‡ç›£æ§**ï¼šçµç®—å¾Œæ¯”å° `funding_rates` èˆ‡å¯¦éš›æ”¶ä»˜ï¼Œè‹¥å·®ç•° > X bp ç«‹å³å‘Šè­¦ï¼›åŒæ™‚ç›£æ§åˆ©ç‡è³‡æ–™æ˜¯å¦éæœŸï¼Œç¢ºä¿ä¸‹ä¸€æœŸè¨ˆç®—è¼¸å…¥å®Œæ•´ã€‚

## position æ¶ˆè²» `MarkPriceUpdated`

- `positions` ä»¥ `instrument_id` ç‚º key æ¶ˆè²» `market.mark-price` topic
- æ›´æ–°ç·©å­˜çš„ï¼š
    - `mark_price`
    - å°‡æ¨™è¨˜åƒ¹å¯«å…¥æœ¬åœ° `MarkPriceCache`ï¼Œä¸¦è¨˜éŒ„äº‹ä»¶æ™‚é–“ï¼ˆé˜²æ­¢èˆŠåƒ¹è¦†è“‹æ–°åƒ¹ï¼‰ã€‚

- æ›´æ–° `instrument_id` æ‰€æœ‰ä»ç‚º `OPEN`å€‰ä½ çš„ï¼š
    * `æœªå¯¦ç¾ç›ˆè™§` `=` `(æ¨™è¨˜åƒ¹æ ¼` `-` `æ–°å¹³å‡é–‹å€‰åƒ¹)` `*` `æ–°æ•¸é‡` `*` `åˆç´„é¢å€¼` (
      å› é–‹å€‰åƒ¹å·²å«æ‰‹çºŒè²»æˆæœ¬ï¼Œæ•…æ­¤ç›ˆè™§ç‚ºæ·¨å€¼)
    * è¨ˆç®—`margin_ratio`ï¼š
      `margin_ratio = (equity / market_notional) = (margin + unrealized_pnl ) / (mark_price * quantity * contract_size)`

- æ›´æ–° `positions` è¡¨èˆ‡ `position_events`ï¼Œåƒ…åœ¨ç›ˆè™§è¶…éé–¾å€¼ï¼ˆå¦‚ notional 0.01%ï¼‰æ™‚è½åº«ï¼Œä»¥æ¸›å°‘å¯«å…¥å£“åŠ›ã€‚
- ç™¼å¸ƒ `PositionUpdated` äº‹ä»¶ä¾›é¢¨æ§ã€å ±è¡¨ä½¿ç”¨ã€‚
- äº‹ä»¶è™•ç†èˆ‡æˆäº¤äº‹ä»¶åˆ†é–‹åŸ·è¡Œï¼Œç¢ºä¿è¡Œæƒ…èˆ‡å€‰ä½è¨ˆç®—äº’ä¸é˜»å¡ï¼›è‹¥è¡Œæƒ…å»¶é²ï¼Œå€‰ä½æœƒä¿ç•™ä¸Šä¸€æ¬¡æ¨™è¨˜åƒ¹èˆ‡ç›ˆè™§ã€‚

# **å¼·å¹³èˆ‡ç©¿å€‰ (Liquidation & Bankruptcy)**

- åœ¨å¹³å€‰è¨ˆç®— PnL æ™‚ï¼Œå¦‚æœè™§æè¶…éäº†ä¿è­‰é‡‘ï¼ˆç©¿å€‰ï¼‰ï¼ŒPosition Service è¨ˆç®—å‡ºçš„ `Payout` æœƒæ˜¯è² æ•¸ã€‚
- é€™æ™‚å‚³çµ¦ Account Service çš„é‚è¼¯ä¸æ˜¯ã€Œå¾ç”¨æˆ¶éŒ¢åŒ…æ‰£éŒ¢ã€ï¼ˆå› ç‚ºé€å€‰ä¸è² å‚µï¼‰ï¼Œè€Œæ˜¯è©²ç­†æå¤±éœ€æ¨™è¨˜ç‚ºã€Œç©¿å€‰æå¤±ã€ï¼Œç”±**é¢¨éšªæº–å‚™é‡‘ (
  Insurance Fund)** å¸³æˆ¶é€²è¡Œå¡«è£œï¼ŒAccount Service åƒ…éœ€å°‡ç”¨æˆ¶è©²é€å€‰ä¿è­‰é‡‘æ­¸é›¶å³å¯ã€‚

## risk æ¶ˆè²» `MarkPriceUpdated`

```
MarkPriceUpdated äº‹ä»¶ç™¼å¸ƒ
   â†“
Risk-Margin æ¶ˆè²»äº‹ä»¶
   â†“
å¸¶å…¥æ—¢æœ‰å€‰ä½å¿«ç…§
   â†“
é‡æ–°è¨ˆç®—æœªå¯¦ç¾æç›Šã€ç¶­æŒä¿è­‰é‡‘æ¯”ç‡èˆ‡å¼·å¹³åƒ¹
   â†“
æ›´æ–° risk snapshotã€ç™¼å¸ƒ RiskUpdate / Liquidation æŒ‡ä»¤
```

è¡Œæƒ…äº‹ä»¶è™•ç†çš„é‡é»åœ¨æ–¼ã€Œå³æ™‚èª¿æ•´ã€ï¼šæ¯ç­†æ¨™è¨˜åƒ¹æ ¼æ›´æ–°éƒ½æœƒé‡æ–°è¨ˆç®—å€‰ä½é¢¨éšªï¼Œå³ä¾¿å€‰ä½æ•¸é‡ä¸è®Šï¼Œä¹Ÿèƒ½åœ¨åƒ¹æ ¼æ€¥é€Ÿè®Šå‹•æ™‚è§¸ç™¼å¼·å¹³æˆ–é€šçŸ¥ã€‚

## risk æ¶ˆè²» `PositionUpdated`

```
PositionUpdated äº‹ä»¶ç™¼å¸ƒ
   â†“
Risk-Margin æ¶ˆè²»äº‹ä»¶
   â†“
è®€å–æœ€æ–°å€‰ä½ä¿¡æ¯
   â†“
è¨ˆç®—åç¾©åƒ¹å€¼èˆ‡å¯¦éš›ä¿è­‰é‡‘ä½”ç”¨
   â†“
æ›´æ–° risk snapshotã€ç™¼å¸ƒ RiskUpdate
```

---

### æ¥æ”¶å€‰ä½æ›´æ–°äº‹ä»¶ `PositionUpdated`

Kafka Consumer æ”¶åˆ° `PositionUpdated` å¾ŒåŸ·è¡Œï¼š

- æ ¹æ“š `instrument_id` æŸ¥æ‰¾å°æ‡‰çš„ `risk_limits`ï¼ˆåˆå§‹ / ç¶­æŒä¿è­‰é‡‘ç‡ã€æœ€å¤§æ§“æ¡¿ï¼‰ã€‚
- å¾äº‹ä»¶æˆ– positions æŸ¥å‡ºå°æ‡‰ç”¨æˆ¶çš„å€‰ä½åŸºç¤è³‡è¨Šï¼ˆ`quantity,` `magin,` `mark_price,` `leverage,` `unrealized_pnl` ï¼‰ã€‚
- å†çµåˆæ—¢æœ‰çš„ä¿è­‰é‡‘é¤˜é¡å¿«ç…§è¨ˆç®—å¯ç”¨æ§“æ¡¿èˆ‡é¢¨éšªæ¯”ç‡ã€‚
- **åˆå§‹åŒ– `risk_snapshots`**ï¼š
    1. ä»¥ `user_id + instrument_id` é€²è¡Œ `SELECT ... FOR UPDATE`ï¼›è‹¥ç„¡è³‡æ–™ä»£è¡¨é¦–æ¬¡æ¥è§¸è©²å•†å“ã€‚
    2. ä¾ç•¶å‰å€‰ä½è¨ˆç®—åˆå§‹æŒ‡æ¨™ï¼š
        - `notional_value = abs(mark_price * quantity * contract_size)`ï¼ˆå¸‚å ´åç¾©åƒ¹å€¼ï¼‰ï¼›è‹¥ç‚º 0 å‰‡è¨­å®šç‚º 1 ä»¥é¿å…é™¤ä»¥ 0ã€‚
        - `used_margin = notional_value / max(leverage, 1)`ã€‚
        - `equity = margin_balance + unrealized_pnl`ï¼Œå…¶ä¸­ `margin_balance` ä¾†æºç‚º account æˆ– risk
          æ¨¡çµ„ç¶­è­·çš„éŒ¢åŒ…å¿«ç…§ï¼›æŸ¥ç„¡è³‡æ–™æ™‚ä»¥ 0 ä¸¦æ¨™è¨˜ `status = NORMAL`ã€‚
        - `margin_ratio = equity / notional_value`ï¼›è‹¥ `notional_value = 0` å‰‡é è¨­ 1ã€‚
        - `liquidation_price` ä¾é€å€‰å…¬å¼è¨ˆç®—ã€‚
    3. æ ¹æ“š `margin_ratio` æ±ºå®šåˆå§‹ç‹€æ…‹ï¼š`NORMAL`ã€`ALERT`ã€`MARGIN_CALL` æˆ–
       `LIQUIDATION_PENDING`ã€‚
    4. å¯«å…¥ `risk_snapshots` æ–°ç´€éŒ„ä¸¦æŠŠ `risk_version = risk_limits.id`ã€`snapshot_source = 'POSITION_UPDATED'`ã€
       `snapshot_at = eventTimestamp`ï¼›ä¹‹å¾ŒåŒä¸€çµ„åˆå³èµ° `UPDATE` æµç¨‹ã€‚

---

### æ›´æ–°ä½”ç”¨ä¿è­‰é‡‘èˆ‡ä¿è­‰é‡‘ç‡

| æŒ‡æ¨™                  | è¨ˆç®—æ–¹å¼                                         | å«ç¾©       |
|---------------------|----------------------------------------------|----------|
| **market_notional** | `abs(mark_price * quantity * contract_size)` | å€‰ä½å¸‚å ´åç¾©åƒ¹å€¼ |
| **used_margin**     | `market_notional / leverage`                 | å€‰ä½ä½”ç”¨ä¿è­‰é‡‘  |
| **margin_ratio**    | `(equity / market_notional)`                 | ä¿è­‰é‡‘ç‡     |

`equity = margin_balance + unrealized_pnl`ï¼ˆé€å€‰æ¨¡å¼ä¸‹ margin_balance å³è©²å€‰ä½å¯¦éš›ä½”ç”¨çš„ä¿è­‰é‡‘ï¼‰

è‹¥å€‰ä½æ“´å¤§æˆ–æ§“æ¡¿èª¿æ•´ï¼š

- æ›´æ–°è©²ç”¨æˆ¶è©² `instrument_id` çš„ `used_margin`ã€‚
- è‹¥è¶…éé¢¨æ§è¦å‰‡ï¼ˆå¦‚æ§“æ¡¿ä¸Šé™ï¼‰ï¼Œæ¨™è¨˜ç‚º `RISK_ALERT`ã€‚

---

### æ ¹æ“š mark_price å¯¦æ™‚æ›´æ–°é¢¨éšªæŒ‡æ¨™ margin_ratio èˆ‡ liquidation_price

| æŒ‡æ¨™                    | è¨ˆç®—å…¬å¼                                                                                                                                                                                       | æ„ç¾©           |
|-----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------|
| **unrealized_pnl**    | `(mark_price - entry_price) * qty * contract_size`                                                                                                                                         | æœªå¯¦ç¾ç›ˆè™§        |
| **margin_ratio**      | `(margin_balance + unrealized_pnl) / market_notional`ï¼ˆäº¦å³ `equity / market_notional`ï¼‰                                                                                                       | ç¶­æŒæ¯”ç‡         |
| **liquidation_price** | é€å€‰å…¬å¼ï¼š`Long = (entryPrice - marginPerUnit)/(1 - mmr)`ã€`Short = (entryPrice + marginPerUnit)/(1 + mmr)`ï¼Œå…¶ä¸­ `marginPerUnit = isolatedMarginAmount / (quantity * contract_size)`ã€`mmr` ç‚ºç¶­æŒä¿è­‰é‡‘ç‡ | å¼·å¹³åƒ¹ï¼ˆä¾å€‰ä½æ–¹å‘è¨ˆç®—ï¼‰ |

---

### æ›´æ–° risk ç‹€æ…‹è¡¨èˆ‡æŒ‡æ¨™å¿«ç…§

å¯«å…¥æˆ–æ›´æ–°ï¼š

```
risk_snapshots {
  user_id,
  instrument_id,
  notional_value,
  used_margin,
  equity,
  margin_ratio,
  liquidation_price,
  status,
  updated_at
}
```

ç‹€æ…‹å¯èƒ½ç‚ºï¼š

- `NORMAL`
- `ALERT`ï¼ˆæ¥è¿‘ç¶­æŒä¿è­‰é‡‘ï¼‰
- `MARGIN_CALL`
- `LIQUIDATION_PENDING`

---

### ç™¼å¸ƒ RiskUpdate äº‹ä»¶

é¢¨æ§çµæœæœƒä»¥äº‹ä»¶å½¢å¼å»£æ’­ï¼š

```
RiskUpdate {
  userId,
  instrumentId,
  marginRatio,
  liquidationPrice,
  status,
  timestamp
}
```

ä¸‹æ¸¸è™•ç†ï¼š[STATUS](#STATUS)
æ¶ˆè²»è€…ï¼š

- **order-service**ï¼šè‹¥é¢¨éšªéé«˜ï¼Œæš«åœæ–°å§”è¨—ã€‚
- **risk-liquidation-worker**ï¼šè‡ªå‹•å¼·å¹³åŸ·è¡Œï¼ˆç™¼èµ· `liquidation_queue`ï¼‰ã€‚
- **monitor/reporting**ï¼šæ›´æ–°é¢¨éšªé¢æ¿èˆ‡å ±è¡¨ã€‚

# æ’¤å–®

- æ’¤å–®æ˜¯ä¸€å€‹æ¶‰åŠ **Order æœå‹™**ã€**Matching æœå‹™** å’Œ **Account æœå‹™** çš„**åˆ†æ•£å¼äº‹å‹™**
  ï¼Œå¿…é ˆç¢ºä¿åŸå­æ€§ï¼šæ’®åˆå¼•æ“åœæ­¢æ’®åˆè©²è¨‚å–®ï¼Œä¸¦ä¸”å‡çµçš„è³‡ç”¢ï¼ˆä¿è­‰é‡‘æˆ–å€‰ä½ï¼‰å¾—åˆ°é‡‹æ”¾ã€‚
- æµç¨‹:
    - ç•¶ç”¨æˆ¶è«‹æ±‚æ’¤éŠ·è¨‚å–® (`DELETE /api/orders/{orderId}`) æ™‚ï¼Œæµç¨‹æœƒåŒæ­¥æˆ–ç•°æ­¥åœ°åœ¨ä¸‰å€‹æœå‹™é–“åŸ·è¡Œï¼š
        - **OrderSvc (å”èª¿è€…):** æ¥æ”¶è«‹æ±‚ï¼Œå°‡è¨‚å–®ç‹€æ…‹æ¨™è¨˜ç‚º `CANCELLING`ï¼Œä¸¦ç™¼å¸ƒæ’¤å–®è«‹æ±‚äº‹ä»¶ã€‚
            - æª¢æŸ¥è¨‚å–®ç‹€æ…‹ï¼ˆåªèƒ½å–æ¶ˆ `NEW` æˆ– `PARTIALLY_FILLED`ï¼‰
        - **MatchingSvc (äº‹å¯¦ä¾†æº):** æ¶ˆè²»äº‹ä»¶ï¼ŒåŸå­æ€§åœ°å°‡è¨‚å–®å¾ Order Book ä¸­ç§»é™¤ï¼Œä¸¦ç™¼å¸ƒå–æ¶ˆæˆåŠŸçš„äº‹ä»¶ã€‚
          -
                1. åŸ·è¡Œ **åŸå­æ“ä½œ**ï¼šå¾å…§å­˜ Order Book ä¸­ç§»é™¤è¨‚å–®ã€‚
            -
                2. è¨˜éŒ„åˆ° WAL (å‹•ä½œé¡å‹ç‚º `CANCEL`)ã€‚
        - **LedgerSvc (çµç®—):** æ¶ˆè²»å–æ¶ˆæˆåŠŸäº‹ä»¶ï¼Œå°‡å·²å‡çµçš„è³‡é‡‘å¾ `reserved` è½‰å› `available`ã€‚
        - **OrderSvc (çµ‚çµè€…):** æ¶ˆè²»æˆåŠŸäº‹ä»¶ï¼Œå°‡è¨‚å–®æœ€çµ‚ç‹€æ…‹è¨­ç‚º `CANCELLED`ã€‚
- å–æ¶ˆåˆ†æ•£å¼äº‹å‹™çš„ç°¡åŒ–è¦é»
    - ç‚ºä»€éº¼åªèƒ½å–æ¶ˆ åªèƒ½å–æ¶ˆ NEW æˆ– PARTIALLY_FILLED ï¼Œæ­£åœ¨å‡çµè³‡æºæ™‚ä¸èƒ½å–æ¶ˆå— ?
        - **åªèƒ½å–æ¶ˆ `NEW` (æ–°è¨‚å–®) æˆ– `PARTIALLY_FILLED` (éƒ¨åˆ†æˆäº¤)** çš„è¨‚å–®ï¼Œæ˜¯å› ç‚ºã€Œæ’¤å–® (Cancel)ã€é€™å€‹å‹•ä½œï¼Œ*
          *åªä½œç”¨æ–¼æ’®åˆå¼•æ“ (Matching Engine) å…§éƒ¨çš„ã€Œæœªæˆäº¤ä¸”ä»æœ‰æ•ˆã€çš„è¨‚å–®éƒ¨åˆ†**ã€‚
        - ä¸¦ä¸” ä¸€æ—¦è¨‚å–®é€²å…¥ **ã€Œé–å®šè³‡ç”¢éšæ®µã€**ï¼ˆå³ `FREEZING_MARGIN` æˆ– `LOCKING_POSITION`ï¼‰ï¼Œæ‚¨æ‡‰è©²**é¿å…**
          è®“ç”¨æˆ¶ç›´æ¥å°å…¶ç™¼èµ·ä¸»å‹•å–æ¶ˆè«‹æ±‚ã€‚
            1. **ç­‰å¾… RPC/äº‹ä»¶å®Œæˆï¼š** è®“æ­£åœ¨é€²è¡Œçš„ã€Œé–å®šã€æˆ–ã€Œå‡çµã€äº‹å‹™è·‘å®Œã€‚
            2. **æˆåŠŸé€²å…¥ `NEW`ï¼š** å¦‚æœæˆåŠŸï¼Œè¨‚å–®é€²å…¥ `NEW` ç‹€æ…‹ï¼Œæ­¤æ™‚å¯é€éæ¨™æº–æµç¨‹å–æ¶ˆã€‚
            3. **å¤±æ•—é€²å…¥ `REJECTED`ï¼š** å¦‚æœå¤±æ•—ï¼Œè¨‚å–®é€²å…¥ `REJECTED` çµ‚æ…‹ï¼Œè³‡ç”¢å°‡è‡ªå‹•å›æ»¾æˆ–ä¿æŒåŸç‹€ï¼Œç„¡éœ€å–æ¶ˆã€‚
        - **ç°¡è€Œè¨€ä¹‹ï¼Œç³»çµ±çš„ç›®æ¨™æ˜¯å°‡è¨‚å–®å„˜å¿«æ¨é€²åˆ° `NEW` (å¯æ’®åˆ/å¯å–æ¶ˆ) æˆ– `REJECTED` (çµ‚æ…‹/ä¸å¯å–æ¶ˆ)
          ç‹€æ…‹ï¼Œé¿å…è¤‡é›œçš„ã€Œå–æ¶ˆæ­£åœ¨é€²è¡Œçš„åˆ†æ•£å¼äº‹å‹™ã€é‚è¼¯ã€‚**
    - Order å¯å¢åŠ å­—æ®µæ¨™è¨˜ï¼Œè®“æ’®åˆå‰äº‹å‹™éšæ®µå¯ä»¥æ‰“ä¸Šæ¨™è¨˜ï¼Œä¸€æ—¦èµ°åˆ°NEWæ™‚ï¼Œè‡ªå‹•å–æ¶ˆã€‚
        - ä¾‹å¦‚ `auto_cancel_at` æˆ– `time_in_force` é¡å‹ï¼‰è®“è¨‚å–®åœ¨ç‰¹å®šæ™‚é–“å¾Œè‡ªå‹•å–æ¶ˆï¼Œä¸¦å°‡æ­¤ä½œç‚ºæ¨™æº–çš„æ’¤å–®æµç¨‹ï¼Œæ˜¯ä¸€å€‹*
          *åœ¨äº¤æ˜“ç³»çµ±ä¸­éå¸¸å¸¸è¦‹ä¸”é«˜æ•ˆçš„è¨­è¨ˆæ¨¡å¼**ï¼Œé€šå¸¸ç¨±ç‚º **Time in Force (TIF) ç­–ç•¥**ï¼Œä¾‹å¦‚:
            - `GTC` (Good-Till-Cancelledï¼Œæ°¸ä¹…æœ‰æ•ˆç›´åˆ°æ‰‹å‹•å–æ¶ˆ)
            - `IOC` (Immediate-or-Cancelï¼Œç«‹å³æˆäº¤å¦å‰‡å–æ¶ˆ)
            - `FOK` (Fill-or-Killï¼Œå…¨éƒ¨æˆäº¤å¦å‰‡å–æ¶ˆ)
            - `GTD` (Good-Till-Date/Timeï¼Œæœ‰æ•ˆè‡³æŒ‡å®šæ™‚é–“)ã€‚
        - æ­¤æ–¹æ¡ˆäº¦å¯æ”¯æŒé †å¸¶æ”¯æŒä»¥ä¸Šè¨‚å–®é¡å‹ã€‚
        - è‡ªå‹•å–æ¶ˆæµç¨‹
            - **é€²å…¥ `NEW` ç‹€æ…‹ï¼š** è¨‚å–®æˆåŠŸå‡çµä¿è­‰é‡‘ï¼ˆé›¢é–‹ `FREEZING_MARGIN` æˆ– `LOCKING_POSITION`ï¼‰ä¸¦é€²å…¥ `NEW` ç‹€æ…‹ã€‚
            - **æ’ç¨‹ç›£æ§ï¼š** Order æœå‹™å…§éƒ¨é‹è¡Œä¸€å€‹è¼•é‡ç´šæ’ç¨‹ä»»å‹™ï¼ŒæŒçºŒæƒæï¼š
                - ç‹€æ…‹ç‚º `NEW` æˆ– `PARTIALLY_FILLED`ã€‚
                - `time_in_force` ç‚º `GTD` ä¸” `expire_at` å°æ–¼ç•¶å‰æ™‚é–“çš„è¨‚å–®ã€‚
            - **è§¸ç™¼å–æ¶ˆï¼š** å°æ–¼ç¬¦åˆæ¢ä»¶çš„è¨‚å–®ï¼Œæ’ç¨‹ä»»å‹™å°‡å…¶æ¨™è¨˜ç‚º `CANCELLING`ã€‚
            - **æ¨™æº–æ’¤éŠ·ï¼š** ç³»çµ±ç™¼å¸ƒ `OrderCancelRequested` äº‹ä»¶ï¼Œè§¸ç™¼ **Matching æœå‹™** å’Œ **Account æœå‹™**
              åŸ·è¡Œèˆ‡æ‰‹å‹•æ’¤å–®ç›¸åŒçš„æ¨™æº–è§£é–å’Œç‹€æ…‹æ›´æ–°æµç¨‹ã€‚
- å†ªç­‰æ€§èˆ‡éŒ¯èª¤è™•ç†
    - **å†ªç­‰æ€§ (Idempotency):**
        - **OrderSvc:** æ‡‰æª¢æŸ¥è¨‚å–®ç‹€æ…‹ã€‚è‹¥è¨‚å–®å·²è™•æ–¼ `CANCELLING` æˆ– `CANCELLED` ç‹€æ…‹ï¼Œç›´æ¥è¿”å›æˆåŠŸæˆ–ç•¶å‰ç‹€æ…‹ï¼Œé¿å…é‡è¤‡ç™¼å¸ƒ
          `OrderCancelRequested`ã€‚
        - **MatchingSvc:** åœ¨ Order Book ä¸­ç§»é™¤è¨‚å–®çš„æ“ä½œæœ¬èº«å…·å‚™å†ªç­‰æ€§ï¼ˆç§»é™¤ä¸å­˜åœ¨çš„è¨‚å–®ä¸ç”¢ç”Ÿå½±éŸ¿ï¼‰ã€‚WAL æ‡‰è¨˜éŒ„
          `OrderCancelRequested` çš„ `reference_id` ç¢ºä¿ä¸é‡è¤‡è™•ç†ã€‚
        - **AccountSvc:** è³‡é‡‘è§£å‡æ“ä½œå¿…é ˆåŸºæ–¼å”¯ä¸€çš„ `reference_id`ï¼ˆä¾‹å¦‚ `orderId` + `CANCEL` é¡å‹ï¼‰å¯«å…¥å¸³å‹™åˆ†éŒ„ï¼Œé˜²æ­¢é‡è¤‡è§£å‡è³‡é‡‘ã€‚
- **éŒ¯èª¤èˆ‡è£œå„Ÿ (Compensation):**
    - é‡è©¦
        - è‹¥ **MatchingSvc å¤±æ•—**ï¼ˆå¦‚ Order Book å´©æ½°ï¼‰ï¼šOrderSvc çš„è¨‚å–®ç‹€æ…‹æœƒå¡åœ¨ `CANCELLING`ã€‚æ‡‰æœ‰æ’ç¨‹ä»»å‹™ç›£æ§é•·æ™‚é–“è™•æ–¼
          `CANCELLING` ç‹€æ…‹çš„è¨‚å–®ï¼Œä¸¦é‡æ–°ç™¼é€ `OrderCancelRequested` äº‹ä»¶ã€‚
            - è‹¥ **AccountSvc å¤±æ•—**ï¼ˆå¦‚è³‡æ–™åº«é–å®šï¼‰ï¼šAccountSvc æ‡‰æœ‰é‡è©¦æ©Ÿåˆ¶ã€‚
    - äººå·¥è™•ç†
        - è‹¥é‡è©¦ä»å¤±æ•—ï¼ŒOrderSvc æœ€çµ‚ç‹€æ…‹ç„¡æ³•è½‰ç‚º `CANCELLED`ã€‚ä½†ç”±æ–¼è³‡é‡‘ä»å‡çµï¼Œè¨‚å–®äº‹å¯¦ä¸Šå·²è¢«æ’®åˆå¼•æ“ç§»é™¤ï¼Œç”¨æˆ¶çš„è³‡ç”¢é¢¨éšªæ˜¯å®‰å…¨çš„ï¼ˆè³‡é‡‘åªæ˜¯è¢«é–ä½ï¼‰ã€‚äººå·¥ä»‹å…¥æˆ–å¾Œå°è£œå„Ÿ
          job éœ€å¼·åˆ¶è§£å‡è³‡é‡‘ä¸¦å°‡è¨‚å–®ç‹€æ…‹è½‰ç‚º `CANCELLED`ã€‚

# è³‡é‡‘è²»ç‡

## account æ¶ˆè²» FundingRateUpdated

#    

# å¾®æœå‹™è¦æ ¼èªªæ˜ (Service Specifications)

# Gateway æœå‹™

## API

| HTTP Method | Endpoint | èªªæ˜           | èª¿ç”¨è€…    | æˆæ¬Š  | è½‰ç™¼è‡³  |
|-------------|----------|--------------|--------|-----|------|
| -           | -        | JWTé©—è­‰ã€è·¯ç”±æ‰€æœ‰è«‹æ±‚ | Client | jwt | å„å¾®æœå‹™ |

---

# Auth æœå‹™

## API

| å®Œæˆ | HTTP Method | Endpoint                  | èªªæ˜      | èª¿ç”¨è€…     | æˆæ¬Š      |
|----|-------------|---------------------------|---------|---------|---------|
| âœ”ï¸ | POST        | `/api/auth/credentials`   | å»ºç«‹æ†‘è­‰    | user    | private |
| âœ”ï¸ | POST        | `/api/auth/login`         | ç™»å…¥      | gateway | public  |
|    | POST        | `/api/auth/token/refresh` | åˆ·æ–°Token | gateway | jwt     |
|    | POST        | `/api/auth/logout`        | ç™»å‡º      | gateway | jwt     |

## event

**äº‹ä»¶æ¶ˆè²»**:

| å®Œæˆ | Topic | äº‹ä»¶ | è™•ç†é‚è¼¯ | äº‹ä»¶ç™¼å¸ƒ |
|----|-------|----|------|------|

**äº‹ä»¶ç™¼å¸ƒ**:

| å®Œæˆ | ç™¼å¸ƒå ´æ™¯            | Topic                | äº‹ä»¶åç¨±                 |
|----|-----------------|----------------------|----------------------|
|    | ä½¿ç”¨è€…ä¸»å‹•ç™»å‡ºæˆ–è¢«é¢¨æ§å¼·åˆ¶ç™»å‡º | auth.session-revoked | `AuthSessionRevoked` |

---

## DDL

#### `auth_credentials` - ç™»å…¥æ†‘è­‰è³‡æ–™

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

# User æœå‹™

## API

| å®Œæˆ | HTTP Method | Endpoint        | èªªæ˜         | èª¿ç”¨è€…     | æˆæ¬Š     |
|----|-------------|-----------------|------------|---------|--------|
| âœ”ï¸ | POST        | `/api/users`    | ç”¨æˆ¶è¨»å†Š       | gateway | public |
| âœ”ï¸ | GET         | `/api/users/me` | æŸ¥è©¢ç•¶å‰ç”¨æˆ¶åŸºæœ¬è³‡æ–™ | gateway | jwt    |

---

## job

- `RetryTaskScheduler` æ’ç¨‹ä»»å‹™ï¼šæƒæ `retry_task`ï¼Œé‡è©¦ auth credential å»ºç«‹

## DDL

### `users` - ä½¿ç”¨è€…ä¸»æª”

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

# Order æœå‹™

## API

| å®Œæˆ | HTTP Method | Endpoint                | èªªæ˜   | èª¿ç”¨è€…                          | æˆæ¬Š            |
|----|-------------|-------------------------|------|------------------------------|---------------|
| âœ”ï¸ | POST        | `/api/orders`           | å»ºç«‹å§”è¨— | gateway / liquidation-worker | jwt / private |
| âœ”ï¸ | GET         | `/api/orders/{orderId}` | æŸ¥è©¢è¨‚å–® | gateway , account            | jwt,private   |

## event

**äº‹ä»¶æ¶ˆè²»**:

| å®Œæˆ | Topic                       | äº‹ä»¶                  | è™•ç†é‚è¼¯                                 | äº‹ä»¶ç™¼å¸ƒ           |
|----|-----------------------------|---------------------|--------------------------------------|----------------|
| âœ”ï¸ | account.funds-frozen        | `FundsFrozen`       | ä¿è­‰é‡‘å‡çµæˆåŠŸï¼Œç‹€æ…‹è½‰ `NEW` ä¸¦ç™¼å¸ƒ `OrderCreated` | `OrderCreated` |
| âœ”ï¸ | account.funds-freeze-failed | `FundsFreezeFailed` | ä¿è­‰é‡‘å‡çµå¤±æ•—ï¼Œç‹€æ…‹è½‰ `REJECTED` ä¸¦ç´€éŒ„åŸå›          | -              |
| âœ”ï¸ | matching.trade-executed     | `TradeExecuted`     | è¨‚å–®æ›´æ–°æˆäº¤é‡ã€å‡åƒ¹ã€æ‰‹çºŒè²»èˆ‡ `filled_at`          | -              |

**äº‹ä»¶ç™¼å¸ƒ**:

| å®Œæˆ | ç™¼å¸ƒå ´æ™¯             | Topic                        | äº‹ä»¶åç¨±                   |
|----|------------------|------------------------------|------------------------|
| âœ”ï¸ | æ”¶åˆ°ç”¨æˆ¶/å¼·å¹³å§”è¨—ä¸¦å®ŒæˆåŸºæœ¬æ ¡é©— | order.funds-freeze-requested | `FundsFreezeRequested` |
| âœ”ï¸ | ä¿è­‰é‡‘å‡çµæˆåŠŸã€å§”è¨—æ­£å¼å»ºæª”   | order.created                | `OrderCreated`         |

---

## DDL

### orders è¡¨

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

### order_events è¡¨

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

##    

## å¦‚ä½•çŸ¥é“é–‹/å¹³å€‰?

é å€‰ä½åˆ¤æ–·ã€‚

`orders.side` åªæœ‰ BUY/SELLï¼Œç„¡æ³•ç›´æ¥è¡¨ç¤ºé–‹å€‰æˆ–å¹³å€‰ã€‚  
å¿…é ˆæŸ¥æ—¢æœ‰å€‰ä½æ‰èƒ½åˆ¤æ–·é–‹å¹³å€‰

## order type

LIMIT  
æŒ‡å®šåƒ¹æ ¼æˆ–æ›´å¥½åƒ¹æ ¼æˆäº¤

- åƒ¹æ ¼ = ä½¿ç”¨è€…æŒ‡å®š
- å¯æ›ç°¿
- ä¸ä¿è­‰æˆäº¤

MARKET  
ä»¥å¸‚å ´æœ€å„ªåƒ¹æ ¼ç«‹å³æˆäº¤

- åƒ¹æ ¼ = å¸‚åƒ¹
- ä¸æ›ç°¿
- ä¿è­‰ç›¡é‡æˆäº¤ï¼Œä½†æœ€çµ‚æˆäº¤åƒ¹ä¸ç¢ºå®š

STOP_LIMIT  
è§¸ç™¼åƒ¹ + é™åƒ¹

- å¸‚åƒ¹åˆ°é”ã€Œè§¸ç™¼åƒ¹ã€æ™‚ï¼Œè½‰ç‚º LIMIT å–®æ›å‡º
- å¯èƒ½å› é™åƒ¹æˆäº¤ä¸åˆ°è€Œå¤±æ•ˆ

STOP_MARKET  
è§¸ç™¼åƒ¹ + å¸‚åƒ¹

- å¸‚åƒ¹åˆ°é”ã€Œè§¸ç™¼åƒ¹ã€æ™‚ï¼Œè½‰ç‚º MARKET å–®
- æœƒç›¡é‡ç«‹å³æˆäº¤

## Order ç‹€æ…‹æ©Ÿ

```mermaid
stateDiagram-v2
    [*] --> CREATED : æ”¶åˆ°ä¸‹å–®è«‹æ±‚

    state "è³‡ç”¢æª¢æŸ¥èˆ‡é–å®šéšæ®µ (Pre-Match)" as PreMatch {
        %% åˆ†æµé‚è¼¯
        state fork_state <<choice>>
        CREATED --> fork_state : åˆ¤æ–·è¨‚å–®é¡å‹
        
        %% 1. ç´”é–‹å€‰è·¯å¾‘
        fork_state --> FREEZING_MARGIN : Open (é–‹å€‰)
        
        note right of FREEZING_MARGIN
            Accountæœå‹™
            å‡çµèµ·å§‹ä¿è­‰é‡‘
        end note
        
        FREEZING_MARGIN --> REJECTED : é¤˜é¡ä¸è¶³
        
        %% 2. ç´”å¹³å€‰è·¯å¾‘
        fork_state --> LOCKING_POSITION : Close (å¹³å€‰)
        
        note right of LOCKING_POSITION
            Positionæœå‹™
            æ¸›å°‘å¯ç”¨æŒå€‰
        end note
        
        LOCKING_POSITION --> REJECTED : æŒå€‰ä¸è¶³/é‡è¤‡é–å®š

        %% 3. åæ‰‹è·¯å¾‘
        fork_state --> FLIP_CALCULATING : Flip (åæ‰‹)
        FLIP_CALCULATING --> FLIP_LOCKING_ASSETS : è¨ˆç®—éœ€è£œä¿è­‰é‡‘ & é–å€‰
        
        note right of FLIP_LOCKING_ASSETS
            Positioné–å€‰
            Accountè£œè¶³å·®é¡
        end note
        
        FLIP_LOCKING_ASSETS --> REJECTED : é¤˜é¡æˆ–æŒå€‰ä¸è¶³
    }

    %% æˆåŠŸé–å®šå¾Œé€²å…¥è¨‚å–®ç°¿
    FREEZING_MARGIN --> NEW : é–å®šæˆåŠŸ
    LOCKING_POSITION --> NEW : é–å®šæˆåŠŸ
    FLIP_LOCKING_ASSETS --> NEW : é–å®šæˆåŠŸ

    state "æ’®åˆå¼•æ“éšæ®µ (Matching Engine)" as Matching {
        %% é€™è£¡å®šç¾© NEW ç‹€æ…‹çš„è¨»è§£
        note left of NEW
            è¨‚å–®å·²é€²å…¥
            OrderBook
        end note
        
        NEW --> PARTIALLY_FILLED : éƒ¨åˆ†æˆäº¤
        PARTIALLY_FILLED --> PARTIALLY_FILLED : ç¹¼çºŒæˆäº¤
        NEW --> FILLED : å®Œå…¨æˆäº¤
        PARTIALLY_FILLED --> FILLED : å®Œå…¨æˆäº¤
        
        %% å–æ¶ˆæµç¨‹
        NEW --> CANCELLING : ç”¨æˆ¶è«‹æ±‚å–æ¶ˆ
        PARTIALLY_FILLED --> CANCELLING : ç”¨æˆ¶è«‹æ±‚å–æ¶ˆ
        CANCELLING --> CANCELLED : æ’®åˆå¼•æ“ç¢ºèªç§»é™¤
    }

    %% çµ‚æ…‹
    REJECTED --> [*]
    FILLED --> [*]
    CANCELLED --> [*]
```

## timestamp

- `submitted_at`: åœ¨ `NEW` ç‹€æ…‹ï¼ˆç™¼å¸ƒ `OrderCreated` äº‹ä»¶çµ¦ Matchingï¼‰æ™‚è¨˜éŒ„
- `filled_at`: ç•¶ `remaining_quantity == 0` æ™‚è¨˜éŒ„ç•¶å‰æ™‚é–“
- `cancelled_at`: åœ¨è™•ç†æ’¤å–®æ™‚è¨˜éŒ„

## ä¸€è‡´æ€§æ•ˆé©—

- **æœ€çµ‚ä¸€è‡´æ€§**: è¨‚å–®ç‹€æ…‹é€šéäº‹ä»¶é©…å‹•æœ€çµ‚èˆ‡æ’®åˆçµæœä¿æŒä¸€è‡´
- æœ€çµ‚ç‹€æ…‹ FILLED, CANCELLED, REJECTED
- **ç‹€æ…‹æ ¡é©—**: å®šæ™‚ä»»å‹™æƒæé•·æ™‚é–“åœç•™åœ¨ `PARTIALLY_FILLED` çš„è¨‚å–®
- **å°è³¬æ©Ÿåˆ¶**: èˆ‡ Matching å¼•æ“çš„ `trade` è¡¨é€²è¡Œå®šæœŸå°è³¬

##    

## Event Sourcing

`order_events` è¡¨å¯¦ç¾**äº‹ä»¶æº¯æº (Event Sourcing)** æ¨¡å¼ï¼Œè¨˜éŒ„å§”è¨—åœ¨æ•´å€‹ç”Ÿå‘½é€±æœŸä¸­çš„æ‰€æœ‰ç‹€æ…‹è®Šæ›´èˆ‡é—œéµæ“ä½œã€‚

### æ ¸å¿ƒè·è²¬

1. **å®Œæ•´å¯©è¨ˆè¿½è¹¤**ï¼šè¨˜éŒ„è¨‚å–®å¾å‰µå»ºåˆ°å®Œæˆ/å–æ¶ˆçš„æ‰€æœ‰ç‹€æ…‹è½‰æ›
2. **æ•…éšœæ¢å¾©**ï¼šç³»çµ±æ•…éšœæ™‚å¯å¾äº‹ä»¶æµé‡å»ºè¨‚å–®ç‹€æ…‹
3. **è¡Œç‚ºåˆ†æ**ï¼šä¾›é¢¨æ§èˆ‡å ±è¡¨ç³»çµ±åˆ†æç”¨æˆ¶äº¤æ˜“è¡Œç‚º
4. **åˆè¦è¦æ±‚**ï¼šæ»¿è¶³é‡‘èç›£ç®¡å°äº¤æ˜“è¨˜éŒ„çš„å®Œæ•´æ€§è¦æ±‚

### ä½¿ç”¨ç¤ºä¾‹

**1. å†ªç­‰æ€§æª¢æŸ¥ï¼ˆé¿å…é‡è¤‡è™•ç† TradeExecutedï¼‰**

```sql
-- æª¢æŸ¥ trade æ˜¯å¦å·²è™•ç†
SELECT COUNT(*)
FROM order_events
WHERE order_id = ?
  AND reference_type = 'TRADE'
  AND reference_id = ?;
-- trade_id

-- è‹¥ COUNT = 0ï¼Œå‰‡è™•ç†ï¼›å¦å‰‡è·³é
```

**2. è¨ˆç®—è¨‚å–®äº‹ä»¶åºè™Ÿ**

```sql
-- æ’å…¥æ–°äº‹ä»¶æ™‚è‡ªå‹•è¨ˆç®— sequence_number
INSERT INTO order_events (event_id, order_id, user_id, instrument_id, event_type,
                          payload, actor, occurred_at, sequence_number)
SELECT ?,
       ?,
       ?,
       ?,
       ?,
       ?,
       ?,
       ?,
       COALESCE(MAX(sequence_number), 0) + 1
FROM order_events
WHERE order_id = ?;
```

**3. æŸ¥è©¢è¨‚å–®å®Œæ•´ç”Ÿå‘½é€±æœŸ**

```sql
SELECT event_type,
       payload,
       actor,
       occurred_at,
       sequence_number
FROM order_events
WHERE order_id = ?
ORDER BY sequence_number ASC;
```

**4. é‡æ”¾äº‹ä»¶é‡å»ºè¨‚å–®ç‹€æ…‹**

```java
public Order rebuildOrderFromEvents(Long orderId) {
    // æŒ‰åºè™Ÿé †åºåŠ è¼‰æ‰€æœ‰äº‹ä»¶
    List<OrderEvent> events = jdbcTemplate.query(
            "SELECT * FROM order_events WHERE order_id = ? ORDER BY sequence_number ASC",
            new Object[]{orderId},
            orderEventRowMapper
                                                );
    
    // åˆå§‹åŒ–è¨‚å–®å°è±¡
    Order order = new Order();
    
    // é€ä¸€æ‡‰ç”¨äº‹ä»¶é‡å»ºç‹€æ…‹
    for (OrderEvent event : events) {
        order.applyEvent(event);
    }
    
    return order;
}
```

### ä½¿ç”¨ç¯„ä¾‹

**1. æŸ¥è©¢è¨‚å–®å®Œæ•´æ­·å²**

```sql
SELECT event_type, payload, occurred_at, actor
FROM order_events
WHERE order_id = ?
ORDER BY occurred_at ASC;
```

**2. é‡å»ºè¨‚å–®ç‹€æ…‹ï¼ˆäº‹ä»¶é‡æ’­ï¼‰**

```java
public Order rebuildOrderFromEvents(String orderId) {
    List<OrderEvent> events = orderEventRepository.findByOrderId(orderId);
    Order order = new Order();
    
    for (OrderEvent event : events) {
        order.apply(event); // é€ä¸€å¥—ç”¨äº‹ä»¶é‡å»ºç‹€æ…‹
    }
    
    return order;
}
```

**3. é¢¨æ§åˆ†æï¼šçµ±è¨ˆç”¨æˆ¶é »ç¹æ’¤å–®è¡Œç‚º**

```sql
SELECT user_id, COUNT(*) as cancel_count
FROM order_events
WHERE event_type = 'ORDER_CANCEL_REQUESTED'
  AND occurred_at > NOW() - INTERVAL 1 HOUR
GROUP BY user_id
HAVING cancel_count > 10;
```

**4. åˆè¦å ±è¡¨ï¼šå°å‡ºç‰¹å®šæ™‚æ®µæ‰€æœ‰è¨‚å–®äº‹ä»¶**

```sql
SELECT oe.*, o.user_id, o.instrument_id
FROM order_events oe
         JOIN orders o ON oe.order_id = o.order_id
WHERE oe.occurred_at BETWEEN '2024-01-01' AND '2024-01-31'
ORDER BY oe.occurred_at;
```

### è¨­è¨ˆåŸå‰‡

1. **ä¸å¯è®Šæ€§ (Immutable)**ï¼šäº‹ä»¶ä¸€æ—¦å¯«å…¥ï¼Œæ°¸ä¸ä¿®æ”¹æˆ–åˆªé™¤
2. **é †åºæ€§ (Sequential)**ï¼šåŒä¸€è¨‚å–®çš„äº‹ä»¶æŒ‰æ™‚é–“é †åºå¯«å…¥
3. **å†ªç­‰æ€§ (Idempotent)**ï¼šé‡è¤‡å¯«å…¥åŒä¸€äº‹ä»¶ä¸å½±éŸ¿ç³»çµ±ç‹€æ…‹
4. **å®Œæ•´æ€§ (Complete)**ï¼šæ‰€æœ‰ç‹€æ…‹è®Šæ›´éƒ½å¿…é ˆè¨˜éŒ„äº‹ä»¶
5. **è¼•é‡åŒ– Payload**ï¼šåªè¨˜éŒ„è®Šæ›´éƒ¨åˆ†ï¼Œé¿å…å†—é¤˜å®Œæ•´è¨‚å–®æ•¸æ“š

## event_typeã€reference_typeã€reference_idã€Actor

## äº‹ä»¶ä¿ç•™ç­–ç•¥

- **ç†±æ•¸æ“š**ï¼šæœ€è¿‘ 3 å€‹æœˆçš„äº‹ä»¶ä¿ç•™åœ¨ä¸»è¡¨
- **å†·æ•¸æ“š**ï¼š3 å€‹æœˆä»¥ä¸Šçš„äº‹ä»¶æ­¸æª”è‡³ `order_events_archive` è¡¨
- **å£“ç¸®å­˜å„²**ï¼šæ­·å²äº‹ä»¶å¯ä½¿ç”¨ JSON å£“ç¸®å­˜å„²ç¯€çœç©ºé–“
- **åˆè¦è¦æ±‚**ï¼šè‡³å°‘ä¿ç•™ 7 å¹´çš„å®Œæ•´äº¤æ˜“è¨˜éŒ„

# Matching æœå‹™

## API

Matching Service ä¸æä¾›å¤–éƒ¨ HTTP APIï¼Œä¸»è¦é€šé Kafka é€²è¡ŒéåŒæ­¥é€šè¨Šã€‚

## event

**äº‹ä»¶æ¶ˆè²»**:

| å®Œæˆ | Topic         | äº‹ä»¶             | è™•ç†é‚è¼¯                     | äº‹ä»¶ç™¼å¸ƒ                                                              |
|----|---------------|----------------|--------------------------|-------------------------------------------------------------------|
| âœ”ï¸ | order.created | `OrderCreated` | å°‡å§”è¨—æ”¾å…¥è¨‚å–®ç°¿ä¸¦è§¸ç™¼æ’®åˆæµç¨‹ï¼Œçµæœå¯«å…¥ WAL | é€šé Async Loader å¯«å…¥ Outbox -> `OrderBookUpdated` / `TradeExecuted` |

**äº‹ä»¶ç™¼å¸ƒ (via CDC Outbox)**:

| å®Œæˆ | ç™¼å¸ƒå ´æ™¯       | Topic                      | äº‹ä»¶åç¨±               |
|----|------------|----------------------------|--------------------|
| âœ”ï¸ | è¨‚å–®ç°¿ç”¢ç”Ÿä»»ä½•è®ŠåŒ–  | matching.orderbook-updated | `OrderBookUpdated` |
| âœ”ï¸ | æ’®åˆæˆäº¤ç”¢ç”Ÿæˆäº¤æ˜ç´° | matching.trade-executed    | `TradeExecuted`    |

---

## DDL

### trade è¡¨ - æˆäº¤ç´€éŒ„

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

##    

## Taker / Maker

Taker / Maker æ˜¯æ’®åˆæ™‚å…©ç¨®è§’è‰²çš„ç°¡å–®åˆ†é¡ã€‚

Maker

- å…ˆæŠŠè¨‚å–®æ›åœ¨ order book
- ç­‰åˆ¥äººä¾†æˆäº¤
- è¢«å‹•
- æä¾›æµå‹•æ€§
- é€šå¸¸æ‰‹çºŒè²»è¼ƒä½æˆ–è¿”å‚­
  ä¾‹
- æˆ‘æ›ä¸€å¼µ LIMIT BUY 100 ç­‰äººè³£çµ¦æˆ‘ â†’ æˆ‘æ˜¯ Maker

  Taker
- ä¸»å‹•åƒæ‰ order book ä¸Šçš„è¨‚å–®
- ç«‹å³æˆäº¤
- æ¶ˆè€—æµå‹•æ€§
- é€šå¸¸æ‰‹çºŒè²»è¼ƒé«˜
  ä¾‹
- å¸‚åƒ¹è²·å…¥ï¼Œæ’®åˆåˆ°å°æ‰‹åƒ¹æ ¼ â†’ æˆ‘æ˜¯ Taker
- æˆ–ç”¨é™åƒ¹å–®ä½†åƒ¹æ ¼è¶Šéè¡Œæƒ…ç›´æ¥æˆäº¤ â†’ é‚„æ˜¯ Taker

---
åˆ¤æ–·æ–¹å¼

- å…ˆåœ¨ç°¿ä¸Šç­‰å¾… â†’ Maker
- å–®å­ä¸€é€²å ´å°±ç«‹å³æˆäº¤ â†’ Taker

  é—œéµ
- **åªæœ‰ Taker æœƒæ±ºå®šæˆäº¤æ–¹å‘**
- Maker æ˜¯å¦è²·è³£ä¸å½±éŸ¿ `trade.side` å®šç¾©

  ç°¡è¡¨
- Maker = æ›å–®
- Taker = åƒå–®

## Order Side

åœ¨æ’®åˆäº¤æ˜“çš„å®šç¾©ä¸­ï¼Œ**æˆäº¤æ–¹å‘æ°¸é ç”± Takerï¼ˆåƒå–®æ–¹/ä¸»å‹•æ–¹ï¼‰æ±ºå®š**ã€‚

- **Taker æ˜¯è²·æ–¹ (BUY)**ï¼šä»£è¡¨ä¸»å‹•è²·å…¥åƒæ‰æ›å–®ï¼Œæ¨å‡åƒ¹æ ¼ï¼Œé€™ç­†æˆäº¤è¢«å®šç¾©ç‚º **"BUY"**ï¼ˆç¶ è‰²ï¼‰ã€‚
- **Taker æ˜¯è³£æ–¹ (SELL)**ï¼šä»£è¡¨ä¸»å‹•è³£å‡ºç ¸ç›¤ï¼Œå£“ä½åƒ¹æ ¼ï¼Œé€™ç­†æˆäº¤è¢«å®šç¾©ç‚º **"SELL"**ï¼ˆç´…è‰²ï¼‰ã€‚

ä¾‹å¦‚:
K ç·šè¨ˆç®—ï¼šéœ€è¦è¨ˆç®—ã€Œä¸»å‹•è²·å…¥é‡ (Taker Buy Volume)ã€èˆ‡ã€Œä¸»å‹•è³£å‡ºé‡ã€ã€‚
å°±å¯ä»¥æ­¤å­—æ®µé€²è¡Œèšåˆ

## Order Book

### æ ¸å¿ƒæ¦‚å¿µ

- **åƒ¹æ ¼å±¤ç´š (Price Level)**: è¨‚å–®ç°¿ä¸­ç‰¹å®šåƒ¹æ ¼ä¸Šçš„æ‰€æœ‰æ›å–®çš„é›†åˆã€‚
- **æœ€ä½³è³£åƒ¹ (Best Ask)**: è³£ç›¤ä¸­åƒ¹æ ¼æœ€ä½çš„æ›å–®åƒ¹æ ¼ã€‚
- **æœ€ä½³è²·åƒ¹ (Best Bid)**: è²·ç›¤ä¸­åƒ¹æ ¼æœ€é«˜çš„æ›å–®åƒ¹æ ¼ã€‚
- **åƒ¹å·® (Spread)**: æœ€ä½³è³£åƒ¹èˆ‡æœ€ä½³è²·åƒ¹ä¹‹é–“çš„å·®é¡ (Best Ask - Best Bid)ã€‚
- **æµå‹•æ€§ (Liquidity)**: è¨‚å–®ç°¿ä¸­å„å€‹åƒ¹æ ¼å±¤ç´šä¸Šçš„æ›å–®æ•¸é‡ï¼Œåæ˜ äº†å¸‚å ´çš„æ·±åº¦å’Œäº¤æ˜“çš„ä¾¿åˆ©æ€§ã€‚

### è¨‚å–®ç°¿æ“ä½œ

- **æ›å–® (Place Order)**: æ–°çš„é™åƒ¹å–®é€²å…¥è¨‚å–®ç°¿ï¼Œå¢åŠ å°æ‡‰åƒ¹æ ¼å±¤ç´šçš„æ•¸é‡ã€‚
- **æ’¤å–® (Cancel Order)**: è¨‚å–®å¾è¨‚å–®ç°¿ä¸­ç§»é™¤ï¼Œæ¸›å°‘å°æ‡‰åƒ¹æ ¼å±¤ç´šçš„æ•¸é‡ã€‚
- **æ’®åˆ (Match Order)**: ç•¶è²·è³£é›™æ–¹åƒ¹æ ¼æ»¿è¶³æ’®åˆæ¢ä»¶æ™‚ï¼Œè¨‚å–®å¾è¨‚å–®ç°¿ä¸­ç§»é™¤ä¸¦ç”Ÿæˆæˆäº¤ã€‚

##    

## Kafka

- key ç”¨ instrument_id ä¿åº
- batch æ‹‰å–
- ç•°æ­¥ ack
- å…ˆå¯« WAL å†æäº¤ack

# Market æœå‹™

## API

| å®Œæˆ | HTTP Method | Endpoint                                | èªªæ˜          | èª¿ç”¨è€…              | æˆæ¬Š     |
|----|-------------|-----------------------------------------|-------------|------------------|--------|
| âœ”ï¸ | GET         | `/api/market/tickers/{instrumentId}`    | æœ€æ–°è¡Œæƒ…è³‡è¨Š      | gateway          | public |
| âœ”ï¸ | GET         | `/api/market/orderbook/{instrumentId}`  | ç•¶å‰è¨‚å–®ç°¿æ·±åº¦èˆ‡æœ€ä½³åƒ¹ | gateway          | public |
| âœ”ï¸ | GET         | `/api/market/kline`                     | Kç·šæŸ¥è©¢        | gateway          | public |
| âœ”ï¸ | GET         | `/api/market/mark-price/{instrumentId}` | è®€å–æœ€æ–°æ¨™è¨˜åƒ¹     | risk / positions | public |

## event

**äº‹ä»¶æ¶ˆè²»**:

| å®Œæˆ | Topic                      | äº‹ä»¶                 | è™•ç†é‚è¼¯                                            | äº‹ä»¶ç™¼å¸ƒ                               |
|----|----------------------------|--------------------|-------------------------------------------------|------------------------------------|
| âœ”ï¸ | matching.orderbook-updated | `OrderBookUpdated` | é‡å»ºæŒ‡å®š instrument çš„è²·è³£ç›¤æ·±åº¦ã€bestBid/bestAsk/midPrice | -                                  |
| âœ”ï¸ | matching.trade-executed    | `TradeExecuted`    | æ›´æ–°Tickerã€ç”ŸæˆKç·šã€æ¨é€æˆäº¤                              | `MarkPriceUpdated` / `KlineClosed` |

**äº‹ä»¶ç™¼å¸ƒ**:

| å®Œæˆ | ç™¼å¸ƒå ´æ™¯           | Topic                   | äº‹ä»¶åç¨±                     |
|----|----------------|-------------------------|--------------------------|
| âœ”ï¸ | æ¨™è¨˜åƒ¹æ ¼é‡æ–°è¨ˆç®—å®Œæˆ     | market.mark-price       | `MarkPriceUpdated`       |
|    | ~~å®šæœŸç”¢å‡ºæ–°çš„è³‡é‡‘è²»ç‡~~ | ~~market.funding-rate~~ | ~~`FundingRateUpdated`~~ |
|    | ~~Kç·šé€±æœŸçµæŸ~~     | ~~market.kline~~        | ~~`KlineClosed`~~        |

---

## DDL

### kline_buckets è¡¨ - Kç·š

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

### mark_price_snapshots è¡¨ - index_price / mark_price

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

# Account æœå‹™è¨­è¨ˆè¦æ ¼æ›¸

## API ä»‹é¢è¦æ ¼

|    | **HTTP Method** | **Endpoint**                           | **èªªæ˜**                     | **èª¿ç”¨è€…**            | **æˆæ¬Š**       |
|----|-----------------|----------------------------------------|----------------------------|--------------------|--------------|
| âœ”ï¸ | **GET**         | `/api/account/balances?userId=&asset=` | æŸ¥è©¢ SPOT/MARGIN ç­‰å¸³æˆ¶çš„é¤˜é¡èˆ‡å¯ç”¨è³‡é‡‘ | Gateway, Risk      | JWT, Private |
| âœ”ï¸ | **POST**        | `/api/account/deposits`                | éˆä¸Š/æ³•å¹£å„²å€¼å…¥å¸³ (ç³»çµ±å…§éƒ¨èª¿ç”¨)         | Wallet-Sync, Admin | Private      |
| âœ”ï¸ | **POST**        | `/api/account/withdrawals`             | å‡ºé‡‘ç”³è«‹èˆ‡æ‰£å¸³                    | Wallet, Admin      | Private      |

---

## äº‹ä»¶é©…å‹•æ¶æ§‹ (Event Architecture)

### äº‹ä»¶æ¶ˆè²» (Consume)

|    | **Topic**                              | **äº‹ä»¶åç¨±**                          | **è™•ç†é‚è¼¯**                                                                                                             |
|----|----------------------------------------|-----------------------------------|----------------------------------------------------------------------------------------------------------------------|
| âœ”ï¸ | `order.funds-freeze-requested`         | `FundsFreezeRequested`            | **é è™•ç†è³‡é‡‘**ï¼šæ”¶åˆ°ä¸‹å–®è«‹æ±‚ï¼Œæª¢æŸ¥é¤˜é¡ä¸¦åŸ·è¡Œå‡çµï¼ˆæ›´æ–° `user_accounts` ç‹€æ…‹ï¼‰ã€‚                                                                   |
| âœ”ï¸ | `matching.trade-executed`              | `TradeExecuted`                   | **é–‹å€‰çµç®—**ï¼šåƒ…è™•ç† `makerIntent/takerIntent = INCREASE` çš„æˆäº¤ï¼›æ‰£é™¤å‡çµã€è¨ˆç®—æ‰‹çºŒè²»ä¸¦å°‡ `SPOT Reserved` è½‰å…¥ `Isolated Margin`ï¼ˆMaker é€€å›å·®é¡ï¼‰ã€‚ |
| âœ”ï¸ | `positions.margin-released`            | `PositionMarginReleased`          | **å¹³å€‰çµç®—**ï¼šå°‡é€å€‰ä¿è­‰é‡‘è½‰å› `SPOT Available`ï¼Œä¸¦æ ¹æ“šå·²å¯¦ç¾ç›ˆè™§èª¿æ•´é¤˜é¡ã€‚                                                                     |
| âœ”ï¸ | `positions.close-to-open-compensation` | `PositionCloseToOpenCompensation` | **è£œå„Ÿçµç®—**ï¼šå¹³å€‰æˆäº¤ç„¡å¯å¹³å€‰ä½æ™‚ï¼Œè¦–ç‚ºé–‹å€‰ï¼›ä¸ä¾è³´é æ‰£ç›´æ¥çµç®—ä¿è­‰é‡‘/æ‰‹çºŒè²»ï¼Œå…è¨±è² æ•¸ä¸¦è¨˜éŒ„åŸå› ã€‚                                                                 |

### äº‹ä»¶ç™¼å¸ƒ (Publish)

|    | **Topic**                      | **äº‹ä»¶åç¨±**             | **ç™¼å¸ƒå ´æ™¯**                      |
|----|--------------------------------|----------------------|-------------------------------|
| âœ”ï¸ | `account.funds-frozen`         | `FundsFrozen`        | é–‹å€‰å‰ï¼Œè³‡é‡‘å‡çµæˆåŠŸï¼Œé€šçŸ¥ Order æœå‹™æ¨é€²ç‹€æ…‹    |
| âœ”ï¸ | `account.funds-freeze-failed`  | `FundsFreezeFailed`  | é–‹å€‰å‰ï¼Œè³‡é‡‘ä¸è¶³æˆ–å‡çµå¤±æ•—                 |
| âœ”ï¸ | `account.trade-margin-settled` | `TradeMarginSettled` | æˆäº¤å¾Œï¼Œå®Œæˆä¿è­‰é‡‘çš„çµè½‰ï¼ˆå¾ç¾è²¨è½‰å…¥åˆç´„å€‰ä½ï¼‰èˆ‡æ‰‹çºŒè²»æ‰£é™¤ |

---

## è³‡æ–™åº«è¨­è¨ˆ (DDL)

æ¡ç”¨ **å¹³å° (Platform)** èˆ‡ **ç”¨æˆ¶ (User)** å…©å¥—ç¨ç«‹å¸³æœ¬ï¼Œä¸¦å€åˆ† **å¸³æˆ¶ç‹€æ…‹ (Accounts)** èˆ‡ **è³‡é‡‘æµæ°´ (Journals)**ã€‚

### å¹³å°ç¸½å¸³ (`platform_accounts`)

å…¬å¸çš„ç¸½åˆ†é¡å¸³ (General Ledger)ã€‚

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

---

## äº¤æ˜“æ‰€å¸³å‹™ç³»çµ±è¨­è¨ˆåŸå‰‡ (Double-Entry Ledger Principles)

ç³»çµ±æ¡ç”¨ **é›™è¦–è§’é›™åˆ†éŒ„ (Dual-View Double-Entry)** æ¶æ§‹ã€‚å¹³å°å¸³èˆ‡ç”¨æˆ¶å¸³é‚è¼¯é—œè¯ä½†ç‰©ç†å­˜å„²è§£è€¦ã€‚

### æœƒè¨ˆæ†ç­‰å¼

$$Asset (è³‡ç”¢) + Expense (è²»ç”¨) = Liability (è² å‚µ) + Equity (æ¬Šç›Š) + Revenue (æ”¶å…¥)$$

ç§»é …å¾Œ (æ·¨å€¼è§€é»)ï¼š

$$Equity (æ·¨å€¼) = Assets - Liabilities + (Revenue - Expense)$$

### å€Ÿè²¸æ³•å‰‡ (Debit & Credit Rules)

| **è¦ç´  (Category)**  | **DEBIT (å€Ÿ/å·¦)** | **CREDIT (è²¸/å³)** | **å¹³å°å¸³ç¯„ä¾‹** | **ç”¨æˆ¶å¸³ç¯„ä¾‹** |
|--------------------|-----------------|------------------|-----------|-----------|
| **ASSET (è³‡ç”¢)**     | **å¢åŠ  (+)**      | æ¸›å°‘ (-)           | ç†±éŒ¢åŒ…       | ç¾è²¨é¤˜é¡      |
| **EXPENSE (è²»ç”¨)**   | **å¢åŠ  (+)**      | æ¸›å°‘ (-)           | è¿”å‚­æ”¯å‡º      | æ‰‹çºŒè²»æ”¯å‡º     |
| **LIABILITY (è² å‚µ)** | æ¸›å°‘ (-)          | **å¢åŠ  (+)**       | ç”¨æˆ¶å­˜æ¬¾ç¸½è² å‚µ   | èè³‡å€Ÿæ¬¾      |
| **EQUITY (æ¬Šç›Š)**    | æ¸›å°‘ (-)          | **å¢åŠ  (+)**       | é¢¨éšªæº–å‚™é‡‘     | æŠ•å…¥æœ¬é‡‘ã€æç›Š   |
| **REVENUE (æ”¶å…¥)**   | æ¸›å°‘ (-)          | **å¢åŠ  (+)**       | æ‰‹çºŒè²»æ”¶å…¥     | è³‡é‡‘è²»æ”¶å…¥     |

---

## é—œéµæ¥­å‹™å ´æ™¯åˆ†éŒ„ (Scenarios)

### ç”¨æˆ¶å…¥é‡‘ (Deposit)

ç”¨æˆ¶å……å€¼ 1000 USDTã€‚

- **ç”¨æˆ¶å´ (`user_journal`)**ï¼š
    - å€Ÿ (Dr) **Asset** (ç¾è²¨éŒ¢åŒ…) +1000
    - è²¸ (Cr) **Equity** (æŠ•å…¥æœ¬é‡‘) +1000
    - _èªªæ˜ï¼šç”¨æˆ¶è³‡ç”¢å¢åŠ ï¼Œæ¬Šç›Šå¢åŠ ã€‚_
- **å¹³å°å´ (`platform_journal`)**ï¼š
    - å€Ÿ (Dr) **Asset** (ç†±éŒ¢åŒ…) +1000
    - è²¸ (Cr) **Liability** (ç”¨æˆ¶å­˜æ¬¾è² å‚µ) +1000
    - _èªªæ˜ï¼šå¹³å°æŒæœ‰è³‡ç”¢å¢åŠ ï¼ŒåŒæ™‚å°ç”¨æˆ¶çš„è² å‚µå¢åŠ ã€‚_

### å¹³å°æ³¨å…¥é¢¨éšªæº–å‚™é‡‘ (Insurance Fund Injection)

å¹³å°å°‡è‡ªæœ‰è³‡é‡‘ 5000 USDT æ³¨å…¥æº–å‚™é‡‘ã€‚

- **å¹³å°å´ (`platform_journal`)**ï¼š
    - å€Ÿ (Dr) **Asset** (æº–å‚™é‡‘éŒ¢åŒ…) +5000
    - è²¸ (Cr) **Equity** (é¢¨éšªæº–å‚™é‡‘) +5000
    - _èªªæ˜ï¼šå¹³å°å…§éƒ¨æ¬Šç›Šæ³¨è³‡ï¼Œä¸æ¶‰åŠç”¨æˆ¶è² å‚µã€‚_

### ä¸‹å–®é æ‰£ (Order Freezing)

ç”¨æˆ¶ä¸‹å–®ï¼Œå‡çµ 100 USDTã€‚

- **ç”¨æˆ¶å´ (`user_accounts`)**ï¼š
    - æ›´æ–°ç‹€æ…‹ï¼š`Available` -100, `Reserved` +100
    - **æ³¨æ„**ï¼šé€šå¸¸**ä¸ç”¢ç”Ÿ** `user_journal` æµæ°´ï¼Œå› ç‚ºç¸½è³‡ç”¢ (Balance) æœªè®Šï¼Œåƒ…åšå…§éƒ¨ç‹€æ…‹æ¨™è¨˜ã€‚è©³ç´°å‡çµæ­·ç¨‹ç”± `Order` æœå‹™çš„
      `Event Sourcing` è² è²¬ã€‚

### äº¤æ˜“æ‰‹çºŒè²» (Trading Fee)

ç”¨æˆ¶æ”¯ä»˜ 1 USDT æ‰‹çºŒè²»ã€‚

- **ç”¨æˆ¶å´ (`user_journal`)**ï¼š
    - è²¸ (Cr) **Asset** (ç¾è²¨éŒ¢åŒ…) 1.0
    - å€Ÿ (Dr) **Expense** (æ‰‹çºŒè²»æ”¯å‡º) 1.0
    - _èªªæ˜ï¼šç”¨æˆ¶è³‡ç”¢æ¸›å°‘ï¼Œè²»ç”¨å¢åŠ ï¼ˆè¦–ç‚ºæ¬Šç›Šæ¸›å°‘ï¼‰ã€‚_
- **å¹³å°å´ (`platform_journal`)**ï¼š
    - å€Ÿ (Dr) **Liability** (ç”¨æˆ¶å­˜æ¬¾è² å‚µ) 1.0
    - è²¸ (Cr) **Revenue** (æ‰‹çºŒè²»æ”¶å…¥) 1.0
    - _èªªæ˜ï¼šå¹³å°å°ç”¨æˆ¶çš„è² å‚µæ¸›å°‘ï¼ˆå› ç‚ºç”¨æˆ¶éŒ¢å°‘äº†ï¼‰ï¼Œç¢ºèªç‚ºå¹³å°æ”¶å…¥ã€‚_

**çµç®—æ™‚**ï¼šåªæœ‰åœ¨æœˆåº•æˆ–å¹´åº•ã€Œçµå¸³ã€æ™‚ï¼Œæœƒè¨ˆç³»çµ±æ‰æœƒæŠŠæ‰€æœ‰çš„ `Expense` ç¸½çµï¼Œå¾ `Equity` ä¸­ä¸€æ¬¡æ‰£é™¤ã€‚
**å¦‚æœä¸é€™æ¨£åšï¼ˆéŒ¯èª¤ç¤ºç¯„ï¼‰ï¼š** å¦‚æœä½ ç›´æ¥å¯« `Debit Equity`ï¼Œä½ å°±ç„¡æ³•çµ±è¨ˆã€Œé€™å€‹æœˆæ‰‹çºŒè²»èŠ±äº†å¤šå°‘ï¼Ÿã€ã€ã€Œè³‡é‡‘è²»ä»˜äº†å¤šå°‘ï¼Ÿã€ï¼Œå› ç‚ºæ‰€æœ‰ç´°ç¯€éƒ½æ··åœ¨æ¬Šç›Šæœ¬é‡‘è£¡äº†ã€‚

### å¯¦ç¾ç›ˆè™§ (Realized PnL)

ç”¨æˆ¶å¹³å€‰ç²åˆ© 50 USDTã€‚

- **ç”¨æˆ¶å´ (`user_journal`)**ï¼š
    - å€Ÿ (Dr) **Asset** (ä¿è­‰é‡‘é¤˜é¡) 50
    - è²¸ (Cr) **Equity** (å·²å¯¦ç¾ç›ˆè™§) 50
    - _èªªæ˜ï¼šè³‡ç”¢å¢åŠ ï¼Œæ¬Šç›Šï¼ˆç²åˆ©ï¼‰å¢åŠ ã€‚_
- **å¹³å°å´ (`platform_journal`)**ï¼š
    - å€Ÿ (Dr) **Liability** (è™§æç”¨æˆ¶çš„ä¿è­‰é‡‘) 50
    - è²¸ (Cr) **Liability** (ç²åˆ©ç”¨æˆ¶çš„ä¿è­‰é‡‘) 50
    - _èªªæ˜ï¼šåˆç´„äº¤æ˜“ç‚ºé›¶å’ŒéŠæˆ²ï¼Œå¹³å°ç¸½è² å‚µä¸è®Šï¼Œåƒ…æ˜¯è² å‚µå°è±¡è½‰ç§»ã€‚_

---

## å ±è¡¨èƒ½åŠ› (Reporting)

åŸºæ–¼æ­¤æ¶æ§‹ï¼Œç³»çµ±å¯ç›´æ¥æ”¯æ´ä»¥ä¸‹è²¡å‹™å ±è¡¨ï¼š

- **ç”¨æˆ¶å€‹äººæç›Šè¡¨**ï¼šçµ±è¨ˆ `user_journal` ä¸­ `REVENUE` èˆ‡ `EXPENSE` é¡åˆ¥çš„ç¸½å’Œã€‚
- **ç”¨æˆ¶è³‡ç”¢è² å‚µè¡¨**ï¼šAsset (å­˜æ¬¾) = Liability (å€Ÿæ¬¾) + Equity (æœ¬é‡‘+æç›Š)ã€‚
- **å¹³å°è³‡ç”¢è² å‚µè¡¨ & PoR (å„²å‚™è­‰æ˜)**ï¼šé©—è­‰ `Platform Asset` (éŒ¢åŒ…é¤˜é¡) >= `Platform Liability` (ç”¨æˆ¶ç¸½è³‡ç”¢)ã€‚
- **å¹³å°æç›Šè¡¨**ï¼šçµ±è¨ˆ `platform_accounts` ä¸­æ‰‹çºŒè²»æ”¶å…¥èˆ‡ç‡Ÿé‹æ”¯å‡ºã€‚

# Positions æœå‹™è¨­è¨ˆè¦æ ¼æ›¸

## æœå‹™å•Ÿå‹•èˆ‡åˆå§‹åŒ– (Startup & Caching)

Positions æœå‹™å¿…é ˆåœ¨å•Ÿå‹•æ™‚é ç†±æ‰€æœ‰äº¤æ˜“å°çš„éœæ…‹é…ç½®èˆ‡é¢¨æ§åƒæ•¸ï¼Œä»¥ä¿è­‰é«˜ä½µç™¼ä¸‹çš„ä½å»¶é²è¨ˆç®—ã€‚

å•Ÿå‹•æµç¨‹

- **ç›£è½å•Ÿå‹•äº‹ä»¶**ï¼šç›£è½ `ApplicationReadyEvent`ã€‚
- **è¼‰å…¥åŸºç¤é…ç½®**ï¼š
    - å‘¼å« Admin Service (`GET /api/admin/instruments`) ç²å–æ‰€æœ‰äº¤æ˜“å°ç‹€æ…‹ã€‚
- **è¼‰å…¥Mark Price**ï¼š
    - å‘¼å« Market Service (`GET /api/market/mark-price/{instrumentId}`) ç²å–æ‰€æœ‰äº¤æ˜“å°çš„ Mark Priceã€‚
    - æ›´æ–° `MarkPriceCache` èˆ‡é‡ç®—æ‰€æœ‰å€‰ä½çš„ `unrealized_pnl` èˆ‡ `liquidation_price`ã€‚
- **è¼‰å…¥é¢¨æ§é…ç½®**ï¼š
    - å‘¼å« Risk Service (`GET /api/risk/limits/{instrumentId}`) ç²å– `RiskLimitResponse`ã€‚
    - é—œéµåƒæ•¸ï¼š`initialMarginRate`, `maxLeverage`, `maintenanceMarginRate`, `liquidationFeeRate` ç­‰ã€‚
- **å»ºç«‹æœ¬åœ°å¿«å–**ï¼š
    - ä½¿ç”¨ Caffeine æˆ– ConcurrentHashMap æ§‹å»ºå…©å±¤ Cacheï¼š
        - `instrumentCache`: `Map<Long, InstrumentSummary>`
        - `riskLimitCache`: `Map<Long, RiskLimit>`
- **éŒ¯èª¤è™•ç†æ©Ÿåˆ¶**ï¼š
    - ä¾è³´æœå‹™ä¸å¯ç”¨æ™‚ï¼ŒåŸ·è¡Œæœ‰é™æ¬¡æ•¸çš„æŒ‡æ•¸é€€é¿é‡è©¦ã€‚
    - è‹¥åˆå§‹åŒ–å¤±æ•—ç‡è¶…éé–¾å€¼ï¼ˆCritical Failureï¼‰ï¼Œé˜»æ­¢æœå‹™å•Ÿå‹•ä»¥é¿å…è™•ç†éŒ¯èª¤æ¥­å‹™ã€‚
- **æ›´æ–°ç­–ç•¥**ï¼š
    - **å®šæ™‚åˆ·æ–°**ï¼šæ¯ 5 åˆ†é˜å…¨é‡åŒæ­¥ä¸€æ¬¡ã€‚
    - **äº‹ä»¶é©…å‹•**ï¼šè¨‚é–± `InstrumentUpdated` èˆ‡ `RiskLimitUpdated` é€²è¡Œå³æ™‚æ›´æ–°ã€‚

---

## API ä»‹é¢è¦æ ¼

|    | **HTTP Method** | **Endpoint**                             | **èªªæ˜**                               | **èª¿ç”¨è€…**           | **æˆæ¬Š**      |
|----|-----------------|------------------------------------------|--------------------------------------|-------------------|-------------|
| âœ”ï¸ | **POST**        | `/api/positions/intent/reserve`          | åˆ¤æ–·äº¤æ˜“æ„åœ–ä¸¦å‡çµï¼ˆå¹³å€‰é å‡çµå€‰ä½ï¼‰ï¼Œå›å‚³ `PositionIntent` | Order Svc         | Private     |
| âœ”ï¸ | **GET**         | `/api/positions/{userId}/{instrumentId}` | æŸ¥è©¢å–®ä¸€äº¤æ˜“å°çš„å³æ™‚å€‰ä½å¿«ç…§                       | Risk Svc, Gateway | Private/JWT |

---

## äº‹ä»¶é©…å‹•æ¶æ§‹ (Event Architecture)

### äº‹ä»¶æ¶ˆè²» (Consume)

|    | **Topic**                      | **äº‹ä»¶åç¨±**             | **è™•ç†é‚è¼¯**                                                                                                              |
|----|--------------------------------|----------------------|-----------------------------------------------------------------------------------------------------------------------|
| âœ”ï¸ | `account.trade-margin-settled` | `TradeMarginSettled` | **é–‹å€‰å…¥å¸³**ï¼šå»ºç«‹æ–°å€‰ä½æˆ–å¢åŠ æŒå€‰ã€‚æ›´æ–° `margin` (å¾éŒ¢åŒ…è½‰å…¥) èˆ‡ `entry_price`ã€‚                                                              |
| âœ”ï¸ | `matching.trade-executed`      | `TradeExecuted`      | **å¹³å€‰çµç®—**ï¼šåƒ…è™•ç† `makerIntent/takerIntent = REDUCE/CLOSE` çš„æˆäº¤ï¼›æ¸›å°‘æŒå€‰ã€é‡‹æ”¾å‡çµæ•¸é‡ã€è¨ˆç®— `realized_pnl` ä¸¦ç™¼å¸ƒ `PositionMarginReleased`ã€‚ |
| âœ”ï¸ | `market.mark-price`            | `MarkPriceUpdated`   | **è¡Œæƒ…æ›´æ–°**ï¼šä½¿ç”¨æœ€æ–°æ¨™è¨˜åƒ¹æ ¼é‡ç®— `unrealized_pnl` èˆ‡ `liquidation_price`ã€‚                                                           |

---

### äº‹ä»¶ç™¼å¸ƒ (Publish)

|    | **Topic**                   | **äº‹ä»¶åç¨±**                 | **è§¸ç™¼å ´æ™¯**                     |
|----|-----------------------------|--------------------------|------------------------------|
| âœ”ï¸ | `positions.margin-released` | `PositionMarginReleased` | å¹³å€‰/æ¸›å€‰å®Œæˆï¼Œé€šçŸ¥ Ledger é‡‹æ”¾ä¿è­‰é‡‘ä¸¦çµç®—ç›ˆè™§ |
| âœ”ï¸ | `positions.updated`         | `PositionUpdated`        | å€‰ä½ç‹€æ…‹è®Šæ›´ï¼ˆé–‹å€‰ã€å¹³å€‰ã€å¼·å¹³ã€è¡Œæƒ…æ›´æ–°ï¼‰        |

## è³‡æ–™åº«è¨­è¨ˆ (DDL Optimized)

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

---

## æ ¸å¿ƒæ¥­å‹™é‚è¼¯ (Business Logic)

### æ§“æ¡¿èˆ‡ä¿è­‰é‡‘ (Leverage & Margin)

- **é æª¢èˆ‡è¨­å®š**ï¼š
    - ç”¨æˆ¶è«‹æ±‚æ§“æ¡¿å€æ•¸éœ€é€šé `Risk Service` æª¢æ ¸ (ä¸è¶…é `max_leverage`)ã€‚
    - æª¢æ ¸é€šéå¾Œï¼Œå¯«å…¥ `positions.leverage`ã€‚
- **åˆå§‹ä¿è­‰é‡‘ (Initial Margin)**ï¼š
    - `margin` (å€‰ä½ä¿è­‰é‡‘) = `cost_basis` / `leverage`
    - `cost_basis` = `abs(entry_price * quantity * contract_size)`
- **ä¿è­‰é‡‘ç‡ (Margin Ratio)**ï¼š
    - åæ˜ å€‰ä½å®‰å…¨ç¨‹åº¦ï¼Œå³æ™‚æ›´æ–°ã€‚
    - å…¬å¼ï¼š`margin_ratio = equity / market_notional`
        - `equity` = `margin` + `unrealized_pnl` (é€å€‰æ¬Šç›Š)
        - `market_notional` = `abs(mark_price * quantity * contract_size)` (å€‰ä½å¸‚å€¼)

### å¹³å‡é–‹å€‰åƒ¹æ ¼ (entry_price)

`entry_price`ï¼ˆå¹³å‡é–‹å€‰åƒ¹æ ¼ï¼‰çš„è¨ˆç®—éµå¾ª **ã€ŒåŠ æ¬Šå¹³å‡æ³• (Weighted Average Price)ã€**ã€‚

æ ¸å¿ƒåŸå‰‡åªæœ‰ä¸€æ¢ï¼š**åªæœ‰åœ¨ã€Œå€‰ä½å¢åŠ ï¼ˆé–‹å€‰/åŠ å€‰ï¼‰ã€æ™‚ï¼Œ`entry_price` æ‰æœƒè®Šå‹•ï¼›ã€Œå€‰ä½æ¸›å°‘ï¼ˆå¹³å€‰/æ¸›å€‰ï¼‰ã€æ™‚ï¼Œ`entry_price` ä¿æŒä¸è®Šã€‚
**

ä»¥ä¸‹æ˜¯è©³ç´°è¨ˆç®—é‚è¼¯èˆ‡å ´æ™¯ç¯„ä¾‹ï¼š

#### 1. è¨ˆç®—å…¬å¼

##### å ´æ™¯ Aï¼šé–‹å€‰ / åŠ å€‰ (Increase Position)

ç•¶ç”¨æˆ¶è²·å…¥æ›´å¤šåˆç´„æ™‚ï¼Œæ–°çš„å‡åƒ¹æ˜¯ã€ŒèˆŠå€‰ä½æˆæœ¬ã€åŠ ä¸Šã€Œæ–°æˆäº¤æˆæœ¬ã€çš„ç¸½å’Œï¼Œé™¤ä»¥ã€Œç¸½æ•¸é‡ã€ã€‚

$$NewEntryPrice = \frac{(OldQty \times OldEntryPrice) + (TradeQty \times TradePrice)}{OldQty + TradeQty}$$

æˆ–è€…å¾è³‡é‡‘è§’åº¦ç†è§£ï¼š

$$NewEntryPrice = \frac{OldCostBasis + NewTradeNotional}{NewTotalQty}$$

> **æ³¨æ„**ï¼šé€™è£¡çš„ `TradePrice` æŒ‡çš„æ˜¯æ’®åˆå¼•æ“å‚³ä¾†çš„æˆäº¤åƒ¹ï¼ˆFill Priceï¼‰ï¼Œä¸æ˜¯æ¨™è¨˜åƒ¹ã€‚

##### å ´æ™¯ Bï¼šå¹³å€‰ / æ¸›å€‰ (Decrease Position)

ç•¶ç”¨æˆ¶è³£å‡ºéƒ¨åˆ†åˆç´„æ™‚ï¼Œå‰©é¤˜å€‰ä½çš„ã€Œå–®ä½æˆæœ¬ã€æ˜¯ä¸è®Šçš„ã€‚

$$NewEntryPrice = OldEntryPrice$$

> ç‚ºä»€éº¼ä¸è®Šï¼Ÿ
>
> å› ç‚ºå¹³å€‰å‹•ä½œæ˜¯ç‚ºäº†ã€Œçµç®—ç›ˆè™§ (Realized PnL)ã€ã€‚ä½ è³£å‡ºçš„é‚£éƒ¨åˆ†å·²ç¶“çµç®—äº†å·®åƒ¹ï¼Œå‰©ä¸‹ä¾†é‚„æ²’è³£å‡ºçš„éƒ¨åˆ†ï¼Œå…¶ç•¶åˆè²·å…¥çš„æˆæœ¬ä¸¦æ²’æœ‰å› ç‚ºä½ è³£äº†åˆ¥çš„è€Œæ”¹è®Šã€‚

---

#### 2. æ•¸å€¼ç¯„ä¾‹ (Example)

å‡è¨­ç”¨æˆ¶äº¤æ˜“ **BTCUSDT**ï¼Œåˆç´„é¢å€¼ 1 BTCã€‚

##### æ­¥é©Ÿ 1ï¼šé¦–æ¬¡é–‹å€‰ (Open)

- **å‹•ä½œ**ï¼šä»¥ **$60,000** è²·å…¥ **1** å€‹ BTC å¤šå–®ã€‚
- **è¨ˆç®—**ï¼š
    - `entry_price` = **60,000**
    - `quantity` = 1

##### æ­¥é©Ÿ 2ï¼šåŠ å€‰ (Increase)

- **å‹•ä½œ**ï¼šåƒ¹æ ¼ä¸‹è·Œï¼Œç”¨æˆ¶ä»¥ **$50,000** åŠ å€‰è²·å…¥ **1** å€‹ BTCã€‚
- **è¨ˆç®—**ï¼š
    - èˆŠæˆæœ¬ = $1 \times 60,000 = 60,000$
    - æ–°æˆæœ¬ = $1 \times 50,000 = 50,000$
    - ç¸½æ•¸é‡ = $1 + 1 = 2$
    - **`entry_price`** = $(60,000 + 50,000) / 2$ = **55,000**
    - _(ç¾åœ¨ä½ çš„æŒå€‰å‡åƒ¹è¢«æ‹‰ä½åˆ°äº† 55,000)_

##### æ­¥é©Ÿ 3ï¼šéƒ¨åˆ†å¹³å€‰ (Reduce)

- **å‹•ä½œ**ï¼šåƒ¹æ ¼åå½ˆåˆ° **$58,000**ï¼Œç”¨æˆ¶è³£å‡º **1** å€‹ BTC ç²åˆ©ã€‚
- **è¨ˆç®—**ï¼š
    - **`entry_price`** = **55,000** (ä¿æŒä¸è®Šï¼)
    - `quantity` = $2 - 1 = 1$
    - **`realized_pnl`** = $(58,000 - 55,000) \times 1$ = **3,000** (ç²åˆ©)

> å¦‚æœå¹³å€‰æ™‚æ”¹è®Šäº† `entry_price`ï¼Œæœƒå°è‡´å‰©ä¸‹çš„é‚£å€‹å€‰ä½æˆæœ¬å¤±çœŸï¼Œå¾ŒçºŒè¨ˆç®—ç›ˆè™§å°±æœƒå‡ºéŒ¯ã€‚

### ç›ˆè™§è¨ˆç®— (PnL Calculation)

- **æœªå¯¦ç¾ç›ˆè™§ (Unrealized PnL)**
    - ç”¨é€”ï¼šé¢¨éšªè©•ä¼°ã€å¼·å¹³è¨ˆç®—ã€å‰ç«¯å±•ç¤ºã€‚
    - è§¸ç™¼ï¼š`MarkPriceUpdated` äº‹ä»¶ã€‚
    - å…¬å¼ï¼š`(mark_price - entry_price) * quantity * contract_size * direction`
        - Long: `direction = 1`
        - Short: `direction = -1`
- **å·²å¯¦ç¾ç›ˆè™§ (Realized PnL)**
    - ç”¨é€”ï¼šå¯¦éš›çµç®—ã€è¨˜å…¥å¸³æœ¬ã€‚
    - è§¸ç™¼ï¼š`TradeExecuted` (å¹³å€‰/æ¸›å€‰æ™‚)ã€‚
    - å…¬å¼ï¼š`(fill_price - entry_price) * trade_quantity * contract_size * direction`
        - æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨çš„æ˜¯ **æˆäº¤åƒ¹ (Fill Price)** è€Œéæ¨™è¨˜åƒ¹ã€‚
    - è™•ç†ï¼šå°‡ç®—å‡ºçš„ PnL åæ˜ åœ¨ `positions.cum_realized_pnl`ï¼Œä¸¦è¨˜éŒ„æ–¼ `position_events.payload` çš„ `cumRealizedPnl` è®Šå‹•ã€‚

### å¼·å¹³é‚è¼¯ (Liquidation Logic)

æ¡ç”¨ **é€å€‰ä¿è­‰é‡‘ (Isolated Margin)** æ¨¡å¼è¨ˆç®—ã€‚

- å¤šå–® (Long) å¼·å¹³åƒ¹ï¼š

  $$LiqPrice_{Long} = \frac{EntryPrice - \frac{Margin}{Quantity \times ContractSize}}{1 - MMR}$$
- ç©ºå–® (Short) å¼·å¹³åƒ¹ï¼š

  $$LiqPrice_{Short} = \frac{EntryPrice + \frac{Margin}{Quantity \times ContractSize}}{1 + MMR}$$
- è®Šæ•¸èªªæ˜ï¼š
    - `MMR`: ç¶­æŒä¿è­‰é‡‘ç‡ (Maintenance Margin Rate)ã€‚
    - `Margin`: è©²é€å€‰å€‰ä½çš„ä¿è­‰é‡‘é¤˜é¡ã€‚

---

## å€‰ä½ç‹€æ…‹æ©Ÿ (State Machine)

Position å¯¦é«”çš„ç”Ÿå‘½é€±æœŸç®¡ç†ï¼š

| **åˆå§‹ç‹€æ…‹**        | **äº‹ä»¶/å‹•ä½œ** | **ç›®æ¨™ç‹€æ…‹**        | **é‚è¼¯èªªæ˜**                                 |
|-----------------|-----------|-----------------|------------------------------------------|
| **(Null)**      | é–‹å€‰æˆäº¤      | **ACTIVE**      | å»ºç«‹æ–° `position_id`ï¼Œåˆå§‹åŒ– margin èˆ‡ quantityã€‚ |
| **ACTIVE**      | åŠ å€‰æˆäº¤      | **ACTIVE**      | `quantity` å¢åŠ ï¼Œ`entry_price` é‡æ–°åŠ æ¬Šå¹³å‡ã€‚      |
| **ACTIVE**      | æ¸›å€‰ (éƒ¨åˆ†å¹³å€‰) | **ACTIVE**      | `quantity` æ¸›å°‘ï¼Œé‡‹æ”¾éƒ¨åˆ†ä¿è­‰é‡‘ï¼Œ`entry_price` ä¸è®Šã€‚  |
| **ACTIVE**      | é¢¨æ§è§¸ç™¼      | **LIQUIDATING** | ä¿è­‰é‡‘ç‡ < MMRã€‚å€‰ä½è¢«å¼·å¹³å¼•æ“æ¥ç®¡ï¼Œç¦æ­¢ç”¨æˆ¶æ“ä½œã€‚             |
| **LIQUIDATING** | å¼·å¹³çµæŸ      | **CLOSED**      | å‰©é¤˜è³‡ç”¢çµç®—å®Œæˆã€‚                                |
| **ACTIVE**      | å…¨å¹³æˆäº¤      | **CLOSED**      | `quantity` æ­¸é›¶ã€‚è¨˜éŒ„ `closed_at`ã€‚            |
| **CLOSED**      | (ä»»ä½•å‹•ä½œ)    | **(ä¸å¯è®Š)**       | æ­·å²å€‰ä½ä¸å¯é‡ç”¨ã€‚æ–°é–‹å€‰å¿…é ˆç”¢ç”Ÿæ–° IDã€‚                    |

# Risk æœå‹™

## æœå‹™å•Ÿå‹•èˆ‡åˆå§‹åŒ– (Startup & Caching)

Risk æœå‹™å¿…é ˆåœ¨å•Ÿå‹•æ™‚é ç†±äº¤æ˜“å°çš„é…ç½®ï¼Œä»¥ä¾¿é€²è¡Œå³æ™‚é¢¨æ§æª¢æŸ¥ã€‚

å•Ÿå‹•æµç¨‹

- **ç›£è½å•Ÿå‹•äº‹ä»¶**ï¼šç›£è½ `ApplicationReadyEvent` (æˆ–ä½¿ç”¨ `CommandLineRunner`)ã€‚
- **è¼‰å…¥åŸºç¤é…ç½®**ï¼š
    - å‘¼å« Admin Service (`GET /api/admin/instruments`) ç²å–æ‰€æœ‰äº¤æ˜“å°ç‹€æ…‹ã€‚
- **è¼‰å…¥æ¨™è¨˜åƒ¹æ ¼**ï¼š
    - å‘¼å« Market Service (`GET /api/market/mark-price/{instrumentId}`) ç²å–æœ€æ–°æ¨™è¨˜åƒ¹æ ¼ã€‚
- **å»ºç«‹æœ¬åœ°å¿«å–**ï¼š
    - ä½¿ç”¨ ConcurrentHashMap æ§‹å»º `instrumentCache`: `Map<Long, InstrumentSummary>`ã€‚
    - ä½¿ç”¨ ConcurrentHashMap æ§‹å»º `markPriceCache`: `Map<Long, BigDecimal>` (æ¶ˆè²» `market.mark-price` æ›´æ–°)ã€‚
- **éŒ¯èª¤è™•ç†æ©Ÿåˆ¶**ï¼š
    - è‹¥åˆå§‹åŒ–å¤±æ•—ï¼ŒåŸ·è¡Œé‡è©¦æˆ–é˜»æ­¢æœå‹™å•Ÿå‹•ã€‚

## API

| å®Œæˆ | HTTP Method | Endpoint                          | èªªæ˜             | èª¿ç”¨è€…       | æˆæ¬Š      |
|----|-------------|-----------------------------------|----------------|-----------|---------|
| âœ”ï¸ | GET         | `/api/risk/limits/{instrumentId}` | æŸ¥è©¢æŒ‡å®šäº¤æ˜“å°çš„é¢¨éšªé™åˆ¶é…ç½® | positions | private |
| âœ”ï¸ | POST        | `/api/risk/orders/precheck`       | ä¸‹å–®å‰é¢¨æ§é æª¢        | order     | private |

## event

**äº‹ä»¶æ¶ˆè²»**:

| å®Œæˆ | Topic             | äº‹ä»¶                 | è™•ç†é‚è¼¯           | äº‹ä»¶ç™¼å¸ƒ                                  |
|----|-------------------|--------------------|----------------|---------------------------------------|
|    | positions.updated | `PositionUpdated`  | æ›´æ–°ç”¨æˆ¶é¢¨éšªæŒ‡æ¨™èˆ‡ç‹€æ…‹    | `RiskUpdate`                          |
|    | market.mark-price | `MarkPriceUpdated` | é‡æ–°è¨ˆç®—ç¶­æŒä¿è­‰é‡‘ç‡èˆ‡å¼·å¹³åƒ¹ | `RiskUpdate` / `LiquidationTriggered` |

**äº‹ä»¶ç™¼å¸ƒ**:

| å®Œæˆ | ç™¼å¸ƒå ´æ™¯     | Topic                      | äº‹ä»¶åç¨±                   |
|----|----------|----------------------------|------------------------|
|    | é‡æ–°è¨ˆç®—é¢¨éšªæŒ‡æ¨™ | risk.update                | `RiskUpdate`           |
|    | è§¸ç™¼å¼·å¹³æµç¨‹   | risk.liquidation-triggered | `LiquidationTriggered` |

---

## DDL

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

åƒ…æä¾›æŸ¥è©¢
å¯«å…¥ç”¨SQLäººå·¥æ’å…¥

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

##    

## é¢¨æ§ç‹€æ…‹ status

- NORMAL  
  ä¿è­‰é‡‘ç‡é«˜æ–¼ç¶­æŒä¿è­‰é‡‘ç‡ã€‚å®‰å…¨ã€‚
    - å…è¨±ä¸‹å–®
    - å…è¨±åŠ å€‰
    - ä¸å‹•ä½œ
- ALERT  
  ä¿è­‰é‡‘ç‡æ¥è¿‘ç¶­æŒä¿è­‰é‡‘ç‡ã€‚æé†’ã€‚
    - å…è¨±ä¸‹å–®
    - å¼·åˆ¶æç¤º
    - ä¸å¼·å¹³
- MARGIN_CALL  
  ä¿è­‰é‡‘ç‡ä½æ–¼ç¶­æŒä¿è­‰é‡‘ç‡ã€‚éœ€è£œä¿ã€‚
    - ç¦æ­¢åŠ å€‰
    - åƒ…å…è¨±æ¸›å€‰
    - æç¤ºè£œä¿
- LIQUIDATION_PENDING  
  è§¸ç™¼å¼·å¹³ã€‚ç­‰å¾…è™•ç†ã€‚
    - èª¿ç”¨æ¸…ç®—
    - å¿…è¦æ™‚éƒ¨åˆ†æˆ–å…¨å€‰å¼·å¹³

## risk_limits è¡¨ é…ç½®è¦å‰‡

### åˆå§‹ä¿è­‰é‡‘  >= ç¶­æŒä¿è­‰é‡‘ç‡

### æ§“æ¡¿å€æ•¸ max_leverage â‰ˆ 1 / åˆå§‹ä¿è­‰é‡‘

- é€™å¥è©±çš„æ„æ€æ˜¯ï¼šç•¶å•†å“è¨­å®šçš„åˆå§‹ä¿è­‰é‡‘ç‡ï¼ˆInitial Margin Rateï¼‰ç‚º IMRï¼ˆä¾‹å¦‚ 5%ï¼‰ï¼ŒåŒä¸€æª”å•†å“æ‰€å…è¨±çš„æœ€å¤§æ§“æ¡¿ max_leverage
  æœƒè¿‘ä¼¼ç­‰æ–¼ 1 / IMRï¼ˆç´„ 20å€ï¼‰ã€‚
- å¯¦éš›ä¸Šå¯ä»¥ä¿ç•™ç·©è¡ï¼ˆä¾‹å¦‚max_leverage <= 0.9 / IMRï¼‰ï¼Œæˆ–è®“ä¸åŒé¢¨éšªåˆ†å±¤èª¿æ•´æ¯”ä¾‹ï¼Œä½†åœ¨è¨­è¨ˆä¸Šç”¨é€™å€‹é—œä¿‚æ–¹ä¾¿ç›´è§€åœ°æ¨å°å¯ç”¨çš„æ§“æ¡¿ä¸Šé™ã€‚

##    

# Admin æœå‹™

## endpoint

| å®Œæˆ | HTTP Method | Endpoint                                | èªªæ˜        | èª¿ç”¨è€…                              | æˆæ¬Š     |
|----|-------------|-----------------------------------------|-----------|----------------------------------|--------|
| âœ”ï¸ | GET         | `/api/admin/instruments`                | æŸ¥è©¢å¯äº¤æ˜“å•†å“åˆ—è¡¨ | order / risk / market / matching | public |
| âœ”ï¸ | GET         | `/api/admin/instruments/{instrumentId}` | æŸ¥è©¢å–®ä¸€å•†å“ç´°ç¯€  | order / risk / market / matching | public |

> **é‹ç¶­èªªæ˜**: ç›®å‰ Admin æœå‹™åƒ…æä¾›æŸ¥è©¢åŠŸèƒ½ï¼›Instrument çš„æ–°å¢/ç•°å‹•/ä¸‹ç·šé€é DBA ç›´æ¥æ“ä½œè³‡æ–™åº«ï¼Œä¸¦ç”±è®Šæ›´æµç¨‹æ§ç®¡ã€‚

## DDL

è©³ç´° SQL è«‹åƒè€ƒ [init.sql](init.sql)

#### å‡æ•¸æ“šç¤ºä¾‹ï¼ˆPERPETUAL åˆç´„ï¼‰

```sql
INSERT INTO instrument (instrument_id, symbol ,name, base_asset, quote_asset, instrument_type, status,  
                        maker_fee_rate, taker_fee_rate, contract_size, default_leverage,  
                        launch_at, delist_at, display_order, is_tradable, is_visible, description, metadata,  
                        created_at, updated_at)  
VALUES (10001, 'BTCUSDT-PERP', 'BTCUSDT', 'BTC', 'USDT', 'PERPETUAL', 'ACTIVE',  
        0.0002, 0.0005, 1, 4,  
        NOW(), NULL, 1, TRUE, TRUE, 'Demo perpetual pair', '{"funding_interval":8}',  
        NOW(), NOW());
```
