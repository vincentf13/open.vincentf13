# 業務概述

- 系統聚焦永續合約／保證金交易場景，涵蓋下單、撮合、資金結算、倉位管理與行情播送。
- 模組間透過事件流串接，確保下單→撮合→結算→倉位更新的閉環。
- Gateway 承接使用者流量與邏輯入口，風控服務負責同步檢查，撮合與賬本服務確保資產安全與一致性。

# 目錄結構

```
open.vincentf13/
├─ sdk-common/                          # 共用 SDK 與基礎建設模組聚合
│  ├─ sdk-core/                         # 核心工具、共用常數、標準配置
│  ├─ sdk-core-log/                     # 統一 Logback/Log4j2 設定與攔截
│  ├─ sdk-core-trace/                   # OpenTelemetry/Tracing 自動配置
│  ├─ sdk-core-metrics/                 # Micrometer 指標與 Prometheus 匯出
│  ├─ sdk-core-test/                    # 測試共用工具、測試容器輔助類別
│  ├─ sdk-spring-mvc/                   # REST 回應包裝、MVC 攔截與設定
│  ├─ sdk-spring-security/              # 共用Spring security 基本防護，驗證與授權由sdk-auth-jwt 與 sdk-auth-server模塊負責
│  ├─ sdk-spring-session/               # Spring Session 與 Redis 會話整合
│  ├─ sdk-spring-cloud-gateway/         # Gateway Filter 與路由策略範本
│  ├─ sdk-spring-websocket/             # WebSocket/STOMP 通道設定
│  ├─ sdk-spring-cloud-openfeign/       # Feign 客戶端預設攔截器與容錯
│  ├─ sdk-spring-cloud-alibaba-nacos/   # Nacos 註冊中心、設定中心整合
│  ├─ sdk-infra-mysql/                  # MySQL 動態資料源、MyBatis 自動配置
│  ├─ sdk-infra-redis/                  # Redis 連線池、序列化與鎖工具
│  ├─ sdk-infra-kafka/                  # Kafka Producer/Consumer 統一設定
│  ├─ sdk-library-resilience4j/         # Resilience4j Circuit/Retry/RateLimiter
│  ├─ sdk-auth-jwt/                     # JWT 生成、驗證、過濾器與屬性
│  └─ sdk-auth-server/                  # 登入流程、會話管理、事件發佈範本
├─ sdk-contract/                        # API 契約與客戶端聚合
│  └─ sdk-exchange/                     # 交易域專用契約與客戶端聚合
│      └─ sdk-exchange-user/            # 使用者子模組（REST 契約與客戶端）
│          ├─ rest-api/                 # OpenAPI 契約、DTO、Controller 介面
│          └─ rest-client/              # 依契約生成的 Feign/HTTP 客戶端
└─ services/                            # 具體業務服務
   ├─ pom.xml                           # 聚合子服務，統一打包
   ├─ service-user/                     # 使用者域服務
   │   ├─ domain/                       # 聚合根、領域服務、錯誤碼
   │   │   ├─ model/                    # Domain Model (Aggregate / Value Object)
   │   │   │   ├─ UserAggregate.java         # Aggregate Root，封裝使用者聚合狀態變更
   │   │   │   ├─ AuthCredential.java        # 使用者認證憑證資料
   │   │   │   ├─ AuthCredentialType.java    # 憑證種類 Enum
   │   │   │   └─ UserStatus.java            # 使用者狀態 Enum
   │   │   ├─ error/                    # Domain Error Code
   │   │   │   └─ UserErrorCode.java        # 使用者領域錯誤碼
   │   │   └─ service/                  # Domain Service 協調領域規則
   │   │       └─ UserDomainService.java    # 領域服務：集中業務不變性（例：註冊時正規化 Email、驗證憑證唯一性）
   │   │                                     # Stateless，避免 @Transactional；由 Application Service 傳入聚合與外部資料
   │   │                                     # 典型場景：變更使用者狀態前先調用風控規則，再委派給聚合執行狀態切換
   │   ├─ infra/                        # Repository / Mapper / PO（資料庫表對應）
   │   │   └─ persistence/              # 持久層實作（Mapper + Repository）
   │   │       ├─ mapper/UserMapper.java
   │   │       └─ repository/UserRepository.java # Repository 介面：隱藏 MyBatis/JPA 細節，返回 Domain Aggregate
   │   │                                     # 實作類位於 infra；透過 Mapper 組裝 UserAggregate，並在 @Transactional 區塊內由上層控制提交
   │   │                                     # 典型場景：提供 findByEmail, save(UserAggregate) 供 Application Service 呼叫
   │   ├─ app/                          # Application Service（用例編排，DTO 與 Entity 映射）
   │   │   └─ service/UserApplicationService.java # Application Service：用例入口，包裝 @Service + @Transactional 邊界
   │   │                                     # 將 REST DTO 轉為 Domain Command，調用 Repository/Domain Service，處理事件發布
   │   │                                     # 典型場景：registerUser() 內建立交易型 @Transactional，先查重 → 執行 Domain 規則 → 持久化 → 回傳 DTO
   │   └─ interfaces/                   # Controller / API 實作
   │       └─ UserController.java       # REST Controller
   ├─ service-order/                    # 委託與撮合前置服務
   │   ├─ domain/
   │   ├─ infra/
   │   ├─ app/
   │   └─ interface/

```

Service 共用架構守則

- 分層命名統一為 `domain`、`infra`、`app`、`interface`，使用 DDD 思維維持領域模型與 I/O 隔離。
- 共享功能優先引用 `sdk-common`，尤其資料庫、MVC、Security 等現成模組，避免各服務自行複製設定。
  - 資料庫連線與 MyBatis 由 `sdk-infra-mysql` 自動配置；服務層僅需提供 Mapper XML 與 Repository 介面。
- DTO 與 Entity 映射建議使用 `OpenMapstruct` 等共用工具，減少手寫轉換與重複樣板。
- 契約優先：先設計 OpenAPI / AsyncAPI，並透過 `sdk-contract` 底下的 `sdk-exchange-*` 發佈 SDK 或範本實作。

# 模塊職責


| 模組             | 核心責任                                           |
| ---------------- | -------------------------------------------------- |
| `gateway`        | 對外入口、JWT 驗證、流量治理、觀測性匯出           |
| `auth`           | 登入/權杖/多因子流程、會話管理、登入審計與事件發布 |
| `user`           | 使用者主檔、偏好設定、KYC、角色/權限管理           |
| `order`          | 委託下單、撤單、歷史查詢、指令排程、訂單事件溯源   |
| `account-ledger` | 雙分錄資產台帳、結算、利息/費率計算、報表輸出      |
| `risk-margin`    | 保證金/風險係數計算、下單前限額、強平判斷與佇列    |
| `matching`       | 訂單簿維護、撮合引擎、成交輸出與行情報表來源       |
| `positions`      | 倉位快照、未實現損益、破產價/強平價計算            |
| `market-data`    | 行情快照、K 線/深度資料生成、串流推播服務          |

模組職責詳述

- **gateway**：
  - 對接外部流量，統一執行 JWT 驗證、節流、設備指紋檢查。
  - 管理路由策略、A/B 測試、灰度/Canary 發佈，並整合觀測性管線。
  - 提供健康檢查、錯誤轉換與安全標頭注入。
- **auth**：
  - 支援密碼、OTP、FIDO、社群登入等多種認證方式，維護登入審計。
  - 維護會話、刷新權杖、黑名單、裝置綁定與登入通知。
  - 發布登入/登出事件給風控、報表與通知模組。
- **user**：
  - 維護使用者主檔、偏好設定、語系與通知訂閱，管理 KYC 流程。
  - 管理角色、權限與範圍（scope），提供 RBAC/ABAC 查詢介面。
- **order**：
  - 統一下單入口，支援市價/限價/條件單等多種委託型別。
  - 提供單筆與批次撤單、委託查詢、歷史訂單匯出。
  - 寫入訂單事件（event sourcing）供撮合、報表與重播。
- **account-ledger**：
  - 以雙分錄維護資產變動，確保借貸平衡並支援審計。
  - 產生結算、利息、資金費率、手續費等財務事件。
- **risk-margin**：
  - 計算保證金與風險指標、提供下單前限額校驗。
  - 維護風控規則版本、建立強平佇列與風險告警。
- **matching**：
  - 維護訂單簿、撮合成交、產生成交紀錄與行情報價來源。
  - 將撮合結果推送給 ledger、positions、market-data。
- **positions**：
  - 根據撮合與台帳事件維護倉位、未實現損益、破產價。
  - 觸發強平邏輯並回寫至 risk-margin 與 order 模組。
- **market-data**：
  - 轉換撮合輸出為行情快照、K 線、深度資料和統計指標。
  - 提供 WebSocket / gRPC 串流與快取服務給前端與夥伴。

# 下單流程

以下圖解展示從使用者發起交易到結算、行情與倉位回饋的主要事件流（括號標示關鍵模組），特別凸顯撮合後的平行處理：

```
Client
  │ 1. 登入 / 權杖刷新（auth）
  │
Gateway
  │ 2. 驗證 JWT、節流、路由
  │
Order ──┐
  │ 3. 建立/撤單並呼叫 Risk-Margin 試算保證金
  │    └─▶ Risk-Margin：下單前限額與風險驗證
  ▼
Matching
  │ 4. 撮合成交 → 將「成交事件」發布至事件匯流排
  │
  ├─▶ Market-Data：公布行情快照 / 深度 / K 線
  ├─▶ Account-Ledger：雙分錄記帳、產生資產事件
  └─▶ Risk-Margin：更新實際成交資訊、調整風險指標

Account-Ledger
  │ 5. 依資產事件更新帳務 → 再發布資產異動事件
  │    └─▶ Positions：同步刷新倉位 / 盈虧 / 破產價

Positions
  │ 6. 更新倉位、市值、未實現損益
  │    └─▶ Risk-Margin：回饋最新風險指標與強平條件

外部消費者（通知 / 報表 / 監控 / BI）
  7. 平行訂閱 Market-Data、Account-Ledger、Positions 事件
```

重點說明：

1. **入口認證**：使用者透過 `auth` 登入或刷新權杖，Gateway 在入口完成 JWT 驗證與節流。
2. **委託檢核**：`order` 接收到委託後先調用 `risk-margin` 進行預檢（可用保證金、限額），通過後再發佈 `OrderCreated` 事件。
3. **撮合發布**：`matching` 撮合成功後，即發佈 `TradeExecuted`，`market-data`、`account-ledger`、`risk-margin` 等下游即會平行訂閱處理。
4. **帳務與倉位**：`account-ledger` 以雙分錄記帳並再發布資產異動事件`LedgerEntryCreated`，`positions` 依此同步更新倉位與盈虧，並把強平訊號回饋給 `risk-margin`。
5. **多路分發**：行情、帳務、倉位、風險等事件可被通知、報表、監控等周邊系統平行訂閱，實現近即時觀測與自動化流程。

# 查詢流程

前端可透過 Gateway 查詢委託、倉位；並從 `market-data` WebSocket 接收實時行情。

# 註冊/登入流程

1. **註冊/登入**：
   - 使用者透過 Gateway 呼叫 `auth/login`，`auth` 驗證 `auth_credentials`；成功後簽發 Access/Refresh Token，並在 Redis 建立 session 記錄（供 Gateway 驗證）。
   - 後續所有 API 請求由 Gateway 的全域 JWT Filter 驗證 Access Token，同時以 sessionId 檢查 Redis 權限；若 session 不存在或失效即拒絕請求。
   - Access Token 過期時，前端調用 `auth/token/refresh` 換取新 Token，`auth` 並延長 Redis session 到期時間。
   - 異常登入或強制登出時，`auth/logout` 或風控事件會刪除 Redis session 並發布 `AuthSessionRevoked`，Gateway 可立即終止會話。
   - 後續各服務的安全 Filter 會解析 JWT 並將使用者資訊放入 ThreadLocal / Reactor Context，供業務流程使用。

# 接口

## gateway

- `POST /auth/login`：轉發登入請求至 `auth`，取得 JWT/Refresh Token。
- `POST /auth/logout`：使用 Refresh Token 或 JWT 作廢會話，轉發至 `auth`。
- `POST /orders`：驗證 JWT 後，建立委託（轉送 `order`）。
- `DELETE /orders/{orderId}`：撤單（轉送 `order`）。
- `GET /orders/{orderId}`：查詢委託狀態（聚合 `order`、`matching` 資訊）。
- `GET /positions`：查詢倉位（向 `positions` 取得資料）。
- `GET /market/ws` (WebSocket)：行情/成交串流（來自 `market-data`）。

## auth

- `POST /api/auth/register`（可選）：建立帳號（寫入 `users`、`auth_credentials`）。
- `POST /api/auth/login`：驗證憑證 → 簽發 Access/Refresh Token，同時在 Redis 建立 session（`sessionId`、`userId`、到期時間等）。
- `POST /api/auth/token/refresh`：使用 Refresh Token 取得新的 Access Token，並延長 Redis session 到期時間。
- `POST /api/auth/logout`：作廢 Refresh Token/Session（刪除 Redis session）。
- Event Output：`AuthSessionRevoked`（強制登出或風險事件時發布，Gateway/周邊可中止會話）。

## user

- `GET /api/users/me`：查詢主檔基本資料。
- `PATCH /api/users/me`：更新郵件、語系等偏好（可後續擴充）。

## order

- `POST /internal/orders`：建立委託（限價/市價/買賣方向）。
- `DELETE /internal/orders/{orderId}`：撤銷委託。
- `GET /internal/orders/{orderId}`：查詢委託狀態與細節。
- Event：`OrderCreated`、`OrderCancelled` 發布到事件匯流排。

## risk-margin

- `POST /internal/risk/pre-check`：依用戶、委託金額、倉位資料返回是否允許下單。
- Event Input：`TradeExecuted`、`PositionUpdated`（更新風險指標）。
- Event Output：`RiskUpdate`（風險調整回饋給 order 或其他模組）。

## matching

- Event Input：`OrderCreated`（掛單/撮合）。
- Event Output：`TradeExecuted`（成交事件，含價格/數量/對手單/手續費等）。
- （可選）`POST /internal/matching/cancel`：撮合層執行撤單。

## account-ledger

- Event Input：`TradeExecuted`（記帳）。
- Event Output：`LedgerEntryCreated`（資產異動事件）。
- `GET /internal/ledger/balances?userId=`：查詢餘額/可用資金（供前端或風控使用）。

## positions

- Event Input：`LedgerEntryCreated`、`TradeExecuted`。
- Event Output：`PositionUpdated`（倉位、市值、未實現損益）。
- `GET /internal/positions?userId=`：查詢當前倉位與損益。

## market-data

- Event Input：`TradeExecuted`、撮合深度快照。
- WebSocket `GET /market/ws`：推送行情、成交、K 線資料。
- REST `GET /market/tickers/{instrumentId}`：提供最新行情資訊。

# 表結構

auth 模組


| 表名                | 用途           | 主要欄位                                                                                           | 備註                                   |
| ------------------- | -------------- | -------------------------------------------------------------------------------------------------- | -------------------------------------- |
| `auth_credentials`* | 登入憑證資料   | `id (PK)`, `user_id`, `credential_type`, `secret_hash`, `salt`, `status`, `expires_at`             | 支援密碼、API Key、FIDO 等多元憑證。   |
| `auth_providers`    | 第三方登入綁定 | `id (PK)`, `user_id`, `provider`, `provider_user_id`, `linked_at`                                  | 儲存社群/外部身份對應。                |
| `refresh_tokens`    | JWT 會話持久化 | `token_id (PK)`, `user_id`, `session_id`, `issued_at`, `expires_at`, `is_active`, `revoked_reason` | 搭配權杖刷新、強制登出與風險登入鎖定。 |
| `login_audits`      | 登入審計記錄   | `id (PK)`, `user_id`, `ip`, `user_agent`, `result`, `failure_reason`, `logged_at`                  | 供風控、合規、行為分析使用。           |

user 模組


| 表名                       | 用途          | 主要欄位                                                                                 | 備註                                |
| -------------------------- | ------------- | ---------------------------------------------------------------------------------------- | ----------------------------------- |
| `users`*                   | 使用者主檔    | `id (PK)`, `external_id`, `email`, `status`, `created_at`, `updated_at`                  | 其他資料表以`user_id` 外鍵串聯。    |
| `user_profiles`            | 個資與偏好    | `user_id (PK/FK users)`, `display_name`, `country`, `language`, `timezone`               | 與`users` 1:1，儲存顯示與通知設定。 |
| `kyc_records`              | 身分驗證紀錄  | `id (PK)`, `user_id`, `tier`, `status`, `submitted_at`, `approved_at`, `rejected_reason` | 支援多次送審與審核歷程。            |
| `role_assignments`         | 角色/權限授權 | `id (PK)`, `user_id`, `role`, `scope`, `granted_by`, `granted_at`, `expires_at`          | RBAC 核心資料表。                   |
| `notification_preferences` | 通知訂閱設定  | `id (PK)`, `user_id`, `channel`, `is_enabled`, `updated_at`                              | 控制 Email、SMS、Push 等通路。      |

order 模組


| 表名           | 用途         | 主要欄位                                                                                                                                                   | 備註                           |
| -------------- | ------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------ |
| `orders`*      | 委託主檔     | `order_id (PK)`, `user_id`, `instrument_id`, `client_order_id`, `side`, `type`, `price`, `quantity`, `status`, `time_in_force`, `created_at`, `updated_at` | 委託生命週期的核心資料。       |
| `order_events` | 委託事件溯源 | `event_id (PK)`, `order_id`, `event_type`, `payload`, `occurred_at`, `actor`                                                                               | 支援重播、稽核與行為分析。     |
| `order_tasks`  | 異步指令佇列 | `task_id (PK)`, `order_id`, `task_type`, `payload`, `status`, `retry_count`, `scheduled_at`                                                                | 批次撤單、策略單等非即時動作。 |

matching 模組


| 表名             | 用途     | 主要欄位                                                                                        | 備註                         |
| ---------------- | -------- | ----------------------------------------------------------------------------------------------- | ---------------------------- |
| `trade_tickers`* | 成交紀錄 | `trade_id (PK)`, `order_id`, `counterparty_order_id`, `price`, `quantity`, `fee`, `executed_at` | 撮合輸出，供報表與事件回放。 |

account-ledger 模組


| 表名              | 用途       | 主要欄位                                                                                                      | 備註                     |
| ----------------- | ---------- | ------------------------------------------------------------------------------------------------------------- | ------------------------ |
| `ledger_entries`* | 雙分錄紀錄 | `entry_id (PK)`, `account_id`, `asset`, `amount`, `direction`, `reference_type`, `reference_id`, `event_time` | 借貸必須平衡，支援審計。 |
| `ledger_balances` | 帳戶餘額   | `id (PK)`, `account_id`, `asset`, `balance`, `available`, `reserved`, `updated_at`                            | 提供資產查詢與風控試算。 |
| `funding_rates`   | 資金費率   | `id (PK)`, `instrument_id`, `rate`, `effective_at`, `calculated_at`                                           | 供費率結算與倉位估值。   |

risk-margin 模組


| 表名                | 用途     | 主要欄位                                                                                                           | 備註                         |
| ------------------- | -------- | ------------------------------------------------------------------------------------------------------------------ | ---------------------------- |
| `risk_limits`       | 風控參數 | `id (PK)`, `instrument_id`, `tier`, `initial_margin_rate`, `maintenance_margin_rate`, `max_leverage`, `updated_at` | 下單前保證金與限額判斷依據。 |
| `liquidation_queue` | 強平佇列 | `id (PK)`, `position_id`, `status`, `queued_at`, `processed_at`, `reason`                                          | 追蹤強平排程與處理狀態。     |

positions 模組


| 表名              | 用途         | 主要欄位                                                                                                                                             | 備註                     |
| ----------------- | ------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------ |
| `positions`*      | 倉位主檔     | `position_id (PK)`, `user_id`, `instrument_id`, `side`, `quantity`, `entry_price`, `mark_price`, `unrealized_pnl`, `liquidation_price`, `updated_at` | 倉位快照與估值資料。     |
| `position_events` | 倉位事件溯源 | `event_id (PK)`, `position_id`, `event_type`, `delta_qty`, `delta_pnl`, `reference_id`, `occurred_at`                                                | 追蹤倉位變化與強平歷程。 |

market-data 模組


| 表名               | 用途     | 主要欄位                                                                                                 | 備註                     |
| ------------------ | -------- | -------------------------------------------------------------------------------------------------------- | ------------------------ |
| `market_snapshots` | 行情快照 | `snapshot_id (PK)`, `instrument_id`, `bid_depth`, `ask_depth`, `last_price`, `volume_24h`, `captured_at` | 提供行情查詢與串流基礎。 |

共用參數


| 表名                  | 用途         | 主要欄位                                                                                                    | 備註                           |
| --------------------- | ------------ | ----------------------------------------------------------------------------------------------------------- | ------------------------------ |
| `instrument_metadata` | 交易商品設定 | `instrument_id (PK)`, `symbol`, `base_asset`, `quote_asset`, `status`, `tick_size`, `lot_size`, `launch_at` | 供所有交易模組共用的靜態資訊。 |

> 後續若擴充期權、現貨或策略單，可依各模組需求延伸專屬資料表與事件流，並沿用上述設計原則。

# 其他

資料模型與一致性

- **賬本**：使用關係型資料庫維護不可變雙分錄表，以事件溯源確保追蹤性。
- **業務鍵**：所有轉賬／撤銷皆使用全球唯一業務鍵，支援冪等與重放。
- **撮合狀態**：採內存訂單簿 + 定期快照 + WAL 備援，依交易對分片擴充。
- **分析側**：事件流計畫匯入 ClickHouse/Elasticsearch，支援即時報表與回溯分析。

協定

- **外部 API**：以 OpenAPI 管理 REST 契約；行情推送以 WebSocket 為主，後續可擴充 gRPC stream。
- **內部事件**：以 Kafka 為主要匯流，訊息以json格式方便開發。
- **客戶端生成**：由 `sdk-contract` 底下的 `sdk-exchange-*` 自動產生 Feign/Web 客戶端，避免手寫 SDK 帶來維護成本。

安全與合規

- **資產安全**：賬本服務保留審計軌跡，錢包/HSM 整合待錢包服務完成後納入。
- **風險控制**：在 Gateway 與風控服務導入節流、簽名與爆倉保護；策略使用配置化管理。
- **身份與授權**：規劃導入 OIDC 與多因子驗證，敏感操作需完整審計與審批流程。
- **合規報表**：透過賬本與事件流提供對帳、監管報表所需資料。

持續優化

- 擴充壓測與撮合回放資料，驗證極端行情下的性能與穩定性。
- 規劃資金費率、強平與錢包模組，並完善對應的事件流與監控。
