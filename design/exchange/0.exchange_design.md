# ç›®éŒ„çµæ§‹

```
open.vincentf13/
â”œâ”€ sdk/                          # èšåˆæ‰€æœ‰æ©«åˆ‡é—œæ³¨é» (cross-cutting concerns)ï¼Œå¦‚æ—¥èªŒã€ç›£æ§ã€è¿½è¹¤ã€è³‡æ–™åº«å­˜å–ç­‰ï¼Œä»¥ Spring Boot Starter çš„å½¢å¼æä¾›çµ¦æ¥­å‹™æœå‹™ä½¿ç”¨ã€‚
â”‚  â”œâ”€ sdk-core/                         # æ ¸å¿ƒå·¥å…·åŒ…ï¼šæä¾›å…±ç”¨å¸¸æ•¸ã€å·¥å…·é¡ (Guava, Vavr)ã€DTO æ˜ å°„ (MapStruct)ã€æ¨™æº–åŒ– Log4j2 é…ç½®èˆ‡ Prometheus æŒ‡æ¨™ã€‚
â”‚  â”œâ”€ sdk-core-test/                    # æ¸¬è©¦åŸºç¤è¨­æ–½ï¼šæ•´åˆ JUnitã€Testcontainersï¼Œæä¾›å° MySQLã€Redisã€Kafka çš„å®¹å™¨åŒ–æ¸¬è©¦æ”¯æ´ã€‚
â”‚  â”œâ”€ sdk-spring-mvc/                   # Spring MVC å¢å¼·ï¼šæä¾›çµ±ä¸€çš„ RESTful API å›æ‡‰çµæ§‹ã€å…¨åŸŸç•°å¸¸è™•ç†èˆ‡ Web ç›¸é—œé…ç½®ã€‚
â”‚  â”œâ”€ sdk-auth/                         # èªè­‰èˆ‡æˆæ¬ŠåŸºåº§ï¼šå®šç¾©å®‰å…¨è¨»è§£ (@PublicApi,@PrivateApi, @Jwt)ï¼Œä¸¦æ•´åˆ Spring Security æä¾›åŸºç¤å®‰å…¨é…ç½®ã€‚
â”‚  â”œâ”€ sdk-auth-jwt/                     # JWT è§£æ±ºæ–¹æ¡ˆï¼šæä¾› JWT çš„ç”Ÿæˆã€è§£æèˆ‡é©—è­‰éæ¿¾å™¨ï¼Œä¸¦æ•´åˆ Redis é€²è¡Œ Session ç‹€æ…‹ç®¡ç†ã€‚
â”‚  â”œâ”€ sdk-auth-server/                  # èªè­‰æœå‹™ç«¯å¯¦ç¾ï¼šåŸºæ–¼ sdk-authï¼Œæä¾›ç™»å…¥ã€ç™»å‡ºã€åˆ·æ–° Token ç­‰æ¨™æº–èªè­‰æµç¨‹çš„ Controller å¯¦ä½œç¯„æœ¬ã€‚
â”‚  â”œâ”€ sdk-spring-session/               # Spring Session æ•´åˆï¼šè‡ªå‹•é…ç½® Spring Session ä½¿ç”¨ Redis ä½œç‚ºæœƒè©±å­˜å„²ã€‚
â”‚  â”œâ”€ sdk-spring-cloud-gateway/         # Spring Cloud Gateway å¢å¼·ï¼šæä¾›å…±ç”¨çš„ Gateway Filterï¼Œå¦‚ JWT é©—è­‰ã€è·¯ç”±èˆ‡è² è¼‰å‡è¡¡é…ç½®ã€‚
â”‚  â”œâ”€ sdk-spring-cloud-openfeign/       # OpenFeign å¢å¼·ï¼šæ•´åˆ OpenFeign å®¢æˆ¶ç«¯ã€è² è¼‰å‡è¡¡èˆ‡ Resilience4j ç†”æ–·æ©Ÿåˆ¶ã€‚
â”‚  â”œâ”€ sdk-spring-cloud-alibaba-nacos/   # Nacos æ•´åˆï¼šæä¾›æœå‹™ç™¼ç¾èˆ‡é…ç½®ä¸­å¿ƒçš„è‡ªå‹•åŒ–é…ç½®ã€‚
â”‚  â”œâ”€ sdk-infra-mysql/                  # MySQL åŸºç¤è¨­æ–½ï¼šæ•´åˆ MyBatisã€PageHelper èˆ‡å‹•æ…‹è³‡æ–™æºï¼Œç°¡åŒ–è³‡æ–™åº«æ“ä½œã€‚
â”‚  â”œâ”€ sdk-infra-redis/                  # Redis åŸºç¤è¨­æ–½ï¼šæ•´åˆ Spring Data Redis èˆ‡ Redissonï¼Œæä¾›å¿«å–ã€åˆ†å¸ƒå¼é–ç­‰åŠŸèƒ½ã€‚
â”‚  â”œâ”€ sdk-infra-kafka/                  # Kafka åŸºç¤è¨­æ–½ï¼šæä¾› Spring Kafka çš„ Producer/Consumer æ¨™æº–åŒ–é…ç½®ã€‚
â”‚  â””â”€ sdk-library-resilience4j/         # Resilience4j æ•´åˆï¼šæä¾›æ–·è·¯å™¨ã€é€Ÿç‡é™åˆ¶å™¨ã€é‡è©¦ç­‰å½ˆæ€§æ¨¡å¼çš„è‡ªå‹•åŒ–é…ç½®ã€‚
â”œâ”€ sdk-contract/                        # API å¥‘ç´„èˆ‡å®¢æˆ¶ç«¯èšåˆ
â”‚  â””â”€ exchange-sdk/                     
â”‚      â”œâ”€ exchange-user-sdk/            
â”‚      â”‚   â”œâ”€ rest-api/                 
â”‚      â”‚   â””â”€ rest-client/             
â”‚      â”œâ”€ exchange-auth-sdk/           
â”‚      â”‚   â”œâ”€ rest-api/                 
â”‚      â”‚   â””â”€ rest-client/             
â”‚      â””â”€ exchange-order-sdk/
â”‚          â”œâ”€ exchange-order-sdk-rest-api/      # Order REST å¥‘ç´„èˆ‡ DTO å®šç¾©ã€å…±ç”¨æšèˆ‰
â”‚          â”œâ”€ exchange-order-sdk-rest-client/   # Order REST Feign å®¢æˆ¶ç«¯
â”‚          â”‚     â””â”€ ExchangeOrderClient.java    # åŸºæ–¼ OrderApi çš„ FeignClientï¼Œé€é sdk-spring-cloud-openfeign å…±ç”¨æ””æˆªèˆ‡éŒ¯èª¤è™•ç†
â”‚          â””â”€ exchange-order-sdk-mq/            # Order äº‹ä»¶ Payload èˆ‡ Topic å¸¸æ•¸ï¼ˆOutbox â†’ Kafka å…±ç”¨ï¼‰
â””â”€ services/                            # å…·é«”æ¥­å‹™æœå‹™
   â”œâ”€ pom.xml                           
   â”œâ”€ service-user/                     # ä½¿ç”¨è€…åŸŸæœå‹™
   â”‚   â”œâ”€ domain/                       # èšåˆæ ¹ã€é ˜åŸŸæœå‹™ã€éŒ¯èª¤ç¢¼
   â”‚   â”‚   â”œâ”€ model/                    # Domain Model (Aggregate / Value Object)
   â”‚   â”‚   â””â”€ service/                  # Domain Service å”èª¿é ˜åŸŸè¦å‰‡
   â”‚   â”‚       â””â”€ UserDomainService.java  
   â”‚   â”œâ”€ infra/                        
   â”‚   â”‚   â””â”€ persistence/              # æŒä¹…å±¤å¯¦ä½œï¼ˆMapper + Repositoryï¼‰
   â”‚   â”‚       â”œâ”€ mapper/UserMapper.java     # MyBatis Mapper ä»‹é¢ï¼Œä¾é å…¨åŸŸ camelCase èˆ‡ Enum TypeHandler è‡ªå‹•å°æ‡‰æ¬„ä½
   â”‚   â”‚       â”œâ”€ po/UserPO.java             # è³‡æ–™åº«è¡¨æ˜ å°„ç‰©ä»¶ï¼Œæ¬„ä½èˆ‡ users è¡¨ä¸€ä¸€å°æ‡‰
   â”‚   â”‚       â””â”€ repository/                # Repository ä»‹é¢é›†åˆï¼Œè¿”å› Domain å¯¦é«”
   â”‚   â”‚           â””â”€ UserRepository.java             # ä½¿ç”¨è€…ä¸»æª”å­˜å–ä»‹é¢     
   â”‚   â”œâ”€ service/                      # Application Serviceï¼ˆç”¨ä¾‹ç·¨æ’ï¼Œéµå¾ª CQRS åˆ‡åˆ†ï¼‰
   â”‚   â”‚   â”œâ”€ UserCommandService.java   # Commandï¼šregisterUserã€ç‹€æ…‹æ›´æ–°ï¼›å®šç¾©äº¤æ˜“é‚Šç•Œèˆ‡äº‹ä»¶ç™¼å¸ƒ
   â”‚   â”‚   â””â”€ UserQueryService.java     # Queryï¼šgetMeã€findByEmailï¼›åƒ…è² è²¬è®€æ¨¡å‹èˆ‡ DTO è£é…
   â”‚   â””â”€ controller/                   # REST Controller / API å¯¦ä½œ
   â”‚       â””â”€ UserController.java       # REST Controller
   â”œâ”€ service-auth/                    # èªè­‰åŸŸæœå‹™ï¼ŒApplication å±¤åŒæ¨£åˆ†ç‚º Command/Query
   â”œâ”€ service-order/                   # è¨‚å–®åŸŸæœå‹™ï¼ŒApplication å±¤æä¾› OrderCommandService / OrderQueryService
   â”œâ”€ service-position/                # å€‰ä½åŸŸæœå‹™ï¼Œæä¾› PositionCommandService / PositionQueryService èˆ‡äº‹ä»¶å”èª¿
   â”‚   â”œâ”€ domain/
   â”‚   â”œâ”€ infra/
   â”‚   â”œâ”€ service/             
   â”‚   â””â”€ controller/

```

# ç‰¹é»

- order
    - ä¸‹å–® ï¼š
        - é™åƒ¹å–®ã€å¸‚åƒ¹å–®
        - é–‹å€‰ (å¤š/ç©º)ã€å¹³å€‰ã€æ’¤éŠ·å§”è¨—
    - ä½¿ç”¨ saga æ¨¡å¼é€²è¡Œä¸‹å–®æµç¨‹
    - event sourcing
- å¸³å‹™
    - ä¸‹å–®é æ‰£
    - æ ¹æ“šæˆäº¤ã€å¼·å¹³ã€~~è³‡é‡‘è²»ç‡~~ äº‹ä»¶èª¿æ•´å¸³å‹™ã€‚
    - å…¬å¸å¸³ç›®å°æ˜ æœƒè¨ˆç§‘ç›®ï¼Œé›™åˆ†éŒ„è¨˜å¸³æ³•
- æ’®åˆ
    - å–®ç·šç¨‹ order book ï¼Œå…§å­˜æ’®åˆ
    - æ¯å€‹äº¤æ˜“å°ç¶­è­·ç¨ç«‹çš„ Order Book
    - åƒ¹æ ¼å„ªå…ˆã€æ™‚é–“å„ªå…ˆ (Price-Time Priority) çš„æ’®åˆç®—æ³•
    - WAL
- è¡Œæƒ…
    - æ¶ˆè²»æˆäº¤ã€æ›æ’¤å–®äº‹ä»¶ï¼Œæ›´æ–° Tickerã€æ·±åº¦ã€K ç·š
    - ~~æ ¹æ“šå¤šå®¶å¤–éƒ¨äº¤æ˜“æ‰€çš„ç¾è²¨åƒ¹æ ¼ï¼Œè¨ˆç®—å‡ºå…¬å…çš„æŒ‡æ•¸åƒ¹æ ¼èˆ‡æ¨™è¨˜åƒ¹æ ¼ï¼Œä¸¦æ¨é€è¡Œæƒ…äº‹ä»¶~~
    - K ç·šåœ–æŸ¥è©¢:
        - æä¾›å¤šç¨®æ™‚é–“é€±æœŸ (1m, 5m, 1h, 1d ç­‰) çš„ K ç·šæ•¸æ“šã€‚
        - æ”¯æ´ REST API æŸ¥è©¢æ­·å² K ç·šã€‚
    - ~~è³‡é‡‘è²»ç‡~~
        - ~~å®šæœŸ (å¦‚æ¯ 8 å°æ™‚) è¨ˆç®—ä¸¦çµç®—å¤šç©ºé›™æ–¹çš„è³‡é‡‘è²»ç”¨ï¼Œè²»ç‡è¨ˆç®—æ‡‰åŸºæ–¼æ¨™è¨˜åƒ¹æ ¼èˆ‡æŒ‡æ•¸åƒ¹æ ¼çš„åƒ¹å·®ã€‚~~
- å€‰ä½
    - å¹³å€‰é æ‰£
    - æ¶ˆè²»æˆäº¤ã€å¸³å‹™ã€è¡Œæƒ…äº‹ä»¶ï¼Œå³æ™‚æ›´æ–°å€‰ä½ä¿¡æ¯
    - æ§“æ¡¿å€æ•¸èª¿æ•´æ¥å£
    - å–®å‘æŒå€‰
    - event sourcing
    - ç”¨æˆ¶å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æŒå€‰çš„è©³ç´°è³‡è¨Šï¼ŒåŒ…æ‹¬å€‰ä½æ•¸é‡ã€é–‹å€‰å‡åƒ¹ã€æœªå¯¦ç¾ç›ˆè™§ã€ä¿è­‰é‡‘ã€å¼·å¹³åƒ¹æ ¼ç­‰ã€‚
- é¢¨æ§
    - ä¸‹å–®é æª¢ï¼Œæ ¹æ“šå€‰ä½å¤§å°å’Œæ§“æ¡¿ï¼Œè¨ˆç®—åˆå§‹ä¿è­‰é‡‘èˆ‡ç¶­æŒä¿è­‰é‡‘ã€‚
    - é€å€‰ä¿è­‰é‡‘æ¨¡å¼
    - ç•¶ç”¨æˆ¶çš„ä¿è­‰é‡‘ç‡ä½æ–¼ç¶­æŒä¿è­‰é‡‘ç‡æ™‚ï¼Œç³»çµ±è‡ªå‹•åŸ·è¡Œå¼·åˆ¶å¹³å€‰æµç¨‹ã€‚
        - æ¡ç”¨æ¨™è¨˜åƒ¹æ ¼è§¸ç™¼å¼·å¹³ï¼Œä»¥é¿å…å¸‚å ´æ’é‡é€ æˆçš„ç•°å¸¸æ³¢å‹•ã€‚

- ~~ç³»çµ±èª¿æ•´ (Manual Adjustments / ADL)~~
- äº¤æ˜“æ­·å²: ç”¨æˆ¶å¯ä»¥æŸ¥è©¢æ­·å²å§”è¨—ã€æ­·å²æˆäº¤èˆ‡è³‡é‡‘æµæ°´è¨˜éŒ„ã€‚
- è¨»å†Šï¼šé€é Email é€²è¡Œè¨»å†Š
- ç™»å…¥ï¼šæ”¯æ´ JWT (Access/Refresh Token) æ©Ÿåˆ¶ï¼Œç®¡ç†ç”¨æˆ¶æœƒè©±ã€‚å¯ä»¥è¸¢ä¸‹ç·š

# 

# æœå‹™ä¾è³´é—œä¿‚åœ–

```mermaid
flowchart LR
    Client[å‰ç«¯/äº¤æ˜“å®¢æˆ¶ç«¯]

    subgraph Services[æœå‹™]
        Gateway[Gateway æœå‹™]
        Auth[Auth æœå‹™]
        User[User æœå‹™]
        OrderSvc[Order æœå‹™]
        RiskSvc[Risk æœå‹™]
        LedgerSvc[Ledger æœå‹™]
        PositionsSvc[Positions æœå‹™]
        MarketSvc[Market æœå‹™]
        MatchingSvc[Matching æœå‹™]

        %% äº‹ä»¶ç¯€é»
        LedgerEntryEvt((LedgerEntryCreated))
        TradeExecutedEvt((TradeExecuted))
    end

    Client -->|HTTP| Gateway
    Gateway -->|REST| Auth
    Gateway -->|REST| User
    Gateway -->|REST| OrderSvc
    Gateway -->|REST| RiskSvc
    Gateway -->|REST| LedgerSvc
    Gateway -->|REST| PositionsSvc
    Gateway -->|REST| MarketSvc
    Gateway -->|REST| MatchingSvc
    User -.->|å»ºç«‹æ†‘è­‰| Auth

    OrderSvc -- OrderSubmitted --> RiskSvc
    OrderSvc -- PositionReserveRequested --> PositionsSvc
    OrderSvc -- OrderCreated --> MatchingSvc

    RiskSvc -- Risk Feedback --> OrderSvc
    RiskSvc -- Margin Alerts --> PositionsSvc

    LedgerSvc --> LedgerEntryEvt
    LedgerEntryEvt --> OrderSvc
    LedgerEntryEvt --> PositionsSvc
    LedgerSvc -- FundsFrozen / FundsUnfrozen --> OrderSvc

    MatchingSvc --> TradeExecutedEvt
    TradeExecutedEvt --> MarketSvc
    TradeExecutedEvt --> LedgerSvc
    TradeExecutedEvt --> PositionsSvc
    MatchingSvc -- OrderBookUpdated --> MarketSvc

    PositionsSvc -- PositionUpdated --> RiskSvc

    MarketSvc -- MarkPriceUpdated --> RiskSvc
    MarketSvc -- MarkPriceUpdated --> PositionsSvc
    MarketSvc -- FundingRateUpdated --> LedgerSvc

    MarketSvc -->|è¡Œæƒ…æ¨é€| Client
```

# æµç¨‹æª¢æ ¸è¡¨

## å¸³è™Ÿ

- âœ”ï¸ è¨»å†Šï¼š[`POST /api/users`ï¼šè¨»å†Š](#`POST%20/api/users`ï¼šè¨»å†Š)
- âœ”ï¸ ç™»å…¥ã€refresh tokenã€ç™»å‡ºï¼š[[#POST `/api/auth/login`ï¼šç™»å…¥]]

## å¸³æˆ¶ã€å‡ºå…¥é‡‘

## èª¿æ•´æ§“æ¡¿

- å€‰ä½
    - âœ”ï¸ [POST `/api/positions/{instrumentId}/leverage`](#POST%20`/api/positions/{instrumentId}/leverage`)
- é¢¨æ§
    - âœ”ï¸ [`POST /api/risk/precheck/leverage`](#`POST%20/api/risk/precheck/leverage`)

## ä¸‹å–®

- **ä¸‹å–®**ï¼š
    - Order
        - [`POST /api/orders`](#`POST%20/api/orders`)
        - POST  `/api/positions/intent`
    - å€‰ä½
        - [Event Inputï¼š`PositionReserveRequested`](#Event%20Inputï¼š`PositionReserveRequested`)
            - ç™¼å¸ƒ`PositionReserved`
            - ç™¼å¸ƒ`PositionReserveRejected`
    - é¢¨æ§
        - [Event Inputï¼š `OrderSubmitted`](#Event%20Inputï¼š%20`OrderSubmitted`)
            - ç™¼å¸ƒ `MarginPreCheckPassed`
            - ç™¼å¸ƒ `MarginPreCheckFailed`
    - å¸³å‹™
        - [Event Inputï¼šMarginPreCheckPassed](#Event%20Inputï¼šMarginPreCheckPassed)
            - ç™¼ä½ˆ`FundsFrozen`
            - ç™¼ä½ˆ`FundsUnfrozen`
- **æ’®åˆ**
    - [Event Inputï¼š`OrderCreated`](#Event%20Inputï¼š`OrderCreated`)
- **è¡Œæƒ…**ï¼š`market-data
    - âœ”ï¸ä¾ `OrderBookUpdated` æ›´æ–°æ·±åº¦èˆ‡æœ€ä½³åƒ¹
    - âœ”ï¸ä¾ `TradeExecuted` æ›´æ–° Tickerã€K ç·šã€markPrice
    - âœ”ï¸ä»¥ `MarkPriceUpdated` ç­‰äº‹ä»¶æ¨é€çµ¦ `positions`ã€`risk-margin`
- **å¸³å‹™**ï¼š`account-ledger`
    - æ¶ˆè²» `TradeExecuted`
        - ç™¼ä½ˆ `LedgerEntryCreated` ï¼Œå°‡è³‡é‡‘è®Šå‹•åŒæ­¥åˆ° order èˆ‡ positions å½¢æˆé–‰ç’°
    - æ¶ˆè²» `LiquidationTriggered`
- **å€‰ä½**ï¼š`positions`
    - æ¶ˆè²»`TradeExecuted`
    - æ¶ˆè²»`LedgerEntryCreated`
    - æ¶ˆè²»`MarkPriceUpdated`

## å¼·å¹³

- é¢¨æ§
    - æ¶ˆè²» `PositionUpdated`
    - æ¶ˆè²»`MarkPriceUpdated` ï¼Œæ›´æ–° `risk_snapshots`ï¼Œæ±ºå®šæ˜¯å¦é™åˆ¶ä¸‹å–®æˆ–è§¸ç™¼å¼·å¹³
    - ç•¶ `margin_ratio` ä½æ–¼é–€æª»ï¼Œå¯«å…¥ `liquidation_queue` ä¸¦é€éæ¸…ç®—æµç¨‹ï¼Œç™¼å¸ƒ `LiquidationTriggered`

# é–‹å¹³å€‰ä¸‹å–®æµç¨‹

é€™æ˜¯ä¸€å€‹åŸºæ–¼**å¾®æœå‹™æ¶æ§‹**ï¼Œé‡å°**é€å€‰ä¿è­‰é‡‘ (Isolated Margin)** èˆ‡ **å–®å‘æŒå€‰ (One-Way Mode)** çš„å®Œæ•´é–‹å¹³å€‰ä¸‹å–®æµç¨‹è¨­è¨ˆã€‚

æˆ‘å€‘å°‡æµç¨‹åˆ†ç‚ºä¸‰å¤§å ´æ™¯ï¼š**é–‹å€‰ (Open)**ã€**å¹³å€‰ (Close)**ã€ä»¥åŠå–®å‘æŒå€‰ç‰¹æœ‰çš„**åæ‰‹ (Flip)**ã€‚

---

### 1. é–‹å€‰æµç¨‹ (Open Position)

**æ ¸å¿ƒåŸå‰‡**ï¼šå…ˆå‡çµè³‡é‡‘ï¼Œç¢ºä¿å„Ÿä»˜èƒ½åŠ›ï¼Œå†å»ºç«‹å€‰ä½ã€‚

#### æµç¨‹æ­¥é©Ÿï¼š

1. **ä¸‹å–®è«‹æ±‚ (Request)**
    - ç”¨æˆ¶ç™¼é€è¨‚å–®ï¼ˆä¾‹å¦‚ï¼šè²·å…¥åšå¤š 1 BTCï¼‰ã€‚
        
2. **é¢¨æ§æª¢æŸ¥ (Risk Check)**
    - æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹ã€æ§“æ¡¿å€æ•¸é™åˆ¶ã€‚
    - è¨ˆç®— **æ‰€éœ€å‡çµé‡‘é¡** = `(è¨‚å–®åƒ¹å€¼ / æ§“æ¡¿) + é ä¼°æ‰‹çºŒè²»`ã€‚
        
3. **è³‡é‡‘å‡çµ (Account Service)**
    - **Action**: Account æœå‹™æ‰£æ¸› `Available Balance`ï¼Œå¢åŠ  `Order Frozen`ã€‚
    - è‹¥é¤˜é¡ä¸è¶³ï¼Œç›´æ¥æ‹’å–®ã€‚
        
4. **æ’®åˆ (Matching Engine)**
    - è¨‚å–®é€²å…¥ Order Bookï¼Œæ’®åˆæˆåŠŸï¼Œç”Ÿæˆæˆäº¤å›å ± (Trade Execution)ã€‚
        
5. **çµç®—èˆ‡å»ºå€‰ (Settlement & Position Service)**
    - æ”¶åˆ°æˆäº¤å›å ±ã€‚
    - **Action 1 (Account)**: å°‡ `Order Frozen` è½‰ç‚º `Realized Deduct` (å¯¦éš›æ‰£é™¤)ï¼Œé€™ç­†éŒ¢åœ¨é‚è¼¯ä¸Šå·²ç¶“é›¢é–‹éŒ¢åŒ…ï¼Œé€²å…¥äº†å€‰ä½ã€‚
	- **Action 2 (Position)**: å»ºç«‹æ–°å€‰ä½è¨˜éŒ„ (Position ID)ã€‚
        - è¨˜éŒ„ `Entry Price` (é–‹å€‰å‡åƒ¹)ã€‚
        - è¨˜éŒ„ `Isolated Margin` (å°‡ Account å‡çµçš„éŒ¢ï¼Œæ­£å¼åŠƒæ­¸ç‚ºæ­¤å€‰ä½çš„ä¿è­‰é‡‘)ã€‚
        

ç¨‹å¼ç¢¼ç‰‡æ®µ

```mermaid
sequenceDiagram
    participant User
    participant Gateway
    participant Account as Account Service
    participant Match as Match Engine
    participant Position as Position Service

    User->>Gateway: é–‹å€‰è¨‚å–® (Open Long)
    Gateway->>Account: 1. è«‹æ±‚å‡çµä¿è­‰é‡‘
    Account-->>Gateway: å‡çµæˆåŠŸ
    Gateway->>Match: 2. ç™¼é€è¨‚å–®
    Match-->>Position: 3. æ’®åˆæˆåŠŸ (æˆäº¤å›å ±)
    Position->>Position: 4. å»ºç«‹å€‰ä½ (è¨˜éŒ„ä¿è­‰é‡‘)
    Position->>Account: 5. é€šçŸ¥: å‡çµè½‰ç‚ºå€‰ä½ä½”ç”¨
```

---

### 2. å¹³å€‰æµç¨‹ (Close Position)

**æ ¸å¿ƒåŸå‰‡**ï¼šå…ˆç”±å€‰ä½è¨ˆç®—ç›ˆè™§ï¼Œå†é€šçŸ¥å¸³æˆ¶å…¥å¸³ã€‚

#### æµç¨‹æ­¥é©Ÿï¼š

1. **ä¸‹å–®è«‹æ±‚ (Request)**
    - ç”¨æˆ¶ç™¼é€å¹³å€‰å–®ï¼ˆä¾‹å¦‚ï¼šæŒæœ‰ 1 BTC å¤šå–®ï¼Œè³£å‡º 1 BTC å¹³å€‰ï¼‰ã€‚
        
2. **æŒå€‰æª¢æŸ¥ (Position Check)**
    - æª¢æŸ¥æ˜¯å¦æœ‰å°æ‡‰çš„æŒå€‰ï¼Ÿæ•¸é‡æ˜¯å¦è¶³å¤ ï¼Ÿ
    - **æ³¨æ„**ï¼šå¹³å€‰å–®**ä¸éœ€è¦**å‡çµæ–°çš„è³‡é‡‘ï¼ˆé™¤éæ˜¯è™§æå°è‡´ç©¿å€‰ï¼Œä½†é‚£æ˜¯æ¥µç«¯æƒ…æ³ï¼‰ï¼Œç›¸åï¼Œå®ƒæœƒé‡‹æ”¾è³‡é‡‘ã€‚
        
3. **æ’®åˆ (Matching Engine)**
    - æ’®åˆæˆåŠŸï¼Œç”Ÿæˆæˆäº¤å›å ±ã€‚
        
4. **çµç®—èˆ‡å¹³å€‰ (Settlement & Position Service)**
    - **Action 1 (Position - è¨ˆç®—)**:
        - è¨ˆç®— **å·²å¯¦ç¾ç›ˆè™§ (Realized PnL)** = `(å¹³å€‰åƒ¹ - é–‹å€‰å‡åƒ¹) * æ•¸é‡ * æ–¹å‘`ã€‚
        - è¨ˆç®— **æ‡‰é‡‹æ”¾ä¿è­‰é‡‘** = è©²é€å€‰å€‰ä½åŸæœ¬é–å®šçš„ä¿è­‰é‡‘ã€‚
        - è¨ˆç®— **ç¸½è¿”é‚„é‡‘é¡ (Payout)** = `æ‡‰é‡‹æ”¾ä¿è­‰é‡‘ + PnL - æ‰‹çºŒè²»`ã€‚
        - æ›´æ–°å€‰ä½ï¼šå°‡æ•¸é‡æ­¸é›¶ï¼ˆæˆ–æ¸›å°‘ï¼‰ï¼Œæ¨™è¨˜ç‚ºé—œé–‰ã€‚
    - **Action 2 (Account - å…¥å¸³)**:
        - Position æœå‹™ç™¼é€ `Payout` æŒ‡ä»¤çµ¦ Accountã€‚
        - Account å¢åŠ ç”¨æˆ¶çš„ `Available Balance`ã€‚
            

ç¨‹å¼ç¢¼ç‰‡æ®µ

```
sequenceDiagram
    participant User
    participant Gateway
    participant Position as Position Service
    participant Match as Match Engine
    participant Account as Account Service

    User->>Gateway: å¹³å€‰è¨‚å–® (Close Long)
    Gateway->>Position: 1. æª¢æŸ¥æŒå€‰ & å¯å¹³é‡
    Position-->>Gateway: æª¢æŸ¥é€šé
    Gateway->>Match: 2. ç™¼é€è¨‚å–®
    Match-->>Position: 3. æ’®åˆæˆåŠŸ (æˆäº¤å›å ±)
    Position->>Position: 4. è¨ˆç®—ç›ˆè™§ & æ‡‰é€€é‡‘é¡ (PnL Calc)
    Position->>Account: 5. åŸ·è¡Œå…¥å¸³ (Add Balance)
```

---

### 3. åæ‰‹æµç¨‹ (The Flip - å–®å‘æŒå€‰ç‰¹æœ‰)

å ´æ™¯ï¼šç”¨æˆ¶æŒæœ‰ 10 å€‹å¤šå–®ï¼Œä¸‹äº†ä¸€å€‹ è³£å‡º 15 å€‹ç©ºå–® çš„æŒ‡ä»¤ã€‚

é‚è¼¯ï¼šç³»çµ±éœ€å°‡å…¶æ‹†è§£ç‚ºã€Œå¹³æ‰ 10 å€‹å¤šå–®ã€+ã€Œæ–°é–‹ 5 å€‹ç©ºå–®ã€ã€‚

#### æµç¨‹æ­¥é©Ÿï¼š

1. **ä¸‹å–®èˆ‡é æª¢æŸ¥**
    - ç³»çµ±è­˜åˆ¥å‡º `è¨‚å–®æ•¸é‡ (15) > æŒå€‰æ•¸é‡ (10)` ä¸”æ–¹å‘ç›¸åã€‚
    - è¨ˆç®—ã€Œè¶…å‡ºçš„ 5 å€‹ç©ºå–®ã€æ‰€éœ€çš„ä¿è­‰é‡‘ã€‚
    - **Account Service**: æª¢æŸ¥ç”¨æˆ¶é¤˜é¡æ˜¯å¦è¶³å¤ æ”¯ä»˜é€™ **5 å€‹æ–°ç©ºå–®** çš„ä¿è­‰é‡‘ï¼Œä¸¦é€²è¡Œå‡çµã€‚
        
2. **æ’®åˆ**
    - Match Engine ä¸ç®¡é‚è¼¯ï¼Œç›´æ¥æˆäº¤ 15 å€‹å–®ä½çš„ Sellã€‚
        
3. **è¤‡é›œçµç®— (Settlement)**
    - Position Service æ”¶åˆ° 15 å€‹ Sell æˆäº¤å›å ±ï¼Œè®€å–ç•¶å‰æŒå€‰ (10 Long)ã€‚
    - **Step A: åŸ·è¡Œå¹³å€‰ (Close Logic)**
        - ä½¿ç”¨ 10 å€‹æˆäº¤é‡å¹³æ‰èˆŠå€‰ä½ã€‚
        - è¨ˆç®— 10 å€‹ Long çš„ PnL å’Œä¿è­‰é‡‘é‡‹æ”¾ã€‚
        - é€šçŸ¥ Account Service å…¥å¸³ (é€™ç­†éŒ¢å›æµåˆ°é¤˜é¡)ã€‚
    - **Step B: åŸ·è¡Œé–‹å€‰ (Open Logic)**
        - ä½¿ç”¨å‰©é¤˜çš„ 5 å€‹æˆäº¤é‡å»ºç«‹æ–°å€‰ä½ (Short)ã€‚
        - ä½¿ç”¨ç¬¬ 1 æ­¥å‡çµçš„è³‡é‡‘ä½œç‚ºæ–°å€‰ä½çš„é€å€‰ä¿è­‰é‡‘ã€‚
        - è¨˜éŒ„æ–°å€‰ä½çš„ Entry Priceã€‚
            

---

### ç¸½çµå°æ¯”è¡¨

|**éšæ®µ**|**å‹•ä½œ**|**è² è²¬æœå‹™**|**è³‡é‡‘æµå‘**|
|---|---|---|---|
|**é–‹å€‰ (Open)**|1. å‡çµè³‡é‡‘|**Account**|`Available` $\to$ `Frozen`|
||2. å»ºç«‹å€‰ä½|**Position**|è¨˜éŒ„å€‰ä½ä¿è­‰é‡‘ï¼Œç¶å®š Position ID|
||3. ç¢ºèªæ‰£æ¬¾|**Account**|`Frozen` $\to$ `Deducted` (éŒ¢é€²å…¥å€‰ä½)|
|**å¹³å€‰ (Close)**|1. æ’®åˆæˆäº¤|**Match**|ç”Ÿæˆæˆäº¤æ•¸æ“š|
||2. è¨ˆç®—çµç®—|**Position**|ç®—å‡º PnLï¼Œæ±ºå®šè©²é‚„çµ¦ç”¨æˆ¶å¤šå°‘éŒ¢|
||3. è³‡é‡‘å…¥å¸³|**Account**|`None` $\to$ `Available` (éŒ¢å›åˆ°éŒ¢åŒ…)|

é€™å€‹æµç¨‹è¨­è¨ˆç¢ºä¿äº†ï¼š

1. **è³‡é‡‘å®‰å…¨**ï¼šé–‹å€‰å‰éŒ¢å°±è¢«é–ä½äº†ï¼Œä¸æœƒç™¼ç”Ÿã€Œé–‹äº†å€‰å»æ²’éŒ¢ä»˜ä¿è­‰é‡‘ã€çš„æƒ…æ³ã€‚
    
2. **å¸³ç›®æ¸…æ™°**ï¼šå¹³å€‰æ™‚ç”± Position æ¸…æ¥šç®—å‡ºè³ºè³ ï¼ŒAccount åªè² è²¬åŸ·è¡ŒåŠ éŒ¢ï¼Œè·è²¬åˆ†é›¢ã€‚

# é–‹å¹³å€‰çµç®—æµç¨‹

æ‚¨çš„ç†è§£åœ¨é‚è¼¯ä¸Šæ˜¯å®Œå…¨æ­£ç¢ºçš„ã€‚åœ¨åˆ†ä½ˆå¼ç³»çµ±æˆ–æ¨¡çµ„åŒ–è¨­è¨ˆçš„äº¤æ˜“ç³»çµ±ä¸­ï¼Œè³‡é‡‘æµï¼ˆAccountï¼‰èˆ‡å€‰ä½æµï¼ˆPositionï¼‰çš„è™•ç†é †åºç¢ºå¯¦éµå¾ªé€™å€‹åŸå‰‡ï¼Œä»¥ç¢ºä¿**ã€Œè³‡é‡‘å®‰å…¨ï¼ˆSolvencyï¼‰ã€**å’Œ**ã€Œæ•¸æ“šä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€**ã€‚

æˆ‘å€‘å°‡é€™å…©å€‹æµç¨‹æ‹†è§£é–‹ä¾†ï¼Œè§£é‡‹ç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆæ˜¯åˆç†çš„ï¼Œä»¥åŠä¸­é–“å¯èƒ½æ¶‰åŠçš„ç´°ç¯€ï¼ˆç‰¹åˆ¥æ˜¯ã€Œå‡çµã€èˆ‡ã€Œçµç®—ã€çš„å€åˆ¥ï¼‰ï¼š

---

### 1. é–‹å€‰ (Open Position)ï¼šå…ˆæ‰£æ¬¾ï¼Œå¾Œçµ¦è²¨

**é‚è¼¯ï¼šAccount (è³‡é‡‘å‡çµ/æ‰£é™¤) $\rightarrow$ Position (å»ºç«‹å€‰ä½/å¯«å…¥ä¿è­‰é‡‘)**

åœ¨é–‹å€‰æ™‚ï¼Œç³»çµ±å¿…é ˆç¢ºä¿ç”¨æˆ¶æœ‰è¶³å¤ çš„éŒ¢ä¾†æ‰¿æ“”é¢¨éšªã€‚å¦‚æœå…ˆå»ºç«‹å€‰ä½å†æ‰£æ¬¾ï¼Œä¸€æ—¦æ‰£æ¬¾å¤±æ•—ï¼Œç”¨æˆ¶å°±æœƒæ“æœ‰ä¸€å€‹ã€Œç„¡æ“”ä¿ã€çš„å€‰ä½ï¼Œé€™åœ¨é‡‘èç³»çµ±ä¸­æ˜¯åš´é‡æ¼æ´ã€‚
- **è©³ç´°æµç¨‹ï¼š**
    
    1. **ä¸‹å–®éšæ®µ (Pre-Trade)**ï¼š
        - **Account Service**ï¼šç”¨æˆ¶ä¸‹å–®ç¬é–“ï¼ŒRisk Engine æœƒå…ˆæª¢æŸ¥é¤˜é¡ï¼Œä¸¦é€šçŸ¥ Account Service **ã€Œå‡çµ (Freeze)ã€** èµ·å§‹ä¿è­‰é‡‘ + æ‰‹çºŒè²»ã€‚æ­¤æ™‚éŒ¢é‚„åœ¨ç”¨æˆ¶å¸³æˆ¶è£¡ï¼Œåªæ˜¯è®Šæˆä¸å¯ç”¨ (Frozen)ã€‚
            
    2. **æˆäº¤éšæ®µ (Post-Trade)**ï¼š
        - **Match Engine**ï¼šæ’®åˆæˆåŠŸï¼Œç”Ÿæˆæˆäº¤å›å ±ã€‚
        - **Settlement (çµç®—)**ï¼šæ”¶åˆ°æˆäº¤å›å ±å¾Œã€‚
        - **Account Service**ï¼šå°‡åŸæœ¬ã€Œå‡çµã€çš„è³‡é‡‘æ­£å¼**ã€Œæ‰£é™¤ã€**ï¼ˆæˆ–è½‰ç§»è‡³ä¿è­‰é‡‘æ± ï¼‰ã€‚
        - **Position Service**ï¼šæ¥æ”¶åˆ°è³‡é‡‘ç¢ºèªå¾Œï¼Œ**ã€Œå¯«å…¥ã€** å€‰ä½æ•¸æ“šï¼Œè¨˜éŒ„è©²å€‰ä½çš„ `Isolated Margin`ï¼ˆé€å€‰ä¿è­‰é‡‘ï¼‰å’Œ `Entry Price`ï¼ˆé–‹å€‰åƒ¹ï¼‰ã€‚
            

> **çµè«–**ï¼šè³‡é‡‘çš„é–å®šå¿…é ˆç™¼ç”Ÿåœ¨å€‰ä½ç”¢ç”Ÿä¹‹å‰ã€‚

---

### 2. å¹³å€‰ (Close Position)ï¼šå…ˆç®—å¸³ï¼Œå¾Œé‚„éŒ¢

**é‚è¼¯ï¼šPosition (è¨ˆç®—ç›ˆè™§èˆ‡é‡‹æ”¾é‡‘é¡) $\rightarrow$ Account (å…¥å¸³)**

åœ¨å¹³å€‰æ™‚ï¼ŒAccount Service ä¸¦ä¸çŸ¥é“é€™ç­†äº¤æ˜“è³ºäº†å¤šå°‘éŒ¢ï¼Œä¹Ÿä¸çŸ¥é“é€™å€‹é€å€‰å€‰ä½ç•¶æ™‚åˆ°åº•é–äº†å¤šå°‘ä¿è­‰é‡‘ã€‚é€™äº›æ•¸æ“šéƒ½åœ¨ Position Service èº«ä¸Šã€‚
- **è©³ç´°æµç¨‹ï¼š**
    
    1. **æˆäº¤éšæ®µ (Post-Trade)**ï¼š
        - **Match Engine**ï¼šæ’®åˆå¹³å€‰å–®ï¼Œç”Ÿæˆæˆäº¤å›å ±ã€‚
            
    2. **çµç®—éšæ®µ (Settlement)**ï¼š
        - **Position Service**ï¼šå®ƒæ˜¯ã€Œå”¯ä¸€çœŸç†ä¾†æºã€ã€‚
            - è¨ˆç®— **å·²å¯¦ç¾ç›ˆè™§ (Realized PnL)**ï¼š`(å¹³å€‰åƒ¹ - é–‹å€‰å‡åƒ¹) * æ•¸é‡`ã€‚
            - è¨ˆç®— **æ‡‰é‡‹æ”¾ä¿è­‰é‡‘**ï¼šæŸ¥è©¢è©²é€å€‰ç•¶å‰é–å®šçš„ä¿è­‰é‡‘é‡‘é¡ã€‚
            - è¨ˆç®— **è¿”é‚„ç¸½é¡ (Payout)**ï¼š`åŸä¿è­‰é‡‘ + PnL` (è‹¥è™§æå‰‡æ‰£é™¤)ã€‚
            - **æ›´æ–°å€‰ä½**ï¼šå°‡å€‰ä½æ•¸é‡æ­¸é›¶æˆ–æ¸›å°‘ï¼Œä¸¦ç”± Position Service ç™¼å‡ºã€Œçµç®—å®Œæˆäº‹ä»¶ã€ã€‚
        - **Account Service**ï¼šæ”¶åˆ° Position Service ç®—å¥½çš„ `Payout` é‡‘é¡ï¼Œå°‡é€™ç­†éŒ¢**ã€ŒåŠ å›ã€** ç”¨æˆ¶çš„å¯ç”¨é¤˜é¡ (Available Balance)ã€‚
            

> **çµè«–**ï¼šå¿…é ˆå…ˆç”±å€‰ä½ç³»çµ±çµç®—ç¸¾æ•ˆï¼Œè³‡é‡‘ç³»çµ±æ‰çŸ¥é“è©²åŠ æ¸›å¤šå°‘éŒ¢ã€‚

---

### 3. ç³»çµ±è¨­è¨ˆä¸Šçš„è£œå……å»ºè­° (å¦‚æœæ˜¯å¾®æœå‹™æ¶æ§‹)

é›–ç„¶é‚è¼¯é †åºæ˜¯é€™æ¨£ï¼Œä½†åœ¨å¯¦ä½œä¸Šï¼ˆç‰¹åˆ¥æ˜¯è³‡æ–™åº«å±¤é¢ï¼‰ï¼Œé€™é€šå¸¸éœ€è¦ç”±ä¸€å€‹ **çµç®—æœå‹™ (Settlement Service)** ä¾†å”èª¿ï¼Œæˆ–è€…ä½¿ç”¨ **TCC (Try-Confirm-Cancel)** æ¨¡å¼ä¾†ä¿è­‰åŸå­æ€§ (Atomicity)ï¼š

1. **å†ªç­‰æ€§ (Idempotency)**ï¼š
    - å¹³å€‰æ™‚ï¼ŒPosition Service è¨ˆç®—å®Œç™¼é€çµ¦ Account Service çš„è«‹æ±‚å¿…é ˆå¸¶æœ‰å”¯ä¸€çš„ `TradeID`ã€‚å¦‚æœ Account Service å› ç‚ºç¶²è·¯æŠ–å‹•æ”¶åˆ°å…©æ¬¡è«‹æ±‚ï¼Œä¸èƒ½åŠ å…©æ¬¡éŒ¢ã€‚
        
2. **å¼·å¹³èˆ‡ç©¿å€‰ (Liquidation & Bankruptcy)**ï¼š
    - åœ¨å¹³å€‰è¨ˆç®— PnL æ™‚ï¼Œå¦‚æœè™§æè¶…éäº†ä¿è­‰é‡‘ï¼ˆç©¿å€‰ï¼‰ï¼ŒPosition Service è¨ˆç®—å‡ºçš„ `Payout` æœƒæ˜¯è² æ•¸ã€‚
    - é€™æ™‚å‚³çµ¦ Account Service çš„é‚è¼¯ä¸æ˜¯ã€Œå¾ç”¨æˆ¶éŒ¢åŒ…æ‰£éŒ¢ã€ï¼ˆå› ç‚ºé€å€‰ä¸è² å‚µï¼‰ï¼Œè€Œæ˜¯è©²ç­†æå¤±éœ€æ¨™è¨˜ç‚ºã€Œç©¿å€‰æå¤±ã€ï¼Œç”±**é¢¨éšªæº–å‚™é‡‘ (Insurance Fund)** å¸³æˆ¶é€²è¡Œå¡«è£œï¼ŒAccount Service åƒ…éœ€å°‡ç”¨æˆ¶è©²é€å€‰ä¿è­‰é‡‘æ­¸é›¶å³å¯ã€‚
        

### ç¸½çµåœ–ç¤º
- **é–‹å€‰**ï¼šğŸ’° Account (é–å®š) $\rightarrow$ ğŸ¤ Match $\rightarrow$ ğŸ“ Position (è¨˜éŒ„)
- **å¹³å€‰**ï¼šğŸ¤ Match $\rightarrow$ ğŸ§® Position (è¨ˆç®— PnL) $\rightarrow$ ğŸ’° Account (è§£é–/å…¥å¸³)
    

æ‚¨çš„è¨­è¨ˆæ€è·¯å®Œå…¨æ­£ç¢ºã€‚
# 

# Gateway æœå‹™

**è·è²¬**: çµ±ä¸€å…¥å£ã€JWTé©—è­‰ã€è·¯ç”±è½‰ç™¼

| HTTP Method | Endpoint | èªªæ˜           | èª¿ç”¨è€…    | æˆæ¬Š  | è½‰ç™¼è‡³  | DBæ“ä½œ | ç·©å­˜æ“ä½œ                                                                | æœå‹™èª¿ç”¨ | è£œå„Ÿæ©Ÿåˆ¶ |
|-------------|----------|--------------|--------|-----|------|------|---------------------------------------------------------------------|------|------|
| -           | -        | JWTé©—è­‰ã€è·¯ç”±æ‰€æœ‰è«‹æ±‚ | Client | jwt | å„å¾®æœå‹™ | -    | Redis get `open:vincentf13:security:sessions:{sessionId}` é©—è­‰Session | -    | -    |

---

## gateway

- å°æ¥å¤–éƒ¨æµé‡ï¼Œçµ±ä¸€åŸ·è¡Œ JWT é©—è­‰~~ã€ç¯€æµã€è¨­å‚™æŒ‡ç´‹æª¢æŸ¥ã€‚~~
- ç®¡ç†è·¯ç”±ç­–ç•¥~~ã€A/B æ¸¬è©¦ã€ç°åº¦/Canary ç™¼ä½ˆï¼Œä¸¦æ•´åˆè§€æ¸¬æ€§ç®¡ç·šã€‚~~
- æä¾›å¥åº·æª¢æŸ¥~~ã€éŒ¯èª¤è½‰æ›ã€~~å®‰å…¨æ¨™é ­æ³¨å…¥ã€‚

# Auth æœå‹™

## è·è²¬

- æ”¯æ´å¯†ç¢¼ã€~~OTPã€FIDOã€ç¤¾ç¾¤ç™»å…¥ç­‰å¤šç¨®èªè­‰æ–¹å¼ï¼Œç¶­è­·ç™»å…¥å¯©è¨ˆã€‚~~
- ç¶­è­·æœƒè©±ã€åˆ·æ–°æ¬Šæ–ã€è¸¢ä¸‹ç·šã€~~è£ç½®ç¶å®šèˆ‡ç™»å…¥é€šçŸ¥~~ã€‚
- ~~ç™¼å¸ƒç™»å…¥/ç™»å‡ºäº‹ä»¶çµ¦é¢¨æ§ã€å ±è¡¨èˆ‡é€šçŸ¥æ¨¡çµ„ã€‚

## endpoint

| å®Œæˆ | HTTP Method | Endpoint                  | èªªæ˜      | èª¿ç”¨è€…     | æˆæ¬Š      | è¼¸å…¥                             | è¼¸å‡º                             | äº‹ä»¶ç™¼å¸ƒ                 | DBæ“ä½œ                                                                                                                                   | ç·©å­˜æ“ä½œ                                                                     | æœå‹™èª¿ç”¨ | è£œå„Ÿæ©Ÿåˆ¶ |
|----|-------------|---------------------------|---------|---------|---------|--------------------------------|--------------------------------|----------------------|----------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|------|------|
| âœ”ï¸ | POST        | `/api/auth/credentials`   | å»ºç«‹æ†‘è­‰    | user    | private | AuthCredentialCreateRequest    | AuthCredentialResponse         | -                    | select `auth_credentials`<user_id, credential_type><br/>insert `auth_credentials`<user_id, credential_type, secret_hash, salt, status> | -                                                                        | -    | -    |
| âœ”ï¸ | POST        | `/api/auth/login`         | ç™»å…¥      | gateway | public  | LoginRequest (email, password) | JWT (Access/Refresh Token)     | -                    | select `auth_credentials`<user_id, credential_type>                                                                                    | Redis set `open:vincentf13:security:sessions:{sessionId}`                | -    | -    |
|    | POST        | `/api/auth/token/refresh` | åˆ·æ–°Token | gateway | jwt     | RefreshToken                   | JWT (new Access/Refresh Token) | -                    | -                                                                                                                                      | Redis get/set `open:vincentf13:security:sessions:{sessionId}` å»¶å±•TTL      | -    | -    |
|    | POST        | `/api/auth/logout`        | ç™»å‡º      | gateway | jwt     | -                              | -                              | `AuthSessionRevoked` | -                                                                                                                                      | Redis markRevoked+delete `open:vincentf13:security:sessions:{sessionId}` | -    | -    |

## events

**äº‹ä»¶ç™¼å¸ƒ**:

| å®Œæˆ | ç™¼å¸ƒå ´æ™¯            | Topic                | äº‹ä»¶åç¨±                 | äº‹ä»¶å…§å®¹                      | æ¶ˆè²»è€…           |
|----|-----------------|----------------------|----------------------|---------------------------|---------------|
|    | ä½¿ç”¨è€…ä¸»å‹•ç™»å‡ºæˆ–è¢«é¢¨æ§å¼·åˆ¶ç™»å‡º | auth.session-revoked | `AuthSessionRevoked` | sessionId, userId, reason | gateway, å…¶ä»–æœå‹™ |

> Kafka Topic ä¸€å¾‹ä»¥ Enum å®šç¾©ï¼ˆæ¬„ä½åŒ…å« topic å­—ä¸²èˆ‡å°æ‡‰ Event é¡åˆ¥ï¼‰ï¼Œæœå‹™ç«¯éœ€ä½¿ç”¨ `.getTopic()` å–å¾—å¯¦éš›åç¨±ï¼Œé¿å…é­”è¡“å­—ä¸²èˆ‡
> Topic/Event æ˜ å°„å¤±èª¿ã€‚

---

## è³‡æ–™è¡¨ DDL

#### `auth_credentials` - ç™»å…¥æ†‘è­‰è³‡æ–™

```sql
CREATE TABLE `auth_credentials`
(
    `id`              BIGINT       NOT NULL COMMENT 'æ†‘è­‰ä¸»éµ',
    `user_id`         BIGINT       NOT NULL COMMENT 'å°æ‡‰ä½¿ç”¨è€… ID',
    `credential_type` VARCHAR(32)  NOT NULL COMMENT 'æ†‘è­‰å‹åˆ¥ï¼ˆPASSWORD / API_KEY / FIDO ç­‰ï¼‰',
    `secret_hash`     VARCHAR(255) NOT NULL COMMENT 'æ†‘è­‰é›œæ¹Šå€¼',
    `salt`            VARCHAR(255) NOT NULL COMMENT 'é›œæ¹Šé¹½å€¼',
    `status`          VARCHAR(32)  NOT NULL DEFAULT 'ACTIVE' COMMENT 'æ†‘è­‰ç‹€æ…‹',
    `expires_at`      TIMESTAMP    NULL COMMENT 'å¯é¸çš„åˆ°æœŸæ™‚é–“',
    `created_at`      TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å»ºç«‹æ™‚é–“',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_auth_credentials_user_type` (`user_id`, `credential_type`),
    CONSTRAINT `fk_auth_credentials_user`
        FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
            ON UPDATE CASCADE ON DELETE CASCADE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4 COMMENT = 'ç™»å…¥æ†‘è­‰è³‡æ–™è¡¨';

-- ç´¢å¼•å»ºè­°
CREATE INDEX idx_user_id ON auth_credentials (user_id) COMMENT 'æŸ¥è©¢ç”¨æˆ¶æ‰€æœ‰æ†‘è­‰';
CREATE INDEX idx_status ON auth_credentials (status) COMMENT 'æŸ¥è©¢ç‰¹å®šç‹€æ…‹æ†‘è­‰ (å¦‚LOCKED)';
CREATE INDEX idx_expires_at ON auth_credentials (expires_at) COMMENT 'å®šæœŸæ¸…ç†éæœŸæ†‘è­‰';
```

#### ~~`refresh_tokens` - JWT æœƒè©±æŒä¹…åŒ–~~

```sql
CREATE TABLE refresh_tokens
(
    token_id         VARCHAR(64)  NOT NULL COMMENT 'Refresh Token UUID',
    user_id          BIGINT       NOT NULL COMMENT 'ç”¨æˆ¶ID',
    session_id       VARCHAR(64)  NOT NULL COMMENT 'æœƒè©±ID (å°æ‡‰ Redis session)',
    access_token_jti VARCHAR(64)  NULL COMMENT 'å°æ‡‰çš„ Access Token JTI (å¯é¸)',
    issued_at        DATETIME     NOT NULL COMMENT 'ç°½ç™¼æ™‚é–“',
    expires_at       DATETIME     NOT NULL COMMENT 'éæœŸæ™‚é–“',
    is_active        BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'æ˜¯å¦æœ‰æ•ˆ (FALSEè¡¨ç¤ºå·²æ’¤éŠ·)',
    revoked_at       DATETIME     NULL COMMENT 'æ’¤éŠ·æ™‚é–“',
    revoked_reason   VARCHAR(100) NULL COMMENT 'æ’¤éŠ·åŸå› : USER_LOGOUT, SECURITY_RISK, ADMIN_FORCE',
    ip_address       VARCHAR(45)  NULL COMMENT 'ç°½ç™¼æ™‚çš„IPåœ°å€',
    user_agent       VARCHAR(255) NULL COMMENT 'ç°½ç™¼æ™‚çš„User-Agent',
    version          INT          NOT NULL DEFAULT 0 COMMENT 'æ¨‚è§€é–ç‰ˆæœ¬è™Ÿ (é˜²æ­¢ä½µç™¼åˆ·æ–°)',
    created_at       DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‰µå»ºæ™‚é–“',
    PRIMARY KEY (token_id)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Refresh TokenæŒä¹…åŒ–è¡¨';

-- ç´¢å¼•å»ºè­°
CREATE INDEX idx_user_id ON refresh_tokens (user_id) COMMENT 'æŸ¥è©¢ç”¨æˆ¶æ‰€æœ‰token';
CREATE INDEX idx_session_id ON refresh_tokens (session_id) COMMENT 'æœƒè©±ç®¡ç†';
CREATE INDEX idx_expires_at ON refresh_tokens (expires_at) COMMENT 'å®šæœŸæ¸…ç†éæœŸtoken';
CREATE INDEX idx_is_active_expires ON refresh_tokens (is_active, expires_at) COMMENT 'æŸ¥è©¢æœ‰æ•ˆä¸”æœªéæœŸçš„token';
```

#### ~~`login_audits` - ç™»å…¥å¯©è¨ˆè¨˜éŒ„~~

```sql
CREATE TABLE login_audits
(
    id                 BIGINT       NOT NULL AUTO_INCREMENT COMMENT 'å¯©è¨ˆè¨˜éŒ„ID',
    user_id            BIGINT       NULL COMMENT 'ç”¨æˆ¶ID (ç™»å…¥å¤±æ•—æ™‚å¯èƒ½ç‚ºNULL)',
    email              VARCHAR(255) NULL COMMENT 'å˜—è©¦ç™»å…¥çš„éƒµç®±',
    credential_type    VARCHAR(20)  NOT NULL COMMENT 'ä½¿ç”¨çš„æ†‘è­‰é¡å‹',
    result             VARCHAR(20)  NOT NULL COMMENT 'ç™»å…¥çµæœ: SUCCESS, FAILED',
    failure_reason     VARCHAR(100) NULL COMMENT 'å¤±æ•—åŸå› : WRONG_PASSWORD, ACCOUNT_LOCKED, CREDENTIAL_EXPIRED',
    ip_address         VARCHAR(45)  NOT NULL COMMENT 'ç™»å…¥IPåœ°å€',
    user_agent         VARCHAR(500) NULL COMMENT 'User-Agentå­—ä¸²',
    device_fingerprint VARCHAR(64)  NULL COMMENT 'è£ç½®æŒ‡ç´‹ (å¯é¸)',
    geo_location       VARCHAR(100) NULL COMMENT 'åœ°ç†ä½ç½® (åœ‹å®¶/åŸå¸‚)',
    session_id         VARCHAR(64)  NULL COMMENT 'æˆåŠŸæ™‚çš„æœƒè©±ID',
    logged_at          DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ç™»å…¥å˜—è©¦æ™‚é–“',
    PRIMARY KEY (id)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='ç™»å…¥å¯©è¨ˆè¨˜éŒ„è¡¨';

-- ç´¢å¼•å»ºè­°
CREATE INDEX idx_user_id_logged ON login_audits (user_id, logged_at DESC) COMMENT 'ç”¨æˆ¶ç™»å…¥æ­·å²';
CREATE INDEX idx_result_logged ON login_audits (result, logged_at DESC) COMMENT 'å¤±æ•—ç™»å…¥åˆ†æ';
CREATE INDEX idx_ip_logged ON login_audits (ip_address, logged_at DESC) COMMENT 'IPè¡Œç‚ºåˆ†æ';
CREATE INDEX idx_logged_at ON login_audits (logged_at DESC) COMMENT 'æ™‚é–“ç¯„åœæŸ¥è©¢';
```

#### ~~`auth_providers` - ç¬¬ä¸‰æ–¹ç™»å…¥ç¶å®š~~

```sql
CREATE TABLE auth_providers
(
    id               BIGINT       NOT NULL COMMENT 'ç¶å®šID (Snowflake)',
    user_id          BIGINT       NOT NULL COMMENT 'ç”¨æˆ¶ID',
    provider         VARCHAR(50)  NOT NULL COMMENT 'æä¾›å•†: GOOGLE, FACEBOOK, GITHUB',
    provider_user_id VARCHAR(255) NOT NULL COMMENT 'ç¬¬ä¸‰æ–¹å¹³å°çš„ç”¨æˆ¶ID',
    provider_email   VARCHAR(255) NULL COMMENT 'ç¬¬ä¸‰æ–¹å¹³å°çš„éƒµç®±',
    access_token     TEXT         NULL COMMENT 'ç¬¬ä¸‰æ–¹ Access Token (åŠ å¯†å­˜å„²)',
    refresh_token    TEXT         NULL COMMENT 'ç¬¬ä¸‰æ–¹ Refresh Token (åŠ å¯†å­˜å„²)',
    token_expires_at DATETIME     NULL COMMENT 'TokenéæœŸæ™‚é–“',
    linked_at        DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ç¶å®šæ™‚é–“',
    last_used_at     DATETIME     NULL COMMENT 'æœ€å¾Œä½¿ç”¨æ™‚é–“',
    PRIMARY KEY (id),
    UNIQUE KEY uk_provider_user (provider, provider_user_id) COMMENT 'åŒä¸€æä¾›å•†çš„ç”¨æˆ¶IDå”¯ä¸€'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='ç¬¬ä¸‰æ–¹ç™»å…¥ç¶å®šè¡¨';

-- ç´¢å¼•å»ºè­°
CREATE INDEX idx_user_id ON auth_providers (user_id) COMMENT 'æŸ¥è©¢ç”¨æˆ¶ç¶å®šçš„æ‰€æœ‰ç¬¬ä¸‰æ–¹å¸³è™Ÿ';
```

## 

## `POST /api/auth/credentials`ï¼šå»ºç«‹æ†‘è­‰

## POST `/api/auth/login`ï¼šç™»å…¥

- ç”± `sdk-auth-server` æä¾›é è¨­å¯¦ä½œï¼›æœå‹™å¼•å…¥è©²æ¨¡çµ„å¾Œå³å¯ç›´æ¥å•Ÿç”¨ã€‚

ç™»å…¥æµç¨‹

- `POST /api/auth/login`ï¼š
    - Gateway å°‡è«‹æ±‚è½‰çµ¦ `auth`ã€‚
    - `auth` ä¾ credential type è®€å– `auth_credentials`ï¼Œä»¥ `BCrypt`/`Argon2` é©—è­‰å¯†ç¢¼ä¸¦æª¢æŸ¥ç‹€æ…‹ï¼ˆLOCKEDã€EXPIRED ç­‰ï¼‰ï¼Œå¿…è¦æ™‚è¿½åŠ 
      OTP/FIDO äºŒæ¬¡é©—è­‰ã€‚
    - é©—è­‰æˆåŠŸå¾Œå¯«å…¥ `login_audits`ã€`auth_sessions`ï¼Œä¸¦åœ¨ Redis å»ºç«‹ `auth:session:{sessionId}`ï¼ˆå«
      userIdã€rolesã€IPã€è£ç½®æŒ‡ç´‹ã€TTLï¼‰ã€‚
    - å›å‚³ Access/Refresh Tokenï¼ŒJWT å…§å« `sessionId`ã€`authContext`ï¼Œä¾›ä¸‹æ¸¸æœå‹™è§£æã€‚
- è«‹æ±‚æˆæ¬Šï¼šå¾ŒçºŒæ‰€æœ‰ API ç”± Gateway çš„ JWT Filter é©—è­‰ Access Tokenï¼Œä¸¦ä»¥ `sessionId` æŸ¥è©¢ Redisï¼ˆæˆ–æœ¬åœ°å¿«å–ï¼‰ç¢ºèªæœƒè©±ä»æœ‰æ•ˆï¼›è‹¥ä¸å­˜åœ¨æˆ–æ¨™è¨˜
  `revoked` å³æ‹’çµ•ã€‚
- Token çºŒæœŸï¼šAccess Token éæœŸæ™‚ï¼Œå‰ç«¯å‘¼å« `POST /api/auth/token/refresh`ï¼Œ`auth` é©—è­‰ Refresh Token æ˜¯å¦ä» activeï¼Œä½¿ç”¨æ¨‚è§€é–ï¼ˆ
  `refresh_tokens.version`ï¼‰é¿å…é‡æ”¾ï¼ŒæˆåŠŸå‰‡ç°½ç™¼æ–° Access/Refresh ä¸¦å»¶é•· Redis session TTLã€‚
- ç™»å‡º/å¤±æ•ˆï¼š`POST /api/auth/logout` æˆ–é¢¨æ§äº‹ä»¶æœƒæ¨™è¨˜ Refresh Token ç‚º `revoked`ã€åˆªé™¤ Redis sessionï¼Œä¸¦ç™¼å¸ƒ
  `AuthSessionRevoked` äº‹ä»¶ï¼›Gateway æˆ–æœå‹™å´å¯ç«‹å³çµ‚æ­¢è©²æœƒè©±ã€‚
- ä¸‹æ¸¸ä½¿ç”¨ï¼šå„æœå‹™çš„å®‰å…¨ Filter è§£æ JWTï¼Œå°‡ `OpenJwtUser`ï¼ˆuserIdã€rolesã€scopesã€sessionIdï¼‰æ”¾å…¥ ThreadLocal æˆ– Reactor
  Contextï¼Œæ”¯æ´å¯©è¨ˆèˆ‡æˆæ¬Šåˆ¤å®šã€‚

## POST `/api/auth/token/refresh`ï¼šrefresh token

- ä½¿ç”¨ Refresh Token å–å¾—æ–°çš„ Access Tokenï¼Œä¸¦å»¶é•· Redis session åˆ°æœŸæ™‚é–“ã€‚
- ç”± `sdk-auth-server` æä¾›é è¨­å¯¦ä½œï¼›æœå‹™å¼•å…¥è©²æ¨¡çµ„å¾Œå³å¯ç›´æ¥å•Ÿç”¨ã€‚

## POST `/api/auth/logout`ï¼šä½¿ token å¤±æ•ˆ

- ä½œå»¢ Refresh Token/Sessionï¼ˆåˆªé™¤ Redis sessionï¼‰ã€‚
-
    - ç”± `sdk-auth-server` æä¾›é è¨­å¯¦ä½œï¼›æœå‹™å¼•å…¥è©²æ¨¡çµ„å¾Œå³å¯ç›´æ¥å•Ÿç”¨ã€‚

# User æœå‹™

## è·è²¬

- ç¶­è­·ä½¿ç”¨è€…ä¸»æª”ã€~~åå¥½è¨­å®šã€èªç³»èˆ‡é€šçŸ¥è¨‚é–±ï¼Œç®¡ç† KYC æµç¨‹ã€‚~~
- ~~ç®¡ç†è§’è‰²ã€æ¬Šé™èˆ‡ç¯„åœï¼ˆscopeï¼‰ï¼Œæä¾› RBAC/ABAC æŸ¥è©¢ä»‹é¢ã€‚

## endpoint

| å®Œæˆ | HTTP Method | Endpoint        | èªªæ˜         | èª¿ç”¨è€…     | æˆæ¬Š     | è¼¸å…¥                                    | è¼¸å‡º           | äº‹ä»¶ç™¼å¸ƒ | DBæ“ä½œ                                                                                                                                                                                                                      | ç·©å­˜æ“ä½œ | æœå‹™èª¿ç”¨                               | è£œå„Ÿæ©Ÿåˆ¶                                                                   |
|----|-------------|-----------------|------------|---------|--------|---------------------------------------|--------------|------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------|------------------------------------|------------------------------------------------------------------------|
| âœ”ï¸ | POST        | `/api/users`    | ç”¨æˆ¶è¨»å†Š       | gateway | public | UserRegisterRequest (email, password) | UserResponse | -    | insert `users`<external_id,email,status><br/>insert `auth_credentials_pending`<user_id, credential_type, secret_hash, salt, status, retry_count><br/>update `auth_credentials_pending`<status, last_error, next_retry_at> | -    | Auth: `POST /api/auth/credentials` | `UserRegistrationResumer` æ’ç¨‹ä»»å‹™ï¼šæƒæ `auth_credentials_pending`ï¼Œé‡è©¦å¤±æ•—çš„æ†‘è­‰å»ºç«‹ |
| âœ”ï¸ | GET         | `/api/users/me` | æŸ¥è©¢ç•¶å‰ç”¨æˆ¶åŸºæœ¬è³‡æ–™ | gateway | jwt    | -                                     | UserResponse | -    | select `users`<id>                                                                                                                                                                                                        | -    | -                                  | -                                                                      |

---

## è³‡æ–™è¡¨ DDL

### `users` - ä½¿ç”¨è€…ä¸»æª”

```sql
CREATE TABLE `users`
(
    `id`          BIGINT       NOT NULL COMMENT 'å¹³å°å…§éƒ¨ä½¿ç”¨è€…ä¸»éµ',
    `external_id` VARCHAR(64)           DEFAULT NULL COMMENT 'å¤–éƒ¨ç³»çµ±å¼•ç”¨ç”¨æˆ¶ IDï¼ˆå¯é¸ï¼‰',
    `email`       VARCHAR(255) NOT NULL COMMENT 'ç™»å…¥/é€šçŸ¥ç”¨ Emailï¼Œå”¯ä¸€',
    `status`      VARCHAR(32)  NOT NULL DEFAULT 'ACTIVE' COMMENT 'ä½¿ç”¨è€…ç‹€æ…‹ï¼ˆACTIVE / LOCKED / DISABLEDï¼‰',
    `created_at`  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å»ºç«‹æ™‚é–“',
    `updated_at`  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æœ€å¾Œæ›´æ–°æ™‚é–“',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_users_email` (`email`),
    UNIQUE KEY `uk_users_external` (`external_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4 COMMENT = 'ä½¿ç”¨è€…ä¸»æª”';

-- ç´¢å¼•å»ºè­°
CREATE INDEX idx_status ON users (status) COMMENT 'æŸ¥è©¢ç‰¹å®šç‹€æ…‹ç”¨æˆ¶';
CREATE INDEX idx_created_at ON users (created_at DESC) COMMENT 'æŒ‰è¨»å†Šæ™‚é–“æ’åº';
```

### ~~`user_profiles` - å€‹è³‡èˆ‡åå¥½~~

```sql
CREATE TABLE user_profiles
(
    user_id      BIGINT       NOT NULL COMMENT 'ç”¨æˆ¶ID (å¤–éµ)',
    display_name VARCHAR(100) NULL COMMENT 'é¡¯ç¤ºåç¨±/æš±ç¨±',
    first_name   VARCHAR(50)  NULL COMMENT 'åå­—',
    last_name    VARCHAR(50)  NULL COMMENT 'å§“æ°',
    country      VARCHAR(2)   NULL COMMENT 'åœ‹å®¶ä»£ç¢¼ (ISO 3166-1 alpha-2)',
    language     VARCHAR(10)  NOT NULL DEFAULT 'zh-TW' COMMENT 'èªè¨€åå¥½ (zh-TW, en-US)',
    timezone     VARCHAR(50)  NOT NULL DEFAULT 'Asia/Taipei' COMMENT 'æ™‚å€',
    avatar_url   VARCHAR(500) NULL COMMENT 'é ­åƒURL',
    bio          TEXT         NULL COMMENT 'å€‹äººç°¡ä»‹',
    created_at   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‰µå»ºæ™‚é–“',
    updated_at   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    PRIMARY KEY (user_id),
    CONSTRAINT fk_profiles_user FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='ç”¨æˆ¶å€‹è³‡èˆ‡åå¥½è¨­å®šè¡¨';

-- ç´¢å¼•å»ºè­°
CREATE INDEX idx_country ON user_profiles (country) COMMENT 'æŒ‰åœ‹å®¶çµ±è¨ˆç”¨æˆ¶åˆ†ä½ˆ';
```

### `auth_credentials_pending` - è¨»å†Šè£œå„Ÿè¡¨

```sql
CREATE TABLE auth_credentials_pending
(
    id              BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    user_id         BIGINT UNSIGNED NOT NULL,
    credential_type VARCHAR(32)     NOT NULL COMMENT 'æ†‘è­‰å‹åˆ¥ï¼ˆPASSWORD / API_KEY ...ï¼‰',
    secret_hash     VARCHAR(512)    NOT NULL COMMENT 'å·²ç¶“ç”± auth ç®—å¥½çš„ hash',
    salt            VARCHAR(128)    NOT NULL,
    status          VARCHAR(32)     NOT NULL COMMENT 'PENDING / COMPLETED / FAILED',
    retry_count     INT UNSIGNED    NOT NULL DEFAULT 0 COMMENT 'å·²é‡è©¦æ¬¡æ•¸',
    next_retry_at   DATETIME        NULL COMMENT 'ä¸‹æ¬¡æ’ç¨‹å¯æ’¿èµ·çš„æ™‚é–“',
    last_error      VARCHAR(512)    NULL COMMENT 'æœ€è¿‘ä¸€æ¬¡å¤±æ•—è¨Šæ¯',
    created_at      DATETIME        NOT NULL,
    updated_at      DATETIME        NOT NULL,
    UNIQUE KEY uk_user_type (user_id, credential_type)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4;

-- ç´¢å¼•å»ºè­°
CREATE INDEX idx_status_created ON user_registration_prepare (status, created_at) COMMENT 'æ’ç¨‹æƒæPREPAREè¨˜éŒ„';
```

### ~~`kyc_records` - èº«åˆ†é©—è­‰ç´€éŒ„~~

```sql
CREATE TABLE kyc_records
(
    id                 BIGINT       NOT NULL COMMENT 'è¨˜éŒ„ID (Snowflake)',
    user_id            BIGINT       NOT NULL COMMENT 'ç”¨æˆ¶ID',
    tier               INT          NOT NULL COMMENT 'ç”³è«‹ç­‰ç´š: 1=åŸºç¤, 2=é€²éš',
    status             VARCHAR(20)  NOT NULL COMMENT 'ç‹€æ…‹: PENDING, APPROVED, REJECTED',
    document_type      VARCHAR(50)  NULL COMMENT 'è­‰ä»¶é¡å‹: PASSPORT, ID_CARD, DRIVER_LICENSE',
    document_number    VARCHAR(100) NULL COMMENT 'è­‰ä»¶è™Ÿç¢¼ (åŠ å¯†å­˜å„²)',
    document_front_url VARCHAR(500) NULL COMMENT 'è­‰ä»¶æ­£é¢ç…§ç‰‡URL',
    document_back_url  VARCHAR(500) NULL COMMENT 'è­‰ä»¶èƒŒé¢ç…§ç‰‡URL',
    selfie_url         VARCHAR(500) NULL COMMENT 'è‡ªæ‹ç…§URL',
    submitted_at       DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'æäº¤æ™‚é–“',
    approved_at        DATETIME     NULL COMMENT 'å¯©æ ¸é€šéæ™‚é–“',
    rejected_at        DATETIME     NULL COMMENT 'æ‹’çµ•æ™‚é–“',
    rejected_reason    VARCHAR(500) NULL COMMENT 'æ‹’çµ•åŸå› ',
    reviewer_id        BIGINT       NULL COMMENT 'å¯©æ ¸äººå“¡ID',
    PRIMARY KEY (id)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='KYCèº«åˆ†é©—è­‰è¨˜éŒ„è¡¨';

-- ç´¢å¼•å»ºè­°
CREATE INDEX idx_user_id_submitted ON kyc_records (user_id, submitted_at DESC) COMMENT 'ç”¨æˆ¶KYCæ­·å²';
CREATE INDEX idx_status ON kyc_records (status) COMMENT 'å¾…å¯©æ ¸åˆ—è¡¨';
```

### ~~`role_assignments` - è§’è‰²æ¬Šé™æˆæ¬Š~~

```sql
CREATE TABLE role_assignments
(
    id         BIGINT       NOT NULL COMMENT 'æˆæ¬ŠID (Snowflake)',
    user_id    BIGINT       NOT NULL COMMENT 'ç”¨æˆ¶ID',
    role       VARCHAR(50)  NOT NULL COMMENT 'è§’è‰²: ADMIN, SUPPORT, TRADER, VIP',
    scope      VARCHAR(100) NULL COMMENT 'æ¬Šé™ç¯„åœ (å¯é¸, å¦‚ç‰¹å®šäº¤æ˜“å°)',
    granted_by BIGINT       NOT NULL COMMENT 'æˆæ¬Šè€…ID',
    granted_at DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'æˆæ¬Šæ™‚é–“',
    expires_at DATETIME     NULL COMMENT 'éæœŸæ™‚é–“ (NULLè¡¨ç¤ºæ°¸ä¹…)',
    PRIMARY KEY (id),
    UNIQUE KEY uk_user_role_scope (user_id, role, scope) COMMENT 'ç”¨æˆ¶è§’è‰²ç¯„åœçµ„åˆå”¯ä¸€'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='è§’è‰²æ¬Šé™æˆæ¬Šè¡¨ - RBAC';

-- ç´¢å¼•å»ºè­°
CREATE INDEX idx_user_id ON role_assignments (user_id) COMMENT 'æŸ¥è©¢ç”¨æˆ¶æ‰€æœ‰è§’è‰²';
CREATE INDEX idx_role ON role_assignments (role) COMMENT 'æŸ¥è©¢ç‰¹å®šè§’è‰²çš„æ‰€æœ‰ç”¨æˆ¶';
```

### ~~`notification_preferences` - é€šçŸ¥è¨‚é–±è¨­å®š~~

```sql
CREATE TABLE notification_preferences
(
    id         BIGINT      NOT NULL AUTO_INCREMENT COMMENT 'åå¥½ID',
    user_id    BIGINT      NOT NULL COMMENT 'ç”¨æˆ¶ID',
    channel    VARCHAR(20) NOT NULL COMMENT 'é€šçŸ¥é€šé“: EMAIL, SMS, PUSH, WEBHOOK',
    event_type VARCHAR(50) NOT NULL COMMENT 'äº‹ä»¶é¡å‹: ORDER_FILLED, PRICE_ALERT, SECURITY',
    is_enabled BOOLEAN     NOT NULL DEFAULT TRUE COMMENT 'æ˜¯å¦å•Ÿç”¨',
    config     JSON        NULL COMMENT 'é¡å¤–é…ç½® (å¦‚åƒ¹æ ¼é–¾å€¼)',
    created_at DATETIME    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‰µå»ºæ™‚é–“',
    updated_at DATETIME    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    PRIMARY KEY (id),
    UNIQUE KEY uk_user_channel_event (user_id, channel, event_type) COMMENT 'ç”¨æˆ¶é€šé“äº‹ä»¶çµ„åˆå”¯ä¸€'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='é€šçŸ¥è¨‚é–±è¨­å®šè¡¨';

-- ç´¢å¼•å»ºè­°
CREATE INDEX idx_user_id ON notification_preferences (user_id) COMMENT 'æŸ¥è©¢ç”¨æˆ¶æ‰€æœ‰é€šçŸ¥è¨­å®š';
```

## 

## `POST /api/users`ï¼šè¨»å†Š

- å‰ç«¯å‘¼å« `user` æœå‹™çš„ `POST /api/users`ï¼ˆç”± Gateway è½‰ç™¼ï¼‰ã€‚
- `user-service` é©—è­‰ä¿¡ç®±æ˜¯å¦å·²å­˜åœ¨ï¼Œå»ºç«‹ `User` ä¸»æª”ï¼Œèˆ‡åœ¨ `user_registration_prepare` è¡¨å¯«å…¥ä¸€ç­† `PREPARE` ç‹€æ…‹çš„è¨»å†Šå·¥ä½œï¼ˆåŒ…å«
  userIdã€emailã€é‡è©¦æ¬¡æ•¸ç­‰æ¬„ä½ï¼‰ã€‚
- å»ºç«‹æˆåŠŸå¾Œå‘¼å« `auth` æœå‹™ï¼Œå‚³å…¥ `AuthCredentialCreateRequest`ï¼ˆå¸¶å…¥ userIdã€å‹åˆ¥ã€å¯†ç¢¼é›œæ¹Šèˆ‡é¹½å€¼ï¼‰ï¼›`auth` å¯«å…¥
  `auth_credentials`ï¼Œä¸¦å›å ±æˆåŠŸä»¥æ›´æ–°è¨»å†Šå·¥ä½œç‹€æ…‹ç‚º `COMPLETED`ã€‚
- è‹¥æ†‘è­‰å»ºç«‹å¤±æ•—æˆ– `auth` æš«æ™‚ä¸å¯ç”¨ï¼Œ`user-service` æœƒä¿ç•™ `PREPARE` ç‹€æ…‹ä¸¦å›å‚³ `RemoteServiceError`ï¼Œä»¥ä¾¿ç¨å¾Œé‡è©¦ã€‚
- **æ’ç¨‹è£œå„Ÿ**ï¼š`UserRegistrationResumer`ï¼ˆSpring Scheduling/Quartz Jobï¼‰æ¯åˆ†é˜æƒæ `user_registration_prepare`ï¼Œå°åœç•™åœ¨
  `PREPARE` çš„è¨˜éŒ„é‡æ–°å‘¼å« `auth` å»ºæ†‘è­‰ï¼›æˆåŠŸå¾Œæ¨™è¨˜ `COMPLETED`ï¼Œé€£çºŒ N æ¬¡å¤±æ•—å‰‡æ¨™è¨˜ `FAILED` ä¸¦ç™¼é€å‘Šè­¦é€šçŸ¥ç‡Ÿé‹è™•ç†ã€‚

## `GET /api/users/me`ï¼šæŸ¥è©¢åŸºæœ¬è³‡æ–™

# Order æœå‹™

## è·è²¬

- çµ±ä¸€ä¸‹å–®å…¥å£ï¼Œæ”¯æ´å¸‚åƒ¹/é™åƒ¹/~~æ¢ä»¶å–®~~ç­‰å¤šç¨®å§”è¨—å‹åˆ¥ã€‚
- æä¾›å–®ç­†èˆ‡æ‰¹æ¬¡æ’¤å–®ã€å§”è¨—æŸ¥è©¢ã€æ­·å²è¨‚å–®åŒ¯å‡ºã€‚
- å¯«å…¥è¨‚å–®äº‹ä»¶ï¼ˆevent sourcingï¼‰ä¾›æ’®åˆã€å ±è¡¨èˆ‡é‡æ’­ã€‚

## endpoint

| å®Œæˆ | HTTP Method | Endpoint                | èªªæ˜   | èª¿ç”¨è€…                          | æˆæ¬Š            | è¼¸å…¥                                                              | è¼¸å‡º                                                           | äº‹ä»¶ç™¼å¸ƒ                                                                    | DBæ“ä½œ                                                                                                                                                                                                        | ç·©å­˜æ“ä½œ | æœå‹™èª¿ç”¨                                      | è£œå„Ÿæ©Ÿåˆ¶ |
|----|-------------|-------------------------|------|------------------------------|---------------|-----------------------------------------------------------------|--------------------------------------------------------------|-------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------|-------------------------------------------|------|
|    | POST        | `/api/orders`           | å»ºç«‹å§”è¨— | gateway / liquidation-worker | jwt / private | OrderCreateRequest (instrument_id, side, type, price, quantity) | OrderResponse (orderId, status, intent, closeCostPrice, ...) | Sagaï¼šæœ€åˆ `PositionReserveRequested` / `OrderSubmitted`ï¼Œæœ€çµ‚ `OrderCreated` | insert `orders`<order_id,user_id,instrument_id,client_order_id,side,intent,close_cost_price,type,status,price,quantity,filled_quantity,remaining_quantity,avg_fill_price,fee,version,created_at,updated_at> | -    | positions: `POST` `/api/positions/intent` | -    |
|    | DELETE      | `/api/orders/{orderId}` | æ’¤éŠ·å§”è¨— | gateway                      | jwt           | orderId                                                         | -                                                            | `OrderCancelRequested`                                                  | update `orders`<status, cancelled_at>                                                                                                                                                                       | -    | -                                         | -    |
| âœ”ï¸ | GET         | `/api/orders/{orderId}` | æŸ¥è©¢è¨‚å–® | gateway , account-ledger     | jwt,private   | orderId                                                         | OrderResponse                                                | -                                                                       | select `orders`<å…¨éƒ¨æ¬„ä½>                                                                                                                                                                                       | -    | -                                         | -    |

## events

**äº‹ä»¶æ¶ˆè²»**:

| å®Œæˆ | ä¾†æºæœå‹™           | Topic                      | äº‹ä»¶                        | è™•ç†é‚è¼¯                                        | äº‹ä»¶ç™¼å¸ƒ             | DBæ“ä½œ                                                                                                              | ç·©å­˜æ“ä½œ | æœå‹™èª¿ç”¨ | è£œå„Ÿæ©Ÿåˆ¶ |
|----|----------------|----------------------------|---------------------------|---------------------------------------------|------------------|-------------------------------------------------------------------------------------------------------------------|------|------|------|
| âœ”ï¸ | positions      | positions.reserved         | `PositionReserved`        | é å‡çµæˆåŠŸ â†’ è¨‚å–® `SUBMITTED` ä¸¦è£œç™¼ `OrderSubmitted` | `OrderSubmitted` | update `orders`<status, submitted_at, updated_at, version, close_cost_price>                                      | -    | -    | -    |
| âœ”ï¸ | positions      | positions.reserve-rejected | `PositionReserveRejected` | é å‡çµå¤±æ•— â†’ è¨‚å–® `FAILED`                         | -                | update `orders`<status, updated_at, version>                                                                      | -    | -    | -    |
|    | risk-margin    | risk.margin-check-failed   | `MarginPreCheckFailed`    | é¢¨æ§æ‹’çµ• â†’ è¨‚å–® `FAILED`                          | -                | update `orders`<status, updated_at, version>                                                                      | -    | -    | -    |
|    | account-ledger | ledger.funds-frozen        | `FundsFrozen`             | è³‡é‡‘å‡çµæˆåŠŸ â†’ è¨‚å–® `ACCEPTED` ä¸¦ç™¼å¸ƒ `OrderCreated`   | `OrderCreated`   | update `orders`<status, submitted_at, updated_at, version>                                                        | -    | -    | -    |
|    | account-ledger | ledger.funds-freeze-failed | `FundsFreezeFailed`       | è³‡é‡‘å‡çµå¤±æ•— â†’ è¨‚å–® `FAILED`                        | -                | update `orders`<status, updated_at, version>                                                                      | -    | -    | -    |
|    | account-ledger | ledger.funds-unfrozen      | `FundsUnfrozen`           | è¨‚å–®ç‹€æ…‹æ”¹ç‚º `CANCELLED`                          | -                | update `orders`<status, updated_at, version>                                                                      | -    | -    | -    |
|    | matching       | matching.trade-executed    | `TradeExecuted`           | è¨‚å–®æ›´æ–°æˆäº¤é‡ã€å‡åƒ¹ã€æ‰‹çºŒè²»èˆ‡ `filled_at`                 | -                | update `orders`<status, filled_quantity, remaining_quantity, avg_fill_price, fee, filled_at, updated_at, version> | -    | -    | -    |

**äº‹ä»¶ç™¼å¸ƒ**:

| å®Œæˆ  | ç™¼å¸ƒå ´æ™¯             | Topic                            | äº‹ä»¶åç¨±                       | äº‹ä»¶å…§å®¹                                                               | æ¶ˆè²»è€…         |
| --- | ---------------- | -------------------------------- | -------------------------- | ------------------------------------------------------------------ | ----------- |
| âœ”ï¸  | å¹³å€‰è¨‚å–®éœ€é å…ˆé–å€‰        | order.position-reserve-requested | `PositionReserveRequested` | orderId, userId, instrumentId, side, intent, quantity, requestedAt | positions   |
| âœ”ï¸  | æ”¶åˆ°ç”¨æˆ¶/å¼·å¹³å§”è¨—ä¸¦å®ŒæˆåŸºæœ¬æ ¡é©— | order.submitted                  | `OrderSubmitted`           | orderId, userId, instrumentId, side, type, price, quantity         | risk-margin |
|     | ä¿è­‰é‡‘å‡çµæˆåŠŸã€å§”è¨—æ­£å¼å»ºæª”   | order.created                    | `OrderCreated`             | orderId, userId, instrumentId, side, type, price, quantity         | matching    |
|     | ç”¨æˆ¶æˆ–ç³»çµ±è«‹æ±‚æ’¤å–®        | order.cancel-requested           | `OrderCancelRequested`     | orderId                                                            | matching    |

---

## è³‡æ–™è¡¨DDL

### orders è¡¨

```sql
CREATE TABLE orders
(
    order_id           BIGINT         NOT NULL COMMENT 'è¨‚å–®ID (Snowflake)',
    user_id            BIGINT         NOT NULL COMMENT 'ç”¨æˆ¶ID (å¤–éµé—œè¯ users.id)',
    instrument_id      BIGINT         NOT NULL COMMENT 'äº¤æ˜“å°ID (å¤–éµé—œè¯ instruments.id)',
    client_order_id    VARCHAR(64)    NULL COMMENT 'å®¢æˆ¶ç«¯è¨‚å–®ID (ç”¨æ–¼å†ªç­‰æ€§å»é‡)',

    # è¨‚å–®
    side               VARCHAR(10)    NOT NULL COMMENT 'è¨‚å–®æ–¹å‘: BUY, SELL.  é–‹å¤š/å¹³ç©º=BUY, é–‹ç©º/å¹³å¤š=è³£',
    intent             VARCHAR(20)    NULL COMMENT 'é–‹å€‰/æ¸›å€‰/å¹³å€‰æ„åœ–: INCREASE, REDUCE, CLOSEï¼Œç”± position æœå‹™åˆ¤æ–·å¾Œå›å¯«',
    close_cost_price   DECIMAL(20, 8) NULL COMMENT 'å¹³å€‰é–å€‰æ™‚è¿”å›çš„å¹³å‡é–‹å€‰æˆæœ¬ï¼Œç”¨æ–¼äº‹å¾Œç›ˆè™§è¨ˆç®—',
    type               VARCHAR(20)    NOT NULL COMMENT 'è¨‚å–®é¡å‹: LIMIT, MARKET, STOP_LIMIT, STOP_MARKET',
    price              DECIMAL(20, 8) NULL COMMENT 'å§”è¨—åƒ¹æ ¼ (å¸‚åƒ¹å–®ç‚º NULL)',
    quantity           DECIMAL(20, 8) NOT NULL COMMENT 'å§”è¨—æ•¸é‡',
    leverage           INT            NULL COMMENT 'æ§“æ¡¿å€æ•¸',


    # æˆäº¤
    filled_quantity    DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'å·²æˆäº¤æ•¸é‡',
    remaining_quantity DECIMAL(20, 8) NOT NULL COMMENT 'å‰©é¤˜æ•¸é‡ (quantity - filled_quantity)',
    avg_fill_price     DECIMAL(20, 8) NULL COMMENT 'å¹³å‡æˆäº¤åƒ¹æ ¼',
    fee                DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'æ‰‹çºŒè²»ç¸½é¡',

    # ç‹€æ…‹
    status             VARCHAR(20)    NOT NULL DEFAULT 'PENDING' COMMENT 'è¨‚å–®ç‹€æ…‹: PENDING, SUBMITTED, ACCEPTED , PARTIAL_FILLED, FILLED, CANCEL_REQUESTED, CANCELLED, REJECTED, FAILED, EXPIRED',
    rejected_reason    VARCHAR(255)   NULL COMMENT 'æ‹’çµ•åŸå›  (é¢¨æ§/é¤˜é¡ä¸è¶³ç­‰)',

    # æ™‚é–“
    created_at         DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‰µå»ºæ™‚é–“',
    updated_at         DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    submitted_at       DATETIME       NULL COMMENT 'æäº¤åˆ°æ’®åˆå¼•æ“æ™‚é–“',
    filled_at          DATETIME       NULL COMMENT 'å®Œå…¨æˆäº¤æ™‚é–“',
    cancelled_at       DATETIME       NULL COMMENT 'å–æ¶ˆæ™‚é–“',

    version            INT            NOT NULL DEFAULT 0 COMMENT 'æ¨‚è§€é–ç‰ˆæœ¬è™Ÿ (ä½µç™¼æ§åˆ¶)',

    PRIMARY KEY (order_id),
    UNIQUE KEY uk_client_order (user_id, client_order_id) COMMENT 'é˜²æ­¢å®¢æˆ¶ç«¯é‡è¤‡æäº¤'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='è¨‚å–®ä¸»æª” - å§”è¨—ç”Ÿå‘½é€±æœŸæ ¸å¿ƒè³‡æ–™';

CREATE INDEX idx_user_status ON orders (user_id, status) COMMENT 'æŸ¥è©¢ç”¨æˆ¶æ´»å‹•è¨‚å–®';
CREATE INDEX idx_instrument_status ON orders (instrument_id, status) COMMENT 'æŸ¥è©¢äº¤æ˜“å°æ´»å‹•è¨‚å–®';
CREATE INDEX idx_status_created ON orders (status, created_at) COMMENT 'æŒ‰ç‹€æ…‹èˆ‡æ™‚é–“æŸ¥è©¢ (å¦‚å¾…æ’®åˆè¨‚å–®)';
CREATE INDEX idx_created_at ON orders (created_at DESC) COMMENT 'æ­·å²è¨‚å–®æ™‚åºæŸ¥è©¢';
```

#### å¦‚ä½•çŸ¥é“é–‹/å¹³å€‰?

é å€‰ä½åˆ¤æ–·ã€‚

`orders.side` åªæœ‰ BUY/SELLï¼Œç„¡æ³•ç›´æ¥è¡¨ç¤ºé–‹å€‰æˆ–å¹³å€‰ã€‚  
æ’®åˆå¾Œç”±å€‰ä½æœå‹™æ±ºå®šçµæœã€‚

æµç¨‹

- BUY
    - è‹¥åŸæœ¬æ˜¯ç©ºå€‰ â†’ å¹³ç©º
    - è‹¥åŸæœ¬ç„¡å€‰æˆ–å¤šå€‰ â†’ é–‹å¤š
- SELL
    - è‹¥åŸæœ¬æ˜¯å¤šå€‰ â†’ å¹³å¤š
    - è‹¥åŸæœ¬ç„¡å€‰æˆ–ç©ºå€‰ â†’ é–‹ç©º

#### type

LIMIT  
æŒ‡å®šåƒ¹æ ¼æˆ–æ›´å¥½åƒ¹æ ¼æˆäº¤

- åƒ¹æ ¼ = ä½¿ç”¨è€…æŒ‡å®š
- å¯æ›ç°¿
- ä¸ä¿è­‰æˆäº¤

MARKET  
ä»¥å¸‚å ´æœ€å„ªåƒ¹æ ¼ç«‹å³æˆäº¤

- åƒ¹æ ¼ = å¸‚åƒ¹
- ä¸æ›ç°¿
- ä¿è­‰ç›¡é‡æˆäº¤ï¼Œä½†æœ€çµ‚æˆäº¤åƒ¹ä¸ç¢ºå®š

STOP_LIMIT  
è§¸ç™¼åƒ¹ + é™åƒ¹

- å¸‚åƒ¹åˆ°é”ã€Œè§¸ç™¼åƒ¹ã€æ™‚ï¼Œè½‰ç‚º LIMIT å–®æ›å‡º
- å¯èƒ½å› é™åƒ¹æˆäº¤ä¸åˆ°è€Œå¤±æ•ˆ

STOP_MARKET  
è§¸ç™¼åƒ¹ + å¸‚åƒ¹

- å¸‚åƒ¹åˆ°é”ã€Œè§¸ç™¼åƒ¹ã€æ™‚ï¼Œè½‰ç‚º MARKET å–®
- æœƒç›¡é‡ç«‹å³æˆäº¤

### order_events è¡¨

```sql
CREATE TABLE order_events
(
    event_id        BIGINT       NOT NULL COMMENT 'äº‹ä»¶ID (Snowflake)',
    user_id         BIGINT       NOT NULL COMMENT 'ç”¨æˆ¶ID (å†—é¤˜æ¬„ä½ä¾¿æ–¼æŸ¥è©¢)',
    instrument_id   BIGINT       NOT NULL COMMENT 'äº¤æ˜“å°ID (å†—é¤˜æ¬„ä½ä¾¿æ–¼æŸ¥è©¢)',
    order_id        BIGINT       NOT NULL COMMENT 'è¨‚å–®ID (å¤–éµé—œè¯ orders.order_id)',

    # äº‹ä»¶    
    event_type      VARCHAR(80)  NOT NULL COMMENT 'äº‹ä»¶é¡å‹',
    sequence_number BIGINT       NOT NULL COMMENT 'åŒä¸€è¨‚å–®å…§çš„äº‹ä»¶åºè™Ÿ (ç¢ºä¿é †åºæ€§)',

    payload         JSON         NOT NULL COMMENT 'äº‹ä»¶å…§å®¹ (ç‹€æ…‹è®Šæ›´çš„å…·é«”æ•¸æ“š)',

    # ä¾†æº
    reference_type  VARCHAR(50)  NULL COMMENT 'ç”¨ä¾†æè¿°é€™ç­†äº‹ä»¶æ˜¯å› ä½•è€Œç™¼ç”Ÿã€é—œè¯åˆ°å“ªå€‹å¤–éƒ¨å¯¦é«”æˆ–å‹•ä½œã€‚é€šå¸¸ç”¨æ–¼å†ªç­‰æ€§æ§åˆ¶ æˆ– è·¨ç³»çµ±è¿½è¹¤: TRADE, CANCEL_REQUEST, RISK_CHECK ..',
    reference_id    BIGINT       NULL COMMENT 'é—œè¯ID (trade_id ç­‰, ç”¨æ–¼å†ªç­‰æ€§æª¢æŸ¥)',
    actor           VARCHAR(100) NOT NULL COMMENT 'æ“ä½œäºº: USER:{userId}, RISK_SERVICE, LEDGER_SERVICE, MATCHING_ENGINE, SYSTEM(å®šæ™‚æˆ–è‡ªå‹•è¦å‰‡ä¸å±¬æ–¼ç‰¹å®šæœå‹™)',


    occurred_at     DATETIME(6)  NOT NULL COMMENT 'åŸå§‹äº‹ä»¶çš„ã€ŒçœŸå¯¦ç™¼ç”Ÿæ™‚é–“ã€ (å¾®ç§’ç²¾åº¦)',
    created_at      DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'è¨˜éŒ„å‰µå»ºæ™‚é–“',
    PRIMARY KEY (event_id),
    UNIQUE KEY uk_order_sequence (order_id, sequence_number) COMMENT 'ç¢ºä¿åŒä¸€è¨‚å–®äº‹ä»¶é †åºå”¯ä¸€',
    UNIQUE KEY uk_idempotent (order_id, reference_type, reference_id) COMMENT 'é˜²æ­¢é‡è¤‡è™•ç†åŒä¸€æ¥­å‹™äº‹ä»¶ (reference_id é NULL æ™‚)'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='è¨‚å–®äº‹ä»¶æº¯æºè¡¨ - Event Sourcing æ¨¡å¼';

CREATE INDEX idx_order_occurred ON order_events (order_id, occurred_at ASC) COMMENT 'æŸ¥è©¢è¨‚å–®äº‹ä»¶æ­·å² (æŒ‰æ™‚é–“é †åº)';
CREATE INDEX idx_user_occurred ON order_events (user_id, occurred_at DESC) COMMENT 'æŸ¥è©¢ç”¨æˆ¶è¨‚å–®äº‹ä»¶';
CREATE INDEX idx_event_type_occurred ON order_events (event_type, occurred_at DESC) COMMENT 'æŒ‰äº‹ä»¶é¡å‹çµ±è¨ˆåˆ†æ';
CREATE INDEX idx_actor ON order_events (actor, occurred_at DESC) COMMENT 'æŒ‰æ“ä½œä¸»é«”æŸ¥è©¢';
CREATE INDEX idx_reference ON order_events (reference_type, reference_id) COMMENT 'é€šéæ¥­å‹™é—œè¯IDæŸ¥æ‰¾äº‹ä»¶';
CREATE INDEX idx_occurred_at ON order_events (occurred_at DESC) COMMENT 'æ™‚åºæŸ¥è©¢æ‰€æœ‰è¨‚å–®äº‹ä»¶';
```

#### äº‹ä»¶é¡å‹ (`event_type`)ã€reference_typeã€reference_idã€Actor

| äº‹ä»¶é¡å‹                    | reference_type | reference_id | Actor            |
|-------------------------|----------------|--------------|------------------|
| OrderApi.create         |                |              | USER:{userId}    |
| PositionReserved        |                |              | POSITION_SERVICE |
| PositionReserveRejected |                |              | POSITION_SERVICE |
| MarginPreCheckFailed    |                |              | RISK_SERVICE     |
| FundsFrozen             |                |              | LEDGER_SERVICE   |
| FundsFreezeFailed       |                |              | LEDGER_SERVICE   |
| FundsUnfrozen           |                |              | LEDGER_SERVICE   |
| TradeExecuted           |                |              | MATCHING_ENGINE  |
| OrderApi.cancel         |                |              | USER:{userId}    |
| OrderCancelRequested    |                |              | MATCHING_ENGINE  |

event_type
åœ¨ Order æœå‹™ä¸­ï¼š

- **äº‹ä»¶é©…å‹•**ï¼šä½¿ç”¨äº‹ä»¶åç¨±ï¼ˆPositionReservedã€FundsFrozenã€TradeExecutedâ€¦ï¼‰ã€‚
- **ä»‹é¢è§¸ç™¼**ï¼šä½¿ç”¨ `ä»‹é¢é¡åˆ¥.æ–¹æ³•`ï¼ˆOrderApi.createã€OrderCommandService.requestCancelâ€¦ï¼‰ã€‚

---

reference_type

- æ„æŒ‡è¦ç”¨å“ªå€‹å­—æ®µç•¶å†ªç­‰éµ

---

reference_id
reference_id å‹åˆ¥èˆ‡ç”Ÿæˆç­–ç•¥

- ç”±ã€Œè«‹æ±‚çš„ç™¼èµ·æ–¹ã€ç”Ÿæˆä¸¦éš¨äº‹ä»¶æµå‚³éï¼š
    - é¢¨æ§è«‹æ±‚ç”± `risk` æœå‹™ç™¼ IDã€‚
    - å‡çµè«‹æ±‚ç”± `account-ledger` ç™¼ IDï¼›è‹¥è¦åœ¨æäº¤å‰å…ˆç¶å®šï¼Œå¯ç”± `order` é å…ˆç”Ÿæˆä¸¦ä½œç‚ºå†ªç­‰éµå‚³çµ¦å¸³æœ¬ã€‚

### order_tasks è¡¨ - ç•°æ­¥æŒ‡ä»¤ä½‡åˆ—

```sql
CREATE TABLE order_tasks
(
    task_id       BIGINT      NOT NULL COMMENT 'ä»»å‹™ID (Snowflake)',
    order_id      BIGINT      NULL COMMENT 'é—œè¯è¨‚å–®ID (æ‰¹æ¬¡æ“ä½œæ™‚ç‚º NULL)',
    user_id       BIGINT      NOT NULL COMMENT 'ç™¼èµ·ç”¨æˆ¶ID',
    task_type     VARCHAR(50) NOT NULL COMMENT 'ä»»å‹™é¡å‹: CANCEL_ORDER, BATCH_CANCEL, STRATEGY_ORDER, SCHEDULED_ORDER',
    payload       JSON        NOT NULL COMMENT 'ä»»å‹™åƒæ•¸ (JSONæ ¼å¼å­˜å„²)',
    status        VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT 'ä»»å‹™ç‹€æ…‹: PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED',
    priority      INT         NOT NULL DEFAULT 5 COMMENT 'å„ªå…ˆç´š (1-10, æ•¸å­—è¶Šå°å„ªå…ˆç´šè¶Šé«˜)',
    retry_count   INT         NOT NULL DEFAULT 0 COMMENT 'å·²é‡è©¦æ¬¡æ•¸',
    max_retries   INT         NOT NULL DEFAULT 3 COMMENT 'æœ€å¤§é‡è©¦æ¬¡æ•¸',
    scheduled_at  DATETIME    NOT NULL COMMENT 'è¨ˆåŠƒåŸ·è¡Œæ™‚é–“ (æ”¯æ´å»¶é²åŸ·è¡Œ)',
    started_at    DATETIME    NULL COMMENT 'å¯¦éš›é–‹å§‹åŸ·è¡Œæ™‚é–“',
    completed_at  DATETIME    NULL COMMENT 'å®Œæˆæ™‚é–“',
    error_message TEXT        NULL COMMENT 'å¤±æ•—åŸå› è©³æƒ…',
    result        JSON        NULL COMMENT 'åŸ·è¡Œçµæœ (æˆåŠŸæ™‚è¨˜éŒ„)',
    created_at    DATETIME    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‰µå»ºæ™‚é–“',
    updated_at    DATETIME    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    PRIMARY KEY (task_id)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='ç•°æ­¥æŒ‡ä»¤ä½‡åˆ— - æ‰¹æ¬¡æ’¤å–®ã€ç­–ç•¥å–®ç­‰éå³æ™‚æ“ä½œ';

CREATE INDEX idx_status_scheduled ON order_tasks (status, scheduled_at) COMMENT 'æŸ¥è©¢å¾…åŸ·è¡Œä»»å‹™ (æ’ç¨‹å™¨ä½¿ç”¨)';
CREATE INDEX idx_user_status ON order_tasks (user_id, status) COMMENT 'æŸ¥è©¢ç”¨æˆ¶ä»»å‹™ç‹€æ…‹';
CREATE INDEX idx_order_id ON order_tasks (order_id) COMMENT 'æŸ¥è©¢ç‰¹å®šè¨‚å–®ç›¸é—œä»»å‹™';
CREATE INDEX idx_priority_scheduled ON order_tasks (priority ASC, scheduled_at ASC) COMMENT 'æŒ‰å„ªå…ˆç´šèˆ‡æ™‚é–“æ’åº';
CREATE INDEX idx_created_at ON order_tasks (created_at DESC) COMMENT 'ä»»å‹™æ­·å²æŸ¥è©¢';
```

## 

## Core

### Order ç‹€æ…‹æ©Ÿ

```mermaid
graph TD
    PENDING -- POST /api/orders (ç´”é–‹å€‰) --> SUBMITTED
    PENDING -- POST /api/orders (å¹³å€‰) --> POSITION_RESERVE_PENDING
    POSITION_RESERVE_PENDING -- PositionReserved --> SUBMITTED
    POSITION_RESERVE_PENDING -- PositionReserveRejected --> FAILED
    SUBMITTED -- FundsFrozen --> ACCEPTED
    ACCEPTED -- TradeExecuted(éƒ¨åˆ†æˆäº¤) --> PARTIAL_FILLED
    PARTIAL_FILLED -- TradeExecuted(éƒ¨åˆ†æˆäº¤) --> PARTIAL_FILLED
    PARTIAL_FILLED -- TradeExecuted(å®Œå…¨æˆäº¤) --> FILLED
    SUBMITTED -- DELETE /api/orders/{id} --> CANCEL_REQUESTED
    PENDING -- DELETE /api/orders/{id} --> CANCEL_REQUESTED
    ACCEPTED -- DELETE /api/orders/{id} --> CANCEL_REQUESTED
    PARTIAL_FILLED -- DELETE /api/orders/{id} --> CANCEL_REQUESTED
    CANCEL_REQUESTED -- OrderCancelRequested --> CANCELLED
    SUBMITTED -- MarginPreCheckFailed / FundsFreezeFailed --> FAILED
```

### æ™‚é–“æˆ³è¨˜æ›´æ–°

- `submitted_at`: åœ¨ACCEPTEDç‹€æ…‹ï¼Œç™¼å¸ƒ `OrderCreated` äº‹ä»¶çµ¦ Matching æ™‚è¨˜éŒ„
- `filled_at`: ç•¶ `remaining_quantity == 0` æ™‚è¨˜éŒ„ç•¶å‰æ™‚é–“
- `cancelled_at`: åœ¨è™•ç†æ’¤å–®æ™‚è¨˜éŒ„

### ç‹€æ…‹ä¸€è‡´æ€§ä¿è­‰

- **æœ€çµ‚ä¸€è‡´æ€§**: è¨‚å–®ç‹€æ…‹é€šéäº‹ä»¶é©…å‹•æœ€çµ‚èˆ‡æ’®åˆçµæœä¿æŒä¸€è‡´
- **ç‹€æ…‹æ ¡é©—**: å®šæ™‚ä»»å‹™æƒæé•·æ™‚é–“åœç•™åœ¨ `PARTIAL_FILLED` çš„è¨‚å–®
- **å°è³¬æ©Ÿåˆ¶**: èˆ‡ Matching å¼•æ“çš„ `trade_tickers` è¡¨é€²è¡Œå®šæœŸå°è³¬

### Event Sourcingï¼š`order_events`

`order_events` è¡¨å¯¦ç¾**äº‹ä»¶æº¯æº (Event Sourcing)** æ¨¡å¼ï¼Œè¨˜éŒ„å§”è¨—åœ¨æ•´å€‹ç”Ÿå‘½é€±æœŸä¸­çš„æ‰€æœ‰ç‹€æ…‹è®Šæ›´èˆ‡é—œéµæ“ä½œã€‚

#### æ ¸å¿ƒè·è²¬

1. **å®Œæ•´å¯©è¨ˆè¿½è¹¤**ï¼šè¨˜éŒ„è¨‚å–®å¾å‰µå»ºåˆ°å®Œæˆ/å–æ¶ˆçš„æ‰€æœ‰ç‹€æ…‹è½‰æ›
2. **æ•…éšœæ¢å¾©**ï¼šç³»çµ±æ•…éšœæ™‚å¯å¾äº‹ä»¶æµé‡å»ºè¨‚å–®ç‹€æ…‹
3. **è¡Œç‚ºåˆ†æ**ï¼šä¾›é¢¨æ§èˆ‡å ±è¡¨ç³»çµ±åˆ†æç”¨æˆ¶äº¤æ˜“è¡Œç‚º
4. **åˆè¦è¦æ±‚**ï¼šæ»¿è¶³é‡‘èç›£ç®¡å°äº¤æ˜“è¨˜éŒ„çš„å®Œæ•´æ€§è¦æ±‚

#### å¯«å…¥æ™‚æ©Ÿèˆ‡æµç¨‹

```mermaid
sequenceDiagram
    participant Client
    participant OrderService
    participant DB-Orders
    participant DB-OrderEvents
    participant Kafka

    Client->>OrderService: POST /api/orders

    OrderService->>DB-Orders: å¯«å…¥ orders (status: PENDING)
    OrderService->>DB-OrderEvents: å¯«å…¥ ORDER_CREATED äº‹ä»¶
    OrderService-->>Client: è¿”å› orderId

    OrderService->>Kafka: ç™¼å¸ƒ OrderSubmitted
    OrderService->>DB-OrderEvents: å¯«å…¥ ORDER_SUBMITTED äº‹ä»¶

    Note over OrderService: å¾ŒçºŒæ¯å€‹ç‹€æ…‹è®Šæ›´éƒ½å¯«å…¥äº‹ä»¶

    OrderService->>DB-OrderEvents: RISK_CHECK_PASSED
    OrderService->>DB-OrderEvents: FUNDS_FROZEN
    OrderService->>DB-OrderEvents: ORDER_ACCEPTED
    OrderService->>DB-OrderEvents: ORDER_PLACED
    OrderService->>DB-OrderEvents: ORDER_FILLED
```

#### ä½¿ç”¨ç¤ºä¾‹

**1. å†ªç­‰æ€§æª¢æŸ¥ï¼ˆé¿å…é‡è¤‡è™•ç† TradeExecutedï¼‰**

```sql
-- æª¢æŸ¥ trade æ˜¯å¦å·²è™•ç†
SELECT COUNT(*)
FROM order_events
WHERE order_id = ?
  AND reference_type = 'TRADE'
  AND reference_id = ?;
-- trade_id

-- è‹¥ COUNT = 0ï¼Œå‰‡è™•ç†ï¼›å¦å‰‡è·³é
```

**2. è¨ˆç®—è¨‚å–®äº‹ä»¶åºè™Ÿ**

```sql
-- æ’å…¥æ–°äº‹ä»¶æ™‚è‡ªå‹•è¨ˆç®— sequence_number
INSERT INTO order_events (event_id, order_id, user_id, instrument_id, event_type,
                          payload, actor, occurred_at, sequence_number)
SELECT ?,
       ?,
       ?,
       ?,
       ?,
       ?,
       ?,
       ?,
       COALESCE(MAX(sequence_number), 0) + 1
FROM order_events
WHERE order_id = ?;
```

**3. æŸ¥è©¢è¨‚å–®å®Œæ•´ç”Ÿå‘½é€±æœŸ**

```sql
SELECT event_type,
       payload,
       actor,
       occurred_at,
       sequence_number
FROM order_events
WHERE order_id = ?
ORDER BY sequence_number ASC;
```

**4. é‡æ”¾äº‹ä»¶é‡å»ºè¨‚å–®ç‹€æ…‹**

```java
public Order rebuildOrderFromEvents(Long orderId) {
    // æŒ‰åºè™Ÿé †åºåŠ è¼‰æ‰€æœ‰äº‹ä»¶
    List<OrderEvent> events = jdbcTemplate.query(
            "SELECT * FROM order_events WHERE order_id = ? ORDER BY sequence_number ASC",
            new Object[]{orderId},
            orderEventRowMapper
                                                );
    
    // åˆå§‹åŒ–è¨‚å–®å°è±¡
    Order order = new Order();
    
    // é€ä¸€æ‡‰ç”¨äº‹ä»¶é‡å»ºç‹€æ…‹
    for (OrderEvent event : events) {
        order.applyEvent(event);
    }
    
    return order;
}
```

#### ä½¿ç”¨ç¯„ä¾‹

**1. æŸ¥è©¢è¨‚å–®å®Œæ•´æ­·å²**

```sql
SELECT event_type, payload, occurred_at, actor
FROM order_events
WHERE order_id = ?
ORDER BY occurred_at ASC;
```

**2. é‡å»ºè¨‚å–®ç‹€æ…‹ï¼ˆäº‹ä»¶é‡æ’­ï¼‰**

```java
public Order rebuildOrderFromEvents(String orderId) {
    List<OrderEvent> events = orderEventRepository.findByOrderId(orderId);
    Order order = new Order();
    
    for (OrderEvent event : events) {
        order.apply(event); // é€ä¸€å¥—ç”¨äº‹ä»¶é‡å»ºç‹€æ…‹
    }
    
    return order;
}
```

**3. é¢¨æ§åˆ†æï¼šçµ±è¨ˆç”¨æˆ¶é »ç¹æ’¤å–®è¡Œç‚º**

```sql
SELECT user_id, COUNT(*) as cancel_count
FROM order_events
WHERE event_type = 'ORDER_CANCEL_REQUESTED'
  AND occurred_at > NOW() - INTERVAL 1 HOUR
GROUP BY user_id
HAVING cancel_count > 10;
```

**4. åˆè¦å ±è¡¨ï¼šå°å‡ºç‰¹å®šæ™‚æ®µæ‰€æœ‰è¨‚å–®äº‹ä»¶**

```sql
SELECT oe.*, o.user_id, o.instrument_id
FROM order_events oe
         JOIN orders o ON oe.order_id = o.order_id
WHERE oe.occurred_at BETWEEN '2024-01-01' AND '2024-01-31'
ORDER BY oe.occurred_at;
```

#### è¨­è¨ˆåŸå‰‡

1. **ä¸å¯è®Šæ€§ (Immutable)**ï¼šäº‹ä»¶ä¸€æ—¦å¯«å…¥ï¼Œæ°¸ä¸ä¿®æ”¹æˆ–åˆªé™¤
2. **é †åºæ€§ (Sequential)**ï¼šåŒä¸€è¨‚å–®çš„äº‹ä»¶æŒ‰æ™‚é–“é †åºå¯«å…¥
3. **å†ªç­‰æ€§ (Idempotent)**ï¼šé‡è¤‡å¯«å…¥åŒä¸€äº‹ä»¶ä¸å½±éŸ¿ç³»çµ±ç‹€æ…‹
4. **å®Œæ•´æ€§ (Complete)**ï¼šæ‰€æœ‰ç‹€æ…‹è®Šæ›´éƒ½å¿…é ˆè¨˜éŒ„äº‹ä»¶
5. **è¼•é‡åŒ– Payload**ï¼šåªè¨˜éŒ„è®Šæ›´éƒ¨åˆ†ï¼Œé¿å…å†—é¤˜å®Œæ•´è¨‚å–®æ•¸æ“š

### äº‹ä»¶ä¿ç•™ç­–ç•¥

- **ç†±æ•¸æ“š**ï¼šæœ€è¿‘ 3 å€‹æœˆçš„äº‹ä»¶ä¿ç•™åœ¨ä¸»è¡¨
- **å†·æ•¸æ“š**ï¼š3 å€‹æœˆä»¥ä¸Šçš„äº‹ä»¶æ­¸æª”è‡³ `order_events_archive` è¡¨
- **å£“ç¸®å­˜å„²**ï¼šæ­·å²äº‹ä»¶å¯ä½¿ç”¨ JSON å£“ç¸®å­˜å„²ç¯€çœç©ºé–“
- **åˆè¦è¦æ±‚**ï¼šè‡³å°‘ä¿ç•™ 7 å¹´çš„å®Œæ•´äº¤æ˜“è¨˜éŒ„

## `POST /api/orders`

Saga æµç¨‹è©³è§£

1. **å¿«é€ŸéŸ¿æ‡‰**:
    * `Order` æœå‹™æ”¶åˆ°è«‹æ±‚å¾Œåƒ…åš DTO é©—è­‰
    * åŒæ­¥å‘¼å« `PositionQueryService` çš„ `/api/positions/intent`ï¼Œæ ¹æ“š (userId, instrumentId, side, quantity) å–å¾—
      `PositionIntentType`ï¼š`INCREASE`ï¼ˆç´”é–‹å€‰ï¼‰ã€`REDUCE`ï¼ˆéƒ¨åˆ†å¹³å€‰ï¼‰ã€`CLOSE`ï¼ˆå…¨éƒ¨å¹³å€‰ï¼‰ã€‚
    * è‹¥:

    - **Intent = INCREASE**ï¼š
        - ç«‹å³ä»¥ `SUBMITTED` ç‹€æ…‹å¯«å…¥ `orders` è¡¨ä¸¦å›å‚³ `orderId`ã€‚å†é€é Outbox ç™¼å¸ƒ `OrderSubmitted`ã€‚
        * `Risk-Margin` æ¶ˆè²» `OrderSubmitted` å®Œæˆé æª¢ä¸¦ç™¼ `MarginPreCheckPassed`ï¼›
        * `Account-Ledger` é æ‰£ä¿è­‰é‡‘å¾Œç™¼ `FundsFrozen`ï¼›
        * `Order` æ¶ˆè²» `FundsFrozen` å°‡è¨‚å–®ç‹€æ…‹æ”¹ç‚º `ACCEPTED` ä¸¦æ¨é€ `OrderCreated` è‡³ `Matching`ã€‚
    - **Intent = REDUCE/CLOSE**ï¼š
        - ç«‹å³ä»¥ `PENDING` ç‹€æ…‹å¯«å…¥ `orders` è¡¨ä¸¦å›å‚³ `orderId`ã€‚
        * `Order` æœå‹™å°‡è©²è¨‚å–®è½‰ç‚º Position Sagaï¼Œå¯«å…¥ Outbox ç™¼é€`PositionReserveRequested)`
        * `Positions` æœå‹™æ¶ˆè²»å¾Œæª¢æŸ¥å€‰ä½å¯é—œæ•¸é‡ï¼›è‹¥æˆåŠŸå‡çµå‰‡å›è¦† `PositionReserved`ï¼ŒåŒ…å«å¹³å‡é–‹å€‰æˆæœ¬ç”¨æ–¼è¨ˆç®—ç›ˆè™§ä½¿ç”¨ï¼Œè‹¥ä¸è¶³å‰‡å›è¦†
          `PositionReserveRejected`ã€‚
        * `Order` æœå‹™æ–°å¢çš„ Kafka Consumer æœƒï¼š
            * æ”¶åˆ° `PositionReserved` æ™‚æ›´æ–°è¨‚å–®ç‹€æ…‹ç‚º `SUBMITTED` ä¸¦è£œç™¼ `OrderSubmitted`ï¼ˆæ­¤æ™‚æ‰å…è¨±é€²å…¥é¢¨æ§/æ’®åˆæµç¨‹ï¼‰ã€‚
            * æ”¶åˆ° `PositionReserveRejected` æ™‚ç«‹å³å°‡è¨‚å–®æ¨™è¨˜ç‚º `FAILED`ï¼ŒåŸå› å¯«å…¥äº‹ä»¶ä¾›å ±è¡¨/å‰ç«¯æŸ¥è©¢ä½¿ç”¨ã€‚

3. **è£œå„Ÿèˆ‡å¤±æ•—è™•ç†**:
    * è‹¥é¢¨æ§æˆ–è³‡é‡‘å‡çµå¤±æ•—ï¼Œ`Order` æ¶ˆè²» `MarginPreCheckFailed`ã€`FundsFreezeFailed` å°‡è¨‚å–®ç½®ç‚º `FAILED`ã€‚å¹³å€‰è¨‚å–®è‹¥åœ¨å€‰ä½é å‡çµéšæ®µå¤±æ•—ï¼Œ
      `PositionReserveRejected` æœƒè§¸ç™¼åŒæ¨£çš„è£œå„Ÿä¸¦è¨˜éŒ„æ‹’çµ•åŸå› ã€‚

## Event Inputï¼š`TradeExecuted`

Order æœå‹™éœ€è¦æ¶ˆè²» Matching å¼•æ“ç™¼å¸ƒçš„ `TradeExecuted` äº‹ä»¶ï¼Œä»¥æ›´æ–°è¨‚å–®çš„æˆäº¤ç‹€æ…‹ã€ç´¯è¨ˆæˆäº¤é‡ã€å¹³å‡æˆäº¤åƒ¹æ ¼å’Œæ‰‹çºŒè²»ç­‰é—œéµæ¬„ä½ã€‚

### æ¶ˆè²»æµç¨‹

```mermaid
sequenceDiagram
    participant Matching
    participant Kafka
    participant Order
    participant OrderDB

    Matching->>Kafka: ç™¼å¸ƒ TradeExecuted äº‹ä»¶
    Note over Matching: {instrumentId, quoteAsset, tradeId, orderId(maker), counterpartyOrderId(taker), orderSide(maker), counterpartyOrderSide(taker), price, quantity, makerUserId, takerUserId, makerFee, takerFee, executedAt}

    Kafka->>Order: Orderæœå‹™æ¶ˆè²» TradeExecuted
    Order->>OrderDB: æŸ¥è©¢è¨‚å–®ç•¶å‰ç‹€æ…‹
    Order->>Order: è¨ˆç®—ç´¯è¨ˆæˆäº¤é‡èˆ‡å¹³å‡åƒ¹æ ¼

    alt éƒ¨åˆ†æˆäº¤
        Order->>OrderDB: æ›´æ–°è¨‚å–®ç‹€æ…‹ç‚º PARTIAL_FILLED
        Note over OrderDB: filled_quantity += quantity<br/>remaining_quantity -= quantity<br/>avg_fill_price = åŠ æ¬Šå¹³å‡<br/>fee += trade_fee
    else å®Œå…¨æˆäº¤
        Order->>OrderDB: æ›´æ–°è¨‚å–®ç‹€æ…‹ç‚º FILLED
        Note over OrderDB: status = FILLED<br/>filled_at = executedAt<br/>remaining_quantity = 0
    end

    Order->>OrderDB: å¯«å…¥ order_events äº‹ä»¶è¨˜éŒ„
    Note over OrderDB: event_type: ORDER_PARTIAL_FILLED<br/>æˆ– ORDER_FILLED
```

### æ›´æ–°é‚è¼¯

**1. è¨‚å–®ç‹€æ…‹è½‰æ›**

```
SUBMITTED â†’ PARTIAL_FILLED â†’ FILLED
         â†˜                 â†—
           (å¤šæ¬¡éƒ¨åˆ†æˆäº¤)
```

**2. ç´¯è¨ˆæˆäº¤é‡è¨ˆç®—**

```java
order.filled_quantity +=trade.quantity;
order.remaining_quantity =order.quantity -order.filled_quantity;
```

**3. å¹³å‡æˆäº¤åƒ¹æ ¼è¨ˆç®—ï¼ˆåŠ æ¬Šå¹³å‡ï¼‰**

```java
// ç´¯è¨ˆæˆäº¤ç¸½é‡‘é¡
total_value +=(trade.price *trade.quantity);
// è¨ˆç®—åŠ æ¬Šå¹³å‡åƒ¹æ ¼
order.avg_fill_price =total_value /order.filled_quantity;
```

**4. æ‰‹çºŒè²»ç´¯è¨ˆ**

```java
order.fee +=trade.fee;
```

### å†ªç­‰æ€§ä¿è­‰

ç‚ºé¿å…é‡è¤‡æ¶ˆè²»å°è‡´æ•¸æ“šéŒ¯èª¤ï¼ŒOrder æœå‹™æ‡‰ï¼š

1. **æª¢æŸ¥ trade_id**: åœ¨ `order_events` è¡¨ä¸­è¨˜éŒ„å·²è™•ç†çš„ `trade_id`
   ```sql
   SELECT COUNT(*) FROM order_events
   WHERE order_id = ? AND reference_id = ?  -- reference_id å­˜ trade_id
   ```

2. **ä½¿ç”¨æ¨‚è§€é–**: é€šé `version` æ¬„ä½æˆ– `updated_at` ç¢ºä¿ä¸¦ç™¼å®‰å…¨
   ```sql
   UPDATE orders
   SET filled_quantity = ?, avg_fill_price = ?, fee = ?, version = version + 1
   WHERE order_id = ? AND version = ?  -- æ¨‚è§€é–
   ```

3. **äº‹å‹™æ€§å¯«å…¥**: è¨‚å–®æ›´æ–° + äº‹ä»¶è¨˜éŒ„å¿…é ˆåœ¨åŒä¸€äº‹å‹™ä¸­å®Œæˆ
   ```java
   @Transactional
   public void handleTradeExecuted(TradeExecutedEvent event) {
       // 1. å†ªç­‰æ€§æª¢æŸ¥
       if (isTradeAlreadyProcessed(event.getTradeId())) {
           return;
       }

       // 2. æ›´æ–°è¨‚å–®ç‹€æ…‹
       Order order = orderRepository.findById(event.getOrderId());
       order.applyTrade(event);
       orderRepository.save(order);

       // 3. è¨˜éŒ„äº‹ä»¶
       orderEventRepository.save(new OrderEvent(
           event.getOrderId(),
           order.isFilled() ? "ORDER_FILLED" : "ORDER_PARTIAL_FILLED",
           event.getTradeId(),
           event.getOccurredAt()
       ));
   }
   ```

### æ¬„ä½å¡«å……å°ç…§è¡¨

| æ¬„ä½                   | å¡«å……æ™‚æ©Ÿ                | æ•¸æ“šä¾†æº                       | èªªæ˜         |
|----------------------|---------------------|----------------------------|------------|
| `submitted_at`       | ç™¼å¸ƒ OrderCreated äº‹ä»¶æ™‚ | Order æœå‹™æœ¬åœ°æ™‚é˜               | æäº¤åˆ°æ’®åˆå¼•æ“çš„æ™‚é–“ |
| `filled_quantity`    | æ¶ˆè²» TradeExecuted äº‹ä»¶ | ç´¯åŠ  trade.quantity          | å·²æˆäº¤ç¸½é‡      |
| `remaining_quantity` | æ¶ˆè²» TradeExecuted äº‹ä»¶ | quantity - filled_quantity | å‰©é¤˜æœªæˆäº¤é‡     |
| `avg_fill_price`     | æ¶ˆè²» TradeExecuted äº‹ä»¶ | åŠ æ¬Šå¹³å‡è¨ˆç®—                     | å¹³å‡æˆäº¤åƒ¹      |
| `fee`                | æ¶ˆè²» TradeExecuted äº‹ä»¶ | ç´¯åŠ  trade.fee               | æ‰‹çºŒè²»ç¸½é¡      |
| `filled_at`          | è¨‚å–®å®Œå…¨æˆäº¤æ™‚             | trade.executedAt           | å®Œå…¨æˆäº¤æ™‚é–“     |
| `cancelled_at`       | è™•ç†æ’¤å–®è«‹æ±‚æ™‚             | Order æœå‹™æœ¬åœ°æ™‚é˜               | æ’¤å–®æ™‚é–“       |

## ~~`DELETE /api/orders/{orderId}`~~

- `order-service` ç™¼é€ `OrderCancelRequested`ã€‚
- `matching` æ¥æ”¶å¾Œå¾è¨‚å–®ç°¿ç§»é™¤ï¼Œç™¼å¸ƒ `OrderCancelled`ã€‚
- `account-ledger` æ¶ˆè²»å¾Œè§£å‡è³‡é‡‘ï¼Œç™¼å¸ƒ `FundsUnfrozen`ã€‚

## ~~**ç‹€æ…‹æ ¡é©—**: å®šæ™‚ä»»å‹™æƒæé•·æ™‚é–“æœªé”æœ€çµ‚ç‹€æ…‹çš„è¨‚å–®~~

æœ€çµ‚ç‹€æ…‹ FILLED, CANCELLED, REJECTED, FAILED

## ~~**å°è³¬æ©Ÿåˆ¶**: èˆ‡ Matching å¼•æ“çš„ `trade_tickers` è¡¨é€²è¡Œå®šæœŸå°è³¬~~

# Matching æœå‹™

## **è·è²¬**

- æ˜¯æ’®åˆæ ¸å¿ƒï¼Œç¶­è­·æ¯å€‹äº¤æ˜“å°çš„è¨‚å–®ç°¿ã€‚
- ä¸»è¦ä»»å‹™æ˜¯ï¼šæ¥æ”¶å§”è¨—äº‹ä»¶ â†’ é€²å…¥è¨‚å–®ç°¿ â†’ æ’®åˆæˆäº¤ -> ç”¢ç”Ÿæˆäº¤ç´€éŒ„èˆ‡è¡Œæƒ…å ±åƒ¹ä¾†æº â†’ **ç™¼å¸ƒæ‰€æœ‰å½±éŸ¿è¨‚å–®ç°¿çš„äº‹ä»¶**ã€‚
- å°‡æ’®åˆçµæœæ¨é€çµ¦ ledgerã€positionsã€market-dataã€‚

## endpoint

| å®Œæˆ | HTTP Method | Endpoint               | èªªæ˜      | èª¿ç”¨è€… | æˆæ¬Š      | è¼¸å…¥      | è¼¸å‡º | äº‹ä»¶ç™¼å¸ƒ             | DBæ“ä½œ | ç·©å­˜æ“ä½œ            | æœå‹™èª¿ç”¨ | è£œå„Ÿæ©Ÿåˆ¶ |
|----|-------------|------------------------|---------|-----|---------|---------|----|------------------|------|-----------------|------|------|
|    | (å¯é¸) POST   | `/api/matching/cancel` | æ’®åˆå±¤åŸ·è¡Œæ’¤å–® | -   | private | orderId | -  | `OrderCancelled` | -    | å…§å­˜è¨‚å–®ç°¿åˆªé™¤ orderId | -    | -    |

## events

**äº‹ä»¶æ¶ˆè²»**:

| å®Œæˆ | ä¾†æºæœå‹™  | Topic         | äº‹ä»¶             | è™•ç†é‚è¼¯            | äº‹ä»¶ç™¼å¸ƒ                                 | DBæ“ä½œ | ç·©å­˜æ“ä½œ          | æœå‹™èª¿ç”¨ | è£œå„Ÿæ©Ÿåˆ¶ |
|----|-------|---------------|----------------|-----------------|--------------------------------------|------|---------------|------|------|
|    | order | order.created | `OrderCreated` | å°‡å§”è¨—æ”¾å…¥è¨‚å–®ç°¿ä¸¦è§¸ç™¼æ’®åˆæµç¨‹ | `OrderBookUpdated` / `TradeExecuted` | -    | å…§å­˜è¨‚å–®ç°¿æ–°å¢/åŒ¹é…/åˆªé™¤ | -    | -    |

**äº‹ä»¶ç™¼å¸ƒ**:

| å®Œæˆ  | ç™¼å¸ƒå ´æ™¯       | Topic                      | äº‹ä»¶åç¨±               | äº‹ä»¶å…§å®¹                                                                                                                                                                                           | æ¶ˆè²»è€…                                    |
| --- | ---------- | -------------------------- | ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------- |
|     | è¨‚å–®ç°¿ç”¢ç”Ÿä»»ä½•è®ŠåŒ–  | matching.orderbook-updated | `OrderBookUpdated` | instrumentId, bids[], asks[], bestBid, bestAsk, midPrice, updatedAtï¼ˆç”±æ’®åˆå³æ™‚è¨ˆç®—æœ€ä½³åƒ¹ä¸¦å°åŒ…ï¼‰                                                                                                                 | market-data                            |
|     | æ’®åˆæˆäº¤ç”¢ç”Ÿæˆäº¤æ˜ç´° | matching.trade-executed    | `TradeExecuted`    | instrumentId, quoteAsset, tradeId, orderId(maker), counterpartyOrderId(taker), orderSide(maker), counterpartyOrderSide(taker), price, quantity, makerUserId, takerUserId, makerFee, takerFee, executedAt | account-ledger, positions, market-data |

---

## è³‡æ–™è¡¨DDL

### trade_tickers è¡¨ - æˆäº¤ç´€éŒ„

```sql
CREATE TABLE trade_tickers
(
    trade_id                 BIGINT         NOT NULL COMMENT 'æˆäº¤ID (Snowflake)',
    instrument_id            BIGINT         NOT NULL COMMENT 'äº¤æ˜“å°ID (å¤–éµé—œè¯ instruments.id)',
    order_id                 BIGINT         NOT NULL COMMENT 'Makerè¨‚å–®ID (æ›å–®æ–¹)',
    counterparty_order_id    BIGINT         NOT NULL COMMENT 'Takerè¨‚å–®ID (åƒå–®æ–¹)',
    order_side               VARCHAR(10)    NOT NULL COMMENT 'Makerè¨‚å–®æ–¹å‘: BUY, SELL',
    counterparty_order_side  VARCHAR(10)    NOT NULL COMMENT 'Takerè¨‚å–®æ–¹å‘: BUY, SELL',
    maker_user_id            BIGINT         NOT NULL COMMENT 'Makerç”¨æˆ¶ID',
    taker_user_id            BIGINT         NOT NULL COMMENT 'Takerç”¨æˆ¶ID',
    price                    DECIMAL(20, 8) NOT NULL COMMENT 'æˆäº¤åƒ¹æ ¼',
    quantity                 DECIMAL(20, 8) NOT NULL COMMENT 'æˆäº¤æ•¸é‡',
    maker_fee                DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'Makeræ‰‹çºŒè²»',
    taker_fee                DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'Takeræ‰‹çºŒè²»',
    total_value              DECIMAL(20, 8) NOT NULL COMMENT 'æˆäº¤ç¸½åƒ¹å€¼ (price * quantity)',
    trade_type               VARCHAR(20)    NOT NULL DEFAULT 'NORMAL' COMMENT 'æˆäº¤é¡å‹: NORMAL, LIQUIDATION, ADL',
    executed_at              DATETIME       NOT NULL COMMENT 'æˆäº¤æ™‚é–“ (å¾®ç§’ç²¾åº¦)',
    created_at               DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'è¨˜éŒ„å‰µå»ºæ™‚é–“',
    PRIMARY KEY (trade_id)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='æˆäº¤ç´€éŒ„è¡¨ - æ’®åˆè¼¸å‡ºä¾›å ±è¡¨èˆ‡äº‹ä»¶å›æ”¾';

CREATE INDEX idx_instrument_executed ON trade_tickers (instrument_id, executed_at DESC) COMMENT 'æŸ¥è©¢äº¤æ˜“å°æ­·å²æˆäº¤';
CREATE INDEX idx_order_id ON trade_tickers (order_id) COMMENT 'æŸ¥è©¢ç‰¹å®šè¨‚å–®æ‰€æœ‰æˆäº¤';
CREATE INDEX idx_counterparty_order ON trade_tickers (counterparty_order_id) COMMENT 'æŸ¥è©¢å°æ‰‹è¨‚å–®æˆäº¤';
CREATE INDEX idx_maker_user ON trade_tickers (maker_user_id, executed_at DESC) COMMENT 'æŸ¥è©¢ç”¨æˆ¶ä½œç‚ºMakerçš„æˆäº¤';
CREATE INDEX idx_taker_user ON trade_tickers (taker_user_id, executed_at DESC) COMMENT 'æŸ¥è©¢ç”¨æˆ¶ä½œç‚ºTakerçš„æˆäº¤';
CREATE INDEX idx_executed_at ON trade_tickers (executed_at DESC) COMMENT 'å…¨å¸‚å ´æˆäº¤æ™‚åºæŸ¥è©¢';
```

#### taker / maker

Taker / Maker æ˜¯æ’®åˆæ™‚å…©ç¨®è§’è‰²çš„ç°¡å–®åˆ†é¡ã€‚

Maker

- å…ˆæŠŠè¨‚å–®æ›åœ¨ order book
- ç­‰åˆ¥äººä¾†æˆäº¤
- è¢«å‹•
- æä¾›æµå‹•æ€§
- é€šå¸¸æ‰‹çºŒè²»è¼ƒä½æˆ–è¿”å‚­
  ä¾‹
- æˆ‘æ›ä¸€å¼µ LIMIT BUY 100 ç­‰äººè³£çµ¦æˆ‘ â†’ æˆ‘æ˜¯ Maker
  Taker
- ä¸»å‹•åƒæ‰ order book ä¸Šçš„è¨‚å–®
- ç«‹å³æˆäº¤
- æ¶ˆè€—æµå‹•æ€§
- é€šå¸¸æ‰‹çºŒè²»è¼ƒé«˜
  ä¾‹
- å¸‚åƒ¹è²·å…¥ï¼Œæ’®åˆåˆ°å°æ‰‹åƒ¹æ ¼ â†’ æˆ‘æ˜¯ Taker
- æˆ–ç”¨é™åƒ¹å–®ä½†åƒ¹æ ¼è¶Šéè¡Œæƒ…ç›´æ¥æˆäº¤ â†’ é‚„æ˜¯ Taker

---
åˆ¤æ–·æ–¹å¼

- å…ˆåœ¨ç°¿ä¸Šç­‰å¾… â†’ Maker
- å–®å­ä¸€é€²å ´å°±ç«‹å³æˆäº¤ â†’ Taker
  é—œéµ
- **åªæœ‰ Taker æœƒæ±ºå®šæˆäº¤æ–¹å‘**
- Maker æ˜¯å¦è²·è³£ä¸å½±éŸ¿ `trade.side` å®šç¾©
  ç°¡è¡¨
- Maker = æ›å–®
- Taker = åƒå–®

#### side

æˆäº¤æ–¹å‘ = ä»¥ **Taker çš„è²·è³£æ–¹å‘** è¡¨ç¤ºé€™ç­†æˆäº¤æ˜¯ **è²·å…¥(BUY)** é‚„æ˜¯ **è³£å‡º(SELL)**ã€‚

## Core

### å†ªç­‰

çµè«–ï¼šç”¨ã€Œå¯æŒä¹…å»é‡éµã€èˆ‡ã€Œå¯«å‰æ—¥èªŒåŠ å¿«ç…§ã€ç¢ºä¿å†ªç­‰ã€‚åªç”¨å…§å­˜å»é‡ä¸å¤ ã€‚é‡æ”¾æ™‚è¦èƒ½å¾æŒä¹…ç‹€æ…‹åˆ¤æ–·ä¸¦å¿½ç•¥é‡è¤‡æŒ‡ä»¤ã€‚

é—œéµåšæ³•

- å…¨åŸŸå”¯ä¸€éµ
    - orderId ç”±ä¸Šæ¸¸ç”¢ç”Ÿä¸¦ä¿è­‰å”¯ä¸€
    - æ¯ç­†æŒ‡ä»¤å†å¸¶ idempotencyKey ä¾‹å¦‚ clientId åŠ  seq
- æŒ‡ä»¤é †åºèˆ‡ç‰ˆæœ¬
    - å°æ¯å€‹ client ç¶­è­· lastAppliedSeq
    - ä½æ–¼æˆ–ç­‰æ–¼ lastAppliedSeq çš„æŒ‡ä»¤ç›´æ¥ä¸Ÿæ£„
    - ä¿®æ”¹èˆ‡å–æ¶ˆç”¨ç‰ˆæœ¬è™Ÿ CAS æµç¨‹
- æŒä¹…åŒ–å»é‡ç‹€æ…‹
    - é¸ä¸€å€‹å…·æŒä¹…æ€§çš„ KV
        - RocksDB å…§åµŒæª”æ¡ˆåŠ  AOF å¿«ç…§
        - Redis é–‹å•Ÿ AOF æˆ– RDB
        - äº¤æ˜“å‹è³‡æ–™åº«å…·æœ‰å”¯ä¸€ç´„æŸ
    - çµæ§‹ç¤ºä¾‹
        - processed:{idempotencyKey} å­˜è™•ç†çµæœæ‘˜è¦
        - lastSeq:{clientId} å­˜æœ€å¾Œå¥—ç”¨åºè™Ÿ
- å¯«å‰æ—¥èªŒèˆ‡å¿«ç…§
    - å…ˆæŠŠ Command è¿½åŠ åˆ° WAL
    - å†åœ¨å…§å­˜æ’®åˆç°¿å¥—ç”¨
    - é€±æœŸå¯«å¿«ç…§ åŠ ä¸Š WAL æˆªæ–·
    - é‡å•Ÿæ™‚å…ˆè¼‰å…¥å¿«ç…§ å†å›æ”¾ WAL ä¸¦ä¾ processed æˆ– lastSeq å…é‡è¤‡
- è³‡æ–™åº«å‹å¥½è·¯å¾‘
    - ä¸‹å–®ç”¨ INSERT ä¾è³´å”¯ä¸€éµ order_id
        - é‡åˆ° duplicate key è¦–ç‚ºå†ªç­‰æˆåŠŸ å›å‚³æ—¢æœ‰ç‹€æ…‹
    - æ’¤å–®æ”¹å–®ç”¨ UPDATE ... WHERE order_id èˆ‡ expected_version
        - å½±éŸ¿åˆ—æ•¸ç‚º 0 è¦–ç‚ºé‡æ”¾æˆ–ç«¶æ…‹ ç›´æ¥è®€ç•¶å‰ç‹€æ…‹å›å‚³
- Kafka è·¯å¾‘
    - æŒ‡ä»¤ topic ä½¿ç”¨ key ç­‰æ–¼ clientId æˆ– orderId ä¿åº
    - ä½¿ç”¨äº¤æ˜“èˆ‡ EOSv2
        - read process write åœ¨å–®ä¸€äº¤æ˜“å…§
        - offset èˆ‡çµæœåŒäº¤æ˜“æäº¤
    - å¦å»º compacted topic processed ç”¨æ–¼å»é‡èˆ‡æ¢å¾©
- é‡è©¦è¨­è¨ˆ
    - å®¢æˆ¶ç«¯é‡è©¦å¿…é ˆé‡é€åŒä¸€ idempotencyKey
    - ä¼ºæœç«¯å°ç›¸åŒ key å›å‚³ç›¸åŒçµæœ

æœ€å°è½åœ°æ–¹æ¡ˆ

- åœ¨æ’®åˆæœå‹™åŠ å…¥ RocksDB
    - è¡¨ä¸€ processed key idempotencyKey value resultHash
    - è¡¨äºŒ lastSeq key clientId value lastAppliedSeq
- å¼•å…¥ WAL
    - å…ˆ append å† apply å†æ¨™è¨˜ processed
- æ¯ 5 åˆ° 30 ç§’åšå¿«ç…§
    - å­˜ orderbook èˆ‡å»é‡å…©å¼µè¡¨çš„ checkpoint

äº‹ä»¶æµç¯„ä¾‹

```mermaid
flowchart LR
  Produceræäº¤æŒ‡ä»¤ --> æŒ‡ä»¤Topic
  æŒ‡ä»¤Topic --> æ’®åˆæ¶ˆè²»è€…
  æ’®åˆæ¶ˆè²»è€… --> å¯«å‰æ—¥èªŒ
  å¯«å‰æ—¥èªŒ --> å»é‡æª¢æŸ¥
  å»é‡æª¢æŸ¥ -->|æœªè™•ç†| å¥—ç”¨æ’®åˆç°¿
  å»é‡æª¢æŸ¥ -->|å·²è™•ç†| ç›´æ¥å›è¦†çµæœ
  å¥—ç”¨æ’®åˆç°¿ --> æ¨™è¨˜processed
  å¥—ç”¨æ’®åˆç°¿ --> ç”¢ç”Ÿæˆäº¤äº‹ä»¶
  ç”¢ç”Ÿæˆäº¤äº‹ä»¶ --> ä¸‹æ¸¸æ¸…çµç®—
  æ¨™è¨˜processed --> é€±æœŸå¿«ç…§
```

è³‡æ–™åº«ç¯„ä¾‹ç‰‡æ®µ

- ä¸‹å–®å†ªç­‰
    - orders è¡¨è¨­å”¯ä¸€éµ order_id
    - duplicate key è¦–ç‚ºå†ªç­‰æˆåŠŸ
- æ’¤å–®å†ªç­‰
    - unique key order_id åŠ  version
    - UPDATE orders SET status CANCELED, version = version + 1 WHERE order_id = ? AND version = ?

å¸¸è¦‹å‘

- åªåœ¨è¨˜æ†¶é«”å»é‡
- å…ˆæäº¤ offset å†å¯« WAL å°è‡´ä¸Ÿç´€éŒ„
- ç„¡ per client åºè™Ÿå°è‡´äº‚åºé‡æ”¾
- ä¿®æ”¹èˆ‡æ’¤å–®æœªåšæ¢ä»¶æ›´æ–°å°è‡´é‡è¤‡ç”Ÿæ•ˆ

### ç·šç¨‹æ¨¡å‹

- é«˜ä½µç™¼ä¸‹ä½¿ç”¨ per-instrument å–®åŸ·è¡Œç·’æ¨¡å‹ç¢ºä¿é †åºèˆ‡ä¸€è‡´æ€§ã€‚

### Order Book

è¨‚å–®ç°¿æ˜¯æ’®åˆå¼•æ“çš„æ ¸å¿ƒæ•¸æ“šçµæ§‹ï¼Œå®ƒå¯¦æ™‚è¨˜éŒ„äº†ç‰¹å®šäº¤æ˜“å°æ‰€æœ‰æœªæˆäº¤çš„é™åƒ¹å§”è¨—ã€‚ä¸€å€‹è¨‚å–®ç°¿é€šå¸¸åˆ†ç‚ºè²·ç›¤ (Bids) å’Œè³£ç›¤ (Asks)
å…©éƒ¨åˆ†ï¼Œåˆ†åˆ¥ä»£è¡¨äº†è²·æ–¹å’Œè³£æ–¹çš„æ›å–®æ„é¡˜ã€‚

#### æ•¸æ“šçµæ§‹

æ¯å€‹äº¤æ˜“å°ç¶­è­·ä¸€å€‹ç¨ç«‹çš„è¨‚å–®ç°¿ï¼Œå…¶å…§éƒ¨çµæ§‹é€šå¸¸ç‚ºå…©å€‹æœ‰åºçš„åƒ¹æ ¼å±¤ç´šåˆ—è¡¨ï¼š

Ask orders (å–Šåƒ¹)

- **è³£ç›¤ (Asks)**: è³£æ–¹æ›å–®åˆ—è¡¨ï¼ŒæŒ‰åƒ¹æ ¼å¾ä½åˆ°é«˜æ’åºã€‚æ¯å€‹åƒ¹æ ¼å±¤ç´šåŒ…å«è©²åƒ¹æ ¼ä¸Šçš„ç¸½æ›å–®æ•¸é‡å’Œæ‰€æœ‰è¨‚å–®çš„è©³ç´°ä¿¡æ¯ã€‚
  ```
  Asks: [
    { price: P_sell_min, quantity: Q_total_sell_min, orders: [Order5, Order6...] },
    { price: P_sell_next, quantity: Q_total_sell_next, orders: [Order7, Order8...] },
    ...
  ]
  ```

Bid orders (å‡ºåƒ¹)

- **è²·ç›¤ (Bids)**: è²·æ–¹æ›å–®åˆ—è¡¨ï¼ŒæŒ‰åƒ¹æ ¼å¾é«˜åˆ°ä½æ’åºã€‚æ¯å€‹åƒ¹æ ¼å±¤ç´šåŒ…å«è©²åƒ¹æ ¼ä¸Šçš„ç¸½æ›å–®æ•¸é‡å’Œæ‰€æœ‰è¨‚å–®çš„è©³ç´°ä¿¡æ¯ (
  å¦‚è¨‚å–®IDã€ç”¨æˆ¶IDã€æ™‚é–“æˆ³)ã€‚
  ```
  Bids: [
    { price: P_buy_max, quantity: Q_total_buy_max, orders: [Order1, Order2...] },
    { price: P_buy_next, quantity: Q_total_buy_next, orders: [Order3, Order4...] },
    ...
  ]
  ```

#### æ ¸å¿ƒæ¦‚å¿µ

- **åƒ¹æ ¼å±¤ç´š (Price Level)**: è¨‚å–®ç°¿ä¸­ç‰¹å®šåƒ¹æ ¼ä¸Šçš„æ‰€æœ‰æ›å–®çš„é›†åˆã€‚
- **æœ€ä½³è²·åƒ¹ (Best Bid)**: è²·ç›¤ä¸­åƒ¹æ ¼æœ€é«˜çš„æ›å–®åƒ¹æ ¼ã€‚
- **æœ€ä½³è³£åƒ¹ (Best Ask)**: è³£ç›¤ä¸­åƒ¹æ ¼æœ€ä½çš„æ›å–®åƒ¹æ ¼ã€‚
- **åƒ¹å·® (Spread)**: æœ€ä½³è³£åƒ¹èˆ‡æœ€ä½³è²·åƒ¹ä¹‹é–“çš„å·®é¡ (Best Ask - Best Bid)ã€‚
- **æµå‹•æ€§ (Liquidity)**: è¨‚å–®ç°¿ä¸­å„å€‹åƒ¹æ ¼å±¤ç´šä¸Šçš„æ›å–®æ•¸é‡ï¼Œåæ˜ äº†å¸‚å ´çš„æ·±åº¦å’Œäº¤æ˜“çš„ä¾¿åˆ©æ€§ã€‚

#### è¨‚å–®ç°¿æ“ä½œ

- **æ›å–® (Place Order)**: æ–°çš„é™åƒ¹å–®é€²å…¥è¨‚å–®ç°¿ï¼Œå¢åŠ å°æ‡‰åƒ¹æ ¼å±¤ç´šçš„æ•¸é‡ã€‚
- **æ’¤å–® (Cancel Order)**: è¨‚å–®å¾è¨‚å–®ç°¿ä¸­ç§»é™¤ï¼Œæ¸›å°‘å°æ‡‰åƒ¹æ ¼å±¤ç´šçš„æ•¸é‡ã€‚
- **æ’®åˆ (Match Order)**: ç•¶è²·è³£é›™æ–¹åƒ¹æ ¼æ»¿è¶³æ’®åˆæ¢ä»¶æ™‚ï¼Œè¨‚å–®å¾è¨‚å–®ç°¿ä¸­ç§»é™¤ä¸¦ç”Ÿæˆæˆäº¤ã€‚

è¨‚å–®ç°¿çš„å¯¦æ™‚æ›´æ–°æ˜¯æ’®åˆå¼•æ“å’Œè¡Œæƒ…æœå‹™çš„åŸºç¤ï¼Œç¢ºä¿äº†äº¤æ˜“çš„å…¬å¹³æ€§å’Œå¸‚å ´ä¿¡æ¯çš„é€æ˜æ€§ã€‚

### æ’®åˆ

â€¢ è¨‚å–®ç°¿èˆ‡è³‡æ–™å–å¾—

- æ¯å€‹äº¤æ˜“å°ç¶­è­·å„è‡ªçš„è¨‚å–®ç°¿ï¼Œå…§å«è²·ç›¤ï¼ˆé«˜â†’ä½ï¼‰èˆ‡è³£ç›¤ï¼ˆä½â†’é«˜ï¼‰çš„åƒ¹æ ¼å±¤ç´šï¼Œå±¤ç´šä¸­è¨˜éŒ„ç¸½é‡èˆ‡åŒåƒ¹ä½çš„è¨‚å–®ä½‡åˆ—ï¼›æ’®åˆå‰å…ˆä¾
  instrumentId æŠ“å‡ºé€™å€‹çµæ§‹ï¼Œæ‰èƒ½æ­£ç¢ºè¾¨è­˜æœ€ä½³è²·åƒ¹/è³£åƒ¹èˆ‡æµå‹•æ€§ä¾†æº
- æ’®åˆå¼•æ“ä»¥åƒ¹æ ¼å„ªå…ˆã€æ™‚é–“å„ªå…ˆè™•ç†ï¼šåŒä¸€åƒ¹æ ¼å±¤ç´šå…§ï¼Œæœ€æ—©é€²å…¥çš„è¨‚å–®æœƒå…ˆè¢«æŠ“å‡ºèˆ‡æ–°ä¾†çš„å°æ‰‹æ–¹æ’®åˆï¼Œç¢ºä¿å…¬å¹³

åˆ¤æ–·æ’®åˆæˆ–æ›å–®

- æ‰€æœ‰è¨‚å–®é€é OrderCreated äº‹ä»¶é€²å…¥æ’®åˆå±¤ï¼›æ”¶åˆ°å¾Œç«‹å³å®šä½è¨‚å–®ç°¿ä¸¦ä¾æ–¹å‘ï¼ˆBUY æ›åœ¨è²·ç›¤ã€SELL æ›åœ¨è³£ç›¤ï¼‰æ”¾å…¥æš«å­˜çµæ§‹
  design/exchange/æ•´é«”è¨­è¨ˆ.md:1252.
- å¸‚åƒ¹å–®ä¸æª¢æŸ¥åƒ¹æ ¼é–€æª»ï¼Œç›´æ¥å•Ÿå‹•æ’®åˆè¿´åœˆï¼›é™åƒ¹å–®å…ˆæ¯”è¼ƒ buy.price â‰¥ bestSell æˆ– sell.price â‰¤ bestBuyï¼Œæ»¿è¶³æ‰é€²å…¥æ’®åˆï¼Œ
  å¦å‰‡åœ¨å°æ‡‰åƒ¹æ ¼å±¤ç´šæ›å–®ç­‰å¾…
- è‹¥æ›å–®ï¼ŒæœƒåŒæ­¥æ ¹æ“šæœ€æ–° bids/asks è¨ˆç®—æœ€ä½³åƒ¹ä¸¦ç™¼å¸ƒ `OrderBookUpdated` äº‹ä»¶ï¼Œä¾›è¡Œæƒ…ç³»çµ±å³æ™‚åˆ·æ–°è¨‚å–®ç°¿è¦–åœ–

| æ¢ä»¶                         | è¡Œç‚º   |
|----------------------------|------|
| buy.price â‰¥ bestSell.price | æˆäº¤   |
| sell.price â‰¤ bestBuy.price | æˆäº¤   |
| å…¶ä»–                         | æ›å–®ç­‰å¾… |

æ’®åˆè¿´åœˆèˆ‡æˆäº¤ç”¢å‡º

- æ’®åˆæ™‚ç¸½æ˜¯å¾è¨‚å–®ç°¿æ‹¿ã€Œæœ€ä½³ã€å°æ‰‹å–®ï¼šBUY å–®å°ä¸Šç›®å‰æœ€ä¾¿å®œçš„ ASKï¼›SELL å–®å°ä¸Šæœ€è²´çš„ BIDã€‚æ¯è¼ªè¨ˆç®— tradeQty = min(æ–°å–®
  å‰©é¤˜, å°æ‰‹å–®å‰©é¤˜)ï¼Œæˆäº¤åƒ¹å–å°æ‰‹å–®åƒ¹æ ¼ï¼ˆmaker åƒ¹ï¼‰ï¼Œå†ç”Ÿæˆ TradeExecuted äº‹ä»¶èˆ‡å¿…éœ€çš„ WAL/DB è¨˜éŒ„ design/exchange/æ•´
  é«”è¨­è¨ˆ.md:1238ã€design/exchange/æ•´é«”è¨­è¨ˆ.md:3037.
- å°æ‰‹å–®è¢«å®Œå…¨åƒå®Œå³å¾è¨‚å–®ç°¿ç§»é™¤ä¸¦å†æ¬¡ç™¼å¸ƒ `OrderBookUpdated`ï¼ˆè¡¨ç¤ºæ›å–®è¢«æ’®åˆå®Œä¸¦åˆ·æ–°æ·±åº¦ï¼‰ï¼›æ–°å–®è‹¥é‚„æœ‰å‰©é¤˜ï¼Œç¹¼çºŒæ‹‰ä¸‹ä¸€
  å€‹åƒ¹æ ¼å±¤ç´šé‡è¤‡è¿´åœˆï¼Œç›´åˆ°æ–°å–®å®Œå…¨æˆäº¤æˆ–æ²’æœ‰å¯æˆäº¤çš„å°æ‰‹å–® design/exchange/æ•´é«”è¨­è¨ˆ.md:3044.
- å‰©é¤˜æœªæˆäº¤éƒ¨ä½æœƒä»¥æœ€æ–°å‰©é¤˜é‡æ›å›è¨‚å–®ç°¿ï¼Œä¸¦ä¾åŠ å…¥æ™‚é–“æ’åœ¨è©²åƒ¹ä½çš„å°¾ç«¯ï¼Œå¾…æœªä¾†å°æ‰‹å–®è£œä¸Šå¾Œå†è¢«å„ªå…ˆæ’®åˆã€‚

æ’®åˆæ¼”ç®—æ³•

```
while (å°æ‰‹å–®å­˜åœ¨ && å°šæœªå®Œå…¨æˆäº¤):
    tradeQty = min(å§”è¨—å‰©- å‰©é¤˜é‡, å°æ‰‹å–®å‰©é¤˜é‡)
    tradePrice = å°æ‰‹å–®åƒ¹æ ¼
    ç”Ÿæˆ TradeExecuted äº‹ä»¶
    æ›´æ–°é›™æ–¹å‰©é¤˜é‡èˆ‡ç‹€æ…‹
    è‹¥å°æ‰‹å–®å®Œæˆå‰‡ç§»å‡ºè¨‚å–®ç°¿
```

äº‹ä»¶èˆ‡ç‹€æ…‹æ›´æ–°

- æ¯æ¬¡è¨‚å–®ç°¿è®Šæ›´éƒ½è¦ç™¼å¸ƒ `OrderBookUpdated`ï¼ˆåŒ…å«é›™é‚Šæ·±åº¦åŠ bestBid/bestAsk/midPriceï¼‰ï¼Œæˆäº¤ä»é€é `TradeExecuted` å‘ŠçŸ¥ä¸‹
  æ¸¸æ¨¡çµ„ï¼›è¡Œæƒ…ã€å¸³å‹™ã€å€‰ä½ã€é¢¨æ§ç­‰æ¨¡çµ„ä¾é€™å…©ç¨®äº‹ä»¶ä¿æŒä¸€è‡´æ€§ design/exchange/æ•´é«”è¨­è¨ˆ.md:1259.
- TradeExecuted ç”± ledger/positions/risk/market-data ä¸¦è¡Œæ¶ˆè²»ï¼Œå®Œæˆè³‡é‡‘æ‰£è§£å‡ã€å€‰ä½èª¿æ•´èˆ‡è¡Œæƒ…æ¨æ’­ï¼›
  è¨‚å–®ç‹€æ…‹ä¹Ÿæœƒå¾ CREATED â†’ PARTIALLY_FILLED â†’ FILLED æˆ– CANCELLED çš„æµç¨‹æ¼”é€²

### WAL

æ’®åˆå¼•æ“æ˜¯æ•´å€‹äº¤æ˜“éˆè·¯çš„æœ€çµ‚äº‹å¯¦ä¾†æºï¼Œå› æ­¤å¿…é ˆåœ¨ã€Œä¿®æ”¹è¨‚å–®ç°¿ä¹‹å‰ã€å…ˆæŠŠå³å°‡åŸ·è¡Œçš„æ“ä½œå¯«å…¥ Write-Ahead Logï¼Œç¢ºä¿å¯é‡æ”¾ã€å¯è¿½
æº¯ã€‚å»ºè­°çš„ WAL æ¬„ä½èˆ‡æµç¨‹å¦‚ä¸‹ï¼š

---

- **åºåˆ—èˆ‡äº‹ä»¶æ™‚é–“**ï¼šWAL `seq` (éå¢åºè™Ÿ) + `logged_at`ï¼Œä¿è­‰è·¨ç¯€é»åˆä½µæ™‚ä»èƒ½ä»¥æ™‚é–“/é †åºé‡å»ºè¨‚å–®ç°¿ã€‚

| WAL seq    | æ’®åˆå¼•æ“å…§       | é‡å»ºè¨‚å–®ç°¿ / æ’®åˆæ­¥é©Ÿé †åº |
|------------|-------------|----------------|
| trade seq  | æ’®åˆå¼•æ“ / æˆäº¤äº‹ä»¶ | æˆäº¤äº‹ä»¶é †åº         |
| outbox seq | Outbox      | äº‹ä»¶ç™¼å¸ƒé †åº         |

WAL seq æ‡‰ç”± **æ’®åˆå¼•æ“æœ¬èº«ç”¢ç”Ÿ**

- å–®èª¿éå¢
- ä¸å¯ç”± DB auto-inc åˆ†æ•£ç”Ÿæˆ
- ä¸å¯ç”±å¤šæœå‹™å…±åŒç”¢ç”Ÿ
- å¯ä»¥æ˜¯ Snowflakeï¼Œä½†è¦ç¢ºä¿æ™‚é–“é †åº OK
- æ›´å¸¸è¦‹ï¼š**å…¨å±€éå¢ long**ï¼ˆmatch engine å…§éƒ¨è¨ˆæ•¸å™¨ï¼‰

---

- **å‹•ä½œé¡å‹**ï¼š`type` å–å€¼ `PLACE`ã€`MATCH`ã€`CANCEL`ã€`REDUCE`ï¼Œæ¸…æ¥šæè¿°è©²ç­†æ“ä½œå°è¨‚å–®ç°¿çš„å½±éŸ¿ã€‚

PLACE
â†’ å°è¨‚å–®ç°¿ï¼šå¢åŠ æ›å–®

MATCH
æ’®åˆç™¼ç”Ÿ  
â€¢ æ’åˆ°å°æ‰‹å–®  
â€¢ ç”¢ç”Ÿæˆäº¤ï¼ˆtradeï¼‰  
â€¢ æ›´æ–°æˆäº¤é‡èˆ‡å‰©é¤˜é‡
â†’ å°è¨‚å–®ç°¿ï¼šç”¢ç”Ÿæˆäº¤ + æ›´æ–°å‰©é¤˜æ›å–®

CANCEL
ä½¿ç”¨è€…æˆ–ç³»çµ±å–æ¶ˆè¨‚å–®  
â€¢ å°‡è¨‚å–®å¾ç°¿ä¸­ç§»é™¤  
â€¢ æ›´æ–°ç‹€æ…‹ç‚º CANCELED
â†’ å°è¨‚å–®ç°¿ï¼šåˆªé™¤æ›å–®

REDUCE
éƒ¨åˆ†æ¸›å°‘æ›å–®æ•¸é‡  
â€¢ ä¾‹å¦‚ä¸‹æ¸¸å› å¯ç”¨é‡‘é¡ä¸è¶³è€Œéœ€èª¿æ•´å¯ä¸‹å–®é‡  
â€¢ æˆ– API ä¸»å‹• `reduceOnly`  
â€¢ æˆ–ç³»çµ±è‡ªå‹•æ¸›é‡
â†’ å°è¨‚å–®ç°¿ï¼šæ›´æ–°æ›å–®å‰©é¤˜é‡ï¼ˆéæˆäº¤ï¼‰
> è¨»ï¼š`REDUCE` ä¸ç­‰åŒ `MATCH`  
> Match = æˆäº¤é€ æˆçš„æ•¸é‡æ¸›å°‘  
> Reduce = å¤–åœ¨åŸå› é€ æˆçš„æ•¸é‡æ¸›å°‘

---

- **è¨‚å–®/äº¤æ˜“å…§å®¹**ï¼šè¨˜éŒ„ `orderId`ã€`side`ã€`price`ã€`remainingQuantity`ï¼Œ
  è‹¥ç‚ºæ’®åˆå‰‡é™„ä¸Š `counterOrderId`ã€`tradeQty`èˆ‡ `tradePrice`ï¼ŒåŒæ™‚å­˜ä¸‹ maker/taker userId æ–¹ä¾¿å¸³å‹™è¿½æº¯ã€‚

---

- **æŒä¹…åŒ–èˆ‡åˆ·ç›¤**ï¼šå¯«å…¥ WAL å¾Œæ‰å°è¨˜æ†¶é«”è¨‚å–®ç°¿å¥—ç”¨è®Šæ›´

---

- åœ¨æˆåŠŸç™¼å¸ƒ `TradeExecuted` äº‹ä»¶å¾Œæ¨™è¨˜è©² WAL æ¢ç›®å·²å®Œæˆï¼ˆä¾› å£“ç¸®/æˆªæ–·ï¼‰ã€‚

---

- checkpoint + å¢é‡ WAL
    - **Checkpoint**ï¼šè¨˜éŒ„ã€ŒæŸæ™‚åˆ»æ•´å€‹è¨‚å–®ç°¿çš„å®Œæ•´å¿«ç…§ã€
    - **å¢é‡ WAL**ï¼šcheckpoint ä¹‹å¾Œç”¢ç”Ÿçš„ WAL

---

- **é‡æ’­ç­–ç•¥**ï¼šæ’®åˆæœå‹™å•Ÿå‹•æ™‚å…ˆè®€ WAL â†’ é‡å»ºå„äº¤æ˜“å°è¨‚å–®ç°¿ï¼›
- è‹¥é‡åˆ°ã€Œå·²å¯« WAL ä½†äº‹ä»¶å°šæœªç™¼å¸ƒã€çš„æ¢ç›®ï¼Œéœ€é‡æ–°åŸ·è¡Œä¸¦è£œç™¼äº‹ä»¶ï¼Œç¢ºä¿ä¸‹æ¸¸æœ€çµ‚ä¸€è‡´ã€‚

- **append-only WAL â†’ å•Ÿå‹•æ™‚ replay â†’ é‚„åŸç°¿**ã€‚
- replayï¼šå¾ WAL æœ€å‰é¢æˆ– checkpointï¼Œä¾ seq éå¢é‡æ”¾ PLACE / MATCH / CANCEL / REDUCEï¼Œé‡å»º bids / asks çµæ§‹
- å£“ç¸®ï¼šä»¥ â€œcheckpoint + å¢é‡ WALâ€ æ¨¡å¼

ä¾æ­¤è¨­è¨ˆï¼Œå³ä½¿æ’®åˆé€²ç¨‹ç•°å¸¸é€€å‡ºæˆ–ç™¼ç”Ÿä¸»å‚™åˆ‡æ›ï¼Œæ–°çš„å¯¦ä¾‹ä¹Ÿèƒ½ä»¥ WAL ç‚ºåŸºæº–å®Œæˆæ¢å¾©ï¼Œé¿å…éºå¤±æˆäº¤æˆ–ç”¢ç”Ÿé›™é‡æ’®åˆã€‚

## Event Inputï¼š`OrderCreated`

- æ¶ˆè²» `OrderCreated` äº‹ä»¶ã€‚
- æ ¹æ“š `instrument_id` å–å¾—å°æ‡‰è¨‚å–®ç°¿ã€‚
- æŒ‰æ–¹å‘æ›å…¥ï¼š`BUY` æ›è²·ç›¤ï¼ˆé«˜åƒ¹å„ªå…ˆï¼‰ï¼Œ`SELL` æ›è³£ç›¤ï¼ˆä½åƒ¹å„ªå…ˆï¼‰ã€‚
- å¸‚åƒ¹å–®å‰‡ç«‹å³æ’®åˆã€‚

### æ ¸å¿ƒäº‹ä»¶è¼¸å‡º

ç‚ºç¢ºä¿ä¸‹æ¸¸æ•¸æ“šçš„å®Œæ•´æ€§ï¼ˆç‰¹åˆ¥æ˜¯ `Market-Data` çš„æ·±åº¦åœ–ï¼‰ï¼Œ`Matching` å¼•æ“å¿…é ˆåœ¨**ä»»ä½•æ”¹è®Šè¨‚å–®ç°¿ç‹€æ…‹çš„æ“ä½œ**å¾Œç™¼å¸ƒå°æ‡‰äº‹ä»¶ã€‚

| äº‹ä»¶                     | è§¸ç™¼æ™‚æ©Ÿ          | æ ¸å¿ƒå…§å®¹                                                                                                                                                                                                                       | ä¸»è¦æ¶ˆè²»è€…                                        |
|:-----------------------|:--------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------|
| **`OrderBookUpdated`** | è¨‚å–®ç°¿å‡ºç¾æ–°å¢/åˆªé™¤/èª¿æ•´ | `instrumentId`, `bids[]`, `asks[]`, `bestBid`, `bestAsk`, `midPrice`, `updatedAt`                                                                                                                                          | `Market-Data`                                |
| **`TradeExecuted`**    | å…©ç­†è¨‚å–®æ’®åˆæˆäº¤      | `instrumentId`, `quoteAsset`, `tradeId`, `orderId`(maker), `counterpartyOrderId`(taker), `orderSide`(maker), `counterpartyOrderSide`(taker), `price`, `quantity`, `makerUserId`, `takerUserId`, `makerFee`, `takerFee`, `executedAt` | `Market-Data`, `Account-Ledger`, `Positions` |

### æ’®åˆå¾Œäº‹ä»¶æµ

`TradeExecuted` è¢«å¤šæ¨¡çµ„å¹³è¡Œæ¶ˆè²»ï¼š

| æ¨¡çµ„             | è™•ç†                                                                       |
|----------------|--------------------------------------------------------------------------|
| account-ledger | é›™åˆ†éŒ„è¨˜å¸³ã€æ‰£é™¤å‡çµã€è¨ˆç®—æ‰‹çºŒè²»ã€ç™¼å¸ƒ `LedgerEntryCreated`                                 |
| positions      | æ›´æ–°å€‰ä½èˆ‡å¹³å‡æˆæœ¬ã€ç›ˆè™§                                                             |
| risk-margin    | æ›´æ–°ç¶­æŒä¿è­‰é‡‘èˆ‡å¼·å¹³åƒ¹                                                              |
| market-data    | **æ ¹æ“š `TradeExecuted` æ›´æ–° Ticker/K ç·šï¼›<br>æ ¹æ“š `OrderBookUpdated` æ›´æ–°æ·±åº¦åœ–èˆ‡æœ€ä½³åƒ¹** |

### æ’®åˆå¾Œè³‡é‡‘èˆ‡ç‹€æ…‹æ¼”é€²

é–‹å€‰

| éšæ®µ    | Order ç‹€æ…‹         | Ledger å‹•ä½œ | Positions |
|-------|------------------|-----------|-----------|
| ä¸‹å–®    | CREATED          | å‡çµä¿è­‰é‡‘     | ç„¡         |
| æ’®åˆä¸­   | PARTIALLY_FILLED | éƒ¨åˆ†æ‰£æ¬¾èˆ‡è§£å‡   | å€‰ä½å¢åŠ       |
| æ’®åˆå®Œæˆ  | FILLED           | å…¨éƒ¨çµç®—èˆ‡è§£å‡   | å€‰ä½å®Œæˆæ›´æ–°    |
| æ’¤å–®æˆ–å¤±æ•— | CANCELLED        | è§£å‡ä¿è­‰é‡‘     | ä¸è®Š        |

## ~~`POST /api/matching/cancel`~~

- `order-service` ç™¼é€ `OrderCancelRequested`ã€‚
- `matching` æ¥æ”¶å¾Œå¾è¨‚å–®ç°¿ç§»é™¤ï¼Œç™¼å¸ƒ `OrderCancelled`ã€‚
- `account-ledger` æ¶ˆè²»å¾Œè§£å‡è³‡é‡‘ï¼Œç™¼å¸ƒ `FundsUnfrozen`ã€‚

## æ’®åˆå¼•æ“çµæ§‹å»ºè­°

```
MatchingEngine
 â”œâ”€ OrderBookManager
 â”‚   â”œâ”€ Map<InstrumentId, OrderBook>
 â”‚   â””â”€ SnapshotServiceï¼ˆå®šæœŸæŒä¹…åŒ–å¿«ç…§ï¼‰
 â”œâ”€ EventListener
 â”‚   â””â”€ consume(OrderCreated)
 â”œâ”€ TradePublisher
 â”‚   â””â”€ publish(TradeExecuted)
 â””â”€ Persistence
     â””â”€ trade_tickers è¡¨ (æˆäº¤ç´€éŒ„)
```

## è³‡æ–™ä¸€è‡´æ€§èˆ‡é‡æ”¾

- æ’®åˆçµæœæ˜¯å”¯ä¸€çœŸå¯¦æˆäº¤ä¾†æºã€‚
- `TradeExecuted` æ‡‰ä½¿ç”¨ Kafka exactly-once æ¨¡å¼ç™¼å¸ƒã€‚
- æ’®åˆå¼•æ“æ‡‰ä¿å­˜ WALï¼ˆwrite-ahead logï¼‰ï¼Œä»¥ä¾¿é‡å•Ÿé‡æ”¾ã€‚

# Market-Data æœå‹™

## è·è²¬

- `market-data` æ¨¡çµ„æ˜¯æ•´å€‹äº¤æ˜“æ‰€çš„**è¡Œæƒ…å¼•æ“èˆ‡è³‡æ–™åˆ†ç™¼å±¤**ï¼Œè² è²¬å¾æ’®åˆçµæœ (`TradeExecuted`) ç”Ÿæˆä¸¦å»£æ’­å¯è§€å¯Ÿè¡Œæƒ…ï¼šæœ€æ–°åƒ¹ã€æˆäº¤é‡ã€K
  ç·šã€æ·±åº¦ã€Funding Rate ç­‰ã€‚ å®ƒä¸åƒèˆ‡è³‡é‡‘çµç®—ï¼Œä¹Ÿä¸ç›´æ¥æŒå€‰ï¼Œåªèšç„¦ã€Œå¸‚å ´è³‡è¨Šçš„ç”Ÿæˆã€å„²å­˜èˆ‡æ¨é€ã€ã€‚
- è½‰æ›æ’®åˆè¼¸å‡ºç‚ºè¡Œæƒ…å¿«ç…§ã€K ç·šã€æ·±åº¦è³‡æ–™å’Œçµ±è¨ˆæŒ‡æ¨™ã€‚
- æä¾› REST API èˆ‡å¿«å–æœå‹™çµ¦å‰ç«¯èˆ‡å¤¥ä¼´ï¼ˆä½¿ç”¨è€…é€éæ‰‹å‹•åˆ·æ–°å–å¾—æœ€æ–°è³‡æ–™ï¼‰ã€‚

| åŠŸèƒ½é¡åˆ¥      | èªªæ˜                                                  |
|-----------|-----------------------------------------------------|
| **è¡Œæƒ…ç”Ÿæˆ**  | å¾ `TradeExecuted` äº‹ä»¶æ›´æ–°æœ€æ–°åƒ¹ã€24h æ¼²è·Œã€æˆäº¤é‡ç­‰ Ticker è³‡è¨Š     |
| **æ·±åº¦åœ–æ§‹å»º** | **æ¶ˆè²» `OrderBookUpdated` äº‹ä»¶ï¼Œå¯¦æ™‚ã€å®Œæ•´åœ°åœ¨å…§å­˜ä¸­é‡å»ºè¨‚å–®ç°¿æ·±åº¦åœ–èˆ‡æœ€ä½³åƒ¹** |
| **è¡Œæƒ…å¿«ç…§**  | REST ç›´æ¥å¾ in-memory ç·©å­˜è®€å–æœ€æ–°è¡Œæƒ…è³‡æ–™                       |
| **è³‡æ–™åˆ†ç™¼**  | é€é REST API æä¾›æœ€æ–°è¡Œæƒ…ã€æ·±åº¦ã€K ç·šä¾›å‰ç«¯æ‰‹å‹•åˆ·æ–°                    |
| **è¡ç”Ÿè³‡æ–™**  | é‡å°ä¸åŒæ´¾ç”Ÿè³‡æ–™è¨‚å®šè§¸ç™¼äº‹ä»¶èˆ‡ç”Ÿæˆæµç¨‹ï¼ˆè©³è¦‹ä¸‹ç¯€ï¼‰                           |
| **å¤–éƒ¨è¨‚é–±**  | ç‚ºå‰ç«¯ã€é¢¨æ§ã€å ±è¡¨æ¨¡çµ„æä¾›è¡Œæƒ…è¨‚é–±ä»‹é¢                                 |

## endpoint

| å®Œæˆ | HTTP Method | Endpoint                                | èªªæ˜          | èª¿ç”¨è€…                     | æˆæ¬Š     | è¼¸å…¥                    | è¼¸å‡º                                                                                                                      | DBæ“ä½œ | ç·©å­˜æ“ä½œ         | æœå‹™èª¿ç”¨ | è£œå„Ÿæ©Ÿåˆ¶ |
|----|-------------|-----------------------------------------|-------------|-------------------------|--------|-----------------------|-------------------------------------------------------------------------------------------------------------------------|------|--------------|------|------|
| âœ”ï¸ | GET         | `/api/market/tickers/{instrumentId}`    | æœ€æ–°è¡Œæƒ…è³‡è¨Š      | gateway                 | public | instrumentId          | TickerResponse(lastPrice, volume24h, turnover24h, high24h, low24h, open24h, priceChange24h, priceChangePct, capturedAt) | -    | è®€å–å…§å­˜è¡Œæƒ…å¿«ç…§     | -    | -    |
| âœ”ï¸ | GET         | `/api/market/orderbook/{instrumentId}`  | ç•¶å‰è¨‚å–®ç°¿æ·±åº¦èˆ‡æœ€ä½³åƒ¹ | gateway                 | public | instrumentId          | OrderBookResponse(bids[], asks[], bestBid, bestAsk, midPrice, updatedAt)                                                | -    | è®€å–å…§å­˜è¨‚å–®ç°¿      | -    | -    |
| âœ”ï¸ | GET         | `/api/market/kline`                     | Kç·šæŸ¥è©¢        | gateway                 | public | symbol, period, limit | KlineResponse[](period, bucketStart, bucketEnd, open, high, low, close, volume, turnover)                               | -    | è®€å–å…§å­˜ Kç·šcache | -    | -    |
| âœ”ï¸ | GET         | `/api/market/mark-price/{instrumentId}` | è®€å–æœ€æ–°æ¨™è¨˜åƒ¹     | risk-margin / positions | public | instrumentId          | MarkPriceSnapshot(markPrice, calculatedAt)                                                                              | -    | è®€å–è¡Œæƒ…å¿«å–       | -    | -    |

## events

**äº‹ä»¶æ¶ˆè²»**:

| å®Œæˆ | ä¾†æºæœå‹™     | Topic                      | äº‹ä»¶                 | è™•ç†é‚è¼¯                                            | äº‹ä»¶ç™¼å¸ƒ                               | DBæ“ä½œ | ç·©å­˜æ“ä½œ         | æœå‹™èª¿ç”¨ | è£œå„Ÿæ©Ÿåˆ¶ |
|----|----------|----------------------------|--------------------|-------------------------------------------------|------------------------------------|------|--------------|------|------|
| âœ”ï¸ | matching | matching.orderbook-updated | `OrderBookUpdated` | é‡å»ºæŒ‡å®š instrument çš„è²·è³£ç›¤æ·±åº¦ã€bestBid/bestAsk/midPrice | -                                  | -    | æ›´æ–°å…§å­˜æ·±åº¦å¿«ç…§     | -    | -    |
| âœ”ï¸ | matching | matching.trade-executed    | `TradeExecuted`    | æ›´æ–°Tickerã€ç”ŸæˆKç·šã€æ¨é€æˆäº¤                              | `MarkPriceUpdated` / `KlineClosed` | -    | æ›´æ–°è¡Œæƒ…/æˆäº¤/Kç·šå¿«å– | -    | -    |

**äº‹ä»¶ç™¼å¸ƒ**:

| å®Œæˆ | ç™¼å¸ƒå ´æ™¯           | Topic                   | äº‹ä»¶åç¨±                     | äº‹ä»¶å…§å®¹                                                                                     | æ¶ˆè²»è€…                    |
|----|----------------|-------------------------|--------------------------|------------------------------------------------------------------------------------------|------------------------|
| âœ”ï¸ | æ¨™è¨˜åƒ¹æ ¼é‡æ–°è¨ˆç®—å®Œæˆ     | market.mark-price       | `MarkPriceUpdated`       | instrumentId, indexPrice, markPrice, fairPrice, premiumIndex, fundingBasis, calculatedAt | positions, risk-margin |
|    | ~~å®šæœŸç”¢å‡ºæ–°çš„è³‡é‡‘è²»ç‡~~ | ~~market.funding-rate~~ | ~~`FundingRateUpdated`~~ | ~~instrumentId, rate, effectiveAt~~                                                      | ~~account-ledger~~     |
|    | ~~Kç·šé€±æœŸçµæŸ~~     | ~~market.kline~~        | ~~`KlineClosed`~~        | ~~instrumentId, period, open, high, low, close, volume, timestamp~~                      | ~~reporting, å‰ç«¯~~      |

---

## è³‡æ–™è¡¨DDL

### kline_buckets è¡¨ - Kç·š

```sql
CREATE TABLE kline_buckets
(
    bucket_id          BIGINT          NOT NULL COMMENT 'Kç·šè¨˜éŒ„ID (Snowflake)',
    instrument_id      BIGINT          NOT NULL COMMENT 'äº¤æ˜“å°ID',
    period VARCHAR (10) NOT NULL COMMENT 'é€±æœŸ: 1m/5m/1h/1d ...',
    bucket_start       DATETIME        NOT NULL COMMENT 'Kç·šæ™‚é–“çª—å£èµ·å§‹ (å«)',
    bucket_end         DATETIME        NOT NULL COMMENT 'Kç·šæ™‚é–“çª—å£çµæŸ (ä¸å«)',

    open_price         DECIMAL(20, 8)  NOT NULL COMMENT 'é–‹ç›¤åƒ¹',
    high_price         DECIMAL(20, 8)  NOT NULL COMMENT 'æœ€é«˜åƒ¹',
    low_price          DECIMAL(20, 8)  NOT NULL COMMENT 'æœ€ä½åƒ¹',
    close_price        DECIMAL(20, 8)  NOT NULL COMMENT 'æ”¶ç›¤åƒ¹',
    volume             DECIMAL(30, 12) NOT NULL DEFAULT 0 COMMENT 'æˆäº¤é‡ (ä»¥ base asset è¨ˆ)',
    turnover           DECIMAL(30, 12) NOT NULL DEFAULT 0 COMMENT 'æˆäº¤é¡ (ä»¥ quote asset è¨ˆ)',
    trade_count        INT             NOT NULL DEFAULT 0 COMMENT 'æˆäº¤ç­†æ•¸',
    taker_buy_volume   DECIMAL(30, 12) NULL COMMENT 'åƒå–®æ–¹æˆäº¤é‡ (å¤šé ­)',
    taker_buy_turnover DECIMAL(30, 12) NULL COMMENT 'åƒå–®æ–¹æˆäº¤é¡ (å¤šé ­)',

    is_closed          BOOLEAN         NOT NULL DEFAULT TRUE COMMENT 'æ˜¯å¦å®Œæ•´æ”¶æ–‚ (é¿å…å»¶é²æˆäº¤è£œå¯«)',
    created_at         DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‰µå»ºæ™‚é–“',
    updated_at         DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    PRIMARY KEY (bucket_id),
    UNIQUE KEY uk_instrument_period_start (instrument_id, period, bucket_start) COMMENT 'å–®å•†å“+é€±æœŸ+èµ·å§‹æ™‚é–“å”¯ä¸€'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Kç·šèšåˆè³‡æ–™è¡¨ - ä¾› REST æŸ¥è©¢çš„æ­·å² OHLC';

CREATE INDEX idx_instrument_period ON kline_buckets (instrument_id, period, bucket_start DESC) COMMENT 'æŸ¥è©¢äº¤æ˜“å°æŒ‡å®šé€±æœŸæ­·å²Kç·š';
CREATE INDEX idx_period_time ON kline_buckets (period, bucket_start DESC) COMMENT 'æŒ‰é€±æœŸå€’åºéæ­·';
```

### mark_price_snapshots è¡¨ - index_price / mark_price

```sql
CREATE TABLE mark_price_snapshots
(
    snapshot_id       BIGINT         NOT NULL COMMENT 'å¿«ç…§ID (Snowflake)',
    instrument_id     BIGINT         NOT NULL COMMENT 'äº¤æ˜“å°ID',
    mark_price        DECIMAL(20, 8) NOT NULL COMMENT 'æ¨™è¨˜åƒ¹ = æœ€æ–°æˆäº¤åƒ¹',
    trade_id          BIGINT         NOT NULL COMMENT 'ä¾†æºäº¤æ˜“ ID',
    trade_executed_at DATETIME       NOT NULL COMMENT 'æˆäº¤æ™‚é–“',
    calculated_at     DATETIME       NOT NULL COMMENT 'å¯«å…¥/è¨ˆç®—æ™‚é–“',
    created_at        DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å»ºç«‹æ™‚é–“',
    updated_at        DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    PRIMARY KEY (snapshot_id),
    UNIQUE KEY uk_instrument_calculated (instrument_id, calculated_at)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='æ¨™è¨˜åƒ¹å¿«ç…§è¡¨ (ä»¥æœ€æ–°æˆäº¤åƒ¹ç‚ºåŸºæº–)';

CREATE INDEX idx_mark_price_snapshot ON mark_price_snapshots (instrument_id, calculated_at DESC);
```

### ~~funding_rates è¡¨ - è³‡é‡‘è²»ç‡~~

```sql
CREATE TABLE funding_rates
(
    id               BIGINT         NOT NULL COMMENT 'è¨˜éŒ„ID (Snowflake)',
    instrument_id    BIGINT         NOT NULL COMMENT 'äº¤æ˜“å°ID',

    rate             DECIMAL(12, 8) NOT NULL COMMENT 'è³‡é‡‘è²»ç‡ (æ­£æ•¸å¤šé ­ä»˜ç©ºé ­)',
    premium_index    DECIMAL(12, 8) NOT NULL DEFAULT 0 COMMENT 'è©²æœŸå¹³å‡æº¢åƒ¹æŒ‡æ•¸',
    interest_rate    DECIMAL(12, 8) NOT NULL DEFAULT 0 COMMENT 'è¨ˆåƒ¹è³‡ç”¢åˆ©ç‡ (æŠ˜ç®—æœ¬æœŸ)',
    borrow_rate      DECIMAL(12, 8) NOT NULL DEFAULT 0 COMMENT 'åŸºç¤è³‡ç”¢å€Ÿè²¸ç‡ (æŠ˜ç®—æœ¬æœŸ)',
    mark_price       DECIMAL(20, 8) NOT NULL COMMENT 'çµç®—æ™‚æ¨™è¨˜åƒ¹',
    index_price      DECIMAL(20, 8) NOT NULL COMMENT 'çµç®—æ™‚æŒ‡æ•¸åƒ¹',
    funding_interval INT            NOT NULL DEFAULT 8 COMMENT 'è³‡é‡‘è²»é–“éš” (å°æ™‚)',

    effective_at     DATETIME       NOT NULL COMMENT 'è³‡é‡‘è²»ç”Ÿæ•ˆæ™‚é–“',
    calculated_at    DATETIME       NOT NULL COMMENT 'è¨ˆç®—å®Œæˆæ™‚é–“',
    settled          BOOLEAN        NOT NULL DEFAULT FALSE COMMENT 'æ˜¯å¦å·²ç”±çµç®—æœå‹™å…¥è³¬',
    settled_at       DATETIME       NULL COMMENT 'å¯¦éš›çµç®—æ™‚é–“',
    source_status    VARCHAR(32)    NOT NULL DEFAULT 'NORMAL' COMMENT 'è¼¸å…¥ç‹€æ…‹: NORMAL/DEGRADED/STALE',

    created_at       DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‰µå»ºæ™‚é–“',
    updated_at       DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    PRIMARY KEY (id),
    UNIQUE KEY uk_instrument_effective (instrument_id, effective_at)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='è³‡é‡‘è²»ç‡ç´€éŒ„ï¼Œä¾›çµç®—èˆ‡å ±è¡¨ä½¿ç”¨';

CREATE INDEX idx_funding_calc ON funding_rates (instrument_id, calculated_at DESC) COMMENT 'æŸ¥è©¢æœ€æ–°è³‡é‡‘è²»ç‡';
CREATE INDEX idx_funding_settled ON funding_rates (settled, effective_at DESC) COMMENT 'æŸ¥è©¢å¾…çµç®—/å·²çµç®—ç´€éŒ„';
```

## 

## ä¸»æµç¨‹

`market-data` æ¨¡çµ„æµç¨‹ç°¡è¿°

```
TradeExecuted
  â†“
æ›´æ–°å³æ™‚è¡Œæƒ…èˆ‡æ·±åº¦
  â†“
èšåˆç”Ÿæˆ K ç·š / æŒ‡æ•¸åƒ¹ 
  â†“
æ›´æ–°è¡Œæƒ…å¿«å–
  â†“
é€é REST æä¾›å¿«ç…§ä¸¦ç™¼å¸ƒ MarkPriceUpdated
  â†“
positions / risk-margin æ¶ˆè²»æ›´æ–°
```

å®ƒæ˜¯æ•´å€‹äº¤æ˜“ç³»çµ±çš„ã€Œè¡Œæƒ…å¿ƒè‡Ÿã€ï¼Œ  
è² è²¬æŠŠæ’®åˆçµæœè½‰åŒ–ç‚ºå¸‚å ´è³‡è¨Šï¼Œé©…å‹•ç”¨æˆ¶ç«¯ç•«é¢ã€é¢¨æ§èˆ‡å€‰ä½ä¼°å€¼ã€‚

## Event Inputï¼š`OrderBookUpdated`

### æ¶ˆè²»äº‹ä»¶

- **æ¶ˆè²» `OrderBookUpdated`**:
    - é€™æ˜¯æ§‹å»º**å¯¦æ™‚å¸‚å ´æ·±åº¦ (Order Book)** çš„å”¯ä¸€æº–ç¢ºæ•¸æ“šæºã€‚
    - `Market-Data` åœ¨å…§å­˜ä¸­ç¶­è­·æ¯å€‹äº¤æ˜“å°çš„è¨‚å–®ç°¿ï¼Œæ”¶åˆ° `OrderBookUpdated` æ™‚ç›´æ¥è¦†å¯«ç›¸é—œ instrument çš„ bids/asks ä»¥åŠ
      bestBid/bestAsk/midPriceï¼Œé¿å…é å·®åˆ†æ¨å°é€ æˆæ¼‚ç§»ã€‚

--- 

### æ·±åº¦è³‡æ–™è™•ç†ä¸»æµç¨‹

```
OrderBookUpdated
  â†“
Market-Data Consumer
  â†“
æ›´æ–°å…§å­˜ä¸­çš„è¨‚å–®ç°¿ (æ·±åº¦åœ–)
  â†“
è¦–éœ€æ±‚æ›´æ–°è¡Œæƒ…å¿«å–
```

---

### æ›´æ–°å…§å­˜ä¸­è¨‚å–®ç°¿ ã€æœ€ä½³è²·åƒ¹/è³£åƒ¹/ä¸­é–“åƒ¹

- ä¾†æºï¼šmatching é€é `OrderBookUpdated` æ¨é€çš„è¨‚å–®ç°¿å¿«ç…§ã€‚
- è³‡æ–™çµæ§‹ï¼š

    ```
    bids: [(price, qty)...]  # é«˜â†’ä½
    asks: [(price, qty)...]  # ä½â†’é«˜
    ```
- æ¯æ¬¡æ›´æ–°
    - æœ€ä½³è²·åƒ¹ / è³£åƒ¹ (`best_bid`, `best_ask`)
    - ä¸­é–“åƒ¹ (`mid_price = (bid + ask)/2`)

## Event Inputï¼š`Matching`

### æ¶ˆè²»äº‹ä»¶

- **æ¶ˆè²» `TradeExecuted`**:
    - ç”¨æ–¼æ›´æ–° Ticker è³‡è¨Šï¼šæœ€æ–°æˆäº¤åƒ¹ã€24h æˆäº¤é‡ã€æ¼²è·Œå¹…ç­‰ã€‚
    - ä½œç‚º K ç·šèšåˆçš„æ•¸æ“šæºï¼ˆä¸åŒé€±æœŸçš„ open/high/low/close è³‡æ–™çš†ç”±æˆäº¤äº‹ä»¶æ¨å°ï¼‰ã€‚

---

### æˆäº¤è³‡æ–™è™•ç†ä¸»æµç¨‹

```
TradeExecuted
  â†“
Market-Data Consumer
  â†“
æ›´æ–° Ticker èˆ‡æˆäº¤åºåˆ—ç·©å­˜
  â†“
ç”Ÿæˆè¡ç”Ÿè³‡æ–™ (K ç·šã€æŒ‡æ•¸åƒ¹ã€Funding Rateã€æ¨™è¨˜åƒ¹)
  â†“
æ›´æ–°å¿«ç…§è³‡æ–™åº«
```

---

### æ›´æ–°å…§å­˜ä¸­æœ€æ–°æˆäº¤åƒ¹ã€24H æˆäº¤é‡/æˆäº¤é¡/é«˜ä½åƒ¹

æ¥æ”¶åˆ°æˆäº¤å¾Œï¼š

```
last_price = trade.price
volume_24h += trade.quantity
turnover_24h += trade.price * trade.quantity
high_24h = max(high_24h, trade.price)
low_24h  = min(low_24h, trade.price)
price_change_24h = (last_price - open_24h) / open_24h
```

çµæœå­˜å…¥ `ticker_cache[instrument_id]`ï¼Œä¾› REST æŸ¥è©¢ä½¿ç”¨ï¼ˆä½¿ç”¨è€…æ‰‹å‹•åˆ·æ–°é é¢ï¼‰ã€‚

---

### è¡ç”Ÿè³‡æ–™ç”Ÿæˆ

| è¡ç”Ÿè³‡æ–™é¡å‹                | è§¸ç™¼ä¾†æº / æ™‚æ©Ÿ                                     | ç”¢å‡ºäº‹ä»¶èˆ‡ç›®çš„                                                                                  |
|-----------------------|-----------------------------------------------|------------------------------------------------------------------------------------------|
| **K ç·š (Candlestick)** | æ¯å€‹æ™‚é–“çª—ï¼ˆ1m/5m/1hâ€¦ï¼‰æœ‰æˆäº¤ (`TradeExecuted`) èšæ»¿æˆ–æ™‚é–“åˆ°æœŸ | `KlineClosed` â†’ å¯«å…¥ `market.kline` topicï¼Œä¾›å‰ç«¯ç¹ªåœ–ã€æ­·å²å›æ”¾ï¼Œä¸¦åŒæ­¥ flush è‡³ `kline_buckets` è³‡æ–™è¡¨       |
| **æŒ‡æ•¸åƒ¹ (Index Price)** | å¤–éƒ¨è¡Œæƒ…èšåˆå™¨è¼ªè©¢/æ¨é€æ–°å ±åƒ¹æˆ–åµæ¸¬åˆ°é¡¯è‘—åƒ¹å·®                       | `IndexPriceUpdated` â†’ å»£æ’­æ–¼ `market.index-price` topicï¼Œä½œç‚ºæ¨™è¨˜åƒ¹ã€æ¸…ç®—å¼•æ“çš„åŸºæº–ï¼›åŒæ™‚ç·©å­˜åœ¨ Redis ä¾›å³æ™‚æŸ¥è©¢     |
| **æ¨™è¨˜åƒ¹ (Mark Price)**  | æŒ‡æ•¸åƒ¹æ›´æ–°æˆ– Premium Index / Funding Basis è®Šå‹•       | `MarkPriceUpdated`ï¼ˆå·²å« index/mark/fair priceï¼‰â†’ è®“ `positions`/`risk-margin` é‡æ–°è¨ˆç®—æœªå¯¦ç¾ç›ˆè™§èˆ‡ä¿è­‰é‡‘ç‡ |
| **Funding Rate**      | æ¯å€‹çµç®—å‘¨æœŸï¼ˆé è¨­ 8hï¼‰è¨ˆç®—æœ€æ–°è³‡é‡‘è²»ç‡                         | `FundingRateUpdated` â†’ å¯«å…¥ `market.funding-rate` topicï¼Œä¾›çµç®—æœå‹™ç™¼æ”¾è³‡é‡‘è²»ï¼›åŒæ™‚è¨˜éŒ„æ–¼ `funding_rates` è¡¨ |

--- 

#### K ç·šç”Ÿæˆï¼ˆ1m/5m/1hâ€¦ï¼‰ï¼Œç™¼å¸ƒäº‹ä»¶

1. **å®šç¾© K ç·šæ¡¶**ï¼šæ¯çµ„ `instrumentId + period` ç¶­è­·ä¸€å€‹ bucketï¼Œä»¥ `(instrumentId, period, bucket_start)` ç‚º keyï¼Œå…§å« K
   ç·šæ¬„ä½ï¼š

```
    open_price          DECIMAL(20,8)   NOT NULL COMMENT 'é–‹ç›¤åƒ¹'
    high_price          DECIMAL(20,8)   NOT NULL COMMENT 'æœ€é«˜åƒ¹'
    low_price           DECIMAL(20,8)   NOT NULL COMMENT 'æœ€ä½åƒ¹'
    close_price         DECIMAL(20,8)   NOT NULL COMMENT 'æ”¶ç›¤åƒ¹'
    volume              DECIMAL(30,12)  NOT NULL DEFAULT 0 COMMENT 'æˆäº¤é‡ (ä»¥ base asset è¨ˆ)'
    turnover            DECIMAL(30,12)  NOT NULL DEFAULT 0 COMMENT 'æˆäº¤é¡ (ä»¥ quote asset è¨ˆ)'
    trade_count         INT             NOT NULL DEFAULT 0 COMMENT 'æˆäº¤ç­†æ•¸'
    taker_buy_volume    DECIMAL(30,12)  NULL     COMMENT 'åƒå–®æ–¹æˆäº¤é‡ (å¤šé ­)'
    taker_buy_turnover  DECIMAL(30,12)  NULL     COMMENT 'åƒå–®æ–¹æˆäº¤é¡ (å¤šé ­)'
```

3. **æ”¶é›†æˆäº¤**ï¼šæ¯ç­† `TradeExecuted` ä¾ `instrumentId + period + bucket_start` æŠ•å…¥ in-memory bucketï¼ˆ
   `bucket_start = floor(tradeTime, period)`ï¼‰ï¼Œå³æ™‚æ›´æ–° OHLCV èˆ‡é‡èƒ½æ¬„ä½ï¼Œç¢ºä¿æ‰€æœ‰æˆäº¤æŒ‰æ™‚é–“çª—èšåˆã€‚

4. **æ™‚é–“çª—é–‰åˆ**ï¼šæ’ç¨‹æ–¼æ¯å€‹ period çµæŸæ™‚æª¢æŸ¥ bucketï¼›è‹¥è©²çª—ç„¡æˆäº¤ï¼Œä»è£œä¸Šä¸€æ ¹â€œç©ºç™½ K ç·šâ€ï¼ˆæ²¿ç”¨ä¸Šä¸€æ ¹ close ä½œç‚º
   open/high/low/closeï¼Œé‡èƒ½ç‚º 0ï¼‰ä»¥ç¶­æŒåœ–è¡¨é€£çºŒã€‚

5. ~~**è£œå¯«å»¶é²æˆäº¤**ï¼šbucket é—œé–‰å¾Œä»ä¿æŒ `is_closed = FALSE` ä¸€æ®µç·©è¡æ™‚é–“ï¼Œè‹¥æ”¶åˆ°è½åœ¨è©²æ™‚é–“çª—çš„å»¶é²æˆäº¤å°±é‡æ–°è¨ˆç®—
   OHLCVï¼›ç¢ºèªä¸å†æœ‰è£œä»¶å¾Œæ‰è¨­æˆ TRUEï¼Œé¿å…éºæ¼æˆäº¤åˆä¸å¿…é‡å»ºæ•´å¼µè¡¨ã€‚~~

6. **æŒä¹…åŒ–**ï¼šç•¶å‰ bucket å®Œæˆï¼ˆæˆ–è£œå¯«å®Œæˆï¼‰å³ upsert è‡³ `kline_buckets`ï¼Œæ¬„ä½åŒ…å«
   `instrument_id, period, bucket_start/end, open/high/low/close, volume, turnover, taker_buy_*`ï¼Œä¸»éµå¯ç”¨ Snowflake æˆ–
   `(instrumentId, period, bucket_start)`ã€‚

7. **äº‹ä»¶èˆ‡å¿«å–**ï¼šå¯«å…¥æˆåŠŸå¾Œç™¼å¸ƒ `KlineClosed` äº‹ä»¶ä¾›å ±è¡¨/ä¸‹æ¸¸é‡ç®—ï¼›å¸¸ç”¨é€±æœŸï¼ˆ1m/5m/1h/1dï¼‰äº¦å°‡æœ€è¿‘ N æ ¹ç·©å­˜åœ¨ Redis/LRUï¼Œä¾›
   REST æŸ¥è©¢æ™‚ç›´æ¥è®€å–ï¼ˆä½¿ç”¨è€…éœ€æ‰‹å‹•åˆ·æ–°ï¼‰ã€‚

> ä»¥ä¸Šæµç¨‹è®“æ¯å€‹é€±æœŸéƒ½æœ‰ä¸€è‡´çš„ OHLCVï¼Œæ”¯æ´å»¶é²è£œä»¶ä¸¦ä»¥äº‹ä»¶ + REST æŸ¥è©¢è¼¸å‡ºã€‚


---

#### å…§å­˜ç”Ÿæˆ  Mark Priceï¼ˆå–æœ€æ–°æˆäº¤åƒ¹ï¼‰ï¼Œç™¼å¸ƒäº‹ä»¶

- **è³‡æ–™ä¾†æº**ï¼šMarket æœå‹™æ¶ˆè²» `TradeExecuted` äº‹ä»¶å¾Œï¼ŒæŠŠè©² instrument çš„æœ€å¾Œæˆäº¤åƒ¹å¯«é€² in-memory cacheï¼ˆå¯ç‚º
  `ConcurrentHashMap` æˆ– Redisï¼‰ã€‚æœ€æ–°ä¸€ç­†æˆäº¤åƒ¹å³ç‚ºè©²æ¨™çš„çš„ Mark Priceã€‚
- **æŒä¹…åŒ–**ï¼šæ¯æ¬¡æ”¶åˆ°æˆäº¤æ™‚ï¼Œè‹¥ price è®Šå‹•æˆ–è·ä¸Šä¸€ç­†è¶…éè¨­å®šé–“éš”ï¼Œå°±æŠŠ
  `instrumentId / markPrice / tradeId / tradeExecutedAt` upsert è‡³ `mark_price_snapshots`ï¼Œä¿ç•™è¿½æº¯ç´€éŒ„ã€‚
- **äº‹ä»¶æ¨æ’­**ï¼šæ›´æ–°æˆåŠŸå¾Œç™¼å¸ƒ `MarkPriceUpdated`ï¼ˆtopic: `market.mark-price`ï¼‰ï¼Œpayload åƒ…åŒ…å«å¿…è¦æ¬„ä½ï¼š

```json
{
  "instrumentId": "BTCUSDT-PERP",
  "markPrice": 63980.45,
  "tradeId": 123456789,
  "executedAt": "2024-05-07T10:15:30.000Z"
}
```

- **ä½¿ç”¨æ–¹å¼**ï¼šPositions / Risk æœå‹™åƒ…éœ€å–é€™å€‹æœ€æ–°æˆäº¤åƒ¹ä½œç‚º Mark Priceï¼Œå³å¯é©…å‹•å¼·å¹³æˆ–ç›ˆè™§è¨ˆç®—ï¼Œçœå»å¤–éƒ¨æŒ‡æ•¸æˆ– premium
  æ¨å°æµç¨‹ã€‚

è£œå„Ÿæ©Ÿåˆ¶

- è‹¥è®€å–å…§å­˜æ™‚ï¼Œæ²’æœ‰æ•¸æ“šï¼Œå°±æŸ¥ `mark_price_snapshots` è©² instrumentId æœ€å¾Œä¸€ç­†æ•¸æ“šä½¿ç”¨ï¼Œè‹¥æ²’æœ‰æœ€å¾Œä¸€ç­†æ•¸æ“šï¼Œç”Ÿæˆä¸€ç­†é»˜èªæ•¸æ“šæ’å…¥ï¼Œä¸¦ä½¿ç”¨é»˜èªæ•¸æ“šã€‚

---

#### ~~ç”Ÿæˆ Funding Rateï¼Œç™¼å¸ƒäº‹ä»¶~~

è³‡é‡‘è²»ç‡çš„è¨ˆç®—æ˜¯ã€Œæ¯å€‹ funding intervalï¼ˆé è¨­ 8 å°æ™‚ï¼Œå¯èª¿ 1 å°æ™‚ç­‰ï¼‰ã€è·‘ä¸€æ¬¡æ‰¹æ¬¡æµç¨‹ï¼Œæœƒé‡å°è©²å€é–“å…§çš„è¡Œæƒ…è³‡æ–™åšå½™æ•´å¾Œå†è¨ˆç®—ï¼š

- premium_indexï¼šä¸æ˜¯å–å–®ä¸€æ™‚åˆ»ï¼Œè€Œæ˜¯å°æœ€è¿‘ä¸€æ®µæ™‚é–“ï¼ˆå¸¸è¦‹ç‚ºæœ€å¾Œ 1ï½5 åˆ†é˜ï¼Œæˆ–æ•´å€‹ 8 å°æ™‚çš„åŠ æ¬Šå¹³å‡ï¼‰åšå¹³å‡ï¼Œè®“è³‡æ–™ä¸æœƒè¢«ç¬æ™‚å°–å³°å½±éŸ¿ã€‚å¯¦ä½œä¸Šå¯ä»¥ç›´æ¥å¾
  `mark_price_snapshots` å–è©²å€é–“çš„ `fair_priceã€index_price` è¨ˆç®—å¾Œå¹³å‡ï¼Œæˆ–åœ¨è¡Œæƒ…è¨ˆç®—éšæ®µå°±æŒçºŒç¶­è­·ä¸€å€‹æ»‘å‹•å¹³å‡ã€‚
- interest_rateã€borrow_rateï¼šé€šå¸¸ä»¥å¤–éƒ¨æˆ–å…§éƒ¨é…ç½®çš„å¹´åŒ–åˆ©ç‡ç‚ºåŸºç¤ï¼Œå†æ›ç®—æˆæœ¬æœŸï¼ˆ8 å°æ™‚ï¼‰çš„å€¼ã€‚å¦‚æœä½ å¸Œæœ›åæ˜ éå» 8
  å°æ™‚çš„å¸‚å ´è®ŠåŒ–ï¼Œä¹Ÿå¯ä»¥å–è©²æœŸé–“çš„å¹³å‡åˆ©ç‡ï¼ˆä¾‹å¦‚å°æ¯æ¬¡æ›´æ–°çš„åˆ©ç‡å¿«ç…§åšå¹³å‡ï¼‰ï¼Œä½†å¤šæ•¸å¹³å°ç›´æ¥ä½¿ç”¨ç•¶å‰é…ç½®å€¼å³å¯ã€‚
- ä»¥ä¸Šè³‡æ–™æ•´å‚™å¥½å¾Œï¼Œå°±ç”¨ `funding_rate` `=` `clamp(premium_index` `+` `clamp(interest_rate_diff,` `â€¦))` ç­‰å…¬å¼ç®—å‡ºæœ¬æœŸè³‡é‡‘è²»ç‡ï¼Œå¯«å…¥
  funding_rates ä¸¦ç™¼å¸ƒ `FundingRateUpdated`ã€‚


1. **èª¿åº¦è¨ˆç®—**ï¼šä¾ `funding_interval`ï¼ˆé è¨­ 8hï¼Œå¯é…ç½® 1hï¼‰å•Ÿå‹•æ‰¹æ¬¡ä»»å‹™ï¼Œæ”¶é›†è¿‘æœŸ `mark_price_snapshots`ã€è¨ˆç®—`premium_index`
   å¹³å‡å€¼
2. **æ¨å°åˆ©ç‡å·®**ï¼š

    ```
    interest_rate = quote_asset_annual_rate / (365 * 24 / funding_interval_hours)
    borrow_rate   = base_asset_annual_rate / (365 * 24 / funding_interval_hours)
    interest_rate_diff = interest_rate - borrow_rate
    ```

   å…©å€‹å¹´åŒ–åˆ©ç‡ä¾†è‡ªå¤–éƒ¨å€Ÿè²¸å¸‚å ´æˆ–å…§éƒ¨è¨­å®šï¼Œå¯ per instrument è¦†å¯«ã€‚

3. **è¨ˆç®—è³‡é‡‘è²»ç‡èˆ‡è²»ç”¨**ï¼š

    ```
    funding_rate = clamp(premium_index + clamp(interest_rate_diff, -0.0005, 0.0005), -0.0075, 0.0075)
    funding_fee  = position_notional * funding_rate
    ```

   `premium_index` å–è¿‘ 1~5 åˆ†é˜å¹³å‡ï¼Œé¿å…ç¬æ™‚ç•°å¸¸ï¼›clamp æ•¸å€¼å¯ä¾ç‡Ÿé‹ç­–ç•¥èª¿æ•´ã€‚

4. **å¯«å…¥ `funding_rates` è¡¨**ï¼š
    - Upsert æ¬„ä½ï¼š
      `instrument_id, rate, premium_index, interest_rate, borrow_rate, mark_price, index_price, effective_at, calculated_at, funding_interval`ã€‚
    - é è¨­ `settled = FALSE`ï¼Œå¾… account-ledger å®Œæˆæ‰£è£œå¾Œç”±çµç®—æœå‹™è¨­ç‚º `TRUE` ä¸¦å¡« `settled_at`ã€‚
    - è‹¥è¼¸å…¥ä¸å®Œæ•´ï¼Œæ²¿ç”¨ä¸Šä¸€æœŸä¸¦åœ¨ç´€éŒ„ä¸Šæ¨™è¨˜ `source_status = 'DEGRADED'` ä»¥åˆ©ç›£æ§ã€‚
5. **ç™¼å¸ƒäº‹ä»¶**ï¼š

    ```
    FundingRateUpdated {
      instrumentId,
      rate,
      premiumIndex,
      interestRate,
      borrowRate,
      effectiveAt,
      fundingInterval
    }
    ```

   positionsã€account-ledger æ¶ˆè²»ç”¨æ–¼è¨ˆç®—ç”¨æˆ¶æ‡‰æ”¶ä»˜è³‡é‡‘è²»ï¼›å ±è¡¨/ç›£æ§å‰‡ç¹ªè£½æ­·å²æ›²ç·šä¸¦è§¸ç™¼å‘Šè­¦ã€‚
6. **å°å¸³èˆ‡ç›£æ§**ï¼šçµç®—å¾Œæ¯”å° `funding_rates` èˆ‡å¯¦éš›æ”¶ä»˜ï¼Œè‹¥å·®ç•° > X bp ç«‹å³å‘Šè­¦ï¼›åŒæ™‚ç›£æ§åˆ©ç‡è³‡æ–™æ˜¯å¦éæœŸï¼Œç¢ºä¿ä¸‹ä¸€æœŸè¨ˆç®—è¼¸å…¥å®Œæ•´ã€‚

# Account-Ledger æœå‹™

## è·è²¬

- å¸³å‹™ç®¡ç†
- ä»¥é›™åˆ†éŒ„ç¶­è­·è³‡ç”¢è®Šå‹•ï¼Œç¢ºä¿å€Ÿè²¸å¹³è¡¡ä¸¦æ”¯æ´å¯©è¨ˆã€‚
- ç”¢ç”Ÿçµç®—ã€åˆ©æ¯ã€è³‡é‡‘è²»ç‡ã€æ‰‹çºŒè²»ç­‰è²¡å‹™äº‹ä»¶ã€‚

## endpoint

| å®Œæˆ  | HTTP Method | Endpoint                              | èªªæ˜                   | èª¿ç”¨è€…               | æˆæ¬Š          | è¼¸å…¥                                                                                                   | è¼¸å‡º                                                                                                                                                                                                        | DBæ“ä½œ                                                                                               | ç·©å­˜æ“ä½œ | æœå‹™èª¿ç”¨ | è£œå„Ÿæ©Ÿåˆ¶                                   |
|-----|-------------|---------------------------------------|----------------------|-------------------|-------------|------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------|------|------|----------------------------------------|
| âœ”ï¸  | GET         | `/api/ledger/balances?userId=&asset=` | æŸ¥è©¢ SPOT_MAIN é¤˜é¡/å¯ç”¨è³‡é‡‘ | gateway,risk      | jwt,private | assetï¼ˆå¿…å¡«ï¼Œåƒ…é™å¹£åˆ¥ï¼‰<br/>userIdï¼ˆå¯å¾ JWT å–å¾—ï¼‰                                                                 | LedgerBalanceResponse(userId, snapshotAt, balances[accountId, accountType, instrumentId, asset, balance, available, reserved, totalDeposited, totalWithdrawn, totalPnl, lastEntryId, version, updatedAt]) | -                                                                                                  | -    | -    | -                                      |
| âœ”ï¸  | POST        | `/api/ledger/deposits`                | éˆä¸Š/æ³•å¹£å„²å€¼å…¥å¸³            | wallet-sync,admin | private     | LedgerDepositRequest(userId, asset, amount, accountType, txId, creditedAt)                           | LedgerDepositResponse(depositId, entryId, status, balanceAfter, creditedAt, userId, asset, amount, txId)                                                                                                  | insert `ledger_entries`<deposit><br/>update `ledger_balances`<balance,available,total_deposited>   | -    | -    | ä¾ txId åšå†ªç­‰ï¼è£œå„Ÿæª¢æŸ¥                        |
| âœ”ï¸ï¸ | POST        | `/api/ledger/withdrawals`             | å‡ºé‡‘ç”³è«‹èˆ‡æ‰£å¸³              | wallet,admin      | private     | LedgerWithdrawalRequest(userId, asset, amount, fee, destination, externalRef, requestedAt, metadata) | LedgerWithdrawalResponse(withdrawalId, reservedEntryId, status, balanceAfter, requestedAt, userId, asset, amount, fee, externalRef)                                                                       | insert `ledger_entries`<withdraw><br/>update `ledger_balances`<available,reserved,total_withdrawn> | -    | -    | éˆä¸Šå¤±æ•—éœ€è£œå„Ÿé‡‹æ”¾ reserved ä¸¦ç™¼å¸ƒ `FundsUnfrozen` |

## events

**äº‹ä»¶æ¶ˆè²»**:

| å®Œæˆ  | ä¾†æºæœå‹™            | Topic                        | äº‹ä»¶                       | è™•ç†é‚è¼¯               | äº‹ä»¶ç™¼å¸ƒ                                 | DBæ“ä½œ                                                                     | ç·©å­˜æ“ä½œ  | æœå‹™èª¿ç”¨  | è£œå„Ÿæ©Ÿåˆ¶  |
| --- | --------------- | ---------------------------- | ------------------------ | ------------------ | ------------------------------------ | ------------------------------------------------------------------------ | ----- | ----- | ----- |
| âœ”ï¸  | risk-margin     | risk.margin-check-passed     | `MarginPreCheckPassed`   | å‡çµä¿è­‰é‡‘ä¸¦è¨˜éŒ„è³‡ç”¢è®Šå‹•       | `FundsFrozen`<br>`FundsFreezeFailed` | insert `ledger_entries`<freeze><br/>update `accounts`<reserved_balance>  | -     | -     | -     |
|     | matching        | matching.trade-executed      | `TradeExecuted`          | æ‰£é™¤å‡çµã€è¨ˆç®—æ‰‹çºŒè²»ã€é€²è¡Œé›™åˆ†éŒ„è¨˜å¸³ | `LedgerEntryCreated`                 | insert `ledger_entries`<trade><br/>update `accounts`<available/reserved> | -     | -     | -     |
|     | ~~matching~~    | ~~matching.order-cancelled~~ | ~~`OrderCancelled`~~     | ~~è§£å‡å°æ‡‰è³‡é‡‘ä¸¦å›è£œé¤˜é¡~~    | ~~`FundsUnfrozen`~~                  | ~~update `accounts`<reserved_balance>~~                                  | ~~-~~ | ~~-~~ | ~~-~~ |
|     | ~~market-data~~ | ~~market.funding-rate~~      | ~~`FundingRateUpdated`~~ | ~~ä¾è³‡é‡‘è²»ç‡çµç®—å¤šç©ºæ”¯ä»˜~~    | ~~`LedgerEntryCreated`~~             | ~~insert `ledger_entries`<funding>~~                                     | ~~-~~ | ~~-~~ | ~~-~~ |

**äº‹ä»¶ç™¼å¸ƒ**:

| å®Œæˆ | ç™¼å¸ƒå ´æ™¯             | Topic                      | äº‹ä»¶åç¨±                 | äº‹ä»¶å…§å®¹                                                                                | æ¶ˆè²»è€…       |
|----|------------------|----------------------------|----------------------|-------------------------------------------------------------------------------------|-----------|
|    | ä¾é¢¨éšªæª¢æŸ¥çµæœå®Œæˆè³‡é‡‘å‡çµ    | ledger.funds-frozen        | `FundsFrozen`        | orderId, userId, asset, amount                                                      | order     |
|    | å‡çµè³‡é‡‘å¤±æ•—ä¸¦éœ€é€šçŸ¥è¨‚å–®æœå‹™   | ledger.funds-freeze-failed | `FundsFreezeFailed`  | orderId, reason                                                                     | order     |
|    | ~~æ’¤å–®æˆ–çµç®—å¾Œé‡‹æ”¾å‡çµè³‡é‡‘~~ | ~~ledger.funds-unfrozen~~  | ~~`FundsUnfrozen`~~  | ~~orderId, userId, asset, amount~~                                                  | ~~-~~     |
|    | è¨˜éŒ„ä»»ä¸€è³‡ç”¢ç•°å‹•         | ledger.entry-created       | `LedgerEntryCreated` | userId, instrumentId, asset, deltaBalance, balanceAfter, referenceType, referenceId | positions |
|    |                  |                            |                      |                                                                                     |           |

---

## è³‡æ–™è¡¨DDL

### ledger_balances è¡¨

```sql
CREATE TABLE ledger_balances
(
    id              BIGINT         NOT NULL COMMENT 'è¨˜éŒ„ID (Snowflake)',
    account_id      BIGINT         NOT NULL COMMENT 'å¸³æˆ¶ID',
    user_id         BIGINT         NOT NULL COMMENT 'ç”¨æˆ¶ID',
    account_type    VARCHAR(32)    NOT NULL COMMENT 'å¸³æˆ¶é¡å‹: SPOT_MAIN, ISOLATED_MARGIN',
    instrument_id   BIGINT         NULL COMMENT 'é€å€‰å€‰ä½å°æ‡‰çš„ instrumentIdï¼Œåƒ… account_type=ISOLATED_MARGIN æ™‚ä½¿ç”¨',
    asset           VARCHAR(20)    NOT NULL COMMENT 'è³‡ç”¢é¡å‹: USDT, BTC, ETHç­‰',
    balance         DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'ç¸½é¤˜é¡',
    available       DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'å¯ç”¨é¤˜é¡ (balance - reserved)',
    reserved        DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'å‡çµé¤˜é¡ (è¨‚å–®ä¿è­‰é‡‘ã€é¢¨éšªæº–å‚™é‡‘)',
    total_deposited DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'ç´¯è¨ˆå……å€¼é‡‘é¡',
    total_withdrawn DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'ç´¯è¨ˆæç¾é‡‘é¡',
    total_pnl       DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'ç´¯è¨ˆå·²å¯¦ç¾ç›ˆè™§',
    version         INT            NOT NULL DEFAULT 0 COMMENT 'æ¨‚è§€é–ç‰ˆæœ¬è™Ÿ',
    last_entry_id   BIGINT         NULL COMMENT 'æœ€å¾Œæ›´æ–°çš„åˆ†éŒ„ID (å†ªç­‰æ€§æª¢æŸ¥)',
    created_at      DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å¸³æˆ¶å‰µå»ºæ™‚é–“',
    updated_at      DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æœ€å¾Œæ›´æ–°æ™‚é–“',
    PRIMARY KEY (id),
    UNIQUE KEY uk_user_scope (user_id, account_type, instrument_id, asset) COMMENT 'æ¯å€‹ç”¨æˆ¶åœ¨ç›¸åŒå¸³æˆ¶ç¯„åœ/è³‡ç”¢åƒ…ä¸€ç­†ç´€éŒ„'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='å¸³æˆ¶é¤˜é¡è¡¨ - æä¾›è³‡ç”¢æŸ¥è©¢èˆ‡é¢¨æ§è©¦ç®—';

CREATE INDEX idx_user_asset ON ledger_balances (user_id, asset) COMMENT 'æŸ¥è©¢ç”¨æˆ¶æ‰€æœ‰è³‡ç”¢';
CREATE INDEX idx_instrument_type ON ledger_balances (account_type, instrument_id) COMMENT 'æŸ¥è©¢æŸåˆç´„é€å€‰å¸³æˆ¶';
CREATE INDEX idx_available ON ledger_balances (asset, available DESC) COMMENT 'æŒ‰è³‡ç”¢æ’åºå¯ç”¨é¤˜é¡';
CREATE INDEX idx_updated_at ON ledger_balances (updated_at DESC) COMMENT 'æœ€è¿‘æ›´æ–°çš„å¸³æˆ¶';
```

### ledger_entries è¡¨

```sql
CREATE TABLE ledger_entries
(
    entry_id           BIGINT         NOT NULL COMMENT 'åˆ†éŒ„ID Snowflake',
    owner_type         VARCHAR(10)    NOT NULL COMMENT 'USER / PLATFORM',
    account_id         BIGINT         NOT NULL COMMENT 'å¸³æˆ¶ID - ç”¨æˆ¶å°æ‡‰ ledger_balances.account_idï¼Œå¹³å°å°æ‡‰ platform_accounts.account_id',
    user_id            BIGINT         NULL COMMENT 'ç”¨æˆ¶ID',

    asset              VARCHAR(20)    NOT NULL COMMENT 'USDT BTC ETH',
    amount             DECIMAL(20, 8) NOT NULL COMMENT 'æ­£åŠ  è² æ¸›',
    direction          VARCHAR(10)    NOT NULL COMMENT 'DEBIT / CREDIT',
    counterparty_entry BIGINT         NULL COMMENT 'å°æ‰‹åˆ†éŒ„ID',
    balance_after      DECIMAL(20, 8) NOT NULL COMMENT 'æœ¬æ¬¡è®Šå‹•å¾Œé¤˜é¡',

    reference_type     VARCHAR(50)    NOT NULL COMMENT 'äº‹ä»¶ä¾†æº',
    reference_id       VARCHAR(64)    NOT NULL COMMENT 'å¯«å…¥äº¤æ˜“/å„²å€¼/å‡ºé‡‘ç­‰æ¥­å‹™éµ (ä¾‹å¦‚ tradeId / txId)',
    entry_type         VARCHAR(50)    NOT NULL COMMENT 'æ¥­å‹™åŸå› åˆ†é¡',

    description        VARCHAR(255)   NULL COMMENT 'çµ¦ç‡Ÿé‹æˆ–å¾Œå° UI é¡¯ç¤ºç°¡çŸ­çš„æ–‡å­—ï¼Œå”åŠ©ç†è§£é€™ç­†åˆ†éŒ„çš„åŸå› ï¼Œä¾‹å¦‚ã€Œå¹³å€‰é‡‹æ”¾ä¿è­‰é‡‘ã€ã€Œæ’®åˆæ‰£é™¤ taker æ‰‹çºŒè²»ã€',
    metadata           JSON           NULL,

    event_time         DATETIME       NOT NULL COMMENT 'é€™ç­†è³‡é‡‘åˆ†éŒ„åœ¨å¸³å‹™ç³»çµ±ä¸­ç”Ÿæ•ˆçš„æ¥­å‹™æ™‚é–“ï¼Œé€šå¸¸ä½¿ç”¨ä¾†æºäº‹ä»¶çš„ executedAt/occurredAtã€‚ä¾‹å¦‚æ’®åˆæˆäº¤æ™‚ç”¨ TradeExecuted.executedAtã€è³‡é‡‘è²»ç‡çµç®—ç”¨ FundingRate.settledAt',
    created_at         DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP,

    # owner_pk çš„ç›®çš„å°±æ˜¯æŠŠã€Œé€™ç­†åˆ†éŒ„å±¬æ–¼å“ªå€‹ ownerã€çµ±ä¸€æŠ½è±¡å‡ºä¾†ï¼šowner_type='USER' æ™‚ç›´æ¥å¡« user_idï¼Œowner_type='PLATFORM' å‰‡èƒ½å¡«å¹³å°ç§‘ç›® IDï¼ˆæˆ–ç•™ç©ºï¼‰ï¼Œå†ç”¨ idx_owner_asset_time(owner_type, owner_pk, asset, event_time) é€™é¡   # ç´¢å¼•ä¸€æ¬¡æŸ¥å®ŒåŒä¸€ owner åä¸‹æ‰€æœ‰å¸³æˆ¶çš„åˆ†éŒ„ã€‚å°å‰å°æŸ¥è©¢ã€Œé¡¯ç¤ºç”¨æˆ¶ 123 çš„è³‡é‡‘æµæ°´ã€æˆ–ç¨½æ ¸ã€Œå¹³å°ä¿éšªåŸºé‡‘çš„æ‰€æœ‰å€Ÿè²¸ã€æ™‚ï¼Œå°±ä¸ç”¨çŸ¥é“åº•å±¤æ‹†æˆå¤šå°‘å¸³æˆ¶ã€‚
    owner_pk           BIGINT GENERATED ALWAYS AS (
        CASE owner_type
            WHEN 'USER' THEN user_id
            ELSE NULL
            END
        ) STORED,

    PRIMARY KEY (entry_id)
)
    ENGINE = InnoDB
    DEFAULT CHARSET = utf8mb4
    COLLATE = utf8mb4_unicode_ci
    COMMENT ='é›™åˆ†éŒ„ç´€éŒ„è¡¨ æ”¯æŒå…¬å¸å¸³æˆ¶';

CREATE INDEX idx_account_asset ON ledger_entries (account_id, asset, event_time DESC);
CREATE INDEX idx_owner_asset_time ON ledger_entries (owner_type, owner_pk, asset, event_time DESC);
CREATE INDEX idx_user_asset ON ledger_entries (user_id, asset, event_time DESC);
CREATE INDEX idx_reference ON ledger_entries (reference_type, reference_id);
CREATE INDEX idx_entry_type ON ledger_entries (entry_type, event_time DESC);
CREATE INDEX idx_counterparty ON ledger_entries (counterparty_entry);
CREATE INDEX idx_event_time ON ledger_entries (event_time DESC);


```

#### reference_type èˆ‡ entry_type

reference_type äº‹ä»¶ä¾†æº

- ORDER

- TRADE

- DEPOSIT

- WITHDRAWAL
  entry_type æ¥­å‹™åŸå› åˆ†é¡
- TRADE_SETTLEMENT_SPOT_MAIN
- TRADE_SETTLEMENT_ISOLATED_MARGIN
- FEE

äºŒè€…é—œä¿‚
åŒä¸€ reference äº‹ä»¶å¯æ‹†æˆå¤šå€‹ entry_type ï¼Œä¾‹ï¼šæˆäº¤ â†’ æ‰‹çºŒè²» + æˆäº¤çµç®—

ç”¨æ³•å·®ç•°

- reference_type + reference_id  
  æŸ¥ã€Œç”±é€™ç­†äº‹ä»¶ç”¢ç”Ÿçš„æ‰€æœ‰åˆ†éŒ„ã€
- entry_type  
  æŸ¥ã€Œæ­¤é¡è²¡å‹™è¡Œç‚ºçš„æ‰€æœ‰åˆ†éŒ„ã€

### platform_accounts

å¹³å°ç§‘ç›®è¡¨

`platform_accounts` æ˜¯å¹³å°ã€Œè‡ªå·±ã€çš„å¸³æˆ¶ï¼ˆæœƒè¨ˆç§‘ç›®ï¼‰æ¸…å–®ã€‚  
ç”¨ä¾†ä»£è¡¨ï¼šä¿éšªåŸºé‡‘ã€å¹³å°æ”¶å…¥ã€æ‰‹çºŒè²»æ± ã€ç†±éŒ¢åŒ…ã€æ¸…ç®—ç§‘ç›®ç­‰ã€‚  
ä¸å±¬æ–¼ç”¨æˆ¶ã€‚

```
CREATE TABLE platform_accounts (
  account_id     BIGINT       NOT NULL COMMENT 'å¹³å°ç§‘ç›®ID',
  account_code   VARCHAR(64)  NOT NULL COMMENT 'ç§‘ç›®ä»£ç¢¼ï¼ˆå”¯ä¸€ï¼‰',
  category       VARCHAR(32)  NOT NULL COMMENT 'ASSET LIABILITY REVENUE EXPENSE EQUITY',
  name           VARCHAR(128) NOT NULL COMMENT 'é¡¯ç¤ºåç¨±',
  status         VARCHAR(16)  NOT NULL COMMENT 'ACTIVE / INACTIVE',
  created_at     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (account_id),
  UNIQUE KEY uk_code (account_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å¹³å°ç§‘ç›®æ¸…å–®';

```

#### account_code

å¹³å°ç§‘ç›®ä»£ç¢¼ã€‚ å”¯ä¸€ã€‚  
ä¾‹

- EXCHANGE_LIABILITY
- HOT_WALLET
- INSURANCE_FUND
- FEE_REVENUE

#### category

æœƒè¨ˆç§‘ç›®é¡å‹ï¼š

- ASSET
- LIABILITY
- EQUITY
- REVENUE
- EXPENSE

æ ¹æ“š category æ±ºå®šå€Ÿè²¸æ–¹å‘

```
User: CREDIT  USDT
Platform FEE_REVENUE: DEBIT
```

```
User: DEBIT  USDT
Platform EXCHANGE_LIAB: CREDIT
```

#### name

é¡¯ç¤ºåç¨±ã€‚  
ä¾‹
`å¹³å°æ¬ ç”¨æˆ¶ å¹³å°ç†±éŒ¢åŒ… ä¿éšªåŸºé‡‘ å¹³å°æ‰‹çºŒè²»æ”¶å…¥`

#### ç¯„ä¾‹

| account_code     | category  | name       |
| ---------------- | --------- | ---------- |
| FEE_REVENUE      | REVENUE   | æ‰‹çºŒè²»æ”¶å…¥      |

### platform_balancesè¡¨

```sql
-- å¹³å°é¤˜é¡å½™ç¸½ï¼šå…¬å¸/ä¿éšªåŸºé‡‘/è²»ç”¨æ”¶å…¥ç­‰å¹³å°ç§‘ç›®
CREATE TABLE platform_balances
(
    id            BIGINT          NOT NULL COMMENT 'ä¸»éµ Snowflake',
    account_id    BIGINT          NOT NULL COMMENT 'å¹³å°ç§‘ç›®IDï¼ˆå°æ‡‰ç¶­è¡¨ platform_accounts.account_idï¼‰',
      account_code     VARCHAR(64)   NOT NULL COMMENT 'å¹³å°ç§‘ç›®ä»£ç¢¼ ä¾‹: FEE_REVENUE',
    asset         VARCHAR(20)     NOT NULL COMMENT 'USDT BTC ..',
    balance       DECIMAL(38, 18) NOT NULL DEFAULT 0 COMMENT 'é¤˜é¡',
    reserved      DECIMAL(38, 18) NOT NULL DEFAULT 0 COMMENT 'å‡çµé‡‘é¡ï¼ˆè‹¥éœ€ï¼‰',
    version       INT             NOT NULL DEFAULT 0 COMMENT 'æ¨‚è§€é–ç‰ˆæœ¬',
    last_entry_id BIGINT          NULL COMMENT 'æœ€å¾Œå¥—ç”¨çš„åˆ†éŒ„ID',
    created_at    DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at    DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    UNIQUE KEY uk_platform_account_asset (account_id, asset),
    KEY idx_code_asset (account_code, asset)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Platform é¤˜é¡å½™ç¸½ï¼ˆå…¬å¸/åŸºé‡‘/ç§‘ç›®ï¼‰';

```

### ~~funding_rates è¡¨ - è³‡é‡‘è²»ç‡~~

```sql
CREATE TABLE funding_rates
(
    id               BIGINT         NOT NULL COMMENT 'è¨˜éŒ„ID (Snowflake)',
    instrument_id    BIGINT         NOT NULL COMMENT 'äº¤æ˜“å°ID (å¤–éµé—œè¯ instruments.id)',
    rate             DECIMAL(10, 6) NOT NULL COMMENT 'è³‡é‡‘è²»ç‡ (æ­£æ•¸ç‚ºå¤šé ­ä»˜ç©ºé ­, è² æ•¸åä¹‹)',
    premium_index    DECIMAL(10, 6) NOT NULL DEFAULT 0 COMMENT 'æº¢åƒ¹æŒ‡æ•¸',
    interest_rate    DECIMAL(10, 6) NOT NULL DEFAULT 0 COMMENT 'åˆ©ç‡',
    mark_price       DECIMAL(20, 8) NOT NULL COMMENT 'çµç®—æ™‚çš„æ¨™è¨˜åƒ¹æ ¼',
    index_price      DECIMAL(20, 8) NOT NULL COMMENT 'çµç®—æ™‚çš„æŒ‡æ•¸åƒ¹æ ¼',
    funding_interval INT            NOT NULL DEFAULT 8 COMMENT 'è³‡é‡‘è²»ç‡çµç®—é–“éš” (å°æ™‚)',
    effective_at     DATETIME       NOT NULL COMMENT 'ç”Ÿæ•ˆæ™‚é–“',
    calculated_at    DATETIME       NOT NULL COMMENT 'è¨ˆç®—æ™‚é–“',
    settled          BOOLEAN        NOT NULL DEFAULT FALSE COMMENT 'æ˜¯å¦å·²çµç®—',
    settled_at       DATETIME       NULL COMMENT 'çµç®—å®Œæˆæ™‚é–“',
    created_at       DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'è¨˜éŒ„å‰µå»ºæ™‚é–“',
    PRIMARY KEY (id),
    UNIQUE KEY uk_instrument_effective (instrument_id, effective_at) COMMENT 'æ¯å€‹äº¤æ˜“å°æ¯å€‹æ™‚é–“é»å”¯ä¸€'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='è³‡é‡‘è²»ç‡è¡¨ - ä¾›è²»ç‡çµç®—èˆ‡å€‰ä½ä¼°å€¼';

CREATE INDEX idx_instrument_effective ON funding_rates (instrument_id, effective_at DESC) COMMENT 'æŸ¥è©¢äº¤æ˜“å°æ­·å²è²»ç‡';
CREATE INDEX idx_effective_settled ON funding_rates (effective_at, settled) COMMENT 'æŸ¥è©¢å¾…çµç®—è²»ç‡';
CREATE INDEX idx_settled_at ON funding_rates (settled_at DESC) COMMENT 'çµç®—æ­·å²æŸ¥è©¢';
```

## 

## Core

### direction

**DEBIT = å€Ÿæ–¹**  (éæŒ‡å€ŸéŒ¢)ã€**CREDIT = è²¸æ–¹**  (éæŒ‡è²¸æ¬¾)

- åƒ…æ˜¯**å·¦å³æ¬„ä½åç¨±**
- æ˜¯**æœƒè¨ˆè¨˜å¸³æ–¹å‘**ï¼Œä¸æ˜¯ã€ŒåŠ æ¸›ã€æœ¬èº«ã€‚æ˜¯å¦å¢åŠ æˆ–æ¸›å°‘ï¼Œè¦çœ‹æ˜¯å“ªä¸€ç¨®ç§‘ç›®ã€‚
- æ¯ç­†åˆ†éŒ„éƒ½å¿…é ˆåŒæ™‚æœ‰ DEBIT èˆ‡ CREDITï¼ˆå€Ÿè²¸å¿…ç›¸ç­‰ï¼‰ã€‚

| ç§‘ç›® | DEBIT å€Ÿ | CREDIT è²¸ | ç§‘ç›® | DEBIT å€Ÿ | CREDIT è²¸ |
|----|---------|----------|----|---------|----------|
| è³‡ç”¢ | å¢       | æ¸›        | è² å‚µ | æ¸›       | å¢        |
|    |         |          | æ¬Šç›Š | æ¸›       | å¢        |
|    |         |          |    |         |          |
| è²»ç”¨ | å¢       | æ¸›        | æ”¶å…¥ | æ¸›       | å¢        |

### åˆ†éŒ„

ä»¥ä¸‹çµ¦ã€Œ**æœ€å°åŒ–ã€å¹³å°å¸¸ç”¨ï¼ˆåªè¨˜ User è³‡ç”¢å´ï¼‰**ã€çš„ **å€Ÿè²¸æ–¹å‘**ã€‚  
é‡é»ï¼š**User Balance = è³‡ç”¢ç§‘ç›® â†’ DEBIT=å¢åŠ ï¼ŒCREDIT=æ¸›å°‘**  
å¹³å°å´ï¼ˆå°æ‰‹ç§‘ç›®ï¼‰çµ¦ç°¡åŒ–åç¨±å³å¯ã€‚

---

#### DEPOSITï¼ˆç”¨æˆ¶å°å¹³å°å…¥é‡‘ â†’ é€²å…¥ SPOT_MAINï¼‰

| å‹•ä½œ      | å€Ÿ DEBIT            | è²¸ CREDIT             |
|---------|--------------------|----------------------|
| ç”¨æˆ¶å……å€¼è‡³å¹³å° | Spot Main Wallet + | Exchange Liability + |

è‹¥åªè¨˜ç”¨æˆ¶ï¼š
â†’ **DEBIT Spot Main Wallet**

---

#### WITHDRAWALï¼ˆç”¨æˆ¶å¾ SPOT_MAIN æç¾ï¼‰

| å‹•ä½œ        | å€Ÿ DEBIT              | è²¸ CREDIT           |
|-----------|----------------------|--------------------|
| å¹³å°æ”¾æ¬¾/è² å‚µèª¿æ•´ | Exchange Liability â€“ | Spot Main Wallet â€“ |

è‹¥åªè¨˜ç”¨æˆ¶ï¼š
â†’ **CREDIT Spot Main Wallet**

---

#### ä¸‹å–®é æ‰£

äº‹ä»¶ï¼š`MarginPreCheckPassed`ï¼ˆé¢¨æ§è©¦ç®—é€šéï¼‰  
è¡Œç‚ºï¼šåœ¨åŒä¸€ SPOT_MAIN å¸³æˆ¶å…§ï¼ŒæŠŠå¯ç”¨é¤˜é¡è½‰ç‚ºé ç•™ï¼Œæ¡é›™åˆ†éŒ„ä¸¦ä»¥ counterpartyEntryId äº’ç›¸å°æ‡‰ã€‚

| å‹•ä½œ    | å€Ÿ DEBIT                                  | è²¸ CREDIT                                | èªªæ˜                                                              |
|-------|------------------------------------------|-----------------------------------------|-----------------------------------------------------------------|
| é æ‰£ä¿è­‰é‡‘ | Spot Main Reserved +ï¼ˆEntryType.RESERVEDï¼‰ | Spot Main Available â€“ï¼ˆEntryType.FREEZEï¼‰ | ä¸è·¨å¸³æˆ¶ï¼Œåªæ˜¯ç§‘ç›®é‡åˆ†é¡ï¼›å…©ç­†åˆ†éŒ„äº’æŒ‡ counterpartyEntryIdï¼Œamount ç‚º requiredMargin |

#### TRADE_SETTLEMENTï¼ˆæ°¸çºŒåˆç´„é€å€‰ï¼‰

æ’®åˆæˆäº¤å¾Œï¼Œè³‡é‡‘æœƒåœ¨ `SPOT_MAIN`ï¼ˆç¾è²¨ä¸»å¸³æˆ¶ï¼‰å’Œ `ISOLATED_MARGIN`ï¼ˆé€å€‰ä¿è­‰é‡‘å¸³æˆ¶ï¼‰ä¹‹é–“æµå‹•ï¼Œä¸¦è™•ç†å·²å¯¦ç¾ç›ˆè™§å’Œæ‰‹çºŒè²»ã€‚ä¾äº¤æ˜“æ„åœ–ï¼ˆé–‹å€‰æˆ–å¹³å€‰ï¼‰å€åˆ†æƒ…å¢ƒï¼š

| æƒ…å¢ƒ                    | è³‡é‡‘è®Šå‹•èªªæ˜                                                                                                                    | å¸³å‹™é¡å‹ï¼ˆ`EntryType`ï¼‰                                                                                            |
|-----------------------|---------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------|
| **é–‹å€‰ (INCREASE)**     | - SPOT_MAIN æ‰£é™¤ï¼šé–‹å€‰æˆæœ¬ + é–‹å€‰æ‰‹çºŒè²»<br>- ISOLATED_MARGIN å¢åŠ ï¼šé–‹å€‰æˆæœ¬                                                                  | `TRADE_SETTLEMENT_SPOT_MAIN` (Debit)   <br/> `TRADE_SETTLEMENT_ISOLATED_MARGIN` (Credit) <br/> `FEE` (Debit) |
| **å¹³å€‰ (REDUCE/CLOSE)** | - ISOLATED_MARGIN Debitï¼šé–‹å€‰æˆæœ¬<br>- SPOT_MAIN Creditï¼šé–‹å€‰æˆæœ¬<br>- SPOT_MAIN Credit or Debitï¼šå·²å¯¦ç¾ç›ˆè™§<br>- SPOT_MAIN Debitï¼šå¹³å€‰æ‰‹çºŒè²»çºŒè²» | `TRADE_SETTLEMENT_ISOLATED_MARGIN` (Debit) <br/> `TRADE_SETTLEMENT_SPOT_MAIN` (Credit)   <br/> `FEE` (Debit) |
|                       |                                                                                                                           |                                                                                                              |

#### FEE

ï¼ˆäº¤æ˜“æ‰‹çºŒè²»ï¼‰

| å‹•ä½œ    | å€Ÿ DEBIT              | è²¸ CREDIT         | èªªæ˜                |
|-------|----------------------|------------------|-------------------|
| ç”¨æˆ¶æ‰‹çºŒè²» | ç”¨æˆ¶ ISOLATED_MARGIN - | å¹³å° FEE_REVENUE + | å¾ç”¨æˆ¶é€å€‰ä¿è­‰é‡‘æ‰£é™¤ï¼Œä½œç‚ºå¹³å°æ”¶å…¥ |

#### LIQUIDATION

| å‹•ä½œ      | å€Ÿ DEBIT               | è²¸ CREDIT                |
|---------|-----------------------|-------------------------|
| ç”¨æˆ¶æå¤±    | Liquidation Expense + | Isolated Margin â€“       |
| ç›ˆé¤˜è¿”é‚„ä¸»å¸³æˆ¶ | User Main Wallet +    | Isolated Margin â€“       |
| ç©¿å€‰å…¥ä¿éšªåŸºé‡‘ | Insurance Fund +      | Isolated Margin â€“ï¼ˆä¸è¶³éƒ¨åˆ†ï¼‰ |

è‹¥åªè¨˜ç”¨æˆ¶å€‰ä½ï¼š

- æ â†’ **CREDIT Isolated Margin**
- è´ â†’ **DEBIT User Main Wallet**ï¼ˆè¿”é‚„ï¼‰

---

#### FUNDING_RATE

æ°¸çºŒåˆç´„é€å€‰æ¨¡å¼ï¼šè³‡é‡‘è²»ç‡ç›´æ¥åœ¨è©²å€‰ä½çš„ä¿è­‰é‡‘å¸³æˆ¶æ”¶ä»˜ã€‚

| å‹•ä½œ | å€Ÿ DEBIT                 | è²¸ CREDIT                |
|----|-------------------------|-------------------------|
| å¤šæ–¹ | Funding Expense +       | Isolated Margin â€“ï¼ˆå¤šæ–¹å€‰ä½ï¼‰ |
| ç©ºæ–¹ | Isolated Margin +ï¼ˆç©ºæ–¹å€‰ä½ï¼‰ | Funding Income +        |

è‹¥åªè¨˜ç”¨æˆ¶ï¼š

- å¤šæ–¹ â†’ **CREDIT Isolated Margin**
- ç©ºæ–¹ â†’ **DEBIT Isolated Margin**

---

### ç”¨æˆ¶ä¸åˆ†ç§‘

ç”¨æˆ¶åªè¨˜è³‡ç”¢ balanceï¼Œè²»ç”¨åªåœ¨åˆ†éŒ„ä¸­ç•¶ä½œä¸€å€‹ç§‘ç›®å»ç´€éŒ„ï¼Œæ–¹ä¾¿å½™ç¸½çµ±è¨ˆ

ä¸€èˆ¬æƒ…æ³ä¸‹ï¼Œæ‰‹çºŒè²»åªæ˜¯ ledger çš„ä¸€ç­†åˆ†éŒ„ï¼ˆå€Ÿè¨˜è²»ç”¨ã€è²¸è¨˜ç”¨æˆ¶è³‡ç”¢ï¼‰ã€‚å¦‚æœä¹‹å¾Œè¦åœ¨ database è£¡è¿½è¹¤ç”¨æˆ¶æ­·å²è²»ç”¨ï¼Œå¯ä»¥åœ¨
ledger_entries æˆ–å ±è¡¨è¡¨æ ¼ä¸Šæ¨™è¨» reference_type = FEE ä¹‹é¡çš„æ¬„ä½ï¼Œè€Œä¸æ˜¯å¦é–‹ä¸€å¼µã€Œè²»ç”¨å¸³æˆ¶ã€è¡¨ã€‚å› æ­¤ä½ çœ‹åˆ°çš„æè¿°åªæ˜¯ä¸€å€‹æœƒè¨ˆæ¦‚å¿µï¼Œå¯¦å‹™ä¸Šä»æ˜¯è¨˜åœ¨
ledger entries æˆ–å¸³æœ¬ç³»çµ±è£¡ã€‚

## Event Inputï¼šMarginPreCheckPassed

## Event Inputï¼š`TradeExecuted`

ä¾†æºäº‹ä»¶ï¼š`TradeExecuted`ï¼ˆç”± matching ç™¼å¸ƒï¼‰

`account-ledger` æ¶ˆè²»é€™å€‹äº‹ä»¶å¾Œï¼Œé–‹å§‹é€²è¡Œã€Œé›™åˆ†éŒ„ã€çµç®—ã€‚

---
è™•ç†ç›®æ¨™

- å°è²·è³£é›™æ–¹é€²è¡Œè³‡é‡‘ç§»è½‰ï¼ˆå¯ç”¨ â†’ å¯¦éš›çµç®—ï¼‰
- æ‰£é™¤æˆ–è¿”é‚„å‡çµè³‡é‡‘
- è¨˜éŒ„æ‰‹çºŒè²»ã€ç›ˆè™§
- ç™¼å¸ƒæ–°çš„ã€Œè³‡ç”¢ç•°å‹•äº‹ä»¶ã€ä¾›å€‰ä½èˆ‡é¢¨æ§æ›´æ–°

---

### æ¥æ”¶äº‹ä»¶

Kafka consumer æ”¶åˆ° `TradeExecuted` â†’ é–‹å•Ÿäº¤æ˜“ï¼ˆ@Transactionalï¼‰

### æŸ¥è©¢é–‹/å¹³å€‰ã€å¹³å€‰æˆæœ¬

ç”¨Order ID å›æŸ¥Orderæœå‹™ï¼Œ GET  `/api/orders/{orderId}` ï¼Œå…¶ä¸­ intent ç‚ºäº¤æ˜“é¡å‹ï¼Œclose_cost_price ç‚º å¹³å‡é–‹å€‰åƒ¹
è‹¥ intent=INCREASE â‡’ å¾ Spot Main Reserved è½‰åˆ° Isolated Marginï¼ˆå»ºå€‰ï¼‰ï¼›
è‹¥ intent=REDUCE/CLOSE â‡’ å¾ Isolated Margin é‡‹æ”¾åˆ° Spot Main Wallet ä¸¦è™•ç†å·²å¯¦ç¾ç›ˆè™§ã€‚
ç¢ºèªç‚ºå¹³å€‰å¾Œï¼Œå¸³æœ¬ä¾ç…§äº¤æ˜“åƒ¹å€¼ã€åŸå…ˆå‡çµçš„ä¿è­‰é‡‘ä»¥åŠæ–¹å‘ä¾†åšé›™åˆ†éŒ„ï¼Œé‡‹æ”¾é€å€‰é¤˜é¡ä¸¦åŒæ™‚è¨ˆç®—ç›ˆè™§ï¼›
ä»¥Order.closeCostPrice ä½œç‚ºå¹³å‡é–‹å€‰åƒ¹æ ¼
å¯¦ç¾ç›ˆè™§ = (å¹³å€‰æˆäº¤åƒ¹ - å¹³å‡é–‹å€‰åƒ¹) Ã— å¹³å€‰æ•¸é‡ï¼ˆä¾å¤šç©ºæ±ºå®šæ­£è² ï¼‰ï¼Œç®—å‡ºçš„çµæœæœƒåæ˜ åœ¨ LedgerEntryCreated äº‹ä»¶çš„
deltaAvailable/deltaReservedï¼Œä¾› positions æœå‹™è½å¯¦ realized_pnl ä¸¦åœ¨æ•¸é‡æ­¸é›¶æ™‚é—œå€‰

### è®€å–åŸºç¤è³‡æ–™

- é©—è­‰æ’®åˆçµæœæ˜¯å¦å·²è™•ç†éï¼ˆæ ¹æ“š tradeId å»é‡ï¼Œç¢ºä¿å†ªç­‰ï¼‰
- æŸ¥è©¢é›™æ–¹çš„å¸³æˆ¶é¤˜é¡ (`ledger_balances`)

### æ“ä½œè³‡é‡‘è®ŠåŒ–

ä»¥ BTCUSDT æ°¸çºŒåˆç´„ç‚ºä¾‹ï¼š

| è§’è‰²   | å‹•ä½œ       | è³‡é‡‘æ–¹å‘                          | å‚™è¨»                          |
|------|----------|-------------------------------|-----------------------------|
| å¤šæ–¹é–‹å€‰ | æ”¯ä»˜æˆäº¤åç¾©åƒ¹å€¼ | å¾ Isolated Margin Reserved æ‰£é™¤ | ä½¿ç”¨å‡çµä¿è­‰é‡‘çµç®—ï¼Œè½‰å…¥ Margin Balance |
| å¹³å€‰   | æ”¶åˆ°æˆäº¤é‡‘é¡   | å¢åŠ  USDT                       | çµç®—å…¥å¸³                        |
| ç³»çµ±å¸³æˆ¶ | æ”¶å–æ‰‹çºŒè²»    | å¢åŠ  USDT                       | maker/taker è²»ç‡              |

---

### åŸ·è¡Œé›™åˆ†éŒ„è¨˜å¸³

ä»¥ã€Œå€Ÿè²¸å¿…å¹³è¡¡ã€åŸå‰‡é€²è¡Œä¸‰çµ„åˆ†éŒ„ï¼š

**1. è³‡é‡‘çµç®—**
**2. æ‰‹çºŒè²»**
**3. è§£å‡ / çµé¤˜èª¿æ•´**

---

### æ›´æ–°é¤˜é¡è¡¨

- `ledger_balances`ï¼šæ›´æ–° balance / available / reserved æ¬„ä½ã€‚
- `ledger_entries`ï¼šæ’å…¥é›™åˆ†éŒ„äº¤æ˜“æ˜ç´°ã€‚

---

### ç™¼å¸ƒè³‡ç”¢ç•°å‹•äº‹ä»¶

æ¯ç­†äº¤æ˜“å®Œæˆå¾Œï¼Œç™¼å‡ºï¼š`LedgerEntryCreated`


---

### æäº¤äº¤æ˜“

- æ•´å€‹éç¨‹åŒ…åœ¨åŒä¸€å€‹è³‡æ–™åº«äº¤æ˜“ä¸­ã€‚
- æˆåŠŸå¾Œæäº¤ä¸¦ç¢ºèªäº‹ä»¶ Outbox â†’ Kafkaï¼ˆç¢ºä¿ exactly-onceï¼‰ã€‚
- è‹¥ä¸­é€”å¤±æ•—å‰‡ rollbackï¼Œç¢ºä¿è³‡ç”¢ä¸äº‚å‹•ã€‚

## Event Inputï¼šOrderCancelled

## ~~Event Inputï¼šFundingRateUpdated~~

## Event Outputï¼š`LedgerEntryCreated`

# Positions æœå‹™

## è·è²¬

- `positions` æ¨¡çµ„è² è²¬ç¶­è­·æ¯å€‹ç”¨æˆ¶åœ¨å„äº¤æ˜“å° (`instrument_id`) ä¸Šçš„**æŒå€‰ã€å¹³å‡æˆæœ¬ã€æœªå¯¦ç¾ç›ˆè™§ã€å¼·å¹³åƒ¹ã€ç ´ç”¢åƒ¹**ç­‰è³‡è¨Šã€‚
  å®ƒä¸è™•ç†é‡‘æµï¼Œåªæ ¹æ“šæˆäº¤èˆ‡è³‡ç”¢äº‹ä»¶ä¾†æ›´æ–°å€‰ä½ã€‚

| é¡åˆ¥   | åŠŸèƒ½                                                                     |
|------|------------------------------------------------------------------------|
| ç‹€æ…‹ç¶­è­· | ç¶­è­·æ¯å€‹ç”¨æˆ¶åœ¨å„äº¤æ˜“å°çš„å€‰ä½æ–¹å‘ã€æ•¸é‡ã€å‡åƒ¹ã€æœªå¯¦ç¾æç›Šã€å¼·å¹³åƒ¹                                       |
| äº‹ä»¶é©…å‹• | æ¶ˆè²» `TradeExecuted`ã€`LedgerEntryCreated`ã€`MarkPriceUpdated` ç­‰äº‹ä»¶ä¾†æ›´æ–°å€‰ä½èˆ‡ç›ˆè™§ |
| é¢¨éšªå›é¥‹ | å°‡æ›´æ–°å¾Œçš„é¢¨éšªæŒ‡æ¨™ï¼ˆmargin ratioã€liquidation priceï¼‰ç™¼é€çµ¦ `risk-margin`             |
| å€‰ä½æº¯æº | ç¶­è­· `position_events` è¡¨ä¾›ç¨½æ ¸èˆ‡é‡æ”¾                                           |
|      |                                                                        |

## å•Ÿå‹•æµç¨‹

### æœå‹™å•Ÿå‹•æ™‚åˆå§‹åŒ– Instrument èˆ‡ RiskLimit å¿«å–


-- è‡¨æ™‚ä»£ç¢¼ --

Positions æœå‹™åœ¨å•Ÿå‹•æ™‚éœ€è¦åŠ è¼‰æ‰€æœ‰äº¤æ˜“å°çš„åŸºç¤é…ç½®èˆ‡é¢¨æ§é…ç½®åˆ°æœ¬åœ°å¿«å–ï¼Œä»¥æ”¯æ´å¾ŒçºŒçš„å€‰ä½è¨ˆç®—èˆ‡é¢¨éšªè©•ä¼°ã€‚

**åŸ·è¡Œæµç¨‹**ï¼š

1. **æœå‹™å•Ÿå‹•è§¸ç™¼**ï¼šæ‡‰ç”¨å•Ÿå‹•å®Œæˆå¾Œï¼ˆ`ApplicationReadyEvent`ï¼‰ï¼ŒåŸ·è¡Œåˆå§‹åŒ–é‚è¼¯
2. **æŸ¥è©¢æ‰€æœ‰äº¤æ˜“å°**ï¼š
   - èª¿ç”¨ Admin æœå‹™æ¥å£ï¼š`GET /api/admin/instruments`
   - ç²å–æ‰€æœ‰ `InstrumentSummaryResponse` åˆ—è¡¨
   - åŒ…å«æ¬„ä½ï¼š`instrumentId`, `symbol`, `instrumentType`, `status` ç­‰
3. **æŸ¥è©¢æ¯å€‹äº¤æ˜“å°çš„é¢¨æ§é…ç½®**ï¼š
   - éæ­·æ‰€æœ‰ `instrumentId`
   - èª¿ç”¨ Risk æœå‹™æ¥å£ï¼š`GET /api/risk/limits/{instrumentId}`
   - ç²å– `RiskLimitResponse`
   - åŒ…å«æ¬„ä½ï¼š`initialMarginRate`, `maxLeverage`, `maintenanceMarginRate`, `liquidationFeeRate`, `positionSizeMin`, `positionSizeMax`, `maxPositionValue`, `maxOrderValue` ç­‰
4. **å¯«å…¥æœ¬åœ°å¿«å–**ï¼š
   - å°‡ Instrument æ•¸æ“šå­˜å…¥å¿«å–ï¼ˆkey: `instrument:{instrumentId}`ï¼‰
   - å°‡ RiskLimit æ•¸æ“šå­˜å…¥å¿«å–ï¼ˆkey: `riskLimit:{instrumentId}`ï¼‰
   - å¿«å–å¯¦ç¾å¯ä½¿ç”¨ `ConcurrentHashMap` æˆ– `Caffeine Cache`
5. **éŒ¯èª¤è™•ç†**ï¼š
   - è‹¥ Admin æœå‹™èª¿ç”¨å¤±æ•—ï¼Œè¨˜éŒ„éŒ¯èª¤ä¸¦å»¶é²é‡è©¦ï¼ˆæœ€å¤šé‡è©¦ 3 æ¬¡ï¼‰
   - è‹¥æŸå€‹ instrumentId çš„ RiskLimit æŸ¥è©¢å¤±æ•—ï¼ˆ404ï¼‰ï¼Œè¨˜éŒ„è­¦å‘Šä¸¦è·³éè©²äº¤æ˜“å°
   - è‹¥æ•´é«”åˆå§‹åŒ–å¤±æ•—è¶…éé–¾å€¼ï¼Œé˜»æ­¢æœå‹™æ­£å¸¸å•Ÿå‹•ï¼ˆæ‹‹å‡ºç•°å¸¸ï¼‰

**å¯¦ç¾è¦é»**ï¼š

- ä½¿ç”¨ `@EventListener(ApplicationReadyEvent.class)` ç›£è½æ‡‰ç”¨å•Ÿå‹•äº‹ä»¶
- ä½¿ç”¨ Feign Client èª¿ç”¨ Admin å’Œ Risk æœå‹™
- å¿«å–æ›´æ–°ç­–ç•¥ï¼š
  - å•Ÿå‹•æ™‚å…¨é‡åŠ è¼‰
  - å¾ŒçºŒå¯é€éå®šæ™‚ä»»å‹™ï¼ˆå¦‚æ¯ 5 åˆ†é˜ï¼‰å¢é‡æ›´æ–°
  - æˆ–è¨‚é–± `InstrumentUpdated`ã€`RiskLimitUpdated` äº‹ä»¶é€²è¡Œå³æ™‚æ›´æ–°
- å¿«å–çµæ§‹å»ºè­°ï¼š
  ```java
  // Instrument å¿«å–
  Map<Long, InstrumentSummaryResponse> instrumentCache;

  // RiskLimit å¿«å–
  Map<Long, RiskLimitResponse> riskLimitCache;
  ```

**å¿«å–ä½¿ç”¨å ´æ™¯**ï¼š

- è¨ˆç®—å€‰ä½ä¿è­‰é‡‘æ™‚ï¼Œå¾ `riskLimitCache` ç²å– `initialMarginRate` å’Œ `maxLeverage`
- è¨ˆç®—å¼·å¹³åƒ¹æ ¼æ™‚ï¼Œå¾ `riskLimitCache` ç²å– `maintenanceMarginRate` å’Œ `liquidationFeeRate`
- é©—è­‰å€‰ä½å¤§å°é™åˆ¶æ™‚ï¼Œå¾ `riskLimitCache` ç²å– `positionSizeMin` å’Œ `positionSizeMax`
- æª¢æŸ¥äº¤æ˜“å°ç‹€æ…‹æ™‚ï¼Œå¾ `instrumentCache` ç²å– `status`

## endpoint

| å®Œæˆ  | HTTP Method | Endpoint                                 | èªªæ˜                     | èª¿ç”¨è€…           | æˆæ¬Š      | è¼¸å…¥                                                                   | è¼¸å‡º                                                                                        | DBæ“ä½œ                                     | ç·©å­˜æ“ä½œ | æœå‹™èª¿ç”¨                                  | è£œå„Ÿæ©Ÿåˆ¶ |     |
| --- | ----------- | ---------------------------------------- | ---------------------- | ------------- | ------- | -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- | ---------------------------------------- | ---- | ------------------------------------- | ---- | --- |
| âœ”ï¸  | POST        | `/api/positions/intent`                  | åˆ¤æ–· LONG/SHORT æ˜¯å¦ç‚ºåŠ å€‰/å¹³å€‰ | order-service | jwt     | PositionIntentRequest(userId,instrumentId,side(LONG/SHORT),quantity) | PositionIntentResponse(intentType, existingQty, requiresReserve)                          | -                                        | -    | -                                     | -    |     |
| âœ”ï¸  | GET         | `/api/positions/{userId}/{instrumentId}` | å³æ™‚å€‰ä½å¿«ç…§                 | risk-margin   | private | path åƒæ•¸ userIdã€instrumentId                                          | PositionSnapshotï¼ˆside, quantity, leverage, margin, closingReservedQuantity, updatedAt...ï¼‰ | -                                        | -    | -                                     | -    |     |
|     | POST        | `/api/positions/{instrumentId}/leverage` | èª¿æ•´å€‰ä½æ§“æ¡¿å€æ•¸               | risk-margin   | private | path instrumentIdã€body: targetLeverageï¼ˆuserId å–è‡ª JWTï¼‰                | PositionLeverageResponseï¼ˆappliedLeverage, effectiveAtï¼‰                                    | update `positions`<leverage, updated_at> | -    | å‘¼å« risk `/api/risk/precheck/leverage` | -    |     |
|     |             |                                          |                        |               |         |                                                                      |                                                                                           |                                          |      |                                       |      |     |

## events

**äº‹ä»¶æ¶ˆè²»**:

| å®Œæˆ  | ä¾†æºæœå‹™           | Topic                            | äº‹ä»¶                         | è™•ç†é‚è¼¯                                                       | äº‹ä»¶ç™¼å¸ƒ                                           | DBæ“ä½œ                                                                         | ç·©å­˜æ“ä½œ | æœå‹™èª¿ç”¨ | è£œå„Ÿæ©Ÿåˆ¶ |
| --- | -------------- | -------------------------------- | -------------------------- | ---------------------------------------------------------- | ---------------------------------------------- | ---------------------------------------------------------------------------- | ---- | ---- | ---- |
| âœ”ï¸  | matching       | matching.trade-executed          | `TradeExecuted`            | èª¿æ•´å€‰ä½æ•¸é‡ã€å‡åƒ¹èˆ‡æœªå¯¦ç¾ç›ˆè™§                                            | `PositionUpdated` / `PositionClosed`           | update `positions`<quantity, entry_price, unrealized_pnl, liquidation_price> | -    | -    | -    |
| âœ”ï¸  | order          | order.position-reserve-requested | `PositionReserveRequested` | å¹³å€‰å‰å‡çµå€‰ä½ (userId, instrumentId, side, quantity, intentType) | `PositionReserved` / `PositionReserveRejected` | update `positions`<closing_reserved_quantity>                                |      |      | -    |
|     | account-ledger | ledger.entry-created             | `LedgerEntryCreated`       | ä¾è³‡ç”¢çµç®—çµæœæ›´æ–°å·²å¯¦ç¾ç›ˆè™§ä¸¦é—œé–‰å€‰ä½                                        | `PositionUpdated` / `PositionClosed`           | update `positions`<realized_pnl, status>                                     | -    | -    | -    |
|     | market-data    | market.mark-price                | `MarkPriceUpdated`         | ä»¥æœ€æ–°æ¨™è¨˜åƒ¹æ ¼é‡ç®—æœªå¯¦ç¾ç›ˆè™§èˆ‡å¼·å¹³åƒ¹                                         | `PositionUpdated`                              | update `positions`<mark_price, unrealized_pnl>                               | -    | -    | -    |

**äº‹ä»¶ç™¼å¸ƒ**:

| å®Œæˆ  | ç™¼å¸ƒå ´æ™¯           | Topic                      | äº‹ä»¶åç¨±                      | äº‹ä»¶å…§å®¹                                                                                         | æ¶ˆè²»è€…                    |
| --- | -------------- | -------------------------- | ------------------------- | -------------------------------------------------------------------------------------------- | ---------------------- |
| âœ”ï¸  | å¹³å€‰é–å€‰æˆåŠŸ         | positions.reserved         | `PositionReserved`        | orderId, userId, instrumentId, intentType, reservedQuantity, avgOpenPrice, reservedAt        | order-service          |
| âœ”ï¸  | å¹³å€‰é–å€‰å¤±æ•—         | positions.reserve-rejected | `PositionReserveRejected` | orderId, userId, instrumentId, intentType, reason, rejectedAt                                | order-service          |
|     | å€‰ä½æ•¸é‡/åƒ¹æ ¼/é¢¨éšªæŒ‡æ¨™æ›´æ–° | positions.updated          | `PositionUpdated`         | userId, instrumentId, side, quantity, entryPrice, markPrice, unrealizedPnl, liquidationPrice | risk-margin, reporting |
|     | å€‰ä½å®Œå…¨é—œé–‰         | positions.closed           | `PositionClosed`          | userId, instrumentId                                                                         | reporting              |

---

## è³‡æ–™è¡¨DDL

### positions è¡¨

```sql
CREATE TABLE positions
(
    position_id               BIGINT         NOT NULL COMMENT 'å€‰ä½ID (Snowflake)',
    user_id                   BIGINT         NOT NULL COMMENT 'ç”¨æˆ¶ID (å¤–éµé—œè¯ users.id)',
    instrument_id             BIGINT         NOT NULL COMMENT 'äº¤æ˜“å°ID (å¤–éµé—œè¯ instruments.id)',

    leverage                  INT            NOT NULL DEFAULT 40 COMMENT 'æ§“æ¡¿å€æ•¸',

    # æ¯æ¬¡é–‹å€‰æ›´æ–°
    margin                    DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'å€‰ä½ä¿è­‰é‡‘',

    # æŒå€‰    
    side                      VARCHAR(10)    NOT NULL COMMENT 'å€‰ä½æ–¹å‘: LONG, SHORT',
    entry_price               DECIMAL(20, 8) NOT NULL COMMENT 'å¹³å‡é–‹å€‰åƒ¹æ ¼',
    quantity                  DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'æŒå€‰æ•¸é‡ (çµ•å°å€¼)',
    closing_reserved_quantity DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'é å…ˆå‡çµç”¨æ–¼å¹³å€‰çš„æ•¸é‡',

    # è¡Œæƒ…æ›´æ–°
    mark_price                DECIMAL(20, 8) NOT NULL COMMENT 'æ¨™è¨˜åƒ¹æ ¼ (ç”¨æ–¼è¨ˆç®—æœªå¯¦ç¾ç›ˆè™§)',
    margin_ratio              DECIMAL(10, 4) NOT NULL DEFAULT 0 COMMENT 'ä¿è­‰é‡‘ç‡ (equity / market_notional) = (margin_balance + unrealized_pnl ) / (mark_price * quantity)',
    unrealized_pnl            DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'æœªå¯¦ç¾ç›ˆè™§',
    # å¹³å€‰æ›´æ–°
    realized_pnl              DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'å·²å¯¦ç¾ç›ˆè™§ (ç´¯è¨ˆ)',


    liquidation_price         DECIMAL(20, 8) NULL COMMENT 'é ä¼°å¼·å¹³åƒ¹æ ¼',


    status                    VARCHAR(20)    NOT NULL DEFAULT 'ACTIVE' COMMENT 'å€‰ä½ç‹€æ…‹: ACTIVE, LIQUIDATING, CLOSED',
    version                   INT            NOT NULL DEFAULT 0 COMMENT 'æ¨‚è§€é–ç‰ˆæœ¬è™Ÿ',
    created_at                DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'é–‹å€‰æ™‚é–“',
    updated_at                DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æœ€å¾Œæ›´æ–°æ™‚é–“',
    closed_at                 DATETIME       NULL COMMENT 'å¹³å€‰æ™‚é–“',
    PRIMARY KEY (position_id),
    UNIQUE KEY uk_user_instrument (user_id, instrument_id) COMMENT 'æ¯å€‹ç”¨æˆ¶æ¯å€‹äº¤æ˜“å°åªèƒ½æœ‰ä¸€å€‹å€‰ä½'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='å€‰ä½ä¸»æª” - å€‰ä½å¿«ç…§èˆ‡ä¼°å€¼è³‡æ–™';

CREATE INDEX idx_user_status ON positions (user_id, status) COMMENT 'æŸ¥è©¢ç”¨æˆ¶æ´»å‹•å€‰ä½';
CREATE INDEX idx_instrument_status ON positions (instrument_id, status) COMMENT 'æŸ¥è©¢äº¤æ˜“å°æ´»å‹•å€‰ä½';
CREATE INDEX idx_margin_ratio ON positions (margin_ratio ASC) COMMENT 'é¢¨æ§ç›£æ§ä½ä¿è­‰é‡‘ç‡å€‰ä½';
CREATE INDEX idx_status_updated ON positions (status, updated_at DESC) COMMENT 'æŸ¥è©¢ç‰¹å®šç‹€æ…‹å€‰ä½';
```

### position_events è¡¨ - å€‰ä½äº‹ä»¶æº¯æº

```sql
CREATE TABLE position_events
(
    event_id              BIGINT         NOT NULL COMMENT 'äº‹ä»¶ID (Snowflake)',
    position_id           BIGINT         NOT NULL COMMENT 'å€‰ä½ID (å¤–éµé—œè¯ positions.position_id)',
    user_id               BIGINT         NOT NULL COMMENT 'ç”¨æˆ¶ID (å†—é¤˜æ¬„ä½ä¾¿æ–¼æŸ¥è©¢)',
    instrument_id         BIGINT         NOT NULL COMMENT 'äº¤æ˜“å°ID (å†—é¤˜æ¬„ä½ä¾¿æ–¼æŸ¥è©¢)',
    event_type            VARCHAR(50)    NOT NULL COMMENT 'äº‹ä»¶é¡å‹: MARGIN_ADJUSTED, POSITION_OPENED, POSITION_INCREASED, POSITION_DECREASED, POSITION_RESERVED, POSITION_CLOSED, REALIZED_PNL_ADJUSTED, LIQUIDATION_TRIGGERED, MARK_PRICE_UPDATED',
    delta_quantity        DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'æ•¸é‡è®ŠåŒ– (æ­£æ•¸å¢åŠ , è² æ•¸æ¸›å°‘)',
    delta_pnl             DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'ç›ˆè™§è®ŠåŒ–',
    new_quantity          DECIMAL(20, 8) NOT NULL COMMENT 'äº‹ä»¶å¾Œçš„æ–°æ•¸é‡',
    new_reserved_quantity DECIMAL(20, 8) NOT NULL COMMENT 'äº‹ä»¶å¾Œçš„é ç•™å¹³å€‰å‡çµæ•¸é‡',
    new_entry_price       DECIMAL(20, 8) NOT NULL COMMENT 'äº‹ä»¶å¾Œçš„æ–°å‡åƒ¹',
    new_leverage          DECIMAL(10, 2) NOT NULL COMMENT 'äº‹ä»¶å¾Œçš„æ–°æ§“æ¡¿å€æ•¸',
    new_margin            DECIMAL(20, 8) NOT NULL COMMENT 'äº‹ä»¶å¾Œçš„å€‰ä½ä¿è­‰é‡‘',
    new_unrealized_pnl    DECIMAL(20, 8) NOT NULL COMMENT 'äº‹ä»¶å¾Œçš„æœªå¯¦ç¾ç›ˆè™§',
    reference_id          BIGINT         NULL COMMENT 'é—œè¯ID (trade_id, liquidation_idç­‰)',
    reference_type        VARCHAR(50)    NULL COMMENT 'é—œè¯é¡å‹: TRADE, LIQUIDATION, MARK_PRICE_UPDATE',
    metadata              JSON           NULL COMMENT 'é¡å¤–å…ƒæ•¸æ“š (äº‹ä»¶è©³æƒ…)',
    occurred_at           DATETIME       NOT NULL COMMENT 'äº‹ä»¶ç™¼ç”Ÿæ™‚é–“',
    created_at            DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'è¨˜éŒ„å‰µå»ºæ™‚é–“',
    PRIMARY KEY (event_id)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='å€‰ä½äº‹ä»¶æº¯æºè¡¨ - è¿½è¹¤å€‰ä½è®ŠåŒ–èˆ‡å¼·å¹³æ­·ç¨‹';

CREATE INDEX idx_position_occurred ON position_events (position_id, occurred_at DESC) COMMENT 'æŸ¥è©¢å€‰ä½æ­·å²äº‹ä»¶';
CREATE INDEX idx_user_occurred ON position_events (user_id, occurred_at DESC) COMMENT 'æŸ¥è©¢ç”¨æˆ¶å€‰ä½æ­·å²';
CREATE INDEX idx_event_type ON position_events (event_type, occurred_at DESC) COMMENT 'æŒ‰äº‹ä»¶é¡å‹æŸ¥è©¢';
CREATE INDEX idx_reference ON position_events (reference_type, reference_id) COMMENT 'é€šéé—œè¯IDæŸ¥æ‰¾äº‹ä»¶';
CREATE INDEX idx_occurred_at ON position_events (occurred_at DESC) COMMENT 'æ™‚åºæŸ¥è©¢æ‰€æœ‰å€‰ä½äº‹ä»¶';
```

## 

## Core

### å…§éƒ¨é‚è¼¯ç‹€æ…‹è½‰æ›

| äº‹ä»¶       | ç‹€æ…‹è®ŠåŒ–                     | èªªæ˜          |
|----------|--------------------------|-------------|
| é–‹å€‰æˆäº¤     | ç„¡ â†’ `ACTIVE`             | å»ºç«‹æ–°å€‰ä½       |
| åŠ å€‰æˆäº¤     | `ACTIVE` â†’ `ACTIVE`      | å¢åŠ æ•¸é‡ï¼Œé‡ç®—å‡åƒ¹   |
| æ¸›å€‰ï¼ˆå¹³å€‰éƒ¨åˆ†ï¼‰ | `ACTIVE` â†’ `ACTIVE`      | æ¸›å°‘æ•¸é‡ï¼Œéƒ¨åˆ†çµç®—   |
| è§¸ç™¼å¼·å¹³     | `ACTIVE` â†’ `LIQUIDATING` | é€²å…¥å¼·å¹³æµç¨‹      |
| å¼·å¹³å®Œæˆ     | `LIQUIDATING` â†’ `CLOSED` | å¼·å¹³å®Œæˆ        |
| å…¨å¹³       | `ACTIVE` â†’ `CLOSED`      | å€‰ä½æ¸…é›¶ï¼Œè¨˜éŒ„å¯¦ç¾ç›ˆè™§ |

### ä¸é‡ç”¨å·²å¹³å€‰å€‰ä½ï¼Œæ‡‰åŠ é–‹æ–°å€‰

å°ˆæ¥­ç³»çµ±é€šå¸¸é€™æ¨£åšï¼š

- position åªè¦ size è®Šç‚º 0
    - ç‹€æ…‹è¨­ç‚º CLOSED
    - å¯«å…¥ closed_at
    - ä¸å†æ¥å—ä»»ä½•è®Šæ›´
- æ–°é–‹å€‰æ°¸é å»ºç«‹æ–° position_id
- è‹¥æ˜¯éƒ¨åˆ†å¹³å€‰
    - position æŒçºŒå­˜åœ¨
    - æ›´æ–°å¹³å‡åƒ¹èˆ‡æœªå¯¦ç¾æç›Š

### å€‰ä½å¸‚å ´åç¾©åƒ¹å€¼ï¼ˆNotionalï¼‰

`market_notional = abs(mark_price * quantity)`ï¼Œä»£è¡¨å€‰ä½ä»¥æœ€æ–°æ¨™è¨˜åƒ¹è¨ˆç®—çš„å¸‚å ´æ›éšªã€‚æ­¤å€¼ç”¨æ–¼é¢¨æ§æ¨¡çµ„çš„ä¿è­‰é‡‘æ¯”ä¾‹ã€ç¶­æŒä¿è­‰é‡‘èˆ‡å¼·å¹³æª¢æŸ¥ã€‚

### å€‰ä½æˆæœ¬åƒ¹å€¼ï¼ˆCost Basisï¼‰

`cost_basis = abs(entry_price * quantity)`ï¼Œè¨˜éŒ„å€‰ä½ä»¥å¹³å‡é–‹å€‰åƒ¹è¨ˆç®—çš„æ­·å²æˆæœ¬ï¼›positions ä»¥æ­¤æ¨å°å€‰ä½å¯¦éš›å·²å ç”¨çš„åˆå§‹ä¿è­‰é‡‘ã€‚

### leverage

- positions.`leverage` æ˜¯å€‰ä½è‡ªå·±çš„æ¬„ä½ã€‚
    - ç”¨æˆ¶åœ¨ä¸‹å–®/èª¿æ•´æ§“æ¡¿æ™‚æœƒæŠŠå¸Œæœ›çš„å€æ•¸å¸¶åˆ° order â†’ risk-margin çš„é æª¢æµç¨‹ï¼›
    - risk-margin æœƒæ ¹æ“š instrument_metadata.max_leverage èˆ‡è©²äº¤æ˜“å°çš„risk_limits.max_leverage
      é©—è­‰åˆæ³•æ€§ï¼Œå…©è€…éƒ½å®šç¾©äº†æ¯å€‹å•†å“/é¢¨éšªç­‰ç´šå…è¨±çš„æœ€å¤§æ§“æ¡¿ ã€‚
    - é æª¢é€šéå¾Œï¼Œpositions åœ¨å»ºç«‹/èª¿æ•´å€‰ä½æ™‚å°±æŠŠé€™å€‹å€æ•¸è½åˆ° leverage æ¬„ä½ï¼Œ
    - å¾ŒçºŒè‹¥ä½¿ç”¨è€…åœ¨ UI è®Šæ›´æ§“æ¡¿ï¼ŒåŒæ¨£èµ°é æª¢ä¸¦æ›´æ–°é€™å€‹æ¬„ä½ã€‚

### margin

- å€‰ä½ä¿è­‰é‡‘æ¬„ä½: ä¸€æ—¦é æª¢å®Œæˆä¸”å¸³æœ¬å‡çµæˆåŠŸï¼Œpositions æ”¶åˆ°æˆäº¤äº‹ä»¶å¾ŒæŸ¥å€‰ä½ã€è¨ˆç®—æ–° quantity/entry_priceï¼Œå†ä¾
  `margin = cost_basis / leverage` ç®—å‡ºå€‰ä½å ç”¨çš„åˆå§‹ä¿è­‰é‡‘ï¼Œä¸¦å°‡ `margin_ratio = equity / market_notional` ä½œç‚ºæ§“æ¡¿å®‰å…¨åº¦æŒ‡æ¨™ã€‚

### equity

é€å€‰æ¨¡å¼
equity = margin_balance + unrealized_pnlï¼Œè€Œ margin_balance ç­‰åŒè©²å€‰ä½è‡ªæœ‰ä¿è­‰é‡‘

### margin_ratio

`margin_ratio = equity / market_notional`ï¼Œè¡Œæƒ…æˆ–ä¿è­‰é‡‘è®Šå‹•æ™‚çš†éœ€æ›´æ–°ã€‚

(margin_balance + unrealized_pnl ) / abs(mark_price * quantity)`

### liquidation_price

è®Šæ•¸å®šç¾©

- `entryPrice`  
  é–‹å€‰åƒ¹æ ¼ï¼ˆæ¯ä¸€å–®ä½æ¨™çš„çš„åƒ¹æ ¼ï¼‰
- `positionQuantity`  
  å€‰ä½æ•¸é‡ï¼ˆä¾‹å¦‚åˆç´„å¼µæ•¸ã€BTC æ•¸é‡ç­‰ï¼‰
- `isolatedMarginAmount`  
  åˆ†é…çµ¦æ­¤é€å€‰å€‰ä½çš„ä¿è­‰é‡‘ç¸½é‡‘é¡
- `maintenanceMarginRate`  
  ç¶­æŒä¿è­‰é‡‘ç‡ï¼ˆä¾‹å¦‚ 0.005 ä»£è¡¨ 0.5%ï¼‰
- `marginPerUnit`  
  æ¯ä¸€å–®ä½æ¨™çš„å°æ‡‰çš„ä¿è­‰é‡‘é‡‘é¡

---

æ¯å–®ä½ä¿è­‰é‡‘é‡‘é¡

```text
marginPerUnit = isolatedMarginAmount / positionQuantity
```

---

å¤šå–®å¼·å¹³åƒ¹æ ¼å…¬å¼

å¤šå–®é€å€‰å€‰ä½çš„å¼·å¹³åƒ¹æ ¼ï¼š

```text
liquidationPrice_Long = (entryPrice - marginPerUnit) / (1 - maintenanceMarginRate)
```

---

ç©ºå–®å¼·å¹³åƒ¹æ ¼å…¬å¼

ç©ºå–®é€å€‰å€‰ä½çš„å¼·å¹³åƒ¹æ ¼ï¼š

```text
liquidationPrice_Short = (entryPrice + marginPerUnit) / (1 + maintenanceMarginRate)
```

---

### å¯¦ç¾èˆ‡æœªå¯¦ç¾ç›ˆè™§è¨ˆç®—

æœªå¯¦ç¾ç›ˆè™§ï¼ˆæµ®å‹•ç›ˆè™§ï¼‰

- å…¬å¼ï¼š

  ```
  unrealized_pnl = (mark_price - entry_price) * position_qty * contract_size
  ```

- `mark_price` ä¾†è‡ªæœ€æ–°çš„ `MarkPriceUpdated` äº‹ä»¶ï¼Œ`entry_price` ç‚ºå€‰ä½åŠ æ¬Šæˆæœ¬ï¼›`contract_size` è¦–æ°¸çºŒåˆç´„é¢é¡æ±ºå®šï¼ˆä¾‹ï¼š1
  USD æˆ– 0.001 BTCï¼‰ã€‚
- `positions` æœƒç¶­è­· `MarkPriceCache`ï¼Œäº‹ä»¶åˆ°é”å¾Œç«‹å³åˆ·æ–° `mark_price` èˆ‡ `unrealized_pnl`ï¼Œä¸¦å°‡çµæœå¯«å…¥è³‡æ–™åº«èˆ‡å¾ŒçºŒäº‹ä»¶ã€‚
- å¤šå€‰ï¼šåƒ¹æ ¼ä¸Šæ¼² â†’ ç›ˆåˆ©ï¼›ä¸‹è·Œ â†’ è™§æã€‚
- ç©ºå€‰ï¼šåƒ¹æ ¼ä¸Šæ¼² â†’ è™§æï¼›ä¸‹è·Œ â†’ ç›ˆåˆ©ï¼ˆè¨ˆç®—æ™‚ `position_qty` ç‚ºè² å€¼ï¼Œè‡ªç„¶åæ˜ æ–¹å‘ï¼‰ã€‚

---

å¯¦ç¾ç›ˆè™§ï¼ˆå¹³å€‰æ™‚ï¼‰

```
realized_pnl = (close_price - entry_price) * closed_qty
```

æ›´æ–°å¾Œï¼š

```
position_qty -= closed_qty
entry_price ä¿æŒæˆ–é‡æ–°è¨ˆç®—
```

## âœ”ï¸POST `/api/positions/{instrumentId}/leverage`

Position æœå‹™æ”¶åˆ°æ­¤è«‹æ±‚æ™‚ï¼Œæœƒå‘¼å« `POST /api/risk/precheck/leverage` é€²è¡Œé æª¢ï¼Œç¢ºèªç›®æ¨™æ§“æ¡¿ç¬¦åˆ `risk_limits` èˆ‡ä¿è­‰é‡‘è¦æ±‚ï¼›
åƒ…åœ¨é¢¨æ§å…è¨±æ™‚æ›´æ–° `positions.leverage` ä¸¦å¯«å…¥äº‹ä»¶


## âœ”ï¸Event Inputï¼š`PositionReserveRequested`

å¹³å€‰å§”è¨—é å…ˆå‡çµå€‰ä½ï¼Œpositions æœå‹™æ¥ç²è«‹æ±‚å¾Œæœƒï¼š

1. é©—è­‰ç•¶å‰å€‰ä½å¯ç”¨æ•¸é‡ (`quantity - closing_reserved_quantity`) æ˜¯å¦è¶³å¤ ã€‚
2. é€šéæ¨‚è§€é–æˆ–è¡Œç´šé–æ›´æ–° `closing_reserved_quantity`ï¼Œä»¥è¨˜éŒ„æœ¬æ¬¡å¹³å€‰å ç”¨çš„å€‰ä½æ•¸é‡ã€‚
3. åœ¨ `position_events` ä¸­æ–°å¢ä¸€ç­† `POSITION_RESERVED` æˆ–å°æ‡‰äº‹ä»¶ï¼Œå¯«å…¥æœ€æ–°çš„ `new_reserved_quantity`ï¼Œä¾›ä¹‹å¾Œæ¢å¾©æˆ–ç¨½æ ¸ã€‚

è‹¥å¹³å€‰å§”è¨—å–æ¶ˆæˆ–å¤±æ•—ï¼ŒSaga/è£œå„Ÿæµç¨‹éœ€è¦å°æ‡‰é‡‹æ”¾ `closing_reserved_quantity`ï¼ŒåŒæ¨£è½åº«äº‹ä»¶ã€‚

## âœ”ï¸Event Inputï¼š`TradeExecuted`

ç•¶ `matching` æ’®åˆæˆåŠŸç™¼å¸ƒæˆäº¤äº‹ä»¶å¾Œï¼Œ`positions` æ¶ˆè²»å®ƒä¾†æ›´æ–°å€‰ä½çš„ï¼š`
`marginã€sideã€entry_priceã€quantityã€mark_priceã€margin_ratioã€unrealized_pnlã€liquidation_price`

é–‹/å¹³å€‰è™•ç†æµç¨‹:

- æ¶ˆè²»äº‹ä»¶: positions æœå‹™ç›£è½ä¸¦æ¥æ”¶åˆ° TradeExecuted äº‹ä»¶
- æŸ¥æ‰¾æˆ–å»ºç«‹å€‰ä½:
    * æ ¹æ“šäº‹ä»¶ä¸­çš„ `userId`, `instrument_id` (äº¤æ˜“å°) å’Œ `side` (æ–¹å‘ï¼Œå¤š/ç©º)ï¼ŒæŸ¥æ‰¾å°æ‡‰çš„ç¾æœ‰å€‰ä½ã€‚
    * å¦‚æœå€‰ä½ä¸å­˜åœ¨ (å³ç‚ºé–‹å€‰äº¤æ˜“)ï¼Œå‰‡å»ºç«‹ä¸€ç­†æ–°çš„å€‰ä½ç´€éŒ„ã€‚
 * æ›´æ–°æ•¸é‡: 
        * é–‹å€‰ ï¼š`quantity` `=` `èˆŠæ•¸é‡` `+` `æœ¬æ¬¡é–‹å€‰æ•¸é‡` 
        * å¹³å€‰ï¼š`quantity` `=` `èˆŠæ•¸é‡` `-` `æœ¬æ¬¡å¹³å€‰æ•¸é‡`  
- é–‹å€‰æ›´æ–°å¹³å‡é–‹å€‰åƒ¹æ ¼
        * `entry_price` `=` `(èˆŠé–‹å€‰åƒ¹` `*` `èˆŠæ•¸é‡` `+` `æœ¬æ¬¡æˆäº¤åƒ¹` `*` `æœ¬æ¬¡æˆäº¤æ•¸é‡)` `/` `æ–°æ•¸é‡`
- å¹³å€‰ï¼š
    - closing_reserved_quantity çš„æ•¸é‡è‹¥è¶³å¤ ï¼Œå°±å°‡ quantity èˆ‡ closing_reserved_quantity éƒ½æ‰£é™¤å¹³å€‰æ•¸é‡
    - æª¢æŸ¥è‹¥å€‰ä½æ•¸é‡ç‚º0 ï¼Œå°‡è©²å€‰ä½ç‹€æ…‹æ›´æ–°ç‚º CLOSEDã€‚ä¸¦ç™¼ä½ˆ`PositionClosed`  äº‹ä»¶
- æ›´æ–° `margin = cost_basis / leverage = abs(entry_price * quantity) / leverage`
- è¨ˆç®—`æœªå¯¦ç¾ç›ˆè™§` `(Unrealized` `PNL)ã€margin_ratio`:
    * å¾æœ¬åœ° `MarkPriceCache` ä¸­è®€å–æœ€æ–°çš„æ¨™è¨˜åƒ¹æ ¼ (`Mark Price`) (è©²åƒ¹æ ¼ç”± `MarkPriceUpdated` äº‹ä»¶æ›´æ–°)ã€‚
    * è‹¥æš«ç„¡è³‡æ–™å‰‡ä¿ç•™ä¸Šä¸€ç­†æ¨™è¨˜åƒ¹ï¼Œå‰‡ä¸è™•ç†ï¼Œè·³éä»¥ä¸‹è¨ˆç®—ï¼Œå¾…äº‹ä»¶æŠµé”æ™‚å†åˆ·æ–°ã€‚
    * `æœªå¯¦ç¾ç›ˆè™§` `=` `(æ¨™è¨˜åƒ¹æ ¼` `-` `æ–°å¹³å‡é–‹å€‰åƒ¹)` `*` `æ–°æ•¸é‡` `*` `åˆç´„é¢å€¼`
    * è¨ˆç®—`margin_ratio`ï¼š`margin_ratio = (equity / market_notional) = (margin + unrealized_pnl ) / (mark_price * quantity)`
- é‡æ–°è¨ˆç®—å¼·å¹³åƒ¹ (`Liquidation` `Price`): æ ¹æ“šæ›´æ–°å¾Œçš„å€‰ä½ã€æ§“æ¡¿å’Œä¿è­‰é‡‘ç‡ï¼Œé‡æ–°è¨ˆç®—å¼·å¹³åƒ¹æ ¼ã€‚
	- æ¯å–®ä½ä¿è­‰é‡‘é‡‘é¡ï¼šmarginPerUnit = isolatedMarginAmount / positionQuantity
	- å¤šå–®é€å€‰å€‰ä½çš„å¼·å¹³åƒ¹æ ¼ï¼šliquidationPrice_Long = (entryPrice - marginPerUnit) / (1 - maintenanceMarginRate)
	- ç©ºå–®å¼·å¹³åƒ¹æ ¼å…¬å¼ï¼šliquidationPrice_Short = (entryPrice + marginPerUnit) / (1 + maintenanceMarginRate)
- æŒä¹…åŒ–å„²å­˜:
    * å°‡æ›´æ–°å¾Œçš„å€‰ä½è³‡è¨Š (æ•¸é‡ã€å‡åƒ¹ã€æœªå¯¦ç¾ç›ˆè™§ç­‰) å„²å­˜åˆ° `positions` è³‡æ–™è¡¨ä¸­ã€‚
    * åœ¨ `position_events` è¡¨ä¸­æ–°å¢ä¸€ç­†äº‹ä»¶ç´€éŒ„ï¼Œç”¨æ–¼å¯©è¨ˆå’Œè¿½è¹¤ã€‚
- ç™¼å¸ƒ `PositionUpdated` äº‹ä»¶: å€‰ä½ç‹€æ…‹æ›´æ–°å¾Œï¼Œç™¼å¸ƒ PositionUpdated äº‹ä»¶ï¼Œ


## âœ”ï¸Event Inputï¼š`LedgerEntryCreated`

æˆäº¤äº‹ä»¶

- `EntryType` ï¼š`TRADE_SETTLEMENT_SPOT_MAIN_PNL`
- æ›´æ–°å€‰ä½çš„ï¼š`å·²å¯¦ç¾ç›ˆè™§`
- ç´€éŒ„ position_event



---

è³‡é‡‘è²»ç‡çµç®— (Funding Fee Settlement)

* `referenceType`: `FUNDING_FEE`
* æ ¸å¿ƒç›®çš„: è™•ç†å¤šç©ºé›™æ–¹ä¹‹é–“å®šæœŸæ”¯ä»˜çš„è³‡é‡‘è²»ç”¨ã€‚é€™æ˜¯ä¸€ç­†ç›´æ¥çš„ç¾é‡‘è½‰ç§»ï¼Œæœƒç›´æ¥å½±éŸ¿å€‰ä½çš„ç¸½ç›ˆè™§ã€‚
* Positions æœå‹™çš„è™•ç†:
    * æ ¹æ“šäº‹ä»¶ä¸­çš„é‡‘é¡ (æ­£æ•¸æˆ–è² æ•¸)ï¼Œç›´æ¥ç´¯åŠ åˆ°å€‰ä½çš„å·²å¯¦ç¾ç›ˆè™§ (`realized_pnl`) ä¸Šã€‚
    * æ³¨æ„: è³‡é‡‘è²»ç‡ä¸å½±éŸ¿å€‰ä½çš„å¹³å‡é–‹å€‰åƒ¹ (entry_price)ï¼Œä½†å®ƒæœƒæ”¹è®Šå€‰ä½çš„ç¸½é«”ç›ˆåˆ©ç‹€æ³ã€‚
    * è¨˜éŒ„ä¸€ç­†æ–°çš„ position_eventsï¼Œé¡å‹ç‚º FUNDINGï¼Œä¸¦ç«‹å³æ¨™è¨˜ç‚º SETTLEDã€‚

å¼·åˆ¶å¹³å€‰çµç®— (Liquidation Settlement)

* `referenceType`: `LIQUIDATION`
* æ ¸å¿ƒç›®çš„: ç¢ºèªä¸€ç­†å¼·å¹³è¨‚å–®çš„æœ€çµ‚è²¡å‹™çµæœï¼Œé€™é€šå¸¸åŒ…æ‹¬é¡å¤–çš„å¼·å¹³è²»ç”¨ã€‚
* Positions æœå‹™çš„è™•ç†:
    * é€™æœ¬è³ªä¸Šä¹Ÿæ˜¯ä¸€ç­†äº¤æ˜“ï¼Œæ‰€ä»¥æœƒåƒè™•ç† TRADE é¡å‹ä¸€æ¨£ï¼Œè¨ˆç®—å·²å¯¦ç¾ç›ˆè™§ã€‚
    * LedgerEntryCreated äº‹ä»¶æœƒåæ˜ å‡ºæ‰£é™¤å¼·å¹³è²»ç”¨ (liquidation fee) å¾Œçš„æœ€çµ‚é‡‘é¡ã€‚positions æœå‹™æ‡‰ä½¿ç”¨é€™å€‹æœ€çµ‚é‡‘é¡ä¾†è¨ˆç®—
      PNLï¼Œä»¥ç¢ºä¿æ•¸æ“šçš„æº–ç¢ºæ€§ã€‚
    * è§¸ç™¼ tryToClosePosition() æª¢æŸ¥ï¼Œé€™å¹¾ä¹ç¸½æœƒå°è‡´å€‰ä½é—œé–‰ã€‚

ä¿éšªåŸºé‡‘æ³¨å…¥æˆ–çˆªå› (Insurance Fund Activity)

* `referenceType`: `INSURANCE_FUND`
* æ ¸å¿ƒç›®çš„: åœ¨ç™¼ç”Ÿç©¿å€‰æå¤± (ç”¨æˆ¶é¤˜é¡è®Šç‚ºè² æ•¸) æ™‚ï¼Œç”±ä¿éšªåŸºé‡‘å¡«è£œè™§æã€‚åä¹‹ï¼Œå¦‚æœå¼·å¹³å¾Œæœ‰å‰©é¤˜ï¼Œå¯èƒ½æœƒæ³¨å…¥ä¿éšªåŸºé‡‘ã€‚
* Positions æœå‹™çš„è™•ç†:
    * é€™æ˜¯ä¸€ç­†ç›´æ¥çš„ PNL èª¿æ•´ã€‚positions æœå‹™éœ€è¦æ ¹æ“šäº‹ä»¶é‡‘é¡ï¼Œæ›´æ–°å€‰ä½çš„å·²å¯¦ç¾ç›ˆè™§ (`realized_pnl`)ï¼Œä»¥åæ˜ é€™ç­†ä¾†è‡ªç³»çµ±çš„æ³¨å…¥æˆ–æ‰£é™¤ã€‚

ç³»çµ±æ‰‹å‹•èª¿æ•´ (Manual Adjustments / ADL)

* `referenceType`: `MANUAL_ADJUSTMENT` æˆ– `ADL`
* æ ¸å¿ƒç›®çš„: è™•ç†é‹ç‡Ÿäººå“¡çš„æ‰‹å‹•è³‡é‡‘èª¿æ•´ï¼Œæˆ–è‡ªå‹•æ¸›å€‰ç³»çµ± (ADL) è§¸ç™¼çš„å¹³å€‰ã€‚
* Positions æœå‹™çš„è™•ç†:
    * èˆ‡å…¶ä»–é¡å‹é¡ä¼¼ï¼Œé€™ä¹Ÿæ˜¯å° PNL çš„ç›´æ¥èª¿æ•´ã€‚positions æœå‹™å¿…é ˆæ›´æ–° realized_pnl ä»¥ä¿æŒèˆ‡å¸³æœ¬çš„åŒæ­¥ã€‚

## âœ”ï¸Event Inputï¼š`MarkPriceUpdated`

- `positions` ä»¥ `instrument_id` ç‚º key æ¶ˆè²» `market.mark-price` topic
- æ›´æ–°ç·©å­˜çš„ï¼š
	- `mark_price`
	- å°‡æ¨™è¨˜åƒ¹å¯«å…¥æœ¬åœ° `MarkPriceCache`ï¼Œä¸¦è¨˜éŒ„äº‹ä»¶æ™‚é–“ï¼ˆé˜²æ­¢èˆŠåƒ¹è¦†è“‹æ–°åƒ¹ï¼‰ã€‚

- æ›´æ–° `instrument_id` æ‰€æœ‰ä»ç‚º `OPEN`å€‰ä½ çš„ï¼š
	* `æœªå¯¦ç¾ç›ˆè™§` `=` `(æ¨™è¨˜åƒ¹æ ¼` `-` `æ–°å¹³å‡é–‹å€‰åƒ¹)` `*` `æ–°æ•¸é‡` `*` `åˆç´„é¢å€¼`
    * è¨ˆç®—`margin_ratio`ï¼š`margin_ratio = (equity / market_notional) = (margin + unrealized_pnl ) / (mark_price * quantity)`

- æ›´æ–° `positions` è¡¨èˆ‡ `position_events`ï¼Œåƒ…åœ¨ç›ˆè™§è¶…éé–¾å€¼ï¼ˆå¦‚ notional 0.01%ï¼‰æ™‚è½åº«ï¼Œä»¥æ¸›å°‘å¯«å…¥å£“åŠ›ã€‚
- ç™¼å¸ƒ `PositionUpdated` äº‹ä»¶ä¾›é¢¨æ§ã€å ±è¡¨ä½¿ç”¨ã€‚
- äº‹ä»¶è™•ç†èˆ‡æˆäº¤äº‹ä»¶åˆ†é–‹åŸ·è¡Œï¼Œç¢ºä¿è¡Œæƒ…èˆ‡å€‰ä½è¨ˆç®—äº’ä¸é˜»å¡ï¼›è‹¥è¡Œæƒ…å»¶é²ï¼Œå€‰ä½æœƒä¿ç•™ä¸Šä¸€æ¬¡æ¨™è¨˜åƒ¹èˆ‡ç›ˆè™§ã€‚

## Event Outputï¼š`PositionUpdated`

ç„¡è«–æ˜¯æˆäº¤äº‹ä»¶é‚„æ˜¯ `MarkPriceUpdated` äº‹ä»¶é€ æˆå€‰ä½ç‹€æ…‹æˆ–ç›ˆè™§è®ŠåŒ–ï¼Œåªè¦è¶…éç™¼å¸ƒé–¾å€¼å³æœƒç™¼å¸ƒï¼š

```
PositionUpdated {
  userId,
  instrumentId,
  side,
  quantity,
  
  entryPrice,
  markPrice,
  unrealizedPnl,
  liquidationPrice,
  
  timestamp
}
```

æ¶ˆè²»æ–¹ï¼š

- **risk-margin**ï¼šæ›´æ–°é¢¨éšªä¿‚æ•¸ã€å¼·å¹³æ¢ä»¶ã€‚
- **reporting**ï¼šå¯«å…¥æ­·å²èˆ‡ç›£æ§ç³»çµ±ã€‚
- **market-data**ï¼ˆå¯é¸ï¼‰ï¼šæä¾›å€‰ä½èšåˆè³‡è¨Šï¼ˆå¤šç©ºæ¯”ï¼‰ã€‚

---


# Risk-Margin æœå‹™

## è·è²¬

- `risk-margin` æ¨¡çµ„è² è²¬æ•´å€‹äº¤æ˜“ç³»çµ±çš„**é¢¨éšªè¨ˆç®—èˆ‡ä¿è­‰é‡‘æ§åˆ¶**ï¼Œ å®ƒé€£æ¥æ’®åˆå±¤èˆ‡å€‰ä½å±¤ï¼Œæ˜¯å¯¦æ™‚ç›£æ§ã€Œæ¯ä½ç”¨æˆ¶èƒ½å¦æ‰¿æ“”é¢¨éšªã€çš„æ ¸å¿ƒã€‚
  åœ¨æ’®åˆæˆäº¤å¾Œï¼Œ`risk-margin` æœƒæ ¹æ“šå¯¦éš›æˆäº¤èˆ‡å€‰ä½è®ŠåŒ–å‹•æ…‹èª¿æ•´å„é …é¢¨éšªæŒ‡æ¨™ã€‚
- è¨ˆç®—ä¿è­‰é‡‘èˆ‡é¢¨éšªæŒ‡æ¨™ã€æä¾›ä¸‹å–®å‰é™é¡æ ¡é©—ã€‚
- ç¶­è­·é¢¨æ§è¦å‰‡ç‰ˆæœ¬ã€å»ºç«‹å¼·å¹³ä½‡åˆ—èˆ‡é¢¨éšªå‘Šè­¦ã€‚
- åŸ·è¡Œå¼·å¹³

| é¡åˆ¥     | è·è²¬                                     |
|--------|----------------------------------------|
| **äº‹å‰** | æ¶ˆè²» `OrderSubmitted` äº‹ä»¶é€²è¡Œä¸‹å–®å‰é æª¢ã€è¨ˆç®—éœ€å‡çµä¿è­‰é‡‘ |
| **äº‹å¾Œ** | æ ¹æ“šæŒå€‰èˆ‡æ¨™è¨˜åƒ¹æ ¼å³æ™‚ç›£æ§æ§“æ¡¿ã€ç¶­æŒä¿è­‰é‡‘ç‡èˆ‡å¼·å¹³æ¢ä»¶            |

## endpoint

| å®Œæˆ  | HTTP Method | Endpoint                          | èªªæ˜             | èª¿ç”¨è€…       | æˆæ¬Š      | è¼¸å…¥                                                                                               | è¼¸å‡º                                                          | æœå‹™èª¿ç”¨ | è£œå„Ÿæ©Ÿåˆ¶ |
| --- | ----------- | --------------------------------- | -------------- | --------- | ------- | ------------------------------------------------------------------------------------------------ | ----------------------------------------------------------- | ---- | ---- |
| âœ”ï¸  | POST        | `/api/risk/precheck/leverage`     | æ§“æ¡¿èª¿æ•´é æª¢ï¼Œå›å‚³å…è¨±èˆ‡ç¼ºå£ | positions | private | LeveragePrecheckRequest(positionId,instrumentId,userId,targetLeverage,quantity,margin,markPrice) | LeveragePrecheckResponse(allow, deficit, suggestedLeverage) | -    | -    |
| âœ”ï¸  | GET         | `/api/risk/limits/{instrumentId}` | æŸ¥è©¢æŒ‡å®šäº¤æ˜“å°çš„é¢¨éšªé™åˆ¶é…ç½® | positions | private | path: instrumentId                                                                               | RiskLimitResponse                                           | -    | -    |

## events

**äº‹ä»¶æ¶ˆè²»**:

| å®Œæˆ | ä¾†æºæœå‹™        | Topic             | äº‹ä»¶                 | è™•ç†é‚è¼¯           | äº‹ä»¶ç™¼å¸ƒ                                            | DBæ“ä½œ | ç·©å­˜æ“ä½œ | æœå‹™èª¿ç”¨ | è£œå„Ÿæ©Ÿåˆ¶ |
|----|-------------|-------------------|--------------------|----------------|-------------------------------------------------|------|------|------|------|
|    | order       | order.submitted   | `OrderSubmitted`   | æ ¹æ“šå§”è¨—è³‡è¨Šè©¦ç®—ä¿è­‰é‡‘èˆ‡é¢¨éšª | `MarginPreCheckPassed` / `MarginPreCheckFailed` | -    | -    | -    | -    |
|    | positions   | positions.updated | `PositionUpdated`  | æ›´æ–°ç”¨æˆ¶é¢¨éšªæŒ‡æ¨™èˆ‡ç‹€æ…‹    | `RiskUpdate`                                    | -    | -    | -    | -    |
|    | market-data | market.mark-price | `MarkPriceUpdated` | é‡æ–°è¨ˆç®—ç¶­æŒä¿è­‰é‡‘ç‡èˆ‡å¼·å¹³åƒ¹ | `RiskUpdate` / `LiquidationTriggered`           | -    | -    | -    | -    |

**äº‹ä»¶ç™¼å¸ƒ**:

| å®Œæˆ | ç™¼å¸ƒå ´æ™¯      | Topic                      | äº‹ä»¶åç¨±                   | äº‹ä»¶å…§å®¹                                                        | æ¶ˆè²»è€…                                  |
|----|-----------|----------------------------|------------------------|-------------------------------------------------------------|--------------------------------------|
|    | ä¸‹å–®å‰é¢¨éšªæª¢æŸ¥é€šé | risk.margin-check-passed   | `MarginPreCheckPassed` | orderId, requiredMargin                                     | account-ledger                       |
|    | ä¸‹å–®å‰é¢¨éšªæª¢æŸ¥å¤±æ•— | risk.margin-check-failed   | `MarginPreCheckFailed` | orderId, reason                                             | order                                |
|    | é‡æ–°è¨ˆç®—é¢¨éšªæŒ‡æ¨™  | risk.update                | `RiskUpdate`           | userId, instrumentId, marginRatio, liquidationPrice, status | order, liquidation-worker, reporting |
|    | è§¸ç™¼å¼·å¹³æµç¨‹    | risk.liquidation-triggered | `LiquidationTriggered` | positionId, userId, instrumentId, reason                    | liquidation-worker                   |

---

## è³‡æ–™è¡¨DDL

### risk_limits è¡¨

```sql
CREATE TABLE risk_limits
(
    id                      BIGINT         NOT NULL COMMENT 'è¨˜éŒ„ID (Snowflake)',
    instrument_id           BIGINT         NOT NULL COMMENT 'äº¤æ˜“å°ID (å¤–éµé—œè¯ instruments.id)',

    # é–‹å€‰
    initial_margin_rate     DECIMAL(10, 4) NOT NULL COMMENT 'åˆå§‹ä¿è­‰é‡‘ç‡ (é–‹å€‰æ‰€éœ€, å¦‚0.01è¡¨ç¤º1%)',
    max_leverage            INT            NOT NULL COMMENT 'æœ€å¤§æ§“æ¡¿å€æ•¸',

    # å¼·å¹³
    maintenance_margin_rate DECIMAL(10, 4) NOT NULL COMMENT 'ç¶­æŒä¿è­‰é‡‘ç‡ (ä½æ–¼æ­¤å€¼è§¸ç™¼å¼·å¹³, å¦‚0.005è¡¨ç¤º0.5%)',
    liquidation_fee_rate    DECIMAL(10, 4) NOT NULL DEFAULT 0.005 COMMENT 'å¼·å¹³æ‰‹çºŒè²»ç‡',

    # å€‰ä½é™åˆ¶
    position_size_min       DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'å€‰ä½è¦æ¨¡ä¸‹é™ (USDT)',
    position_size_max       DECIMAL(20, 8) NULL COMMENT 'å€‰ä½è¦æ¨¡ä¸Šé™ (USDT, NULLè¡¨ç¤ºç„¡ä¸Šé™)ï¼Œé™åˆ¶å–®å¸³æˆ¶æœ€å¤§æŒå€‰é‡ï¼Œèˆ‡åƒ¹æ ¼ç„¡é—œã€‚',
    max_position_value      DECIMAL(20, 8) NULL COMMENT 'å–®ä¸€å€‰ä½æœ€å¤§åç¾©åƒ¹å€¼é™åˆ¶ï¼Œå·²æœ‰å€‰ä½ï¼Œä¸å› ä¸Šæ¼²è€Œè¢«å¼·åˆ¶æ¸›å€‰ï¼Œç¦æ­¢å†å¢åŠ å€‰ä½',
    max_order_value         DECIMAL(20, 8) NULL COMMENT 'å–®ç­†è¨‚å–®æœ€å¤§åç¾©åƒ¹å€¼é™åˆ¶',

    is_active               BOOLEAN        NOT NULL DEFAULT TRUE COMMENT 'æ˜¯å¦å•Ÿç”¨',
    created_at              DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‰µå»ºæ™‚é–“',
    updated_at              DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    PRIMARY KEY (id),
    UNIQUE KEY uk_instrument (instrument_id) COMMENT 'åŒä¸€äº¤æ˜“å°åƒ…æœ‰ä¸€æ¢è¦å‰‡'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='é¢¨æ§åƒæ•¸è¡¨ - ä¸‹å–®å‰ä¿è­‰é‡‘èˆ‡é™é¡åˆ¤æ–·ä¾æ“š';

CREATE INDEX idx_instrument_active ON risk_limits (instrument_id, is_active) COMMENT 'æŸ¥è©¢äº¤æ˜“å°æœ‰æ•ˆé¢¨æ§åƒæ•¸';
```

åƒ…æä¾›æŸ¥è©¢
å¯«å…¥ç”¨SQLäººå·¥æ’å…¥

### risk_snapshots è¡¨

```sql
CREATE TABLE risk_snapshots
(
    id                      BIGINT          NOT NULL COMMENT 'è¨˜éŒ„ID (Snowflake)',
    user_id                 BIGINT          NOT NULL COMMENT 'ç”¨æˆ¶ID',
    risk_version            BIGINT          NULL COMMENT 'å‘½ä¸­çš„é¢¨æ§è¦å‰‡ç‰ˆæœ¬ (risk_limits.id)',
    account_id              BIGINT          NULL COMMENT 'å¸³æˆ¶ID (è¡ç”Ÿäº¤æ˜“å¸³æœ¬)',
    instrument_id           BIGINT          NOT NULL COMMENT 'äº¤æ˜“å°ID',
    maintenance_margin_rate DECIMAL(10, 4)  NOT NULL COMMENT 'ç¶­æŒä¿è­‰é‡‘ç‡å¿«ç…§',

    # position äº‹ä»¶æ›´æ–°
    position_id             BIGINT          NULL COMMENT 'å€‰ä½ID (å¯é¸, æ–¹ä¾¿è¿½è¹¤)',
    used_margin             DECIMAL(30, 12) NOT NULL COMMENT 'å¯¦éš›ä½”ç”¨ä¿è­‰é‡‘',
    equity                  DECIMAL(30, 12) NOT NULL COMMENT 'equity = margin_balance + unrealized_pnlï¼›margin_balance ç­‰åŒè©²å€‰ä½è‡ªæœ‰ä¿è­‰é‡‘',
    notional_value          DECIMAL(30, 12) NOT NULL COMMENT 'market_notional = abs(mark_price * quantity)',
    margin_ratio            DECIMAL(18, 8)  NOT NULL COMMENT 'ä¿è­‰é‡‘ç‡ (equity / market_notional)',
    liquidation_price       DECIMAL(30, 12) NULL COMMENT 'é ä¼°å¼·å¹³åƒ¹',


    status                  VARCHAR(32)     NOT NULL COMMENT 'NORMAL/ALERT/MARGIN_CALL/LIQUIDATION_PENDING',

    snapshot_source         VARCHAR(32)     NOT NULL DEFAULT 'POSITION_UPDATED' COMMENT 'å¿«ç…§ä¾†æºäº‹ä»¶',
    snapshot_at             DATETIME        NOT NULL COMMENT 'å¿«ç…§æ™‚é–“ (äº‹ä»¶æ™‚é–“æˆ³)',
    created_at              DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‰µå»ºæ™‚é–“',
    updated_at              DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    PRIMARY KEY (id),
    UNIQUE KEY uk_user_instrument (user_id, instrument_id) COMMENT 'åŒä¸€ç”¨æˆ¶+äº¤æ˜“å°åƒ…ä¿ç•™æœ€æ–°ç´€éŒ„'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='ä¿è­‰é‡‘èˆ‡é¢¨éšªæŒ‡æ¨™å¿«ç…§';

CREATE INDEX idx_user_status ON risk_snapshots (user_id, status, snapshot_at DESC) COMMENT 'æŸ¥è©¢ç”¨æˆ¶é¢¨éšªç‹€æ…‹';
CREATE INDEX idx_instrument_snapshot ON risk_snapshots (instrument_id, snapshot_at DESC) COMMENT 'äº¤æ˜“å°é¢¨éšªç›£æ§';
CREATE INDEX idx_snapshot_source ON risk_snapshots (snapshot_source, snapshot_at DESC) COMMENT 'ä¾äº‹ä»¶ä¾†æºè¿½è¹¤å¿«ç…§';
```

#### status

- NORMAL  
  ä¿è­‰é‡‘ç‡é«˜æ–¼ç¶­æŒä¿è­‰é‡‘ç‡ã€‚å®‰å…¨ã€‚
    - å…è¨±ä¸‹å–®
    - å…è¨±åŠ å€‰
    - ä¸å‹•ä½œ
- ALERT  
  ä¿è­‰é‡‘ç‡æ¥è¿‘ç¶­æŒä¿è­‰é‡‘ç‡ã€‚æé†’ã€‚
    - å…è¨±ä¸‹å–®
    - å¼·åˆ¶æç¤º
    - ä¸å¼·å¹³
- MARGIN_CALL  
  ä¿è­‰é‡‘ç‡ä½æ–¼ç¶­æŒä¿è­‰é‡‘ç‡ã€‚éœ€è£œä¿ã€‚
    - ç¦æ­¢åŠ å€‰
    - åƒ…å…è¨±æ¸›å€‰
    - æç¤ºè£œä¿
- LIQUIDATION_PENDING  
  è§¸ç™¼å¼·å¹³ã€‚ç­‰å¾…è™•ç†ã€‚
    - èª¿ç”¨æ¸…ç®—
    - å¿…è¦æ™‚éƒ¨åˆ†æˆ–å…¨å€‰å¼·å¹³

### liquidation_queue è¡¨ - å¼·å¹³ä½‡åˆ—

```sql
CREATE TABLE liquidation_queue
(
    id                BIGINT         NOT NULL COMMENT 'å¼·å¹³ä»»å‹™ID (Snowflake)',
    position_id       BIGINT         NOT NULL COMMENT 'å€‰ä½ID (å¤–éµé—œè¯ positions.position_id)',
    user_id           BIGINT         NOT NULL COMMENT 'ç”¨æˆ¶ID (å†—é¤˜æ¬„ä½ä¾¿æ–¼æŸ¥è©¢)',
    instrument_id     BIGINT         NOT NULL COMMENT 'äº¤æ˜“å°ID (å†—é¤˜æ¬„ä½ä¾¿æ–¼æŸ¥è©¢)',

    # å¼·å¹³ç‹€æ…‹
    status            VARCHAR(20)    NOT NULL DEFAULT 'PENDING' COMMENT 'ç‹€æ…‹: PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED',
    liquidation_type  VARCHAR(20)    NOT NULL COMMENT 'å¼·å¹³é¡å‹: MARGIN_CALL, FORCED_LIQUIDATION, ADL',
    priority          INT            NOT NULL DEFAULT 5 COMMENT 'å„ªå…ˆç´š (1-10, æ•¸å­—è¶Šå°å„ªå…ˆç´šè¶Šé«˜)',
    queued_at         DATETIME       NOT NULL COMMENT 'åŠ å…¥ä½‡åˆ—æ™‚é–“',

    # å¼·å¹³æ¯æ¯
    trigger_price     DECIMAL(20, 8) NOT NULL COMMENT 'è§¸ç™¼å¼·å¹³æ™‚çš„æ¨™è¨˜åƒ¹æ ¼',
    position_quantity DECIMAL(20, 8) NOT NULL COMMENT 'å¾…å¼·å¹³æ•¸é‡',
    margin_ratio      DECIMAL(10, 4) NOT NULL COMMENT 'è§¸ç™¼æ™‚çš„ä¿è­‰é‡‘ç‡',
    reason            VARCHAR(255)   NOT NULL COMMENT 'å¼·å¹³åŸå› ',

    # è™•ç†ä¿¡æ¯
    started_at        DATETIME       NULL COMMENT 'é–‹å§‹è™•ç†æ™‚é–“',
    processed_at      DATETIME       NULL COMMENT 'å®Œæˆè™•ç†æ™‚é–“',
    liquidation_price DECIMAL(20, 8) NULL COMMENT 'å¯¦éš›å¼·å¹³æˆäº¤åƒ¹æ ¼',
    liquidation_pnl   DECIMAL(20, 8) NULL COMMENT 'å¼·å¹³ç›ˆè™§',
    error_message     TEXT           NULL COMMENT 'å¤±æ•—åŸå› ',
    retry_count       INT            NOT NULL DEFAULT 0 COMMENT 'é‡è©¦æ¬¡æ•¸',
    max_retries       INT            NOT NULL DEFAULT 3 COMMENT 'æœ€å¤§é‡è©¦æ¬¡æ•¸',

    created_at        DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'è¨˜éŒ„å‰µå»ºæ™‚é–“',
    updated_at        DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    PRIMARY KEY (id)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='å¼·å¹³ä½‡åˆ—è¡¨ - è¿½è¹¤å¼·å¹³æ’ç¨‹èˆ‡è™•ç†ç‹€æ…‹';

CREATE INDEX idx_status_priority ON liquidation_queue (status, priority ASC, queued_at ASC) COMMENT 'å¼·å¹³å¼•æ“æŒ‰å„ªå…ˆç´šè™•ç†';
CREATE INDEX idx_position ON liquidation_queue (position_id, status) COMMENT 'æŸ¥è©¢å€‰ä½å¼·å¹³ç‹€æ…‹';
CREATE INDEX idx_user_status ON liquidation_queue (user_id, status) COMMENT 'æŸ¥è©¢ç”¨æˆ¶å¼·å¹³æ­·å²';
CREATE INDEX idx_instrument_queued ON liquidation_queue (instrument_id, queued_at DESC) COMMENT 'æŸ¥è©¢äº¤æ˜“å°å¼·å¹³è¨˜éŒ„';
CREATE INDEX idx_queued_at ON liquidation_queue (queued_at DESC) COMMENT 'æ™‚åºæŸ¥è©¢å¼·å¹³äº‹ä»¶';
```

## risk_limits è¡¨ é…ç½®

### åˆå§‹ä¿è­‰é‡‘  >= ç¶­æŒä¿è­‰é‡‘ç‡

### æ§“æ¡¿å€æ•¸ max_leverage â‰ˆ 1 / åˆå§‹ä¿è­‰é‡‘

- é€™å¥è©±çš„æ„æ€æ˜¯ï¼šç•¶å•†å“è¨­å®šçš„åˆå§‹ä¿è­‰é‡‘ç‡ï¼ˆInitial Margin Rateï¼‰ç‚º IMRï¼ˆä¾‹å¦‚ 5%ï¼‰ï¼ŒåŒä¸€æª”å•†å“æ‰€å…è¨±çš„æœ€å¤§æ§“æ¡¿ max_leverage
  æœƒè¿‘ä¼¼ç­‰æ–¼ 1 / IMRï¼ˆç´„ 20å€ï¼‰ã€‚
- åŸç†ï¼šé–‹å€‰éœ€æ±‚çš„ä¿è­‰é‡‘ = å€‰ä½åç¾©åƒ¹å€¼ Ã— åˆå§‹ä¿è­‰é‡‘ç‡ï¼Œè€Œæ§“æ¡¿ = å€‰ä½åç¾©åƒ¹å€¼ Ã· ä¿è­‰é‡‘ã€‚å¦‚æœæŠŠé€™å…©å€‹å…¬å¼äº’æ›ï¼Œå°±æœ‰
  required_margin = notional / leverageå’Œ required_margin = notional * IMRï¼Œè‹¥é¢¨æ§å¸Œæœ›ã€Œä»¥ç›®æ¨™æ§“æ¡¿è¨ˆç®—å‡ºçš„ä¿è­‰é‡‘ä¸ä½æ–¼åˆå§‹ä¿è­‰é‡‘ç‡ã€ï¼Œå°±è®“
  notional / max_leverage â‰ˆ notional * IMRï¼ŒåŒ–ç°¡å¾Œå³max_leverage â‰ˆ 1 / IMRã€‚
- é€™åªæ˜¯ä¸€ç¨®å¸¸è¦‹é…ç½®æ–¹å¼ï¼šç¢ºä¿ä½¿ç”¨è€…æŠŠæ§“æ¡¿æ‹‰åˆ°ä¸Šé™æ™‚ï¼Œæœ€ä½è¦æ”¾çš„ä¿è­‰é‡‘ä»ç­‰æ–¼åˆå§‹ä¿è­‰é‡‘ç‡ã€‚å¯¦éš›ä¸Šå¯ä»¥ä¿ç•™ç·©è¡ï¼ˆä¾‹å¦‚
  max_leverage <= 0.9 / IMRï¼‰ï¼Œæˆ–è®“ä¸åŒé¢¨éšªåˆ†å±¤èª¿æ•´æ¯”ä¾‹ï¼Œä½†åœ¨è¨­è¨ˆä¸Šç”¨é€™å€‹é—œä¿‚æ–¹ä¾¿ç›´è§€åœ°æ¨å°å¯ç”¨çš„æ§“æ¡¿ä¸Šé™ã€‚

## 

## `POST /api/risk/precheck/leverage`

1. Position æœå‹™å°‡ç›®æ¨™æ§“æ¡¿ã€ç”¨æˆ¶/å•†å“ï¼ˆuserId + instrumentIdï¼‰ã€å€‰ä½æ•¸é‡ä»¥åŠæœ€æ–° `margin`ã€`markPrice` ä¸€ä½µå¸¶å…¥
   `LeveragePrecheckRequest`ã€‚
2. `risk-margin` ä¾ç…§ `risk_limits` é‡æ–°è¨ˆç®—ï¼š
    - å…ˆé©—è­‰ç›®æ¨™æ§“æ¡¿æ˜¯å¦åœ¨ `max_leverage` å…è¨±ç¯„åœå…§ã€‚
    - `notional = markPrice * quantity`
    - ä»¥`requiredMargin = max(notional / targetLeverage, notional * initial_margin_rate)` è¨ˆç®—éœ€æ±‚ã€‚
    - æ¨¡æ“¬ `requiredMargin / notional` æ˜¯å¦ä»é«˜æ–¼ `maintenance_margin_rate + buffer`ã€‚
    - ä»¥ä¸ŠäºŒå¼ï¼Œä»£è¡¨èª¿æ•´æ§“æ¡¿å¾Œä¸å¾—ä½æ–¼ç¶­æŒä¿è­‰é‡‘ç‡ï¼Œä¸”åˆå§‹ä¿è­‰é‡‘ç‡éœ€é«˜æ–¼ç¶­æŒä¿è­‰é‡‘ç‡
3. è‹¥ä»»ä¸€æ­¥é©Ÿä¸ç¬¦ï¼Œå›å‚³ `allow=false` ä¸¦é™„ç¼ºå£ï¼å»ºè­°æ§“æ¡¿ï¼›é€šéå‰‡ `allow=true`ï¼ŒPosition å¾—ä»¥æ›´æ–° `positions.leverage`ã€‚
4. ç•¶ `notional` = 0 æ™‚ï¼Œä»£è¡¨é¦–æ¬¡é–‹å€‰å‰é…ç½®çš„æ§“æ¡¿ï¼Œå›å‚³é€šé `allow=true`
5. positions.margin è¢«è¦–ç‚ºè¡ç”Ÿæ¬„ä½ï¼šç•¶çœŸæ­£ç™¼ç”Ÿæˆäº¤ã€å€‰ä½æ•¸é‡ï¼å‡åƒ¹æ”¹è®Šæ™‚ï¼ŒPosition æœå‹™æ‰æœƒä¾
   `margin = abs(entry_price * quantity) / leverage`ï¼ˆäº¦å³ `cost_basis / leverage`ï¼‰é‡æ–°è¨ˆç®—ä¸¦å…¥åº«ï¼ŒåŒæ­¥æ›´æ–°
   `margin_ratio = equity / market_notional`ã€‚å–®ç´”ä¿®æ”¹æ§“æ¡¿ä¸¦ä¸æœƒé©…å‹•é€™å€‹æµç¨‹ï¼Œå› æ­¤ä¸æœƒè‡ªå‹•èª¿æ•´ marginã€‚
6. è³‡é‡‘é‡‹æ”¾ï¼ä½”ç”¨çš„å¯¦éš›çµæœç”±å¸³æœ¬ï¼ˆledgerï¼‰è² è²¬ï¼›è‹¥æ²’æœ‰é€éæˆäº¤ã€æ’¤å–®æˆ–å…¶ä»– ledger æŒ‡ä»¤å»æ”¹è®Šå‡çµé¡ï¼ŒPosition
   æœå‹™ä¹Ÿç„¡å¾æŠŠå·®é¡ã€Œé€€å›å¸³æˆ¶ã€ã€‚å› æ­¤ã€Œæé«˜æ§“æ¡¿å°±é‡‹æ”¾ä¿è­‰é‡‘ã€éœ€è¦é¡å¤–çš„å¸³æœ¬äº¤æ˜“èˆ‡äº‹ä»¶é…åˆï¼Œç›®å‰çš„ç¨‹å¼èˆ‡è¦æ ¼éƒ½é‚„æ²’æœ‰é€™æ®µæµç¨‹ã€‚

## Event Inputï¼š `OrderSubmitted`

1. **æ¥æ”¶äº‹ä»¶**ï¼šlistener å–å¾— `OrderSubmitted` payloadï¼ˆåŒ…å« userIdã€instrumentIdã€price/quantityã€sideã€type ç­‰ï¼‰ã€‚
2. **å–å¾—é¢¨æ§åŸºæº–**ï¼š `risk_limits`
3. å–å¾—å€‰ä½å¿«ç…§ï¼š POSITION `/api/positions/{userId}/{instrumentId}`ï¼Œä¸¦è®€å–å€‰ä½ç•¶å‰çš„ `leverage`ã€‚
4. **é©—è­‰æ§“æ¡¿**ï¼šè‹¥è©²å€‰ä½çš„ `leverage` è¶…å‡º `risk_limits.max_leverage` ç«‹å³å›è¦† `MarginPreCheckFailed`ã€‚
5. **è¨ˆç®—å§”è¨—åç¾©åƒ¹å€¼**ï¼š`order_notional = price * quantity`ï¼ˆå¸‚åƒ¹å–®æ”¹ç”¨æœ€æ–° `mark_price`ï¼‰ã€‚
    - `mark_price`ï¼šå‘¼å« `GET /api/market/mark-price/{instrumentId}` å–å¾—å³æ™‚æ¨™è¨˜åƒ¹ã€‚
6. è©¦ç®—é æ‰£ä¿è­‰é‡‘ï¼šä»¥å€‰ä½æ—¢æœ‰ `leverage` ä½œç‚º `current_leverage`ï¼Œè¨ˆç®—
   `required_margin = max(order_notional / current_leverage, order_notional * initial_margin_rate)`ã€‚
7. è©¦ç®—æ‰‹çºŒè²»ï¼Œè¨ªå•Admin GET   `/api/admin/instruments/{instrumentId}` ï¼Œ
   å–å¾—æ‰‹çºŒè²»ç‡ï¼Œåªæœ‰é™åƒ¹å–®æœƒæ˜¯MAKERï¼Œå¸‚åƒ¹è·Ÿé™åƒ¹éƒ½å¯èƒ½æ˜¯TAKER
   æ‰‹çºŒè²»éƒ½å…ˆä»¥ `taker_fee_rate` è¨ˆç®—ï¼Œå…ˆå‡çµï¼Œæˆäº¤å¾Œè‹¥ç‚ºMAKER å†é‡‹æ”¾å¤šé¤˜å‡çµé‡‘é¡
   `fee` = `taker_fee_rate` * `order_notional`
8. æŸ¥è©¢ `account` æœå‹™æ¥å£ GET `/api/ledger/balances?userId=` æˆ–ä½¿ç”¨ `risk_snapshots.equity` å¿«ç…§è©•ä¼°`ä¿è­‰é‡‘é¤˜é¡` `>`
   `required_margin` `+` `fee` ï¼Œè‹¥ä¸è¶³å‰‡æ‹’çµ•ã€‚
9. `simulated_equity` = `å€‰ä½çš„` `margin` `+` `unrealized_pnl` ï¼ŒåŠ ä¸Š `required_margin`
10. è©¦ç®—æˆäº¤å¾ŒæŒ‡æ¨™ï¼š
    - æœ€æ–°å€‰ä½å¸‚å ´åç¾©åƒ¹å€¼ï¼š `simulated_notional = current_market_notional + order_notional`ï¼Œå…¶ä¸­
      `current_market_notional = abs(mark_price * current_quantity)`ã€‚
    - `simulated_margin_ratio = simulated_equity / simulated_notional`ï¼›è‹¥ä½æ–¼ `maintenance_margin_rate + buffer` å‰‡æ‹’çµ•ã€‚
11. **ç™¼å¸ƒçµæœäº‹ä»¶**ï¼š

- æª¢æ ¸é€šé â†’ ç™¼å¸ƒ `MarginPreCheckPassed`ï¼ˆorderId, requiredMarginï¼‰ï¼Œç”± account-ledger è² è²¬å‡çµè³‡é‡‘ã€‚
- æª¢æ ¸å¤±æ•— â†’ ç™¼å¸ƒ `MarginPreCheckFailed`ï¼ˆorderId, reasonCode, deficitï¼‰ã€‚

1. ç›®å‰é€£çºŒä¸‹å–®æœ‰é–‹å€‰å³çˆ†å€‰é¢¨éšªï¼Œéœ€å¯¦ç¾ `simulated_margin_ratio` è¨ˆç®—æ™‚ï¼Œè€ƒæ…®åˆ°åœ¨é€”è¨‚å–®ã€‚

## Event Inputï¼š`PositionUpdated`

```
PositionUpdated äº‹ä»¶ç™¼å¸ƒ
   â†“
Risk-Margin æ¶ˆè²»äº‹ä»¶
   â†“
è®€å–æœ€æ–°å€‰ä½ä¿¡æ¯
   â†“
è¨ˆç®—åç¾©åƒ¹å€¼èˆ‡å¯¦éš›ä¿è­‰é‡‘ä½”ç”¨
   â†“
æ›´æ–° risk snapshotã€ç™¼å¸ƒ RiskUpdate
```

---

### æ¥æ”¶å€‰ä½æ›´æ–°äº‹ä»¶ `PositionUpdated`

Kafka Consumer æ”¶åˆ° `PositionUpdated` å¾ŒåŸ·è¡Œï¼š

- æ ¹æ“š `instrument_id` æŸ¥æ‰¾å°æ‡‰çš„ `risk_limits`ï¼ˆåˆå§‹ / ç¶­æŒä¿è­‰é‡‘ç‡ã€æœ€å¤§æ§“æ¡¿ï¼‰ã€‚
- å¾äº‹ä»¶æˆ– positions æŸ¥å‡ºå°æ‡‰ç”¨æˆ¶çš„å€‰ä½åŸºç¤è³‡è¨Šï¼ˆ`quantity,` `magin,` `mark_price,` `leverage,` `unrealized_pnl` ï¼‰ã€‚
- å†çµåˆæ—¢æœ‰çš„ä¿è­‰é‡‘é¤˜é¡å¿«ç…§è¨ˆç®—å¯ç”¨æ§“æ¡¿èˆ‡é¢¨éšªæ¯”ç‡ã€‚
- **åˆå§‹åŒ– `risk_snapshots`**ï¼š
    1. ä»¥ `user_id + instrument_id` é€²è¡Œ `SELECT ... FOR UPDATE`ï¼›è‹¥ç„¡è³‡æ–™ä»£è¡¨é¦–æ¬¡æ¥è§¸è©²å•†å“ã€‚
    2. ä¾ç•¶å‰å€‰ä½è¨ˆç®—åˆå§‹æŒ‡æ¨™ï¼š
        - `notional_value = abs(mark_price * quantity)`ï¼ˆå¸‚å ´åç¾©åƒ¹å€¼ï¼‰ï¼›è‹¥ç‚º 0 å‰‡è¨­å®šç‚º 1 ä»¥é¿å…é™¤ä»¥ 0ã€‚
        - `used_margin = notional_value / max(leverage, 1)`ï¼›è‹¥ `leverage` ç‚º NULL å‰‡ä»¥ `risk_limits.max_leverage` å€¼ã€‚
        - `equity = margin_balance + unrealized_pnl`ï¼Œå…¶ä¸­ `margin_balance` ä¾†æºç‚º account-ledger æˆ– risk
          æ¨¡çµ„ç¶­è­·çš„éŒ¢åŒ…å¿«ç…§ï¼›æŸ¥ç„¡è³‡æ–™æ™‚ä»¥ 0 ä¸¦æ¨™è¨˜ `status = NORMAL`ã€‚
        - `margin_ratio = equity / notional_value`ï¼›è‹¥ `notional_value = 0` å‰‡é è¨­ 1ã€‚
        - `liquidation_price` ä¾é€å€‰å…¬å¼è¨ˆç®—ã€‚
    3. æ ¹æ“š `margin_ratio` æ±ºå®šåˆå§‹ç‹€æ…‹ï¼š`NORMAL`ã€`ALERT`ï¼ˆè½åœ¨ `maintenance_margin_rate * 1.2` ä»¥å…§ï¼‰ã€`MARGIN_CALL` æˆ–
       `LIQUIDATION_PENDING`ã€‚
    4. å¯«å…¥ `risk_snapshots` æ–°ç´€éŒ„ä¸¦æŠŠ `risk_version = risk_limits.id`ã€`snapshot_source = 'POSITION_UPDATED'`ã€
       `snapshot_at = eventTimestamp`ï¼›ä¹‹å¾ŒåŒä¸€çµ„åˆå³èµ° `UPDATE` æµç¨‹ã€‚

---

### æ›´æ–°ä½”ç”¨ä¿è­‰é‡‘èˆ‡ä¿è­‰é‡‘ç‡

| æŒ‡æ¨™                  | è¨ˆç®—æ–¹å¼                         | å«ç¾©       |
|---------------------|------------------------------|----------|
| **market_notional** | `abs(mark_price * quantity)` | å€‰ä½å¸‚å ´åç¾©åƒ¹å€¼ |
| **used_margin**     | `market_notional / leverage` | å€‰ä½ä½”ç”¨ä¿è­‰é‡‘  |
| **margin_ratio**    | `(equity / market_notional)` | ä¿è­‰é‡‘ç‡     |

`equity = margin_balance + unrealized_pnl`ï¼ˆé€å€‰æ¨¡å¼ä¸‹ margin_balance å³è©²å€‰ä½å¯¦éš›ä½”ç”¨çš„ä¿è­‰é‡‘ï¼‰

è‹¥å€‰ä½æ“´å¤§æˆ–æ§“æ¡¿èª¿æ•´ï¼š

- æ›´æ–°è©²ç”¨æˆ¶è©² `instrument_id` çš„ `used_margin`ã€‚
- è‹¥è¶…éé¢¨æ§è¦å‰‡ï¼ˆå¦‚æ§“æ¡¿ä¸Šé™ï¼‰ï¼Œæ¨™è¨˜ç‚º `RISK_ALERT`ã€‚

---

### æ ¹æ“š mark_price å¯¦æ™‚æ›´æ–°é¢¨éšªæŒ‡æ¨™ margin_ratio èˆ‡ liquidation_price

| æŒ‡æ¨™                    | è¨ˆç®—å…¬å¼                                                                                                                                                                                       | æ„ç¾©           |
|-----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------|
| **unrealized_pnl**    | `(mark_price - entry_price) * qty`                                                                                                                                                         | æœªå¯¦ç¾ç›ˆè™§        |
| **margin_ratio**      | `(margin_balance + unrealized_pnl) / market_notional`ï¼ˆäº¦å³ `equity / market_notional`ï¼‰                                                                                                       | ç¶­æŒæ¯”ç‡         |
| **liquidation_price** | é€å€‰å…¬å¼ï¼š`Long = (entryPrice - marginPerUnit)/(1 - mmr)`ã€`Short = (entryPrice + marginPerUnit)/(1 + mmr)`ï¼Œå…¶ä¸­ `marginPerUnit = isolatedMarginAmount / quantity`ã€`mmr = maintenance_margin_rate` | å¼·å¹³åƒ¹ï¼ˆä¾å€‰ä½æ–¹å‘è¨ˆç®—ï¼‰ |

---

### æ›´æ–° risk ç‹€æ…‹è¡¨èˆ‡æŒ‡æ¨™å¿«ç…§

å¯«å…¥æˆ–æ›´æ–°ï¼š

```
risk_snapshots {
  user_id,
  instrument_id,
  notional_value,
  used_margin,
  equity,
  margin_ratio,
  liquidation_price,
  status,
  updated_at
}
```

ç‹€æ…‹å¯èƒ½ç‚ºï¼š

- `NORMAL`
- `ALERT`ï¼ˆæ¥è¿‘ç¶­æŒä¿è­‰é‡‘ï¼‰
- `MARGIN_CALL`
- `LIQUIDATION_PENDING`

---

### ç™¼å¸ƒ RiskUpdate äº‹ä»¶

é¢¨æ§çµæœæœƒä»¥äº‹ä»¶å½¢å¼å»£æ’­ï¼š

```
RiskUpdate {
  userId,
  instrumentId,
  marginRatio,
  liquidationPrice,
  status,
  timestamp
}
```

ä¸‹æ¸¸è™•ç†ï¼š[STATUS](#STATUS)
æ¶ˆè²»è€…ï¼š

- **order-service**ï¼šè‹¥é¢¨éšªéé«˜ï¼Œæš«åœæ–°å§”è¨—ã€‚
- **risk-liquidation-worker**ï¼šè‡ªå‹•å¼·å¹³åŸ·è¡Œï¼ˆç™¼èµ· `liquidation_queue`ï¼‰ã€‚
- **monitor/reporting**ï¼šæ›´æ–°é¢¨éšªé¢æ¿èˆ‡å ±è¡¨ã€‚

## Event Input ï¼š`MarkPriceUpdated`

```
MarkPriceUpdated äº‹ä»¶ç™¼å¸ƒ
   â†“
Risk-Margin æ¶ˆè²»äº‹ä»¶
   â†“
å¸¶å…¥æ—¢æœ‰å€‰ä½å¿«ç…§
   â†“
é‡æ–°è¨ˆç®—æœªå¯¦ç¾æç›Šã€ç¶­æŒä¿è­‰é‡‘æ¯”ç‡èˆ‡å¼·å¹³åƒ¹
   â†“
æ›´æ–° risk snapshotã€ç™¼å¸ƒ RiskUpdate / Liquidation æŒ‡ä»¤
```

è¡Œæƒ…äº‹ä»¶è™•ç†çš„é‡é»åœ¨æ–¼ã€Œå³æ™‚èª¿æ•´ã€ï¼šæ¯ç­†æ¨™è¨˜åƒ¹æ ¼æ›´æ–°éƒ½æœƒé‡æ–°è¨ˆç®—å€‰ä½é¢¨éšªï¼Œå³ä¾¿å€‰ä½æ•¸é‡ä¸è®Šï¼Œä¹Ÿèƒ½åœ¨åƒ¹æ ¼æ€¥é€Ÿè®Šå‹•æ™‚è§¸ç™¼å¼·å¹³æˆ–é€šçŸ¥ã€‚

## Liquidation å¼·å¹³

## é—œéµç‰¹æ€§

- **é¢¨éšªæŒ‡æ¨™ä¾†æº**ï¼šä»¥ `positions` å€‰ä½å¿«ç…§èˆ‡è¡Œæƒ…æ¨™è¨˜åƒ¹ç‚ºä¸»ï¼Œæ­é…é¢¨æ§æ¨¡çµ„è‡ªèº«ç¶­è­·çš„ä¿è­‰é‡‘é¤˜é¡å¿«ç…§ã€‚
- **mark_price é©…å‹•**ï¼šæ‰€æœ‰é¢¨æ§ä»¥æ¨™è¨˜åƒ¹ç‚ºæº–ã€‚
- **äº‹ä»¶é©…å‹•æ›´æ–°**ï¼šä¸è¼ªè©¢ï¼Œè€Œæ˜¯æ¶ˆè²»å€‰ä½æ›´æ–°èˆ‡è¡Œæƒ…æ¨é€ã€‚
- **å³æ™‚è­¦æˆ’**ï¼šmargin_ratio ä½æ–¼é–¾å€¼æ™‚å¯ä¸»å‹•é€šçŸ¥ order-service ç¦æ­¢åŠ å€‰ã€‚
- **æŒä¹…åŒ–å¿«ç…§**ï¼šæ‰€æœ‰é¢¨éšªè®ŠåŒ–å¯«å…¥ `risk_snapshots`ï¼Œå¯å›æ”¾èˆ‡ç›£æ§ã€‚

# Admin æœå‹™

## è·è²¬

Admin æœå‹™æ˜¯æ‰€æœ‰äº¤æ˜“å•†å“ï¼ˆInstrumentï¼‰è³‡è¨Šçš„å”¯ä¸€ä¾†æºã€‚
çŸ­æœŸå…§åƒ…æä¾›çµ¦å…¶ä»–æœå‹™çš„æŸ¥è©¢ APIï¼Œä»»ä½•å•†å“çš„æ–°å¢/èª¿æ•´/ä¸‹ç·šéƒ½é€é DBA ç›´æ¥æ“ä½œè³‡æ–™åº«ï¼Œä¸¦ç”± change management æµç¨‹æ§ç®¡ã€‚
åœ¨å¯¦éš›ä¸Šç·šå¾Œï¼Œå¯å†é€æ­¥è£œé½Šå¾Œå° UI èˆ‡å¯©æ‰¹æµç¨‹ã€‚

## endpoint

| å®Œæˆ  | HTTP Method | Endpoint                                | èªªæ˜        | èª¿ç”¨è€…                              | æˆæ¬Š     | è¼¸å…¥                          | è¼¸å‡º                  | äº‹ä»¶ç™¼å¸ƒ | DBæ“ä½œ                                                    | ç·©å­˜æ“ä½œ | æœå‹™èª¿ç”¨ | è£œå„Ÿæ©Ÿåˆ¶ |
| --- | ----------- | --------------------------------------- | --------- | -------------------------------- | ------ | --------------------------- | ------------------- | ---- | ------------------------------------------------------- | ---- | ---- | ---- |
| âœ”ï¸  | GET         | `/api/admin/instruments`                | æŸ¥è©¢å¯äº¤æ˜“å•†å“åˆ—è¡¨ | order / risk / market / matching | public | status, instrumentType (å¯é¸) | InstrumentSummary[] | -    | select `instrument`<status,instrument_type,is_tradable> | -    | -    | -    |
| âœ”ï¸  | GET         | `/api/admin/instruments/{instrumentId}` | æŸ¥è©¢å–®ä¸€å•†å“ç´°ç¯€  | order / risk / market / matching | public | instrumentId                | InstrumentDetail    | -    | select `instrument`<instrument_id>                      | -    | -    | -    |

> **é‹ç¶­èªªæ˜**: ç›®å‰ Admin æœå‹™åƒ…æä¾›æŸ¥è©¢åŠŸèƒ½ï¼›Instrument çš„æ–°å¢/ç•°å‹•/ä¸‹ç·šé€é DBA ç›´æ¥æ“ä½œè³‡æ–™åº«ï¼Œä¸¦ç”±è®Šæ›´æµç¨‹æ§ç®¡ã€‚

## è³‡æ–™è¡¨ DDL

### instrument è¡¨ - äº¤æ˜“å•†å“è¨­å®š

```sql
CREATE TABLE instrument
(
    instrument_id      BIGINT         NOT NULL COMMENT 'äº¤æ˜“å°ID (Snowflake)',
    symbol             VARCHAR(50)    NOT NULL COMMENT 'äº¤æ˜“å°ä»£ç¢¼ (å¦‚ BTCUSDT, ETHUSDT)',
    name               VARCHAR(100)   NOT NULL COMMENT 'äº¤æ˜“å°åç¨±',
    base_asset         VARCHAR(20)    NOT NULL COMMENT 'åŸºç¤è³‡ç”¢ (å¦‚ BTC, ETH)',
    quote_asset        VARCHAR(20)    NOT NULL COMMENT 'è¨ˆåƒ¹è³‡ç”¢ (å¦‚ USDT, USD)',
    instrument_type    VARCHAR(20)    NOT NULL COMMENT 'å•†å“é¡å‹: SPOT(ç¾è²¨), PERPETUAL(æ°¸çºŒåˆç´„), FUTURES(æœŸè²¨), OPTION(é¸æ“‡æ¬Š)',
    status             VARCHAR(20)    NOT NULL DEFAULT 'ACTIVE' COMMENT 'ç‹€æ…‹: ACTIVE, SUSPENDED, DELISTED, COMING_SOON',

    # è¨‚å–®é™åˆ¶
    tick_size          DECIMAL(20, 8) NOT NULL COMMENT 'æœ€å°åƒ¹æ ¼è®Šå‹•å–®ä½ (å¦‚ 0.01)',
    lot_size           DECIMAL(20, 8) NOT NULL COMMENT 'æœ€å°ä¸‹å–®æ•¸é‡å–®ä½ (å¦‚ 0.001)',
    min_order_value    DECIMAL(20, 8) NOT NULL COMMENT 'æœ€å°è¨‚å–®åç¾©åƒ¹å€¼ (USDT)',
    max_order_value    DECIMAL(20, 8) NULL COMMENT 'æœ€å¤§è¨‚å–®åç¾©åƒ¹å€¼é™åˆ¶',

    # æˆäº¤
    min_notional       DECIMAL(20, 8) NOT NULL DEFAULT 0 COMMENT 'æœ€å°æˆäº¤é¡ (ç”¨æ–¼å¸‚åƒ¹å–®)',
    price_precision    INT            NOT NULL DEFAULT 8 COMMENT 'åƒ¹æ ¼å°æ•¸ä½æ•¸',
    quantity_precision INT            NOT NULL DEFAULT 8 COMMENT 'æ•¸é‡å°æ•¸ä½æ•¸',

    # æ‰‹çºŒè²»
    maker_fee_rate     DECIMAL(10, 4) NOT NULL DEFAULT 0.0002 COMMENT 'Makeræ‰‹çºŒè²»ç‡ (å¦‚ 0.0002 = 0.02%)',
    taker_fee_rate     DECIMAL(10, 4) NOT NULL DEFAULT 0.0005 COMMENT 'Takeræ‰‹çºŒè²»ç‡ (å¦‚ 0.0005 = 0.05%)',

    # åˆç´„é…ç½®
    contract_size      DECIMAL(20, 8) NULL COMMENT 'åˆç´„é¢å€¼ (åˆç´„å°ˆç”¨)',
    settlement_asset   VARCHAR(20)    NULL COMMENT 'çµç®—è³‡ç”¢ (åˆç´„å°ˆç”¨)',
    max_leverage       INT            NOT NULL DEFAULT 1 COMMENT 'æœ€å¤§æ§“æ¡¿å€æ•¸',
    maintenance_margin DECIMAL(10, 4) NOT NULL DEFAULT 0.005 COMMENT 'ç¶­æŒä¿è­‰é‡‘ç‡',

    launch_at          DATETIME       NOT NULL COMMENT 'ä¸Šç·šæ™‚é–“',
    delist_at          DATETIME       NULL COMMENT 'ä¸‹ç·šæ™‚é–“ (NULLè¡¨ç¤ºæœªä¸‹ç·š)',
    display_order      INT            NOT NULL DEFAULT 0 COMMENT 'å‰ç«¯é¡¯ç¤ºæ’åº (æ•¸å­—è¶Šå°è¶Šé å‰)',
    is_tradable        BOOLEAN        NOT NULL DEFAULT TRUE COMMENT 'æ˜¯å¦å¯äº¤æ˜“',
    is_visible         BOOLEAN        NOT NULL DEFAULT TRUE COMMENT 'æ˜¯å¦å‰ç«¯å¯è¦‹',
    description        TEXT           NULL COMMENT 'å•†å“æè¿°',
    metadata           JSON           NULL COMMENT 'é¡å¤–é…ç½® (é¢¨éšªåƒæ•¸ã€ç‰¹æ®Šè¦å‰‡ç­‰)',
    created_at         DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‰µå»ºæ™‚é–“',
    updated_at         DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    PRIMARY KEY (instrument_id),
    UNIQUE KEY uk_symbol (symbol) COMMENT 'äº¤æ˜“å°ä»£ç¢¼å”¯ä¸€'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='äº¤æ˜“å•†å“è¨­å®šè¡¨ - ä¾›æ‰€æœ‰äº¤æ˜“æ¨¡çµ„å…±ç”¨çš„éœæ…‹è³‡è¨Š';

CREATE INDEX idx_status_tradable ON instrument_metadata (status, is_tradable, display_order) COMMENT 'æŸ¥è©¢å¯äº¤æ˜“å•†å“åˆ—è¡¨';
CREATE INDEX idx_base_asset ON instrument_metadata (base_asset, status) COMMENT 'æŒ‰åŸºç¤è³‡ç”¢æŸ¥è©¢';
CREATE INDEX idx_quote_asset ON instrument_metadata (quote_asset, status) COMMENT 'æŒ‰è¨ˆåƒ¹è³‡ç”¢æŸ¥è©¢';
CREATE INDEX idx_instrument_type ON instrument_metadata (instrument_type, status) COMMENT 'æŒ‰å•†å“é¡å‹æŸ¥è©¢';
CREATE INDEX idx_launch_at ON instrument_metadata (launch_at DESC) COMMENT 'æŒ‰ä¸Šç·šæ™‚é–“æ’åº';
CREATE INDEX idx_display_order ON instrument_metadata (display_order ASC, symbol) COMMENT 'å‰ç«¯é¡¯ç¤ºæ’åº';
```

#### å‡æ•¸æ“šç¤ºä¾‹ï¼ˆPERPETUAL åˆç´„ï¼‰

```sql
INSERT INTO instrument (instrument_id, symbol, base_asset, quote_asset, instrument_type, status,
                        tick_size, lot_size, min_order_value, max_order_value, min_notional,
                        price_precision, quantity_precision, maker_fee_rate, taker_fee_rate,
                        contract_size, settlement_asset, max_leverage, maintenance_margin,
                        launch_at, delist_at, display_order, is_tradable, is_visible, description, metadata,
                        created_at, updated_at)
VALUES (10001, 'BTCUSDT-PERP', 'BTC', 'USDT', 'PERPETUAL', 'ACTIVE',
        0.1, 0.001, 5, 500000, 5,
        2, 3, 0.0002, 0.0005,
        1, 'USDT', 50, 0.005,
        '2024-01-01 00:00:00', NULL, 1, TRUE, TRUE, 'Demo perpetual pair', '{"funding_interval":8}',
        NOW(), NOW());
```
