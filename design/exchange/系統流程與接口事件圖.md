# 交易平台系統流程與接口事件圖

本文件根據整體設計文檔，整理出各流程中涉及的服務、API接口、事件發布與消費關係。


---

## 服務、API、事件、Job一覽

### Gateway 服務
**職責**: 統一入口、JWT驗證、路由轉發

| HTTP Method | Endpoint | 說明 | 轉發至 |
|------------|----------|------|--------|
| - | - | JWT驗證、路由所有請求 | 各微服務 |

---

### Auth 服務
**職責**: 認證、憑證管理、會話管理

| HTTP Method | Endpoint | 說明 | 輸入 | 輸出 | 事件發布 |
|------------|----------|------|------|------|---------|
| POST | `/api/auth/credentials` | 建立憑證 | AuthCredentialCreateRequest | AuthCredentialResponse | - |
| POST | `/api/auth/login` | 登入 | LoginRequest (email, password) | JWT (Access/Refresh Token) | - |
| POST | `/api/auth/token/refresh` | 刷新Token | RefreshToken | JWT (new Access/Refresh Token) | - |
| POST | `/api/auth/logout` | 登出 | - | - | `AuthSessionRevoked` |

**事件發布**:
- `AuthSessionRevoked`: 強制登出或風險事件時發布

---

### User 服務
**職責**: 用戶主檔管理、註冊

| HTTP Method | Endpoint | 說明 | 輸入 | 輸出 | 事件發布 | 調用服務 |
|------------|----------|------|------|------|---------|---------|
| POST | `/api/users` | 用戶註冊 | UserRegisterRequest (email, password) | UserResponse | - | Auth服務 (建立憑證) |
| GET | `/api/users/me` | 查詢當前用戶基本資料 | - | UserResponse | - | - |

**調用其他服務的API**:
- 調用 `auth` 服務的 `POST /api/auth/credentials` 建立憑證

**補償機制**:
- `UserRegistrationResumer` 排程任務：掃描 `user_registration_prepare` 表，重試失敗的憑證建立

---

### Order 服務
**職責**: 委託管理、下單入口

| HTTP Method | Endpoint | 說明 | 輸入 | 輸出 | 事件發布 |
|------------|----------|------|------|------|---------|
| POST | `/api/orders` | 建立委託 | OrderCreateRequest (instrument_id, side, type, price, quantity) | OrderResponse (orderId, status: PENDING) | `OrderSubmitted` → `OrderCreated` |
| DELETE | `/api/orders/{orderId}` | 撤銷委託 | orderId | - | `OrderCancelRequested` |
| GET | `/api/orders/{orderId}` | 查詢委託狀態 | orderId | OrderResponse | - |

**事件發布**:
- `OrderSubmitted`: 下單時立即發布，啟動Saga流程
- `OrderCreated`: 資金凍結完成後發布，送至撮合引擎
- `OrderCancelRequested`: 撤單請求

**事件消費**:
- `MarginPreCheckPassed` (from risk-margin)
- `FundsFrozen` (from account-ledger)

---

### Risk-Margin 服務
**職責**: 風險計算、保證金管理、強平執行

| HTTP Method | Endpoint | 說明 | 輸入 | 輸出 |
|------------|----------|------|------|------|
| POST | `/api/risk/pre-check` | 下單前風險檢查 | userId, instrumentId, quantity, price | 是否允許下單、需凍結保證金金額 |

**事件消費**:
- `OrderSubmitted` (from order): 進行保證金試算
- `PositionUpdated` (from positions): 更新風險指標
- `MarkPriceUpdated` (from market-data): 重新計算維持保證金率與強平價

**事件發布**:
- `MarginPreCheckPassed`: 保證金檢查通過
- `MarginPreCheckFailed`: 保證金檢查失敗
- `RiskUpdate`: 風險狀態更新 (margin_ratio, liquidation_price, status)
- `LiquidationTriggered`: 觸發強平

---

### Account-Ledger 服務
**職責**: 資產管理、雙分錄記帳、資金費率

| HTTP Method | Endpoint | 說明 | 輸入 | 輸出 |
|------------|----------|------|------|------|
| GET | `/api/ledger/balances?userId=` | 查詢餘額/可用資金 | userId | LedgerBalanceResponse |

**事件消費**:
- `MarginPreCheckPassed` (from risk-margin): 凍結資金
- `TradeExecuted` (from matching): 雙分錄記帳、扣除凍結、計算手續費
- `OrderCancelled` (from matching): 解凍資金
- `FundingRateUpdated` (from market-data): 定期結算資金費率

**事件發布**:
- `FundsFrozen`: 資金凍結完成
- `FundsUnfrozen`: 資金解凍完成
- `LedgerEntryCreated`: 資產異動事件 (含已實現盈虧、手續費等)

---

### Matching 服務
**職責**: 撮合引擎、訂單簿管理

| HTTP Method | Endpoint | 說明 | 輸入 | 輸出 | 事件發布 |
|------------|----------|------|------|------|---------|
| (可選) POST | `/api/matching/cancel` | 撮合層執行撤單 | orderId | - | `OrderCancelled` |

**事件消費**:
- `OrderCreated` (from order): 委託進入訂單簿、執行撮合

**事件發布**:
- `OrderPlaced`: 新訂單成功掛入訂單簿
- `OrderCancelled`: 訂單從訂單簿移除
- `TradeExecuted`: 撮合成交 (buyOrderId, sellOrderId, price, quantity, fee)

---

### Positions 服務
**職責**: 倉位管理、盈虧計算

| HTTP Method | Endpoint | 說明 | 輸入 | 輸出 |
|------------|----------|------|------|------|
| GET | `/api/positions?userId=` | 查詢當前倉位與損益 | userId | PositionResponse[] |

**事件消費**:
- `TradeExecuted` (from matching): 更新倉位數量、均價、未實現盈虧、強平價
- `LedgerEntryCreated` (from account-ledger): 確認資金結算、更新已實現盈虧、關閉倉位
- `MarkPriceUpdated` (from market-data): 重新計算未實現盈虧

**事件發布**:
- `PositionUpdated`: 倉位狀態更新 (quantity, entryPrice, markPrice, unrealizedPnl, liquidationPrice)
- `PositionClosed`: 倉位完全關閉

---

### Market-Data 服務
**職責**: 行情生成、深度圖、K線、標記價格、資金費率

| HTTP Method | Endpoint | 說明 | 輸入 | 輸出 |
|------------|----------|------|------|------|
| GET | `/api/market/tickers/{instrumentId}` | 最新行情資訊 | instrumentId | TickerResponse |
| GET | `/api/market/kline` | K線查詢 | symbol, period | KlineResponse[] |
| WebSocket | `/ws/market` | 推送行情、深度、K線 | - | 實時推送 |

**事件消費**:
- `OrderPlaced` (from matching): 更新深度圖
- `OrderCancelled` (from matching): 更新深度圖
- `TradeExecuted` (from matching): 更新Ticker、生成K線

**事件發布**:
- `MarkPriceUpdated`: 標記價格更新 (indexPrice, markPrice, fairPrice)
- `FundingRateUpdated`: 資金費率更新 (rate, effectiveAt)
- `KlineClosed`: K線周期結束

---

## API調用者

| 調用方 | 被調用方 | API端點 | 場景 |
|--------|---------|---------|------|
| user | auth | `POST /api/auth/credentials` | 用戶註冊時建立憑證 |
| gateway | auth | `POST /api/auth/login` | 用戶登入 |
| gateway | auth | `POST /api/auth/token/refresh` | Token刷新 |
| gateway | auth | `POST /api/auth/logout` | 用戶登出 |
| gateway | user | `POST /api/users` | 用戶註冊 |
| gateway | user | `GET /api/users/me` | 查詢用戶資料 |
| gateway | order | `POST /api/orders` | 下單 |
| gateway | order | `DELETE /api/orders/{orderId}` | 撤單 |
| gateway | order | `GET /api/orders/{orderId}` | 查詢委託 |
| gateway | positions | `GET /api/positions?userId=` | 查詢倉位 |
| gateway | ledger | `GET /api/ledger/balances?userId=` | 查詢餘額 |
| gateway | market-data | `GET /api/market/tickers/{instrumentId}` | 查詢行情 |
| gateway | market-data | `GET /api/market/kline` | 查詢K線 |
| liquidation-worker | order | `POST /api/orders` | 執行強平委託 (內部) |
| order (可選) | risk-margin | `POST /api/risk/pre-check` | 下單前風險檢查 (內部) |

---

## event 表

| 事件名稱 | 發布者 | 消費者 | Kafka Topic | 事件內容 |
|---------|--------|--------|-------------|---------|
| `AuthSessionRevoked` | auth | gateway, 其他服務 | auth.session-revoked | sessionId, userId, reason |
| `OrderSubmitted` | order | risk-margin | order.submitted | orderId, userId, instrumentId, side, type, price, quantity |
| `MarginPreCheckPassed` | risk-margin | account-ledger | risk.margin-check-passed | orderId, requiredMargin |
| `MarginPreCheckFailed` | risk-margin | order | risk.margin-check-failed | orderId, reason |
| `FundsFrozen` | account-ledger | order | ledger.funds-frozen | orderId, userId, asset, amount |
| `FundsUnfrozen` | account-ledger | - | ledger.funds-unfrozen | orderId, userId, asset, amount |
| `OrderCreated` | order | matching | order.created | orderId, userId, instrumentId, side, type, price, quantity |
| `OrderCancelRequested` | order | matching | order.cancel-requested | orderId |
| `OrderPlaced` | matching | market-data | matching.order-placed | orderId, side, price, quantity |
| `OrderCancelled` | matching | market-data, account-ledger | matching.order-cancelled | orderId |
| `TradeExecuted` | matching | account-ledger, positions, market-data | matching.trade-executed | tradeId, buyOrderId, sellOrderId, price, quantity, buyerUserId, sellerUserId, fee, executedAt |
| `LedgerEntryCreated` | account-ledger | positions | ledger.entry-created | userId, instrumentId, asset, deltaAvailable, deltaReserved, balanceAfter, referenceType, referenceId |
| `PositionUpdated` | positions | risk-margin, reporting | positions.updated | userId, instrumentId, side, quantity, entryPrice, markPrice, unrealizedPnl, liquidationPrice |
| `PositionClosed` | positions | reporting | positions.closed | userId, instrumentId, realizedPnl |
| `MarkPriceUpdated` | market-data | positions, risk-margin | market.mark-price | instrumentId, indexPrice, markPrice, fairPrice, premiumIndex, fundingBasis, calculatedAt |
| `FundingRateUpdated` | market-data | account-ledger | market.funding-rate | instrumentId, rate, effectiveAt |
| `KlineClosed` | market-data | reporting, 前端 | market.kline | instrumentId, period, open, high, low, close, volume, timestamp |
| `RiskUpdate` | risk-margin | order, liquidation-worker, reporting | risk.update | userId, instrumentId, marginRatio, liquidationPrice, status |
| `LiquidationTriggered` | risk-margin | liquidation-worker | risk.liquidation-triggered | positionId, userId, instrumentId, reason |

---

---

## 流程圖

### 用戶註冊流程

```mermaid
sequenceDiagram
    participant Client
    participant Gateway
    participant User
    participant Auth
    participant DB-User
    participant DB-Auth
    participant Scheduler

    Client->>+Gateway: POST /api/users
    Gateway->>+User: 轉發註冊請求 (email, password)

    User->>DB-User: 檢查email是否已存在
    alt Email已存在
        User-->>Client: 400 Email already exists
    end

    User->>DB-User: 創建User主檔
    User->>DB-User: 寫入user_registration_prepare (PREPARE狀態)

    User->>+Auth: POST /api/auth/credentials
    Note over User,Auth: AuthCredentialCreateRequest<br/>(userId, type, secret_hash, salt)

    alt Auth服務可用
        Auth->>DB-Auth: 寫入auth_credentials
        Auth-->>User: 201 Created
        User->>DB-User: 更新registration狀態為COMPLETED
        User-->>-Client: 200 OK (UserResponse)
    else Auth服務不可用或失敗
        Auth-->>User: 500/503 Error
        User->>DB-User: 保留PREPARE狀態
        User-->>-Client: 500 RemoteServiceError
    end

    Note over Scheduler: 每分鐘執行
    Scheduler->>DB-User: 掃描PREPARE狀態記錄
    loop 重試邏輯
        Scheduler->>+Auth: POST /api/auth/credentials (重試)
        alt 成功
            Auth-->>Scheduler: 201 Created
            Scheduler->>DB-User: 更新為COMPLETED
        else N次失敗
            Scheduler->>DB-User: 標記為FAILED
            Scheduler->>Scheduler: 發送告警通知營運
        end
    end
```

**涉及的API**:
- `POST /api/users` (user)
- `POST /api/auth/credentials` (auth)

**涉及的表**:
- `users`
- `user_registration_prepare`
- `auth_credentials`

**補償機制**:
- `UserRegistrationResumer` 排程任務

---

### 用戶登入流程

```mermaid
sequenceDiagram
    participant Client
    participant Gateway
    participant Auth
    participant DB-Auth
    participant Redis

    Client->>+Gateway: POST /api/auth/login
    Note over Client,Gateway: LoginRequest<br/>(email, password)

    Gateway->>+Auth: 轉發登入請求

    Auth->>DB-Auth: 查詢auth_credentials (by email)
    Auth->>Auth: BCrypt/Argon2驗證密碼

    alt 密碼錯誤
        Auth->>DB-Auth: 寫入login_audits (FAILED)
        Auth-->>Client: 401 Unauthorized
    end

    alt 憑證狀態異常 (LOCKED/EXPIRED)
        Auth->>DB-Auth: 寫入login_audits (FAILED, reason)
        Auth-->>Client: 403 Forbidden (reason)
    end

    Auth->>DB-Auth: 寫入login_audits (SUCCESS)
    Auth->>DB-Auth: 寫入auth_sessions

    Auth->>Redis: 建立session
    Note over Redis: auth:session:{sessionId}<br/>{userId, roles, IP, deviceFingerprint, TTL}

    Auth->>Auth: 簽發JWT
    Note over Auth: Access Token (短期, 15min)<br/>Refresh Token (長期, 7天)<br/>含sessionId, authContext

    Auth-->>-Client: 200 OK (Access/Refresh Token)

    Note over Client,Gateway: 後續請求攜帶Access Token

    Client->>Gateway: GET /api/orders (with JWT)
    Gateway->>Gateway: JWT Filter驗證Token
    Gateway->>Redis: 查詢session是否有效

    alt Session不存在或已revoked
        Gateway-->>Client: 401 Unauthorized
    else Session有效
        Gateway->>Gateway: 放入userId到ThreadLocal/Context
        Gateway->>Order: 轉發請求
    end
```

**涉及的API**:
- `POST /api/auth/login` (auth)
- `POST /api/auth/token/refresh` (auth)
- `POST /api/auth/logout` (auth)

**涉及的表**:
- `auth_credentials`
- `login_audits`
- `auth_sessions`
- Redis: `auth:session:{sessionId}`

**事件發布**:
- `AuthSessionRevoked` (登出或強制失效時)

---

### 下單流程 (Saga異步模式)

```mermaid
sequenceDiagram
    participant Client
    participant Gateway
    participant Order
    participant Kafka
    participant Risk-Margin
    participant Account-Ledger
    participant Matching
    participant Market-Data

    Client->>+Gateway: POST /api/orders
    Note over Client,Gateway: OrderCreateRequest<br/>(instrument_id, side, type, price, quantity)

    Gateway->>+Order: 轉發下單請求

    Order->>Order: 基礎驗證 (參數、格式)
    Order->>DB-Order: 創建orders (status: PENDING)
    Order-->>-Client: 200 OK (orderId, status: PENDING)

    Note over Order: 立即響應用戶<br/>延遲極低

    Order->>Kafka: 發布OrderSubmitted事件

    par 異步Saga流程
        Kafka->>Risk-Margin: OrderSubmitted事件
        Risk-Margin->>Risk-Margin: 保證金試算
        Risk-Margin->>Risk-Margin: 檢查風險限額

        alt 風控檢查通過
            Risk-Margin->>Kafka: 發布MarginPreCheckPassed
        else 風控檢查失敗
            Risk-Margin->>Kafka: 發布MarginPreCheckFailed
            Kafka->>Order: MarginPreCheckFailed事件
            Order->>DB-Order: 更新status為FAILED
            Order->>WebSocket: 通知用戶失敗原因
        end
    and
        Kafka->>Account-Ledger: MarginPreCheckPassed事件
        Account-Ledger->>Account-Ledger: 計算需凍結金額
        Account-Ledger->>DB-Ledger: 更新ledger_balances<br/>(available減少, reserved增加)
        Account-Ledger->>DB-Ledger: 寫入ledger_entries (借貸分錄)

        alt 資金充足
            Account-Ledger->>Kafka: 發布FundsFrozen
        else 資金不足
            Account-Ledger->>Kafka: 發布FundsFrozenFailed
            Kafka->>Order: FundsFrozenFailed事件
            Order->>DB-Order: 更新status為FAILED
            Order->>WebSocket: 通知用戶餘額不足
        end
    end

    Kafka->>Order: FundsFrozen事件
    Order->>DB-Order: 更新status為ACCEPTED
    Order->>Kafka: 發布OrderCreated事件

    Kafka->>Matching: OrderCreated事件
    Matching->>Matching: 委託進入訂單簿
    Matching->>Kafka: 發布OrderPlaced事件

    Kafka->>Market-Data: OrderPlaced事件
    Market-Data->>Market-Data: 更新訂單簿深度圖
    Market-Data->>WebSocket: 推送深度更新給前端
```

**涉及的API**:
- `POST /api/orders` (order)
- `POST /api/risk/pre-check` (可選，order內部調用)

**涉及的事件**:
1. `OrderSubmitted` (order → risk-margin)
2. `MarginPreCheckPassed` (risk-margin → account-ledger)
3. `MarginPreCheckFailed` (risk-margin → order)
4. `FundsFrozen` (account-ledger → order)
5. `OrderCreated` (order → matching)
6. `OrderPlaced` (matching → market-data)

**涉及的表**:
- `orders`
- `risk_limits`
- `ledger_balances`
- `ledger_entries`
- 內存訂單簿 (matching)

---

### 撤單流程

```mermaid
sequenceDiagram
    participant Client
    participant Gateway
    participant Order
    participant Kafka
    participant Matching
    participant Account-Ledger
    participant Market-Data

    Client->>+Gateway: DELETE /api/orders/{orderId}
    Gateway->>+Order: 轉發撤單請求

    Order->>DB-Order: 檢查訂單狀態

    alt 訂單不存在或已完成
        Order-->>Client: 404 Not Found / 400 Bad Request
    end

    Order->>Kafka: 發布OrderCancelRequested
    Order-->>-Client: 200 OK (撤單請求已提交)

    Kafka->>Matching: OrderCancelRequested事件
    Matching->>Matching: 從訂單簿移除委託
    Matching->>Kafka: 發布OrderCancelled事件

    par 並行處理
        Kafka->>Market-Data: OrderCancelled事件
        Market-Data->>Market-Data: 更新訂單簿深度圖
        Market-Data->>WebSocket: 推送深度更新
    and
        Kafka->>Account-Ledger: OrderCancelled事件
        Account-Ledger->>DB-Ledger: 解凍保證金
        Note over Account-Ledger: 借: reserved減少<br/>貸: available增加
        Account-Ledger->>Kafka: 發布FundsUnfrozen
    end

    Kafka->>Order: OrderCancelled事件
    Order->>DB-Order: 更新status為CANCELLED
```

**涉及的API**:
- `DELETE /api/orders/{orderId}` (order)

**涉及的事件**:
1. `OrderCancelRequested` (order → matching)
2. `OrderCancelled` (matching → market-data, account-ledger)
3. `FundsUnfrozen` (account-ledger)

---

### 撮合與成交流程

```mermaid
sequenceDiagram
    participant Kafka
    participant Matching
    participant Account-Ledger
    participant Positions
    participant Market-Data
    participant Risk-Margin
    participant WebSocket

    Kafka->>Matching: OrderCreated事件
    Matching->>Matching: 取得交易對訂單簿

    alt 市價單
        Matching->>Matching: 立即撮合
    else 限價單
        Matching->>Matching: 檢查是否可撮合
        Note over Matching: buy.price >= bestSell.price<br/>或<br/>sell.price <= bestBuy.price
    end

    loop 撮合迴圈 (while 對手單存在 && 未完全成交)
        Matching->>Matching: tradeQty = min(剩餘量, 對手單剩餘量)
        Matching->>Matching: tradePrice = 對手單價格
        Matching->>DB-Matching: 寫入trade_tickers
        Matching->>Kafka: 發布TradeExecuted事件
        Note over Kafka: tradeId, buyOrderId, sellOrderId<br/>price, quantity, buyerUserId, sellerUserId<br/>fee, executedAt

        Matching->>Matching: 更新雙方剩餘量與狀態

        alt 對手單完成
            Matching->>Matching: 從訂單簿移出
            Matching->>Kafka: 發布OrderCancelled (完全成交)
        end
    end

    par 並行消費TradeExecuted
        Kafka->>Account-Ledger: TradeExecuted事件
        Note over Account-Ledger: 開啟@Transactional
        Account-Ledger->>DB-Ledger: 查詢雙方餘額
        Account-Ledger->>Account-Ledger: 驗證tradeId去重 (冪等性)
        Account-Ledger->>Account-Ledger: 計算資金變化

        Note over Account-Ledger: 雙分錄記帳
        Account-Ledger->>DB-Ledger: 寫入ledger_entries (資金結算)
        Account-Ledger->>DB-Ledger: 寫入ledger_entries (手續費)
        Account-Ledger->>DB-Ledger: 寫入ledger_entries (解凍/結餘)
        Account-Ledger->>DB-Ledger: 更新ledger_balances

        Account-Ledger->>Kafka: 發布LedgerEntryCreated
        Note over Kafka: userId, instrumentId, asset<br/>deltaAvailable, deltaReserved<br/>balanceAfter, referenceType=TRADE<br/>referenceId=tradeId
    and
        Kafka->>Positions: TradeExecuted事件
        Positions->>DB-Positions: 查找或建立倉位

        alt 開倉
            Positions->>DB-Positions: 建立新倉位
        else 加倉
            Positions->>Positions: 新數量 = 舊數量 + 成交數量
            Positions->>Positions: 新均價 = 加權平均
        else 減倉/平倉
            Positions->>Positions: 計算已實現盈虧
            Positions->>DB-Positions: 減少數量
        end

        Positions->>Positions: 從MarkPriceCache讀取標記價
        Positions->>Positions: 計算未實現盈虧
        Positions->>Positions: 重新計算強平價

        Positions->>DB-Positions: 更新positions表
        Positions->>DB-Positions: 寫入position_events

        Positions->>Kafka: 發布PositionUpdated
        Note over Kafka: userId, instrumentId, side<br/>quantity, entryPrice, markPrice<br/>unrealizedPnl, liquidationPrice
    and
        Kafka->>Market-Data: TradeExecuted事件
        Market-Data->>Market-Data: 更新Ticker緩存
        Note over Market-Data: last_price, volume_24h<br/>high_24h, low_24h, price_change_24h

        Market-Data->>Market-Data: K線聚合
        Market-Data->>DB-Market: 寫入market_snapshots
        Market-Data->>WebSocket: 推送最新成交
        Market-Data->>WebSocket: 推送Ticker更新
    end

    Kafka->>Positions: LedgerEntryCreated事件
    alt referenceType = TRADE (平倉確認)
        Positions->>Positions: 更新已實現盈虧
        alt 倉位數量歸零
            Positions->>DB-Positions: 更新status為CLOSED
            Positions->>Kafka: 發布PositionClosed
        end
    end

    Kafka->>Risk-Margin: PositionUpdated事件
    Risk-Margin->>Risk-Margin: 更新風險指標
    Risk-Margin->>Kafka: 發布RiskUpdate
```

**涉及的事件**:
1. `OrderCreated` (order → matching)
2. `TradeExecuted` (matching → account-ledger, positions, market-data)
3. `LedgerEntryCreated` (account-ledger → positions)
4. `PositionUpdated` (positions → risk-margin)
5. `PositionClosed` (positions)
6. `RiskUpdate` (risk-margin)

**涉及的表**:
- 內存訂單簿 (matching)
- `trade_tickers`
- `ledger_entries`
- `ledger_balances`
- `positions`
- `position_events`
- `market_snapshots`

---

### 倉位更新流程

```mermaid
sequenceDiagram
    participant Matching
    participant Positions
    participant Market-Data
    participant Risk-Margin

    Note over Matching,Positions: 成交驅動倉位更新 (已在上圖)

    Note over Market-Data: 定期計算標記價格
    Market-Data->>Market-Data: 聚合外部現貨價格
    Market-Data->>Market-Data: 計算指數價 (index_price)
    Market-Data->>Market-Data: 計算溢價指數 (premium_index)
    Market-Data->>Market-Data: 計算標記價 (mark_price)

    Market-Data->>Kafka: 發布MarkPriceUpdated
    Note over Kafka: instrumentId, indexPrice, markPrice<br/>fairPrice, premiumIndex, fundingBasis

    par 並行消費MarkPriceUpdated
        Kafka->>Positions: MarkPriceUpdated事件
        Positions->>Positions: 更新MarkPriceCache
        Positions->>DB-Positions: 查詢該instrument的所有OPEN倉位

        loop 每個倉位
            Positions->>Positions: 重新計算未實現盈虧
            Note over Positions: unrealized_pnl = <br/>(mark_price - entry_price) * qty

            alt 盈虧變化超過閾值
                Positions->>DB-Positions: 更新positions表
                Positions->>DB-Positions: 寫入position_events
                Positions->>Kafka: 發布PositionUpdated
            end
        end
    and
        Kafka->>Risk-Margin: MarkPriceUpdated事件
        Risk-Margin->>Risk-Margin: 更新既有倉位快照
        Risk-Margin->>Risk-Margin: 重新計算margin_ratio
        Risk-Margin->>Risk-Margin: 重新計算liquidation_price

        alt margin_ratio <= maintenance_margin_rate
            Risk-Margin->>DB-Risk: 寫入liquidation_queue
            Risk-Margin->>DB-Positions: 標記倉位為LIQUIDATION_PENDING
            Risk-Margin->>Kafka: 發布LiquidationTriggered
        end

        Risk-Margin->>Kafka: 發布RiskUpdate
    end
```

**涉及的事件**:
1. `MarkPriceUpdated` (market-data → positions, risk-margin)
2. `PositionUpdated` (positions → risk-margin)
3. `LiquidationTriggered` (risk-margin)
4. `RiskUpdate` (risk-margin)

---

### 風險管理與強平流程

```mermaid
sequenceDiagram
    participant Kafka
    participant Risk-Margin
    participant Liquidation-Worker
    participant Order
    participant Matching
    participant Account-Ledger
    participant Positions

    Note over Risk-Margin: 消費PositionUpdated或MarkPriceUpdated
    Risk-Margin->>Risk-Margin: 計算margin_ratio

    alt margin_ratio <= maintenance_margin_rate
        Risk-Margin->>DB-Risk: 寫入liquidation_queue (status: PENDING)
        Risk-Margin->>DB-Positions: 標記position為LIQUIDATION_PENDING
        Risk-Margin->>Kafka: 發布LiquidationTriggered
        Risk-Margin->>Kafka: 發布RiskUpdate (status: LIQUIDATION_PENDING)
    end

    Kafka->>Liquidation-Worker: LiquidationTriggered事件
    Liquidation-Worker->>DB-Risk: 查詢liquidation_queue

    loop 處理強平隊列
        Liquidation-Worker->>DB-Positions: 查詢倉位詳情

        Liquidation-Worker->>Order: POST /api/orders (強平委託)
        Note over Liquidation-Worker,Order: 以市價單平倉<br/>標記為LIQUIDATION訂單

        Order->>Kafka: 發布OrderCreated (type: MARKET, is_liquidation: true)

        Kafka->>Matching: OrderCreated事件
        Matching->>Matching: 立即撮合強平單
        Matching->>Kafka: 發布TradeExecuted

        Kafka->>Account-Ledger: TradeExecuted事件 (referenceType: LIQUIDATION)
        Account-Ledger->>Account-Ledger: 計算已實現盈虧
        Account-Ledger->>Account-Ledger: 扣除強平費用 (liquidation_fee)

        alt 穿倉 (餘額為負)
            Account-Ledger->>Account-Ledger: 記錄穿倉損失
            Account-Ledger->>Kafka: 發布InsuranceFundRequired
            Note over Account-Ledger: referenceType: INSURANCE_FUND
        end

        Account-Ledger->>DB-Ledger: 雙分錄記帳
        Account-Ledger->>Kafka: 發布LedgerEntryCreated (referenceType: LIQUIDATION)

        Kafka->>Positions: LedgerEntryCreated事件 (LIQUIDATION)
        Positions->>DB-Positions: 更新已實現盈虧
        Positions->>DB-Positions: 更新status為CLOSED
        Positions->>Kafka: 發布PositionClosed

        Liquidation-Worker->>DB-Risk: 更新liquidation_queue (status: PROCESSED)
    end
```

**涉及的API**:
- `POST /api/orders` (強平委託，內部調用)

**涉及的事件**:
1. `LiquidationTriggered` (risk-margin → liquidation-worker)
2. `RiskUpdate` (risk-margin)
3. `OrderCreated` (order → matching, 強平單)
4. `TradeExecuted` (matching)
5. `LedgerEntryCreated` (account-ledger, referenceType: LIQUIDATION)
6. `PositionClosed` (positions)
7. `InsuranceFundRequired` (account-ledger, 穿倉時)

**涉及的表**:
- `liquidation_queue`
- `risk_snapshots`
- `positions`
- `orders`
- `ledger_entries`

---

### 行情數據生成與推送流程

```mermaid
sequenceDiagram
    participant Matching
    participant Market-Data
    participant DB-Market
    participant WebSocket
    participant Redis

    Note over Matching: 訂單簿事件
    Matching->>Kafka: 發布OrderPlaced
    Matching->>Kafka: 發布OrderCancelled
    Matching->>Kafka: 發布TradeExecuted

    par 並行處理
        Kafka->>Market-Data: OrderPlaced事件
        Market-Data->>Market-Data: 更新內存訂單簿 (深度圖)
        Note over Market-Data: bids: [(price, qty)...]<br/>asks: [(price, qty)...]
        Market-Data->>Market-Data: 計算best_bid, best_ask, mid_price
        Market-Data->>Redis: 緩存訂單簿快照
        Market-Data->>WebSocket: 推送深度更新 (/ws/market/depth)
    and
        Kafka->>Market-Data: OrderCancelled事件
        Market-Data->>Market-Data: 從內存訂單簿移除
        Market-Data->>WebSocket: 推送深度更新
    and
        Kafka->>Market-Data: TradeExecuted事件
        Market-Data->>Market-Data: 更新Ticker緩存
        Note over Market-Data: last_price = trade.price<br/>volume_24h += quantity<br/>high_24h, low_24h, price_change

        Market-Data->>WebSocket: 推送最新成交 (/ws/market/trades)
        Market-Data->>WebSocket: 推送Ticker更新 (/ws/market/tickers)

        Market-Data->>Market-Data: K線聚合器收集成交
    end

    Note over Market-Data: K線定時任務 (1m/5m/1h...)
    loop 每個時間窗口
        Market-Data->>Market-Data: 從成交流聚合K線
        Note over Market-Data: open, high, low, close, volume
        Market-Data->>DB-Market: 寫入kline_buckets
        Market-Data->>Kafka: 發布KlineClosed
        Market-Data->>WebSocket: 推送K線更新 (/ws/market/kline)
    end

    Note over Market-Data: 週期性快照任務
    Market-Data->>DB-Market: 寫入market_snapshots
    Note over DB-Market: snapshot_id, instrument_id<br/>bid_depth, ask_depth<br/>last_price, volume_24h
```

**涉及的事件**:
1. `OrderPlaced` (matching → market-data)
2. `OrderCancelled` (matching → market-data)
3. `TradeExecuted` (matching → market-data)
4. `KlineClosed` (market-data → 前端, reporting)

**涉及的表**:
- 內存 TickerCache
- 內存 DepthCache (訂單簿)
- Redis 快照緩存
- `kline_buckets`
- `market_snapshots`

**WebSocket推送**:
- `/ws/market/tickers` - Ticker更新
- `/ws/market/depth` - 深度圖更新
- `/ws/market/trades` - 最新成交
- `/ws/market/kline` - K線更新

---

### 標記價格與資金費率流程

```mermaid
sequenceDiagram
    participant External-Exchanges
    participant Market-Data
    participant Positions
    participant Risk-Margin
    participant Account-Ledger
    participant DB-Market

    Note over Market-Data: 指數價格計算 (定期輪詢或推送)
    loop 每30秒
        Market-Data->>External-Exchanges: 查詢外部現貨價格
        Note over External-Exchanges: Binance, Coinbase, Kraken等

        Market-Data->>Market-Data: 聚合計算指數價
        Note over Market-Data: index_price = Σ weight_i * price_i<br/>使用VWAP平滑，過濾異常

        Market-Data->>Market-Data: 計算溢價指數
        Note over Market-Data: premium_index = <br/>(fair_price - index_price) / index_price

        Market-Data->>Market-Data: 計算標記價
        Note over Market-Data: mark_price = index_price * <br/>(1 + clamp(premium_index + funding_basis))

        Market-Data->>DB-Market: 寫入index_price歷史
        Market-Data->>Kafka: 發布MarkPriceUpdated
        Note over Kafka: instrumentId, indexPrice, markPrice<br/>fairPrice, premiumIndex, fundingBasis
    end

    par 並行消費MarkPriceUpdated
        Kafka->>Positions: MarkPriceUpdated事件
        Positions->>Positions: 更新所有倉位未實現盈虧
        Positions->>Kafka: 發布PositionUpdated
    and
        Kafka->>Risk-Margin: MarkPriceUpdated事件
        Risk-Margin->>Risk-Margin: 重新計算風險指標
        Risk-Margin->>Kafka: 發布RiskUpdate
    end

    Note over Market-Data: 資金費率計算 (每8小時)
    loop 每8小時
        Market-Data->>Market-Data: 計算資金費率
        Note over Market-Data: funding_rate = <br/>clamp(premium_index + interest_rate_diff)

        Market-Data->>DB-Market: 寫入funding_rates表
        Market-Data->>Kafka: 發布FundingRateUpdated
        Note over Kafka: instrumentId, rate, effectiveAt
    end

    Kafka->>Account-Ledger: FundingRateUpdated事件
    Account-Ledger->>DB-Positions: 查詢所有持倉用戶

    loop 每個持倉用戶
        Account-Ledger->>Account-Ledger: 計算資金費用
        Note over Account-Ledger: funding_fee = <br/>position_notional * funding_rate

        alt 多方持倉且rate > 0 (多方支付)
            Account-Ledger->>DB-Ledger: 扣除資金費 (多方)
            Account-Ledger->>DB-Ledger: 增加資金費 (空方)
        else 空方持倉且rate < 0 (空方支付)
            Account-Ledger->>DB-Ledger: 扣除資金費 (空方)
            Account-Ledger->>DB-Ledger: 增加資金費 (多方)
        end

        Account-Ledger->>DB-Ledger: 雙分錄記帳
        Account-Ledger->>Kafka: 發布LedgerEntryCreated (referenceType: FUNDING_FEE)
    end

    Kafka->>Positions: LedgerEntryCreated事件 (FUNDING_FEE)
    Positions->>DB-Positions: 累加已實現盈虧
    Positions->>DB-Positions: 寫入position_events (type: FUNDING, status: SETTLED)
```

**涉及的事件**:
1. `MarkPriceUpdated` (market-data → positions, risk-margin)
2. `FundingRateUpdated` (market-data → account-ledger)
3. `LedgerEntryCreated` (account-ledger → positions, referenceType: FUNDING_FEE)
4. `PositionUpdated` (positions)
5. `RiskUpdate` (risk-margin)

**涉及的表**:
- `funding_rates`
- `ledger_entries`
- `ledger_balances`
- `positions`
- `position_events`

**外部依賴**:
- 外部交易所API (Binance, Coinbase, Kraken等)

---

## 完整系統事件流圖

```mermaid
graph TB
    subgraph "Client Layer"
        Client[前端/交易客戶端]
        WebSocket[WebSocket連接]
    end

    subgraph "Gateway Layer"
        Gateway[API Gateway]
    end

    subgraph "Service Layer"
        Auth[Auth Service]
        User[User Service]
        Order[Order Service]
        Matching[Matching Engine]
        Positions[Positions Service]
        Risk[Risk-Margin Service]
        Ledger[Account-Ledger Service]
        Market[Market-Data Service]
    end

    subgraph "Event Bus"
        Kafka[(Kafka)]
    end

    subgraph "Storage Layer"
        MySQL[(MySQL)]
        Redis[(Redis)]
    end

    subgraph "External Systems"
        ExternalExchange[外部交易所]
    end

    Client -->|HTTP/WS| Gateway
    Gateway -->|JWT驗證| Auth
    Gateway --> User
    Gateway --> Order
    Gateway --> Positions
    Gateway --> Ledger
    Gateway --> Market

    User -.->|POST /api/auth/credentials| Auth

    Order -->|OrderSubmitted| Kafka
    Risk -->|MarginPreCheckPassed| Kafka
    Ledger -->|FundsFrozen| Kafka
    Order -->|OrderCreated| Kafka
    Order -->|OrderCancelRequested| Kafka

    Matching -->|OrderPlaced| Kafka
    Matching -->|OrderCancelled| Kafka
    Matching -->|TradeExecuted| Kafka

    Ledger -->|LedgerEntryCreated| Kafka
    Positions -->|PositionUpdated| Kafka
    Positions -->|PositionClosed| Kafka

    Market -->|MarkPriceUpdated| Kafka
    Market -->|FundingRateUpdated| Kafka
    Market -->|KlineClosed| Kafka

    Risk -->|RiskUpdate| Kafka
    Risk -->|LiquidationTriggered| Kafka

    Kafka -.->|消費事件| Order
    Kafka -.->|消費事件| Matching
    Kafka -.->|消費事件| Positions
    Kafka -.->|消費事件| Risk
    Kafka -.->|消費事件| Ledger
    Kafka -.->|消費事件| Market

    Auth --> MySQL
    User --> MySQL
    Order --> MySQL
    Matching --> MySQL
    Positions --> MySQL
    Risk --> MySQL
    Ledger --> MySQL
    Market --> MySQL

    Auth --> Redis
    Gateway --> Redis
    Market --> Redis

    ExternalExchange -.->|價格推送| Market

    Market -->|行情推送| WebSocket
    WebSocket -->|實時數據| Client

    style Kafka fill:#f9f,stroke:#333,stroke-width:4px
    style Client fill:#bbf,stroke:#333,stroke-width:2px
    style Gateway fill:#bfb,stroke:#333,stroke-width:2px
```

---

## 總結

本文檔完整呈現了交易平台中：

1. **9個核心服務**及其職責
2. **20+個REST API端點**
3. **18個核心事件**及其發布/消費關係
4. **9個主要業務流程**的完整序列圖

所有流程均採用**事件驅動架構 (EDA)**，通過Kafka實現異步解耦，確保：
- 高性能 (低延遲響應)
- 高可用 (服務解耦，容錯性強)
- 高擴展性 (各服務可獨立擴展)
- 最終一致性 (通過事件溯源與補償機制)

關鍵設計模式：
- **Saga模式** (下單流程)
- **Event Sourcing** (訂單、倉位事件)
- **CQRS** (讀寫分離)
- **雙分錄記帳** (account-ledger)
- **補償機制** (用戶註冊、強平重試)
