<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="open.vincentf13.exchange.order.infra.persistence.mapper.OrderMapper">

    <resultMap id="OrderResultMap" type="open.vincentf13.exchange.order.infra.persistence.po.OrderPO">
        <id property="id" column="order_id" />
        <result property="userId" column="user_id" />
        <result property="instrumentId" column="instrument_id" />
        <result property="clientOrderId" column="client_order_id" />
        <result property="side" column="side" />
        <result property="type" column="type" />
        <result property="status" column="status" />
        <result property="timeInForce" column="time_in_force" />
        <result property="price" column="price" />
        <result property="stopPrice" column="stop_price" />
        <result property="quantity" column="quantity" />
        <result property="filledQuantity" column="filled_quantity" />
        <result property="remainingQuantity" column="remaining_quantity" />
        <result property="avgFillPrice" column="avg_fill_price" />
        <result property="fee" column="fee" />
        <result property="source" column="source" />
        <result property="version" column="version" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
    </resultMap>

    <insert id="insert" parameterType="open.vincentf13.exchange.order.infra.persistence.po.OrderPO">
        INSERT INTO orders (
            order_id,
            user_id,
            instrument_id,
            client_order_id,
            side,
            type,
            status,
            time_in_force,
            price,
            stop_price,
            quantity,
            filled_quantity,
            remaining_quantity,
            avg_fill_price,
            fee,
            source,
            version,
            created_at,
            updated_at
        ) VALUES (
            #{id},
            #{userId},
            #{instrumentId},
            #{clientOrderId},
            #{side},
            #{type},
            #{status},
            #{timeInForce},
            #{price},
            #{stopPrice},
            #{quantity},
            #{filledQuantity},
            #{remainingQuantity},
            #{avgFillPrice},
            #{fee},
            #{source},
            #{version},
            #{createdAt},
            #{updatedAt}
        )
    </insert>

    <select id="findById" parameterType="long" resultMap="OrderResultMap">
        SELECT
            order_id,
            user_id,
            instrument_id,
            client_order_id,
            side,
            type,
            status,
            time_in_force,
            price,
            stop_price,
            quantity,
            filled_quantity,
            remaining_quantity,
            avg_fill_price,
            fee,
            source,
            version,
            created_at,
            updated_at
        FROM orders
        WHERE order_id = #{orderId}
        LIMIT 1
    </select>

    <select id="findByUserAndClientOrderId" resultMap="OrderResultMap">
        SELECT
            order_id,
            user_id,
            instrument_id,
            client_order_id,
            side,
            type,
            status,
            time_in_force,
            price,
            stop_price,
            quantity,
            filled_quantity,
            remaining_quantity,
            avg_fill_price,
            fee,
            source,
            version,
            created_at,
            updated_at
        FROM orders
        WHERE user_id = #{userId}
          AND client_order_id = #{clientOrderId}
        LIMIT 1
    </select>

    <update id="updateStatus">
        UPDATE orders
        SET status = #{status},
            updated_at = #{updatedAt},
            version = version + 1
        WHERE order_id = #{orderId}
          AND user_id = #{userId}
          AND version = #{expectedVersion}
    </update>
</mapper>
