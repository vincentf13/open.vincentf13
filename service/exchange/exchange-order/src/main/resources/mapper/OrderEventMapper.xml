<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="open.vincentf13.exchange.order.infra.persistence.mapper.OrderEventMapper">

    <insert id="insertWithSequence" parameterType="open.vincentf13.exchange.order.infra.persistence.po.OrderEventPO">
        INSERT INTO order_events (
            event_id,
            order_id,
            user_id,
            instrument_id,
            event_type,
            payload,
            reference_id,
            reference_type,
            actor,
            occurred_at,
            sequence_number,
            created_at
        )
        SELECT
            #{eventId},
            #{orderId},
            #{userId},
            #{instrumentId},
            #{eventType},
            #{payload},
            #{referenceId},
            #{referenceType},
            #{actor},
            #{occurredAt},
            COALESCE(MAX(sequence_number), 0) + 1,
            CURRENT_TIMESTAMP
        FROM order_events
        WHERE order_id = #{orderId}
    </insert>
</mapper>
