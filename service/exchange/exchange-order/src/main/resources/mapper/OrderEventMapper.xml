<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="open.vincentf13.exchange.order.infra.persistence.mapper.OrderEventMapper">

    <resultMap id="OrderEventResultMap" type="open.vincentf13.exchange.order.infra.persistence.po.OrderEventPO">
        <id property="eventId" column="event_id"/>
        <result property="userId" column="user_id"/>
        <result property="instrumentId" column="instrument_id"/>
        <result property="orderId" column="order_id"/>
        <result property="eventType" column="event_type"/>
        <result property="sequenceNumber" column="sequence_number"/>
        <result property="payload" column="payload"/>
        <result property="referenceId" column="reference_id"/>
        <result property="referenceType" column="reference_type"/>
        <result property="actor" column="actor"/>
        <result property="occurredAt" column="occurred_at"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <insert id="insert" parameterType="open.vincentf13.exchange.order.infra.persistence.po.OrderEventPO">
        INSERT INTO order_events (
            event_id,
            user_id,
            instrument_id,
            order_id,
            event_type,
            (SELECT COALESCE(MAX(sequence_number), 0) + 1 FROM order_events WHERE order_id = #{orderId} FOR UPDATE) AS sequence_number,
            payload,
            reference_type,
            reference_id,
            actor,
            occurred_at,
            created_at
        ) VALUES (
            #{eventId},
            #{userId},
            #{instrumentId},
            #{orderId},
            #{eventType},
            #{sequenceNumber},
            #{payload},
            #{referenceType},
            #{referenceId},
            #{actor},
            #{occurredAt},
            #{createdAt}
        )
    </insert>

    <select id="findBy" parameterType="open.vincentf13.exchange.order.infra.persistence.po.OrderEventPO"
            resultMap="OrderEventResultMap">
        SELECT
            event_id,
            user_id,
            instrument_id,
            order_id,
            event_type,
            sequence_number,
            payload,
            reference_type,
            reference_id,
            actor,
            occurred_at,
            created_at
        FROM order_events
        <where>
            <if test="eventId != null">AND event_id = #{eventId}</if>
            <if test="userId != null">AND user_id = #{userId}</if>
            <if test="instrumentId != null">AND instrument_id = #{instrumentId}</if>
            <if test="orderId != null">AND order_id = #{orderId}</if>
            <if test="eventType != null">AND event_type = #{eventType}</if>
            <if test="sequenceNumber != null">AND sequence_number = #{sequenceNumber}</if>
            <if test="referenceType != null">AND reference_type = #{referenceType}</if>
            <if test="referenceId != null">AND reference_id = #{referenceId}</if>
            <if test="actor != null">AND actor = #{actor}</if>
            <if test="occurredAt != null">AND occurred_at = #{occurredAt}</if>
            <if test="createdAt != null">AND created_at = #{createdAt}</if>
        </where>
        ORDER BY sequence_number ASC
    </select>

</mapper>
