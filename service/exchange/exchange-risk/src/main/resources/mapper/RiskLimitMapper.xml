<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="open.vincentf13.exchange.risk.infra.persistence.mapper.RiskLimitMapper">

    <select id="findBy" parameterType="RiskLimitPO" resultType="RiskLimitPO">
        SELECT *
        FROM risk_limits
        <where>
            <if test="riskLimitId != null">AND id = #{riskLimitId}</if>
            <if test="instrumentId != null">AND instrument_id = #{instrumentId}</if>
            <if test="active != null">AND is_active = #{active}</if>
        </where>
    </select>

    <select id="findEffective" resultType="RiskLimitPO">
        SELECT *
        FROM risk_limits
        WHERE instrument_id = #{instrumentId}
          AND is_active = 1
        ORDER BY updated_at DESC
        LIMIT 1
    </select>

    <insert id="insertSelective" parameterType="RiskLimitPO">
        INSERT INTO risk_limits
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="riskLimitId != null">id,</if>
            <if test="instrumentId != null">instrument_id,</if>
            <if test="initialMarginRate != null">initial_margin_rate,</if>
            <if test="maxLeverage != null">max_leverage,</if>
            <if test="maintenanceMarginRate != null">maintenance_margin_rate,</if>
            <if test="liquidationFeeRate != null">liquidation_fee_rate,</if>
            <if test="positionSizeMin != null">position_size_min,</if>
            <if test="positionSizeMax != null">position_size_max,</if>
            <if test="maxPositionValue != null">max_position_value,</if>
            <if test="maxOrderValue != null">max_order_value,</if>
            <if test="active != null">is_active,</if>
        </trim>
        VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="riskLimitId != null">#{riskLimitId},</if>
            <if test="instrumentId != null">#{instrumentId},</if>
            <if test="initialMarginRate != null">#{initialMarginRate},</if>
            <if test="maxLeverage != null">#{maxLeverage},</if>
            <if test="maintenanceMarginRate != null">#{maintenanceMarginRate},</if>
            <if test="liquidationFeeRate != null">#{liquidationFeeRate},</if>
            <if test="positionSizeMin != null">#{positionSizeMin},</if>
            <if test="positionSizeMax != null">#{positionSizeMax},</if>
            <if test="maxPositionValue != null">#{maxPositionValue},</if>
            <if test="maxOrderValue != null">#{maxOrderValue},</if>
            <if test="active != null">#{active},</if>
        </trim>
    </insert>

    <update id="updateActiveByIdAndVersion">
        UPDATE risk_limits
        SET is_active = #{active},
            version = version + 1
        WHERE id = #{riskLimitId}
        <if test="expectedVersion != null">
            AND version = #{expectedVersion}
        </if>
    </update>
</mapper>
