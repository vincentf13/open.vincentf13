<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="open.vincentf13.exchange.risk.infra.persistence.mapper.RiskLimitMapper">

    <resultMap id="RiskLimitResultMap" type="open.vincentf13.exchange.risk.infra.persistence.po.RiskLimitPO">
        <id property="riskLimitId" column="id" />
        <result property="instrumentId" column="instrument_id" />
        <result property="tier" column="tier" />
        <result property="initialMarginRate" column="initial_margin_rate" />
        <result property="maxLeverage" column="max_leverage" />
        <result property="maintenanceMarginRate" column="maintenance_margin_rate" />
        <result property="liquidationFeeRate" column="liquidation_fee_rate" />
        <result property="positionSizeMin" column="position_size_min" />
        <result property="positionSizeMax" column="position_size_max" />
        <result property="maxPositionValue" column="max_position_value" />
        <result property="maxOrderValue" column="max_order_value" />
        <result property="active" column="is_active" />
        <result property="effectiveFrom" column="effective_from" />
        <result property="effectiveTo" column="effective_to" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
    </resultMap>

    <select id="findEffective" resultMap="RiskLimitResultMap">
        SELECT *
        FROM risk_limits
        WHERE instrument_id = #{instrumentId}
          AND (#{tier} IS NULL OR tier = #{tier})
          AND is_active = 1
          AND effective_from <= #{asOf}
          AND (effective_to IS NULL OR effective_to >= #{asOf})
        ORDER BY tier ASC
        LIMIT 1
    </select>

    <select id="findActiveByInstrument" resultMap="RiskLimitResultMap">
        SELECT *
        FROM risk_limits
        WHERE instrument_id = #{instrumentId}
          AND is_active = 1
          AND effective_from <= #{asOf}
          AND (effective_to IS NULL OR effective_to >= #{asOf})
        ORDER BY tier ASC
    </select>

    <insert id="insert" parameterType="open.vincentf13.exchange.risk.infra.persistence.po.RiskLimitPO">
        INSERT INTO risk_limits (
            id,
            instrument_id,
            tier,
            initial_margin_rate,
            max_leverage,
            maintenance_margin_rate,
            liquidation_fee_rate,
            position_size_min,
            position_size_max,
            max_position_value,
            max_order_value,
            is_active,
            effective_from,
            effective_to,
            created_at,
            updated_at
        ) VALUES (
            #{riskLimitId},
            #{instrumentId},
            #{tier},
            #{initialMarginRate},
            #{maxLeverage},
            #{maintenanceMarginRate},
            #{liquidationFeeRate},
            #{positionSizeMin},
            #{positionSizeMax},
            #{maxPositionValue},
            #{maxOrderValue},
            #{active},
            #{effectiveFrom},
            #{effectiveTo},
            #{createdAt},
            #{updatedAt}
        )
    </insert>

    <update id="update" parameterType="open.vincentf13.exchange.risk.infra.persistence.po.RiskLimitPO">
        UPDATE risk_limits
        <set>
            instrument_id = #{instrumentId},
            tier = #{tier},
            initial_margin_rate = #{initialMarginRate},
            max_leverage = #{maxLeverage},
            maintenance_margin_rate = #{maintenanceMarginRate},
            liquidation_fee_rate = #{liquidationFeeRate},
            position_size_min = #{positionSizeMin},
            position_size_max = #{positionSizeMax},
            max_position_value = #{maxPositionValue},
            max_order_value = #{maxOrderValue},
            is_active = #{active},
            effective_from = #{effectiveFrom},
            effective_to = #{effectiveTo},
            updated_at = #{updatedAt}
        </set>
        WHERE id = #{riskLimitId}
    </update>
</mapper>
