# 使用前請先執行 position_setup.http 以初始化 Token 與配置
@gatewayHost = http://localhost:12345
@instrumentId = 10001

### 讀取帳號 A 資產 (現貨/逐倉) 作為基準
GET {{gatewayHost}}/account/api/account/balance-sheet
Authorization: Bearer {{tokenA}}

> {%
    var data = response.body.data;
    var assets = data.assets || [];
    var instrumentId = parseInt(client.global.get("instrumentId"));
    var assetCode = "USDT";
    var spot = assets.find(a => a.accountCode === "SPOT" && a.asset === assetCode);
    var margin = assets.find(a => a.accountCode === "MARGIN" && a.instrumentId == instrumentId && a.asset === assetCode);
    client.assert(spot != null, "Spot account not found for baseline");
    client.global.set("baseSpotBalance", spot.balance);
    client.global.set("baseSpotAvailable", spot.available);
    client.global.set("baseSpotReserved", spot.reserved);
    client.global.set("baseMarginBalance", margin ? margin.balance : 0);
    client.global.set("baseMarginAvailable", margin ? margin.available : 0);
    client.global.set("baseMarginReserved", margin ? margin.reserved : 0);
    client.log("Baseline loaded: Spot=" + spot.balance + ", Margin=" + (margin ? margin.balance : 0));
%}

### [開倉] A Sell 5 (B Buy 5) @ 100 -> A 預期持空倉 5
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 100,
  "quantity": 5000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 100,
  "quantity": 5000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Short 5
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 5: Position Logic Check", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "SHORT");
        client.global.set("expQty", 5000);
        // Entry avg = (100 * 5) / 5 = 100
        client.global.set("expEntry", 100);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 100);
        // Fee (this step): 5 * 100 * 0.0002 = 0.1
        // PnL - Fee = 0 - 0.1 = -0.1
        client.global.set("expCumRealizedPnl", -0.1);
        // Fee: 5 * 100 * 0.0002 = 0.1
        client.global.set("expCumFee", 0.1);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 驗證 A 資產: Spot/Margin
GET {{gatewayHost}}/account/api/account/balance-sheet
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 5: Account Balance Check", function() {
        eval(client.global.get("verifyAccountScript"));
    });
%}

### [減倉] A Buy 3 (B Sell 3) @ 101 -> A 預期持空倉 2
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 101,
  "quantity": 3000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 101,
  "quantity": 3000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Short 2
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 6: Position Logic Check", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "SHORT");
        client.global.set("expQty", 2000);
        // Entry = (100 * 2) / 2 = 100 (reduce only)
        client.global.set("expEntry", 100);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 101);
        // PnL: (100 - 101) * 3 = -3 (Short Sell)
        // Fee (this step): 3 * 101 * 0.0002 = 0.0606
        // PnL - Fee = -3 - 0.0606 = -3.0606 (Cum = -0.1 - 3.0606 = -3.1606)
        client.global.set("expCumRealizedPnl", -3.1606);
        // Fee: 0.1 + (3 * 101 * 0.0002) = 0.1606
        client.global.set("expCumFee", 0.1606);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 驗證 A 資產: Spot/Margin
GET {{gatewayHost}}/account/api/account/balance-sheet
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 6: Account Balance Check", function() {
        eval(client.global.get("verifyAccountScript"));
    });
%}

### [增倉] A Sell 2 (B Buy 2) @ 102 -> A 預期持空倉 4
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 102,
  "quantity": 2000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 102,
  "quantity": 2000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Short 4
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 7: Position Logic Check", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "SHORT");
        client.global.set("expQty", 4000);
        // Entry avg = (100 * 2 + 102 * 2) / 4 = 101
        client.global.set("expEntry", 101);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 102);
        // PnL: -3 (No change on increase)
        // Fee (this step): 2 * 102 * 0.0002 = 0.0408
        // PnL - Fee = 0 - 0.0408 = -0.0408 (Cum = -3.1606 - 0.0408 = -3.2014)
        client.global.set("expCumRealizedPnl", -3.2014);
        // Fee: 0.1606 + (2 * 102 * 0.0002) = 0.2014
        client.global.set("expCumFee", 0.2014);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 驗證 A 資產: Spot/Margin
GET {{gatewayHost}}/account/api/account/balance-sheet
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 7: Account Balance Check", function() {
        eval(client.global.get("verifyAccountScript"));
    });
%}

### [平倉] A Buy 4 (B Sell 4) @ 99 -> A 預期持倉 0 (因為之前是空倉 4)
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 99,
  "quantity": 4000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 99,
  "quantity": 4000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Closed
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 8: Position Logic Check (Close)", function() {
        client.global.set("expStatus", "CLOSED");
        client.global.set("expSide", "SHORT");
        client.global.set("expQty", 0);
        // Entry avg = (100 * 2 + 102 * 2) / 4 = 101
        client.global.set("expEntry", 101);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 99);
        // PnL: (101 - 99) * 4 = 8 (Avg entry 101, Close 4)
        // Fee (this step): 4 * 99 * 0.0002 = 0.0792
        // PnL - Fee = 8 - 0.0792 = 7.9208 (Cum = -3.2014 + 7.9208 = 4.7194)
        client.global.set("expCumRealizedPnl", 4.7194);
        // Fee: 0.2014 + (4 * 99 * 0.0002) = 0.2806
        client.global.set("expCumFee", 0.2806);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 驗證 A 資產: Spot/Margin
GET {{gatewayHost}}/account/api/account/balance-sheet
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 8: Account Balance Check", function() {
        eval(client.global.get("verifyAccountScript"));
    });
%}

### [再次開倉] A Sell 5 (B Buy 5) @ 98 -> A 預期持空倉 5
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 98,
  "quantity": 5000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 98,
  "quantity": 5000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Short 5
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 9: Position Logic Check (Open)", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "SHORT");
        client.global.set("expQty", 5000);
        // Entry avg = (98 * 5) / 5 = 98
        client.global.set("expEntry", 98);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 98);
        // PnL: 5 (No change on open)
        // Fee (this step): 5 * 98 * 0.0002 = 0.098
        // PnL - Fee = 0 - 0.098 = -0.098 (Cum = 4.7194 - 0.098 = 4.6214)
        client.global.set("expCumRealizedPnl", 4.6214);
        // Fee: 0.2806 + (5 * 98 * 0.0002) = 0.3786
        client.global.set("expCumFee", 0.3786);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 驗證 A 資產: Spot/Margin
GET {{gatewayHost}}/account/api/account/balance-sheet
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 9: Account Balance Check", function() {
        eval(client.global.get("verifyAccountScript"));
    });
%}

### [Flip 反手] A Buy 10 (B Sell 10) @ 100 -> A 預期持多倉 5 (原空 5 - 買 10)
# A 原本持空倉 5，買 10 變多 5
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 100,
  "quantity": 10000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 100,
  "quantity": 10000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Long 5
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 10: Position Logic Check", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "LONG");
        client.global.set("expQty", 5000);
        // Entry avg = (100 * 5) / 5 = 100
        client.global.set("expEntry", 100);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 100);
        // PnL: 5 + ((98 - 100) * 5) = -5 (Short entry 98, Close 5)
        // Fee (this step): 10 * 100 * 0.0002 = 0.2
        // PnL - Fee = -10 - 0.2 = -10.2 (Cum = 4.6214 - 10.2 = -5.5786)
        client.global.set("expCumRealizedPnl", -5.5786);
        // Fee: 0.3786 + (10 * 100 * 0.0002) = 0.5786
        client.global.set("expCumFee", 0.5786);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 驗證 A 資產: Spot/Margin
GET {{gatewayHost}}/account/api/account/balance-sheet
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 10: Account Balance Check", function() {
        eval(client.global.get("verifyAccountScript"));
    });
%}

### [Flip 並發測試] A 同時下二單 (Sell 3, Sell 10) @ 100，B 依序成交 -> A 預期持空倉 8
# A 原本持多倉 5，賣 3 變多 2，再賣 10 變空 8
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 100,
  "quantity": 3000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 100,
  "quantity": 10000
}

> {%
    eval(client.global.get("waitMaker"));
%}

### B 成交 A 的 10 張
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 100,
  "quantity": 10000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### B 成交 A 的 3 張
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 100,
  "quantity": 3000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Short 8
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 11: Position Logic Check (Concurrency)", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "SHORT");
        client.global.set("expQty", 8000);
        // Entry avg = (100 * 8) / 8 = 100
        client.global.set("expEntry", 100);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 100);
        // PnL: -5 + ((100 - 100) * 5) = -5 (Long entry 100, Close 5)
        // Fee (this step): 13 * 100 * 0.0002 = 0.26
        // PnL - Fee = 0 - 0.26 = -0.26 (Cum = -5.5786 - 0.26 = -5.8386)
        client.global.set("expCumRealizedPnl", -5.8386);
        // Fee: 0.5786 + (13 * 100 * 0.0002) = 0.8386
        client.global.set("expCumFee", 0.8386);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 驗證 A 資產: Spot/Margin
GET {{gatewayHost}}/account/api/account/balance-sheet
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 11: Account Balance Check", function() {
        eval(client.global.get("verifyAccountScript"));
    });
%}
