# 使用前請先執行 position_setup.http 以初始化 Token 與配置
@gatewayHost = http://localhost:12345
@instrumentId = 10001

### 5. [開倉] A Sell 5 (B Buy 5) -> A 預期持空倉 5
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 10,
  "quantity": 5
}

> {%
    eval(client.global.get("waitScript"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 10,
  "quantity": 5
}

> {%
    eval(client.global.get("waitScript"));
%}

### 5-Check. 驗證 A 持倉: Short 5
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 5: Position Logic Check", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "SHORT");
        client.global.set("expQty", 5);
        client.global.set("expEntry", 10);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 10);
        client.global.set("expCumRealizedPnl", 0);
        // Fee: 5 * 10 * 0.0002 = 0.01
        client.global.set("expCumFee", 0.01);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 6. [減倉] A Buy 3 (B Sell 3) -> A 預期持空倉 2
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 11,
  "quantity": 3
}

> {%
    eval(client.global.get("waitScript"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 11,
  "quantity": 3
}

> {%
    eval(client.global.get("waitScript"));
%}

### 6-Check. 驗證 A 持倉: Short 2
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 6: Position Logic Check", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "SHORT");
        client.global.set("expQty", 2);
        client.global.set("expEntry", 10);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 11);
        // PnL: (10 - 11) * 3 = -3 (Short Sell)
        client.global.set("expCumRealizedPnl", -3);
        // Fee: 0.01 + (3 * 11 * 0.0002) = 0.0166
        client.global.set("expCumFee", 0.0166);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 7. [增倉] A Sell 2 (B Buy 2) -> A 預期持空倉 4
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 12,
  "quantity": 2
}

> {%
    eval(client.global.get("waitScript"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 12,
  "quantity": 2
}

> {%
    eval(client.global.get("waitScript"));
%}

### 7-Check. 驗證 A 持倉: Short 4
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 7: Position Logic Check", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "SHORT");
        client.global.set("expQty", 4);
        client.global.set("expEntry", 11);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 12);
        // PnL: -3 (No change on increase)
        client.global.set("expCumRealizedPnl", -3);
        // Fee: 0.0166 + (2 * 12 * 0.0002) = 0.0214
        client.global.set("expCumFee", 0.0214);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 8. [平倉] A Buy 5 (B Sell 5) -> A 預期持多倉 1 (因為之前是空倉 4)
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 9,
  "quantity": 5
}

> {%
    eval(client.global.get("waitScript"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 9,
  "quantity": 5
}

> {%
    eval(client.global.get("waitScript"));
%}

### 8-Check. 驗證 A 持倉: Long 1
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 8: Position Logic Check (Flip to Long)", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "LONG");
        client.global.set("expQty", 1);
        client.global.set("expEntry", 9);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 9);
        // PnL: -3 + ((11 - 9) * 4) = 5 (Avg entry 11, Close 4)
        client.global.set("expCumRealizedPnl", 5);
        // Fee: 0.0214 + (5 * 9 * 0.0002) = 0.0304
        client.global.set("expCumFee", 0.0304);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 9. [再次開倉] A Sell 5 (B Buy 5) -> A 預期持空倉 4 (原多 1 + 賣 5)
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 8,
  "quantity": 5
}

> {%
    eval(client.global.get("waitScript"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 8,
  "quantity": 5
}

> {%
    eval(client.global.get("waitScript"));
%}

### 9-Check. 驗證 A 持倉: Short 4
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 9: Position Logic Check (Flip back to Short)", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "SHORT");
        client.global.set("expQty", 4);
        client.global.set("expEntry", 8);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 8);
        // PnL: 5 + ((8 - 9) * 1) = 4 (Long entry 9, Close 1)
        client.global.set("expCumRealizedPnl", 4);
        // Fee: 0.0304 + (5 * 8 * 0.0002) = 0.0384
        client.global.set("expCumFee", 0.0384);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 10. [Flip 反手] A Buy 9 (B Sell 9) -> A 預期持多倉 5 (原空 4 - 買 9)
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 10,
  "quantity": 9
}

> {%
    eval(client.global.get("waitScript"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 10,
  "quantity": 9
}

> {%
    eval(client.global.get("waitScript"));
%}

### 10-Check. 驗證 A 持倉: Long 5
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 10: Position Logic Check", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "LONG");
        client.global.set("expQty", 5);
        client.global.set("expEntry", 10);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 10);
        // PnL: 4 + ((8 - 10) * 4) = -4 (Short entry 8, Close 4)
        client.global.set("expCumRealizedPnl", -4);
        // Fee: 0.0384 + (9 * 10 * 0.0002) = 0.0564
        client.global.set("expCumFee", 0.0564);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### 11. [Flip 並發測試] A 同時下二單 (Sell 3, Sell 10)，B 依序成交 -> A 預期持空倉 8
# A 原本持多倉 5，賣 3 變多 2，再賣 10 變空 8
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 10,
  "quantity": 3
}

> {%
    eval(client.global.get("waitScript"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 10,
  "quantity": 10
}

> {%
    eval(client.global.get("waitScript"));
%}

### B 成交 A 的 10 張
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 10,
  "quantity": 10
}

> {%
    eval(client.global.get("waitScript"));
%}

### B 成交 A 的 3 張
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 10,
  "quantity": 3
}

> {%
    eval(client.global.get("waitScript"));
%}

### 11-Check. 驗證 A 持倉: Short 8
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 11: Position Logic Check (Concurrency)", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "SHORT");
        client.global.set("expQty", 8);
        client.global.set("expEntry", 10);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 10);
        // PnL: -4 + ((10 - 10) * 5) = -4 (Long entry 10, Close 5)
        client.global.set("expCumRealizedPnl", -4);
        // Fee: 0.0564 + (13 * 10 * 0.0002) = 0.0824
        client.global.set("expCumFee", 0.0824);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}