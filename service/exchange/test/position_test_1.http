# 使用前請先執行 position_setup.http 以初始化 Token 與配置
@gatewayHost = http://localhost:12345
@instrumentId = 10001

### [開倉] A Buy 5 (B Sell 5) @ 10 -> A 預期持多倉 5
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 10,
  "quantity": 5000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 10,
  "quantity": 5000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Long 5, Price 10
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 5: Position Logic Check", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "LONG");
        client.global.set("expQty", 5000);
        // Entry avg = (10 * 5) / 5 = 10
        client.global.set("expEntry", 10);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 10);
        // Fee (this step): 5 * 10 * 0.0002 = 0.01
        // PnL - Fee = 0 - 0.01 = -0.01
        client.global.set("expCumRealizedPnl", -0.01);
        // Fee: 5 * 10 * 0.0002 = 0.01
        client.global.set("expCumFee", 0.01);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### [減倉] A Sell 3 (B Buy 3) @ 11 -> A 預期持多倉 2
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 11,
  "quantity": 3000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 11,
  "quantity": 3000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Long 2
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 6: Position Logic Check", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "LONG");
        client.global.set("expQty", 2000);
        // Entry = (10 * 2) / 2 = 10 (reduce only)
        client.global.set("expEntry", 10);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 11);
        // PnL: (11 - 10) * 3 = 3
        // Fee (this step): 3 * 11 * 0.0002 = 0.0066
        // PnL - Fee = 3 - 0.0066 = 2.9934 (Cum = -0.01 + 2.9934 = 2.9834)
        client.global.set("expCumRealizedPnl", 2.9834);
        // Fee: 0.01 + (3 * 11 * 0.0002) = 0.0166
        client.global.set("expCumFee", 0.0166);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### [增倉] A Buy 2 (B Sell 2) @ 12 -> A 預期持多倉 4
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 12,
  "quantity": 2000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 12,
  "quantity": 2000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Long 4
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 7: Position Logic Check", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "LONG");
        client.global.set("expQty", 4000);
        // Entry avg = (10 * 2 + 12 * 2) / 4 = 11
        client.global.set("expEntry", 11);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 12);
        // PnL: 3 (No change on increase)
        // Fee (this step): 2 * 12 * 0.0002 = 0.0048
        // PnL - Fee = 0 - 0.0048 = -0.0048 (Cum = 2.9834 - 0.0048 = 2.9786)
        client.global.set("expCumRealizedPnl", 2.9786);
        // Fee: 0.0166 + (2 * 12 * 0.0002) = 0.0214
        client.global.set("expCumFee", 0.0214);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### [平倉] A Sell 4 (B Buy 4) @ 9 -> A 預期持倉 0 (因為之前是多倉 4)
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 9,
  "quantity": 4000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 9,
  "quantity": 4000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Closed
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 8: Position Logic Check (Close)", function() {
        client.global.set("expStatus", "CLOSED");
        client.global.set("expSide", "LONG");
        client.global.set("expQty", 0);
        // Entry avg = (10 * 2 + 12 * 2) / 4 = 11
        client.global.set("expEntry", 11);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 9);
        // PnL: (9 - 11) * 4 = -8 (Avg entry 11, Close 4)
        // Fee (this step): 4 * 9 * 0.0002 = 0.0072
        // PnL - Fee = -8 - 0.0072 = -8.0072 (Cum = 2.9786 - 8.0072 = -5.0286)
        client.global.set("expCumRealizedPnl", -5.0286);
        // Fee: 0.0214 + (4 * 9 * 0.0002) = 0.0286
        client.global.set("expCumFee", 0.0286);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### [再次開倉] A Buy 5 (B Sell 5) @ 8 -> A 預期持多倉 5
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 8,
  "quantity": 5000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 8,
  "quantity": 5000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Long 5
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 9: Position Logic Check (Open)", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "LONG");
        client.global.set("expQty", 5000);
        // Entry avg = (8 * 5) / 5 = 8
        client.global.set("expEntry", 8);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 8);
        // PnL: -5 (No change on open)
        // Fee (this step): 5 * 8 * 0.0002 = 0.008
        // PnL - Fee = 0 - 0.008 = -0.008 (Cum = -5.0286 - 0.008 = -5.0366)
        client.global.set("expCumRealizedPnl", -5.0366);
        // Fee: 0.0286 + (5 * 8 * 0.0002) = 0.0366
        client.global.set("expCumFee", 0.0366);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### [Flip 反手] A Sell 10 (B Buy 10) @ 10 -> A 預期持空倉 5 (原多 5 - 賣 10)
# A 原本持多倉 5，賣 10 變空 5
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 10,
  "quantity": 10000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 10,
  "quantity": 10000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Short 5
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 10: Position Logic Check", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "SHORT");
        client.global.set("expQty", 5000);
        // Entry avg = (10 * 5) / 5 = 10
        client.global.set("expEntry", 10);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 10);
        // PnL: -5 + ((10 - 8) * 5) = 5 (Long entry 8, Close 5)
        // Fee (this step): 10 * 10 * 0.0002 = 0.02
        // PnL - Fee = 10 - 0.02 = 9.98 (Cum = -5.0366 + 9.98 = 4.9434)
        client.global.set("expCumRealizedPnl", 4.9434);
        // Fee: 0.0366 + (10 * 10 * 0.0002) = 0.0566
        client.global.set("expCumFee", 0.0566);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}

### [Flip 並發測試] A 同時下二單 (Buy 3, Buy 10) @ 10，B 依序成交 -> A 預期持多倉 8
# A 原本持空倉 5，買 3 變空 2，再買 10 變多 8
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 10,
  "quantity": 3000
}

> {%
    eval(client.global.get("waitMaker"));
%}

###
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenA}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "BUY",
  "type": "LIMIT",
  "price": 10,
  "quantity": 10000
}

> {%
    eval(client.global.get("waitMaker"));
%}

### B 成交 A 的 10 張
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 10,
  "quantity": 10000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### B 成交 A 的 3 張
POST {{gatewayHost}}/order/api/orders
Authorization: Bearer {{tokenB}}
Content-Type: application/json

{
  "instrumentId": {{instrumentId}},
  "side": "SELL",
  "type": "LIMIT",
  "price": 10,
  "quantity": 3000
}

> {%
    eval(client.global.get("waitTaker"));
%}

### 驗證 A 持倉: Long 8
GET {{gatewayHost}}/position/api/positions?instrumentId={{instrumentId}}
Authorization: Bearer {{tokenA}}

> {%
    client.test("Step 11: Position Logic Check (Concurrency)", function() {
        client.global.set("expStatus", "ACTIVE");
        client.global.set("expSide", "LONG");
        client.global.set("expQty", 8000);
        // Entry avg = (10 * 8) / 8 = 10
        client.global.set("expEntry", 10);
        client.global.set("expCloseReserved", 0);
        client.global.set("expMarkPrice", 10);
        // PnL: 5 + ((10 - 10) * 5) = 5 (Short entry 10, Close 5)
        // Fee (this step): 13 * 10 * 0.0002 = 0.026
        // PnL - Fee = 0 - 0.026 = -0.026 (Cum = 4.9434 - 0.026 = 4.9174)
        client.global.set("expCumRealizedPnl", 4.9174);
        // Fee: 0.0566 + (13 * 10 * 0.0002) = 0.0826
        client.global.set("expCumFee", 0.0826);
        client.global.set("expCumFundingFee", 0);
        eval(client.global.get("verifyScript"));
    });
%}
