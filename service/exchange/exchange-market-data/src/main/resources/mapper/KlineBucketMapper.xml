<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="open.vincentf13.exchange.marketdata.infra.persistence.mapper.KlineBucketMapper">

    <insert id="insertSelective" parameterType="KlineBucketPO">
        INSERT INTO kline_buckets
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="bucketId != null">bucket_id,</if>
            <if test="instrumentId != null">instrument_id,</if>
            <if test="period != null">period,</if>
            <if test="bucketStart != null">bucket_start,</if>
            <if test="bucketEnd != null">bucket_end,</if>
            <if test="openPrice != null">open_price,</if>
            <if test="highPrice != null">high_price,</if>
            <if test="lowPrice != null">low_price,</if>
            <if test="closePrice != null">close_price,</if>
            <if test="volume != null">volume,</if>
            <if test="turnover != null">turnover,</if>
            <if test="tradeCount != null">trade_count,</if>
            <if test="takerBuyVolume != null">taker_buy_volume,</if>
            <if test="takerBuyTurnover != null">taker_buy_turnover,</if>
            <if test="closed != null">is_closed,</if>
        </trim>
        VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="bucketId != null">#{bucketId},</if>
            <if test="instrumentId != null">#{instrumentId},</if>
            <if test="period != null">#{period},</if>
            <if test="bucketStart != null">#{bucketStart},</if>
            <if test="bucketEnd != null">#{bucketEnd},</if>
            <if test="openPrice != null">#{openPrice},</if>
            <if test="highPrice != null">#{highPrice},</if>
            <if test="lowPrice != null">#{lowPrice},</if>
            <if test="closePrice != null">#{closePrice},</if>
            <if test="volume != null">#{volume},</if>
            <if test="turnover != null">#{turnover},</if>
            <if test="tradeCount != null">#{tradeCount},</if>
            <if test="takerBuyVolume != null">#{takerBuyVolume},</if>
            <if test="takerBuyTurnover != null">#{takerBuyTurnover},</if>
            <if test="closed != null">#{closed},</if>
        </trim>
    </insert>

    <update id="updateSelectiveBy">
        UPDATE kline_buckets
        <set>
            <if test="record.instrumentId != null">instrument_id = #{record.instrumentId},</if>
            <if test="record.period != null">period = #{record.period},</if>
            <if test="record.bucketStart != null">bucket_start = #{record.bucketStart},</if>
            <if test="record.bucketEnd != null">bucket_end = #{record.bucketEnd},</if>
            <if test="record.openPrice != null">open_price = #{record.openPrice},</if>
            <if test="record.highPrice != null">high_price = #{record.highPrice},</if>
            <if test="record.lowPrice != null">low_price = #{record.lowPrice},</if>
            <if test="record.closePrice != null">close_price = #{record.closePrice},</if>
            <if test="record.volume != null">volume = #{record.volume},</if>
            <if test="record.turnover != null">turnover = #{record.turnover},</if>
            <if test="record.tradeCount != null">trade_count = #{record.tradeCount},</if>
            <if test="record.takerBuyVolume != null">taker_buy_volume = #{record.takerBuyVolume},</if>
            <if test="record.takerBuyTurnover != null">taker_buy_turnover = #{record.takerBuyTurnover},</if>
            <if test="record.closed != null">is_closed = #{record.closed},</if>
        </set>
        WHERE bucket_id = #{bucketId}
          <if test="instrumentId != null">AND instrument_id = #{instrumentId}</if>
          <if test="period != null">AND period = #{period}</if>
          <if test="closed != null">AND is_closed = #{closed}</if>
    </update>

    <select id="findByInstrumentPeriodAndStart" resultType="KlineBucketPO">
        SELECT
            bucket_id,
            instrument_id,
            period,
            bucket_start,
            bucket_end,
            open_price,
            high_price,
            low_price,
            close_price,
            volume,
            turnover,
            trade_count,
            taker_buy_volume,
            taker_buy_turnover,
            is_closed,
            created_at,
            updated_at
        FROM kline_buckets
        WHERE instrument_id = #{instrumentId}
          AND period = #{period}
          AND bucket_start = #{bucketStart}
        LIMIT 1
    </select>

    <select id="findActiveBucket" resultType="KlineBucketPO">
        SELECT
            bucket_id,
            instrument_id,
            period,
            bucket_start,
            bucket_end,
            open_price,
            high_price,
            low_price,
            close_price,
            volume,
            turnover,
            trade_count,
            taker_buy_volume,
            taker_buy_turnover,
            is_closed,
            created_at,
            updated_at
        FROM kline_buckets
        WHERE instrument_id = #{instrumentId}
          AND period = #{period}
          AND bucket_start <= #{targetTime}
          AND bucket_end > #{targetTime}
        ORDER BY bucket_start DESC
        LIMIT 1
    </select>

    <select id="findRecentBuckets" resultType="KlineBucketPO">
        SELECT
            bucket_id,
            instrument_id,
            period,
            bucket_start,
            bucket_end,
            open_price,
            high_price,
            low_price,
            close_price,
            volume,
            turnover,
            trade_count,
            taker_buy_volume,
            taker_buy_turnover,
            is_closed,
            created_at,
            updated_at
        FROM kline_buckets
        WHERE instrument_id = #{instrumentId}
          AND period = #{period}
        ORDER BY bucket_start DESC
        LIMIT #{limit}
    </select>

    <select id="findBucketsBetween" resultType="KlineBucketPO">
        SELECT
            bucket_id,
            instrument_id,
            period,
            bucket_start,
            bucket_end,
            open_price,
            high_price,
            low_price,
            close_price,
            volume,
            turnover,
            trade_count,
            taker_buy_volume,
            taker_buy_turnover,
            is_closed,
            created_at,
            updated_at
        FROM kline_buckets
        WHERE instrument_id = #{instrumentId}
          AND period = #{period}
          AND bucket_start BETWEEN #{start} AND #{end}
        ORDER BY bucket_start ASC
    </select>

    <select id="findLatestBefore" resultType="KlineBucketPO">
        SELECT
            bucket_id,
            instrument_id,
            period,
            bucket_start,
            bucket_end,
            open_price,
            high_price,
            low_price,
            close_price,
            volume,
            turnover,
            trade_count,
            taker_buy_volume,
            taker_buy_turnover,
            is_closed,
            created_at,
            updated_at
        FROM kline_buckets
        WHERE instrument_id = #{instrumentId}
          AND period = #{period}
          AND bucket_start < #{start}
        ORDER BY bucket_start DESC
        LIMIT 1
    </select>
</mapper>
