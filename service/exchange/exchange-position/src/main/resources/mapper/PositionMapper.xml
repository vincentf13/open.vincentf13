<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="open.vincentf13.exchange.position.infra.persistence.mapper.PositionMapper">

    <select id="findBy" parameterType="PositionPO" resultType="PositionPO">
        SELECT *
        FROM positions
        <where>
            <if test="positionId != null">AND position_id = #{positionId}</if>
            <if test="userId != null">AND user_id = #{userId}</if>
            <if test="instrumentId != null">AND instrument_id = #{instrumentId}</if>
            <if test="side != null">AND side = #{side}</if>
            <if test="status != null">AND status = #{status}</if>
        </where>
        ORDER BY updated_at DESC
    </select>

    <insert id="insertSelective" parameterType="PositionPO">
        INSERT INTO positions
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="positionId != null">position_id,</if>
            <if test="userId != null">user_id,</if>
            <if test="instrumentId != null">instrument_id,</if>
            <if test="leverage != null">leverage,</if>
            <if test="margin != null">margin,</if>
            <if test="side != null">side,</if>
            <if test="entryPrice != null">entry_price,</if>
            <if test="quantity != null">quantity,</if>
            <if test="closingReservedQuantity != null">closing_reserved_quantity,</if>
            <if test="markPrice != null">mark_price,</if>
            <if test="marginRatio != null">margin_ratio,</if>
            <if test="unrealizedPnl != null">unrealized_pnl,</if>
            <if test="realizedPnl != null">realized_pnl,</if>
            <if test="liquidationPrice != null">liquidation_price,</if>
            <if test="bankruptcyPrice != null">bankruptcy_price,</if>
            <if test="status != null">status,</if>
            <if test="version != null">version,</if>
            <if test="closedAt != null">closed_at,</if>
        </trim>
        VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="positionId != null">#{positionId},</if>
            <if test="userId != null">#{userId},</if>
            <if test="instrumentId != null">#{instrumentId},</if>
            <if test="leverage != null">#{leverage},</if>
            <if test="margin != null">#{margin},</if>
            <if test="side != null">#{side},</if>
            <if test="entryPrice != null">#{entryPrice},</if>
            <if test="quantity != null">#{quantity},</if>
            <if test="closingReservedQuantity != null">#{closingReservedQuantity},</if>
            <if test="markPrice != null">#{markPrice},</if>
            <if test="marginRatio != null">#{marginRatio},</if>
            <if test="unrealizedPnl != null">#{unrealizedPnl},</if>
            <if test="realizedPnl != null">#{realizedPnl},</if>
            <if test="liquidationPrice != null">#{liquidationPrice},</if>
            <if test="bankruptcyPrice != null">#{bankruptcyPrice},</if>
            <if test="status != null">#{status},</if>
            <if test="version != null">#{version},</if>
            <if test="closedAt != null">#{closedAt},</if>
        </trim>
    </insert>

    <update id="updateSelectiveBy">
        UPDATE positions
        <set>
            <if test="record.userId != null">user_id = #{record.userId},</if>
            <if test="record.instrumentId != null">instrument_id = #{record.instrumentId},</if>
            <if test="record.leverage != null">leverage = #{record.leverage},</if>
            <if test="record.margin != null">margin = #{record.margin},</if>
            <if test="record.side != null">side = #{record.side},</if>
            <if test="record.entryPrice != null">entry_price = #{record.entryPrice},</if>
            <if test="record.quantity != null">quantity = #{record.quantity},</if>
            <if test="record.closingReservedQuantity != null">closing_reserved_quantity = #{record.closingReservedQuantity},</if>
            <if test="record.markPrice != null">mark_price = #{record.markPrice},</if>
            <if test="record.marginRatio != null">margin_ratio = #{record.marginRatio},</if>
            <if test="record.unrealizedPnl != null">unrealized_pnl = #{record.unrealizedPnl},</if>
            <if test="record.realizedPnl != null">realized_pnl = #{record.realizedPnl},</if>
            <if test="record.liquidationPrice != null">liquidation_price = #{record.liquidationPrice},</if>
            <if test="record.bankruptcyPrice != null">bankruptcy_price = #{record.bankruptcyPrice},</if>
            <if test="record.status != null">status = #{record.status},</if>
            <if test="record.version != null">version = #{record.version},</if>
            <if test="record.closedAt != null">closed_at = #{record.closedAt},</if>
        </set>
        WHERE position_id = #{positionId}
          <if test="userId != null">AND user_id = #{userId}</if>
          <if test="instrumentId != null">AND instrument_id = #{instrumentId}</if>
          <if test="side != null">AND side = #{side}</if>
          <if test="expectedVersion != null">AND version = #{expectedVersion}</if>
          <if test="status != null">AND status = #{status}</if>
    </update>
</mapper>
