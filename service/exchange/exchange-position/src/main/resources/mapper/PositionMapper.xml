<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="open.vincentf13.exchange.position.infra.persistence.mapper.PositionMapper">

    <resultMap id="PositionResultMap" type="open.vincentf13.exchange.position.infra.persistence.po.PositionPO">
        <id property="positionId" column="position_id" />
        <result property="userId" column="user_id" />
        <result property="instrumentId" column="instrument_id" />
        <result property="leverage" column="leverage" />
        <result property="margin" column="margin" />
        <result property="side" column="side" />
        <result property="entryPrice" column="entry_price" />
        <result property="quantity" column="quantity" />
        <result property="closingReservedQuantity" column="closing_reserved_quantity" />
        <result property="markPrice" column="mark_price" />
        <result property="marginRatio" column="margin_ratio" />
        <result property="unrealizedPnl" column="unrealized_pnl" />
        <result property="realizedPnl" column="realized_pnl" />
        <result property="liquidationPrice" column="liquidation_price" />
        <result property="bankruptcyPrice" column="bankruptcy_price" />
        <result property="status" column="status" />
        <result property="lastTradeId" column="last_trade_id" />
        <result property="version" column="version" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
        <result property="closedAt" column="closed_at" />
    </resultMap>

    <sql id="BaseColumns">
        position_id,
        user_id,
        instrument_id,
        leverage,
        margin,
        side,
        entry_price,
        quantity,
        closing_reserved_quantity,
        mark_price,
        margin_ratio,
        unrealized_pnl,
        realized_pnl,
        liquidation_price,
        bankruptcy_price,
        status,
        last_trade_id,
        version,
        created_at,
        updated_at,
        closed_at
    </sql>

    <select id="findActive" resultMap="PositionResultMap">
        SELECT
        <include refid="BaseColumns" />
        FROM positions
        WHERE user_id = #{userId}
          AND instrument_id = #{instrumentId}
          AND status = 'ACTIVE'
        ORDER BY updated_at DESC
        LIMIT 1
    </select>

    <update id="reserveForClose">
        UPDATE positions
        SET closing_reserved_quantity = closing_reserved_quantity + #{quantity},
            version = version + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE user_id = #{userId}
          AND instrument_id = #{instrumentId}
          AND side = #{side}
          AND status = 'ACTIVE'
          AND (quantity - closing_reserved_quantity) >= #{quantity}
    </update>

    <!-- write operations will be reintroduced once position creation logic is wired -->
</mapper>
