<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="open.vincentf13.sdk.infra.mysql.mq.offset.MqConsumerOffsetMapper">

    <resultMap id="MqConsumerOffsetResultMap" type="open.vincentf13.sdk.infra.mysql.mq.offset.MqConsumerOffsetPO">
        <id property="consumerGroup" column="consumer_group"/>
        <id property="topic" column="topic"/>
        <id property="partitionId" column="partition_id"/>
        <result property="lastSeq" column="last_seq"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="insertSelective" parameterType="open.vincentf13.sdk.infra.mysql.mq.offset.MqConsumerOffsetPO">
        INSERT INTO mq_consumer_offsets
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="consumerGroup != null">consumer_group,</if>
            <if test="topic != null">topic,</if>
            <if test="partitionId != null">partition_id,</if>
            <if test="lastSeq != null">last_seq,</if>
            <if test="updatedAt != null">updated_at,</if>
        </trim>
        VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="consumerGroup != null">#{consumerGroup},</if>
            <if test="topic != null">#{topic},</if>
            <if test="partitionId != null">#{partitionId},</if>
            <if test="lastSeq != null">#{lastSeq},</if>
            <if test="updatedAt != null">#{updatedAt},</if>
        </trim>
    </insert>

    <select id="findByPO" parameterType="open.vincentf13.sdk.infra.mysql.mq.offset.MqConsumerOffsetPO" resultMap="MqConsumerOffsetResultMap">
        SELECT consumer_group, topic, partition_id, last_seq, updated_at
        FROM mq_consumer_offsets
        <where>
            <if test="consumerGroup != null">AND consumer_group = #{consumerGroup}</if>
            <if test="topic != null">AND topic = #{topic}</if>
            <if test="partitionId != null">AND partition_id = #{partitionId}</if>
            <if test="lastSeq != null">AND last_seq = #{lastSeq}</if>
            <if test="updatedAt != null">AND updated_at = #{updatedAt}</if>
        </where>
        ORDER BY updated_at DESC
    </select>

    <update id="updateSelective" parameterType="open.vincentf13.sdk.infra.mysql.mq.offset.MqConsumerOffsetPO">
        UPDATE mq_consumer_offsets
        <set>
            <if test="lastSeq != null">last_seq = #{lastSeq},</if>
            <if test="updatedAt != null">updated_at = #{updatedAt},</if>
        </set>
        WHERE consumer_group = #{consumerGroup}
          AND topic = #{topic}
          AND partition_id = #{partitionId}
    </update>

    <insert id="batchUpsert" parameterType="java.util.List">
        INSERT INTO mq_consumer_offsets (consumer_group, topic, partition_id, last_seq, updated_at)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.consumerGroup}, #{item.topic}, #{item.partitionId}, #{item.lastSeq}, #{item.updatedAt})
        </foreach>
        ON DUPLICATE KEY UPDATE
            last_seq = VALUES(last_seq),
            updated_at = VALUES(updated_at)
    </insert>

</mapper>
