<?xml version="1.0" encoding="UTF-8"?>
<Configuration monitorInterval="60">

    <Properties>
        <!-- 讀 Spring 屬性，帶預設值 -->
        <Property name="LOG_PATH">${spring:logging.file.path:-./logs}</Property>
        <Property name="LOG_LEVEL_ROOT">${spring:logging.level.root:-INFO}</Property>

        <!-- 模式：含 X-Trace-Id / X-Request-Id（MDC） -->
        <Property name="LOG_PATTERN_CONSOLE">%style{%d{HH:mm:ss.SSS}}{cyan} %highlight{%-5level} [%style{%thread}{magenta}] %style{%logger{36}}{green} [%X{X-Trace-Id} %X{X-Request-Id}] - %msg%n</Property>
        <Property name="LOG_PATTERN_FILE">%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} [%X{X-Trace-Id} %X{X-Request-Id}] - %msg%n</Property>
    </Properties>

    <!-- ========== dev ========== -->
    <SpringProfile name="dev,default">
        <Appenders>
            <Console name="CONSOLE">
                <PatternLayout pattern="${LOG_PATTERN_CONSOLE}" disableAnsi="false"/>
            </Console>
        </Appenders>

        <!-- 可選：開發也要落地檔案時開啟 -->
        <!--        <RollingFile name="FILE"-->
        <!--                     fileName="${LOG_PATH}/app.log"-->
        <!--                     filePattern="${LOG_PATH}/app-%d{yyyy-MM-dd}-%i.log.gz">-->
        <!--            <PatternLayout pattern="${LOG_PATTERN_FILE}"/>-->
        <!--            <Policies>-->
        <!--                <TimeBasedTriggeringPolicy interval="1"/>-->
        <!--                <SizeBasedTriggeringPolicy size="100 MB"/>-->
        <!--            </Policies>-->
        <!--            <DefaultRolloverStrategy>-->
        <!--                <Delete basePath="${LOG_PATH}">-->
        <!--                    <IfFileName glob="app-*.log.gz"/>-->
        <!--                    <IfLastModified age="7d"/>-->
        <!--                </Delete>-->
        <!--            </DefaultRolloverStrategy>-->
        <!--        </RollingFile>-->

        <Loggers>
            <!-- 使用 AsyncRoot 提升吞吐量，includeLocation=false 避免昂貴的 StackWalker 操作 -->
            <AsyncRoot level="${LOG_LEVEL_ROOT}" includeLocation="false">
                <AppenderRef ref="CONSOLE"/>
                <!-- 可選：開發也要落地檔案時開啟 -->
                <!--                <AppenderRef ref="FILE"/>-->
            </AsyncRoot>
        </Loggers>
    </SpringProfile>

    <!-- ========== prod ========== -->
    <SpringProfile name="prod">
        <Appenders>
            <!-- K8s 最佳實踐：只輸出到 Console (Stdout)，由 Fluentd/Filebeat 收集 -->
            <Console name="CONSOLE">
                <PatternLayout pattern="${LOG_PATTERN_CONSOLE}" disableAnsi="false"/>
            </Console>
        </Appenders>

        <Loggers>
            <!-- 生產環境強制使用異步日誌，並關閉 location 獲取以達極致效能 -->
            <AsyncRoot level="${LOG_LEVEL_ROOT}" includeLocation="false">
                <AppenderRef ref="CONSOLE"/>
            </AsyncRoot>
        </Loggers>
    </SpringProfile>

</Configuration>
