<?xml version="1.0" encoding="UTF-8"?>
<Configuration monitorInterval="60">

    <Properties>
        <!-- 讀 Spring 屬性，帶預設值 -->
        <Property name="LOG_PATH">${spring:logging.file.path:-./logs}</Property>
        <Property name="LOG_LEVEL_ROOT">${spring:logging.level.root:-INFO}</Property>

        <!-- 開發環境模式：縮短 Logger 類名，標註並上色 T:TraceID 與 R:ReqID -->
        <Property name="LOG_PATTERN_CONSOLE">%style{%d{HH:mm:ss.SSS}}{cyan} %highlight{%-5level} [%style{%thread}{magenta}] %style{%logger{1.}}{green} [%style{T:%X{X-Trace-Id}}{yellow} %style{R:%X{X-Request-Id}}{blue}] - %msg%n</Property>
        <Property name="LOG_PATTERN_FILE">%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{1.} [T:%X{X-Trace-Id} R:%X{X-Request-Id}] - %msg%n</Property>
    </Properties>

    <!-- ========== dev ========== -->
    <SpringProfile name="dev,default">
        <Appenders>
            <Console name="CONSOLE">
                <PatternLayout pattern="${LOG_PATTERN_CONSOLE}" disableAnsi="false"/>
            </Console>
        </Appenders>

        <Loggers>
            <!-- 使用 AsyncRoot 提升吞吐量，includeLocation=false 避免昂貴的 StackWalker 操作 -->
            <AsyncRoot level="${LOG_LEVEL_ROOT}" includeLocation="false">
                <AppenderRef ref="CONSOLE"/>
            </AsyncRoot>
        </Loggers>
    </SpringProfile>

    <!-- ========== prod ========== -->
    <SpringProfile name="prod">
        <Appenders>
            <!-- K8s 最佳實踐：JSON 格式輸出到 Console (Stdout) -->
            <Console name="CONSOLE">
                <!-- 使用高效能的 JSON 模板佈局 -->
                <JsonTemplateLayout eventTemplateUri="classpath:EcsLayout.json"/>
            </Console>
        </Appenders>

        <Loggers>
            <!-- 生產環境強制使用異步日誌，並關閉 location 獲取以達極致效能 -->
            <AsyncRoot level="${LOG_LEVEL_ROOT}" includeLocation="false">
                <AppenderRef ref="CONSOLE"/>
            </AsyncRoot>
        </Loggers>
    </SpringProfile>
</Configuration>
