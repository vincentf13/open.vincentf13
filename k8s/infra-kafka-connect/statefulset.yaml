apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: infra-kafka-connect
  labels:
    app: infra-kafka-connect
spec:
  serviceName: infra-kafka-connect
  replicas: 1
  selector:
    matchLabels:
      app: infra-kafka-connect
  template:
    metadata:
      labels:
        app: infra-kafka-connect
    spec:
      initContainers:
        - name: install-debezium-mysql
          image: curlimages/curl:8.9.1
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 0
          env:
            - name: DEBEZIUM_MYSQL_VERSION
              value: "2.6.0.Final"
          command:
            - /bin/sh
            - -c
            - |
              set -euo pipefail
              download_url="https://repo1.maven.org/maven2/io/debezium/debezium-connector-mysql/${DEBEZIUM_MYSQL_VERSION}/debezium-connector-mysql-${DEBEZIUM_MYSQL_VERSION}-plugin.tar.gz"
              dest="/opt/kafka/plugins/debezium-connector-mysql-${DEBEZIUM_MYSQL_VERSION}"
              if [ -d "$dest" ]; then
                echo "Debezium MySQL connector already present at $dest"
              else
                echo "Downloading Debezium MySQL connector ${DEBEZIUM_MYSQL_VERSION}"
                tmpfile="/tmp/debezium-mysql-${DEBEZIUM_MYSQL_VERSION}.tar.gz"
                curl -fsSL "$download_url" -o "$tmpfile"
                mkdir -p /opt/kafka/plugins
                tar -xzf "$tmpfile" -C /opt/kafka/plugins
                rm -f "$tmpfile"
              fi
          volumeMounts:
            - name: connect-plugins
              mountPath: /opt/kafka/plugins
      containers:
        - name: kafka-connect
          image: confluentinc/cp-kafka-connect:7.5.0
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8083
              name: rest
          env:
            - name: MALLOC_ARENA_MAX
              value: "2"
            - name: JAVA_TOOL_OPTIONS
              # 解說：同業務服務優化配置
              value: >-
                -XX:+UseSerialGC
                -Xms128m -Xmx384m
                -Xss512k
                -XX:ReservedCodeCacheSize=64m
                -XX:TieredStopAtLevel=1
                -XX:MaxDirectMemorySize=64m
                -XX:MaxMetaspaceSize=128m
                -XX:MinHeapFreeRatio=20 -XX:MaxHeapFreeRatio=40
            - name: CONNECT_LOG4J_LOGGERS
              value: "org.apache.kafka.connect.runtime.rest=WARN"
          volumeMounts:
            - name: connect-config
              mountPath: /etc/kafka-connect/connect-distributed.properties
              subPath: connect-distributed.properties
            - name: connect-data
              mountPath: /var/lib/kafka-connect
            - name: connect-plugins
              mountPath: /opt/kafka/plugins
          startupProbe:
            httpGet:
              path: /connectors
              port: rest
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 30 # 給予最多 150 秒啟動時間
          readinessProbe:
            httpGet:
              path: /connectors
              port: rest
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /connectors
              port: rest
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          resources:
            requests:
              memory: "64Mi"
            limits:
              memory: "1500Mi" # 【關鍵】強制封頂 1.5GB
          command:
            - /bin/bash
            - -lc
            - exec /usr/bin/connect-distributed /etc/kafka-connect/connect-distributed.properties
      volumes:
        - name: connect-config
          configMap:
            name: infra-kafka-connect-config
            items:
              - key: connect-distributed.properties
                path: connect-distributed.properties
        - name: connect-plugins
          persistentVolumeClaim:
            claimName: kafka-connect-plugins
  volumeClaimTemplates:
    - metadata:
        name: connect-data
        labels:
          app: infra-kafka-connect
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 2Gi
        storageClassName: infra-kafka-connect-local
