apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: infra-kafka-connect
  labels:
    app: infra-kafka-connect
spec:
  serviceName: infra-kafka-connect
  replicas: 1
  selector:
    matchLabels:
      app: infra-kafka-connect
  template:
    metadata:
      labels:
        app: infra-kafka-connect
    spec:
      containers:
        - name: kafka-connect
          image: confluentinc/cp-kafka-connect:7.5.0
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8083
              name: rest
          env:
            - name: KAFKA_HEAP_OPTS
              value: "-Xms256m -Xmx256m"
            - name: CONNECT_LOG4J_LOGGERS
              value: "org.apache.kafka.connect.runtime.rest=WARN"
          volumeMounts:
            - name: connect-config
              mountPath: /etc/kafka-connect
            - name: connect-data
              mountPath: /var/lib/kafka-connect
            - name: connect-plugins
              mountPath: /opt/kafka/plugins
          readinessProbe:
            httpGet:
              path: /connectors
              port: rest
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 5
          livenessProbe:
            httpGet:
              path: /connectors
              port: rest
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 5
          resources:
            requests:
              cpu: 50m
              memory: 384Mi
            limits:
              cpu: 200m
              memory: 512Mi
          command:
            - /bin/bash
            - -lc
            - exec /usr/bin/connect-distributed /etc/kafka-connect/connect-distributed.properties
      volumes:
        - name: connect-config
          configMap:
            name: infra-kafka-connect-config
            items:
              - key: connect-distributed.properties
                path: connect-distributed.properties
        - name: connect-plugins
          persistentVolumeClaim:
            claimName: kafka-connect-plugins
  volumeClaimTemplates:
    - metadata:
        name: connect-data
        labels:
          app: infra-kafka-connect
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 2Gi
        storageClassName: infra-kafka-connect-local
