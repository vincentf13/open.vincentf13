apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: monitoring
  labels:
    app: prometheus
  annotations:
    kubernetes.io/description: Basic alert rules for service health
    # 可增補更多規則檔案置於 /etc/prometheus/rules
  
data:
  general-rules.yml: |
    groups:
      - name: service-health
        rules:
          - alert: TargetDown
            expr: sum by (job, instance) (up == 0) > 0
            for: 1m
            labels:
              severity: warning
            annotations:
              summary: "{{ $labels.job }} / {{ $labels.instance }} target down"
              description: "Prometheus 已偵測 {{ $labels.instance }} (job {{ $labels.job }}) 連續 1 分鐘為 down 狀態。"
          - alert: HighErrorRate
            expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
            for: 10m
            labels:
              severity: critical
            annotations:
              summary: "HTTP 5xx rate high"
              description: "HTTP 5xx rate > 5% 持續 10 分鐘，檢查服務健康情形。"
          - alert: NodeCpuHigh
            expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
            for: 1m
            labels:
              severity: warning
            annotations:
              summary: "CPU 使用率過高"
              description: "{{ $labels.instance }} CPU 使用率 > 80% 已持續 1 分鐘，請檢查節點負載。"
      - name: service-test-app
        rules:
          - alert: ServiceTestProcessCpuHigh
            expr: system_cpu_usage{application="service-test"} > 0.8
            for: 1m
            labels:
              severity: critical
              service: service-test
            annotations:
              summary: "service-test 服務 CPU 超過80%"
              description: "process_cpu_usage 高於 80% 已持續 1 分鐘，建議檢查工作負載或擴大服務。"
